{% load static %}
{# Order WhatsApp chat popup modal - same chat form as whatssap/chat.html: send/receive/templates #}
<div id="order-wa-chat-modal" class="order-wa-modal-overlay" style="display: none; position: fixed; inset: 0; z-index: 10000; background: rgba(0,0,0,0.5); align-items: center; justify-content: center;" aria-hidden="true">
  <div class="order-wa-modal-backdrop" style="position: absolute; inset: 0;"></div>
  <div class="order-wa-modal-dialog" style="position: relative; width: 95%; max-width: 480px; max-height: 90vh; background: #fff; border-radius: 12px; box-shadow: 0 20px 50px rgba(0,0,0,0.25); display: flex; flex-direction: column; overflow: hidden;">
    <div class="order-wa-modal-header" style="display: flex; justify-content: space-between; align-items: center; padding: 12px 16px; background: #075e54; color: #fff;">
      <h3 style="margin: 0; font-size: 1rem;">WhatsApp â€“ <span id="order-wa-chat-name">â€”</span></h3>
      <button type="button" class="order-wa-modal-close" aria-label="Close" style="background: none; border: none; color: #fff; font-size: 1.5rem; cursor: pointer; line-height: 1;">&times;</button>
    </div>
    <div class="order-wa-chat-col" style="display: flex; flex-direction: column; min-height: 400px; max-height: 65vh;">
      <div id="order-wa-messages-area" class="order-wa-messages-area" style="flex: 1; padding: 12px; overflow-y: auto; min-height: 200px; background-image: url('data:image/svg+xml,%3Csvg width=\'60\' height=\'60\' viewBox=\'0 0 60 60\' xmlns=\'http://www.w3.org/2000/svg\'%3E%3Cpath d=\'M6 11c2.2 0 4-1.8 4-4s-1.8-4-4-4-4 1.8-4 4 1.8 4 4 4zm29 15c2.2 0 4-1.8 4-4s-1.8-4-4-4-4 1.8-4 4 1.8 4 4 4zm-25-4c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zm38 18c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2z\' fill=\'%23e6e6e6\' fill-opacity=\'0.2\' fill-rule=\'evenodd\'/%3E%3C/svg%3E');"></div>
      <div class="order-wa-media-preview" id="order-wa-media-preview" style="display: none; padding: 8px; background: #f1f3f4; border-radius: 8px; margin-bottom: 6px;"></div>
      <div class="order-wa-input-wrapper" style="padding: 10px; background: #f0f0f0; border-top: 1px solid #e0e0e0;">
        <div class="order-wa-input-row" style="display: flex; align-items: center; gap: 8px;">
          <button type="button" class="order-wa-btn-img" title="Image" style="background: none; border: none; font-size: 1.2rem; cursor: pointer;">ðŸ“·</button>
          <button type="button" class="order-wa-btn-vid" title="Video" style="background: none; border: none; font-size: 1.2rem; cursor: pointer;">ðŸŽ¬</button>
          <button type="button" class="order-wa-btn-tpl" title="Send template" style="background: #128c7e; color: #fff; border: none; padding: 8px 12px; border-radius: 8px; font-size: 0.8rem; cursor: pointer;">Template</button>
          <textarea id="order-wa-message-input" placeholder="Type a messageâ€¦" rows="2" style="flex: 1; padding: 10px 12px; border: 1px solid #ddd; border-radius: 20px; resize: none; font-size: 14px; outline: none;"></textarea>
          <button type="button" id="order-wa-send-btn" class="order-wa-send-btn" title="Send" style="background: #128c7e; color: #fff; border: none; width: 40px; height: 40px; border-radius: 50%; display: inline-flex; align-items: center; justify-content: center; cursor: pointer;">âž¤</button>
        </div>
      </div>
      <input type="file" id="order-wa-image-input" accept="image/*" style="display: none;">
      <input type="file" id="order-wa-video-input" accept="video/*" style="display: none;">
    </div>
  </div>
</div>

{# Template picker modal (inside order-wa so IDs are unique) #}
<div id="order-wa-template-modal" class="order-wa-tpl-overlay" style="display: none; position: fixed; inset: 0; z-index: 10001; background: rgba(0,0,0,0.6); align-items: center; justify-content: center;">
  <div style="position: relative; background: #1e293b; color: #fff; width: 90%; max-width: 520px; max-height: 80vh; border-radius: 12px; display: flex; flex-direction: column; box-shadow: 0 20px 50px rgba(0,0,0,0.4);">
    <div style="padding: 12px 16px; border-bottom: 1px solid #334155; display: flex; justify-content: space-between; align-items: center;">
      <h4 style="margin: 0; font-size: 1rem;">Select template</h4>
      <button type="button" class="order-wa-tpl-close" style="background: none; border: none; color: #fff; font-size: 1.4rem; cursor: pointer;">&times;</button>
    </div>
    <div style="flex: 1; overflow-y: auto; padding: 12px;">
      <input type="text" id="order-wa-tpl-search" placeholder="Search templatesâ€¦" style="width: 100%; padding: 8px; margin-bottom: 10px; border: 1px solid #475569; border-radius: 6px; background: #334155; color: #fff;">
      <div id="order-wa-tpl-list"></div>
      <div id="order-wa-tpl-preview" style="margin-top: 12px; padding: 12px; background: #0f172a; border-radius: 8px; min-height: 60px; display: none;">
        <div id="order-wa-tpl-vars"></div>
      </div>
    </div>
    <div style="padding: 12px; border-top: 1px solid #334155; text-align: right;">
      <button type="button" id="order-wa-tpl-send" disabled style="padding: 8px 16px; background: #128c7e; color: #fff; border: none; border-radius: 8px; cursor: pointer;">Send template</button>
    </div>
  </div>
</div>

<style>
.order-wa-msg-bubble { max-width: 85%; margin-bottom: 8px; padding: 8px 12px; border-radius: 12px; clear: both; font-size: 14px; }
.order-wa-msg-bubble.me { background: #dcf8c6; float: right; margin-left: auto; }
.order-wa-msg-bubble.them { background: #fff; border: 1px solid #e0e0e0; float: left; }
.order-wa-msg-time { font-size: 10px; color: #888; margin-top: 4px; }
.order-wa-tpl-item { padding: 10px 12px; cursor: pointer; border-bottom: 1px solid #334155; border-radius: 6px; margin-bottom: 4px; }
.order-wa-tpl-item:hover, .order-wa-tpl-item.active { background: #334155; }
.order-wa-tpl-item .name { font-weight: 600; }
.order-wa-var-input { width: 100%; padding: 6px 8px; margin-top: 4px; background: #334155; border: 1px solid #475569; color: #fff; border-radius: 4px; font-size: 13px; }
.order-wa-loading { text-align: center; padding: 20px; color: #666; }
</style>

<script>
(function() {
  var channelId = {{ default_channel_id|default:"null" }};
  var sendUrl = '{% url "send_message" %}';
  var messagesUrl = '{% url "get_messages" %}';
  var templatesUrl = '/discount/whatssapAPI/api/get_templates/';
  var modal = document.getElementById('order-wa-chat-modal');
  var messagesArea = document.getElementById('order-wa-messages-area');
  var messageInput = document.getElementById('order-wa-message-input');
  var sendBtn = document.getElementById('order-wa-send-btn');
  var tplModal = document.getElementById('order-wa-template-modal');
  var tplList = document.getElementById('order-wa-tpl-list');
  var tplPreview = document.getElementById('order-wa-tpl-preview');
  var tplVars = document.getElementById('order-wa-tpl-vars');
  var tplSendBtn = document.getElementById('order-wa-tpl-send');
  var currentPhone = null;
  var currentName = null;
  var lastMessageId = 0;
  var pollTimer = null;
  var selectedTpl = null;
  var orderWaQueuedFile = null;
  var orderWaQueuedType = null;
  var orderWaWs = null;
  var orderWaWsQueue = [];
  var orderWaWsReady = false;
  var wsPath = (window.location.protocol === 'https:' ? 'wss:' : 'ws:') + '//' + window.location.host + '/chat/stream/';

  function orderWaWsConnect() {
    if (orderWaWs) { try { orderWaWs.close(); } catch(e){} }
    orderWaWs = new WebSocket(wsPath);
    orderWaWs.onopen = function() {
      orderWaWsReady = true;
      while (orderWaWsQueue.length) {
        var msg = orderWaWsQueue.shift();
        try { orderWaWs.send(msg); } catch(e) { break; }
      }
    };
    orderWaWs.onmessage = function(ev) {
      try {
        var data = JSON.parse(ev.data);
        if (data.type === 'send_result') {
          if (sendBtn) sendBtn.disabled = false;
          if (data.status === 200) {
            if (messageInput) messageInput.value = '';
            orderWaQueuedFile = null; orderWaQueuedType = null;
            var preview = document.getElementById('order-wa-media-preview');
            if (preview) { preview.style.display = 'none'; preview.innerHTML = ''; }
            fetchMessages(true);
          } else {
            var err = (data.payload && data.payload.error) || data.message || 'Send failed.';
            alert(err);
          }
          return;
        }
        if (data.data_type === 'finished' && data.payload) {
          var to = (data.payload.to || data.payload.phone || '').toString().replace(/\D/g, '');
          var cur = (currentPhone || '').toString().replace(/\D/g, '');
          if (cur && to === cur && modal && modal.style.display === 'flex') {
            var msg = {
              id: data.payload.saved_message_id,
              body: data.payload.body,
              type: data.payload.media_type || 'text',
              url: data.payload.media_url || data.payload.url || '',
              time: new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }),
              fromMe: true,
              status: 'sent'
            };
            appendMessageToArea(msg);
          }
          return;
        }
        if (data.data_type === 'log_message_received' && data.payload && data.payload.contact) {
          var phone = (data.payload.contact.phone || '').toString().replace(/\D/g, '');
          var cur = (currentPhone || '').toString().replace(/\D/g, '');
          if (cur && phone === cur && modal && modal.style.display === 'flex') {
            var m = data.payload.message || data.payload;
            var msg = {
              id: m.id,
              body: m.body,
              type: m.media_type || m.type || 'text',
              url: m.media_url || m.url || '',
              time: m.timestamp || m.time || new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }),
              fromMe: false
            };
            appendMessageToArea(msg);
          }
        }
      } catch (e) { console.error('order-wa ws onmessage', e); }
    };
    orderWaWs.onclose = function() {
      orderWaWsReady = false;
      setTimeout(orderWaWsConnect, 3000);
    };
    orderWaWs.onerror = function() {}
  }
  orderWaWsConnect();

  function orderWaSend(type, payload) {
    var text = JSON.stringify({ type: type, payload: payload });
    if (orderWaWsReady && orderWaWs && orderWaWs.readyState === WebSocket.OPEN) {
      orderWaWs.send(text);
      return Promise.resolve();
    }
    orderWaWsQueue.push(text);
    return Promise.resolve();
  }

  function csrfToken() {
    var m = document.querySelector('meta[name="csrf-token"]');
    if (m) return m.getAttribute('content');
    var i = document.getElementById('csrf-token-input');
    return i ? i.value : '';
  }

  function escapeHtml(s) { return (s||'').toString().replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }

  function openModal(phone, name) {
    currentPhone = (phone||'').toString().replace(/^\+/,'').replace(/\s+/g,'');
    currentName = (name||'').toString().trim() || currentPhone;
    lastMessageId = 0;
    if (!modal) return;
    document.getElementById('order-wa-chat-name').textContent = currentName || currentPhone || 'â€”';
    messagesArea.innerHTML = '<div class="order-wa-loading">Loading conversationâ€¦</div>';
    modal.style.display = 'flex';
    modal.setAttribute('aria-hidden', 'false');
    if (messageInput) messageInput.value = '';
    fetchMessages();
    startPoll();
  }

  function closeModal() {
    if (modal) { modal.style.display = 'none'; modal.setAttribute('aria-hidden', 'true'); }
    stopPoll();
  }

  function startPoll() {
    stopPoll();
    function poll() {
      if (!currentPhone || !modal || modal.style.display === 'none') return;
      fetchMessages(true);
      pollTimer = setTimeout(poll, 4000);
    }
    pollTimer = setTimeout(poll, 4000);
  }
  function stopPoll() { if (pollTimer) { clearTimeout(pollTimer); pollTimer = null; } }

  function makeBubble(m) {
    var isMe = !!m.fromMe;
    var div = document.createElement('div');
    div.className = 'order-wa-msg-bubble ' + (isMe ? 'me' : 'them');
    var time = '<span class="order-wa-msg-time">' + escapeHtml(m.time || '') + '</span>';
    if (m.type === 'image' && m.url) {
      div.innerHTML = '<img src="' + escapeHtml(m.url) + '" style="max-width:100%;border-radius:8px;margin-bottom:4px;"><div class="order-wa-msg-time">' + escapeHtml(m.time||'') + '</div>';
    } else if (m.type === 'video' && m.url) {
      div.innerHTML = '<video controls style="max-width:100%;border-radius:8px;margin-bottom:4px;"><source src="' + escapeHtml(m.url) + '"></video><div class="order-wa-msg-time">' + escapeHtml(m.time||'') + '</div>';
    } else {
      div.innerHTML = '<div>' + escapeHtml(m.body||'') + '</div>' + time;
    }
    return div;
  }

  function appendMessageToArea(m) {
    var loading = messagesArea.querySelector('.order-wa-loading');
    if (loading) loading.remove();
    var empty = messagesArea.querySelector('.order-wa-empty');
    if (empty) empty.remove();
    var node = makeBubble(m);
    if (m.id) node.dataset.msgId = m.id;
    messagesArea.appendChild(node);
    messagesArea.scrollTop = messagesArea.scrollHeight;
  }

  function fetchMessages(silent) {
    if (!currentPhone || !channelId) {
      if (!silent && messagesArea) messagesArea.innerHTML = '<div class="order-wa-loading">No channel configured.</div>';
      return;
    }
    var url = messagesUrl + '?phone=' + encodeURIComponent(currentPhone) + '&since_id=' + (lastMessageId||0) + '&channel_id=' + channelId + '&tracking=true';
    fetch(url, { cache: 'no-store', headers: { 'Accept': 'application/json' } })
      .then(function(r) { return r.json(); })
      .then(function(data) {
        var msgs = data.messages || [];
        var loading = messagesArea.querySelector('.order-wa-loading');
        if (loading) loading.remove();
        if (msgs.length === 0 && !messagesArea.querySelector('.order-wa-msg-bubble')) {
          messagesArea.innerHTML = '<div class="order-wa-loading order-wa-empty">No messages yet.</div>';
          return;
        }
        msgs.forEach(function(m) {
          if (m.id && m.id > lastMessageId) lastMessageId = m.id;
          var existing = messagesArea.querySelector('[data-msg-id="' + m.id + '"]');
          if (existing) return;
          var node = makeBubble(m);
          node.dataset.msgId = m.id;
          messagesArea.appendChild(node);
        });
        messagesArea.scrollTop = messagesArea.scrollHeight;
      })
      .catch(function() {
        if (!silent && messagesArea && !messagesArea.querySelector('.order-wa-msg-bubble'))
          messagesArea.innerHTML = '<div class="order-wa-loading">Failed to load messages.</div>';
      });
  }

  function fileToBase64(file) {
    return new Promise(function(resolve, reject) {
      var reader = new FileReader();
      reader.onload = function() { resolve(reader.result.split(',')[1]); };
      reader.onerror = reject;
      reader.readAsDataURL(file);
    });
  }

  function sendTextOrMedia() {
    if (!currentPhone) return;
    if (!channelId) { alert('No WhatsApp channel configured.'); return; }
    var payload = { to: currentPhone, channel_id: channelId };
    if (orderWaQueuedFile && orderWaQueuedType) {
      sendBtn.disabled = true;
      fileToBase64(orderWaQueuedFile).then(function(base64) {
        payload.msg_type = 'media_upload';
        payload.type = orderWaQueuedType;
        payload.file = base64;
        payload.mime = orderWaQueuedFile.type || (orderWaQueuedType === 'image' ? 'image/jpeg' : 'video/mp4');
        payload.body = '';
        return orderWaSend('send_message', payload);
      }).catch(function() { sendBtn.disabled = false; alert('Failed to read file.'); });
      return;
    }
    var text = messageInput && messageInput.value.trim();
    if (!text) return;
    sendBtn.disabled = true;
    payload.type = 'text';
    payload.body = text;
    orderWaSend('send_message', payload).catch(function() { sendBtn.disabled = false; });
  }

  if (sendBtn) sendBtn.addEventListener('click', function() { sendTextOrMedia(); });
  if (messageInput) messageInput.addEventListener('keydown', function(e) {
    if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendTextOrMedia(); }
  });

  var imgInput = document.getElementById('order-wa-image-input');
  var vidInput = document.getElementById('order-wa-video-input');
  var mediaPreview = document.getElementById('order-wa-media-preview');
  function showMediaPreview(file, type) {
    orderWaQueuedFile = file; orderWaQueuedType = type;
    if (!mediaPreview) return;
    mediaPreview.style.display = 'block';
    var name = file.name || (type === 'image' ? 'Image' : 'Video');
    mediaPreview.innerHTML = '<span style="margin-right:8px">' + escapeHtml(name) + '</span><button type="button" class="order-wa-clear-media" style="background:none;border:none;cursor:pointer">âœ•</button>';
    mediaPreview.querySelector('.order-wa-clear-media').onclick = function() {
      orderWaQueuedFile = null; orderWaQueuedType = null;
      mediaPreview.style.display = 'none';
      mediaPreview.innerHTML = '';
    };
  }
  document.querySelector('.order-wa-btn-img') && document.querySelector('.order-wa-btn-img').addEventListener('click', function() { if (imgInput) imgInput.click(); });
  document.querySelector('.order-wa-btn-vid') && document.querySelector('.order-wa-btn-vid').addEventListener('click', function() { if (vidInput) vidInput.click(); });
  if (imgInput) imgInput.addEventListener('change', function(e) {
    var f = e.target.files[0];
    if (f) showMediaPreview(f, 'image');
    imgInput.value = '';
  });
  if (vidInput) vidInput.addEventListener('change', function(e) {
    var f = e.target.files[0];
    if (f) showMediaPreview(f, 'video');
    vidInput.value = '';
  });

  if (modal) {
    var closeBtn = modal.querySelector('.order-wa-modal-close');
    var backdrop = modal.querySelector('.order-wa-modal-backdrop');
    if (closeBtn) closeBtn.addEventListener('click', closeModal);
    if (backdrop) backdrop.addEventListener('click', closeModal);
  }

  window.openOrderWaChat = openModal;
  window.closeOrderWaChat = closeModal;

  // Template modal
  function openTplModal() {
    if (!currentPhone || !channelId) { alert('Select a conversation first.'); return; }
    selectedTpl = null;
    tplList.innerHTML = '<div class="order-wa-loading">Loading templatesâ€¦</div>';
    tplPreview.style.display = 'none';
    tplSendBtn.disabled = true;
    tplModal.style.display = 'flex';
    fetch(templatesUrl + '?channel_id=' + channelId, { headers: { 'Accept': 'application/json' } })
      .then(function(r) { return r.json(); })
      .then(function(data) {
        var tpls = data.templates || [];
        tplList.innerHTML = '';
        tpls.forEach(function(t) {
          var el = document.createElement('div');
          el.className = 'order-wa-tpl-item';
          el.innerHTML = '<div class="name">' + escapeHtml(t.name) + '</div><div style="font-size:0.75rem;color:#94a3b8">' + escapeHtml(t.language) + ' â€¢ ' + escapeHtml(t.status||'') + '</div>';
          el.dataset.body = t.body || '';
          el.dataset.name = t.name || '';
          el.dataset.language = t.language || '';
          el.onclick = function() { selectTpl(t, el); };
          tplList.appendChild(el);
        });
        if (tpls.length === 0) tplList.innerHTML = '<div class="order-wa-loading">No templates.</div>';
      })
      .catch(function() { tplList.innerHTML = '<div class="order-wa-loading">Failed to load templates.</div>'; });
  }

  function selectTpl(tpl, el) {
    tplList.querySelectorAll('.order-wa-tpl-item').forEach(function(i) { i.classList.remove('active'); });
    el.classList.add('active');
    selectedTpl = tpl;
    var body = tpl.body || '';
    var vars = body.match(/\{\{(\d+)\}\}/g);
    tplVars.innerHTML = '';
    tplPreview.innerHTML = '';
    var bodyDiv = document.createElement('div');
    bodyDiv.style.cssText = 'white-space:pre-wrap;padding:8px;background:#1e293b;border-radius:6px;margin-bottom:10px;';
    bodyDiv.textContent = body;
    tplPreview.appendChild(bodyDiv);
    tplPreview.appendChild(tplVars);
    if (vars && vars.length) {
      var seen = {};
      vars.forEach(function(v) {
        var num = v.replace(/\{\{|\}\}/g, '');
        if (seen[num]) return;
        seen[num] = true;
        var group = document.createElement('div');
        group.style.marginBottom = '10px';
        group.innerHTML = '<label style="display:block;font-size:0.8rem;color:#94a3b8;margin-bottom:4px">Variable {{' + num + '}}</label><input type="text" class="order-wa-var-input" data-var="' + escapeHtml(num) + '" placeholder="Value for {{' + num + '}}">';
        tplVars.appendChild(group);
      });
    }
    tplPreview.style.display = 'block';
    tplSendBtn.disabled = false;
  }

  function sendTemplate() {
    if (!selectedTpl || !currentPhone) return;
    var inputs = tplVars.querySelectorAll('.order-wa-var-input');
    var parameters = [];
    inputs.forEach(function(inp) {
      parameters.push({ type: 'text', text: inp.value || ' ' });
    });
    var payload = {
      to: currentPhone,
      type: 'template',
      channel_id: channelId,
      template_name: selectedTpl.name,
      language: selectedTpl.language || 'en',
      components: [{ type: 'body', parameters: parameters }]
    };
    tplSendBtn.disabled = true;
    fetch(sendUrl, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrfToken() },
      body: JSON.stringify(payload),
      credentials: 'same-origin'
    })
      .then(function(r) { return r.json(); })
      .then(function(data) {
        if (data.error) { alert(data.error); tplSendBtn.disabled = false; return; }
        tplModal.style.display = 'none';
        fetchMessages(true);
        tplSendBtn.disabled = false;
      })
      .catch(function() { tplSendBtn.disabled = false; alert('Send failed.'); });
  }

  document.querySelector('.order-wa-btn-tpl') && document.querySelector('.order-wa-btn-tpl').addEventListener('click', openTplModal);
  document.querySelector('.order-wa-tpl-close') && document.querySelector('.order-wa-tpl-close').addEventListener('click', function() { tplModal.style.display = 'none'; });
  tplSendBtn && tplSendBtn.addEventListener('click', sendTemplate);

  document.body.addEventListener('click', function(e) {
    var btn = e.target && e.target.closest && e.target.closest('.order-wa-btn');
    if (!btn) return;
    e.preventDefault();
    var phone = (btn.getAttribute('data-order-phone') || '').trim();
    var name = (btn.getAttribute('data-order-name') || '').trim();
    if (!phone) { alert('No phone for this order.'); return; }
    if (typeof window.openOrderWaChat === 'function') {
      window.openOrderWaChat(phone, name);
    }
  });
})();
</script>

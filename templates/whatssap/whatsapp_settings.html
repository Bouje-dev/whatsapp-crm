<style>
    .loading-overlay {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(22, 27, 34, 0.85); /* Ù„ÙˆÙ† Ø¯Ø§ÙƒÙ† Ø´ÙØ§Ù */
    backdrop-filter: blur(4px); /* ØªØ£Ø«ÙŠØ± Ø§Ù„Ø²Ø¬Ø§Ø¬ Ø§Ù„Ø¶Ø¨Ø§Ø¨ÙŠ */
    z-index: 100; /* Ù„ØªÙƒÙˆÙ† ÙÙˆÙ‚ ÙƒÙ„ Ø§Ù„Ø­Ù‚ÙˆÙ„ */
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 16px; /* Ù†ÙØ³ Ø§Ù†Ø­Ù†Ø§Ø¡ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© */
    transition: all 0.3s ease;
}
    /* --- ØµÙˆØ±Ø© Ø§Ù„Ø¨Ø±ÙˆÙØ§ÙŠÙ„ --- */
.profile-upload-wrapper {
    position: relative;
    /* width: 80px; */
    /* height: 80px; */
}

.profile-img-lg {
    width: 80px;
    height: 80px;
    object-fit: cover;
    border: 2px solid #30363d;
}

.upload-overlay {
    position: absolute;
    top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(0, 0, 0, 0.5);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    opacity: 0;
    cursor: pointer;
    transition: opacity 0.2s;
}

.profile-upload-wrapper:hover .upload-overlay {
    opacity: 1;
}

/* --- Ù…ÙˆØ¯Ø§Ù„ Ø§Ù„Ø®Ø·Ø± --- */
.letter-spacing-2 {
    letter-spacing: 5px;
}
    /* --- Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø­Ø§ÙˆÙŠØ© Ø§Ù„Ø¹Ø§Ù…Ø© --- */
.settings-card {
    background: #161b22; /* Ù„ÙˆÙ† Ø¯Ø§ÙƒÙ† Ø£Ù‚Ù„ Ø­Ø¯Ø© Ù…Ù† Ø§Ù„Ø£Ø³ÙˆØ¯ */
    border: 1px solid #30363d;
    border-radius: 16px;
    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2);
    overflow: hidden; /* Ù„Ø¶Ù…Ø§Ù† Ø¹Ø¯Ù… Ø®Ø±ÙˆØ¬ Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø¹Ù† Ø§Ù„Ø­ÙˆØ§Ù */
}

/* --- ØªØµÙ…ÙŠÙ… Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø§Øª Ø§Ù„Ø¹ØµØ±ÙŠ (Tabs) --- */
.settings-tabs .nav-link {
    color: #8b949e;
    background: transparent !important;
    border: none !important;
    border-bottom: 2px solid transparent !important;
    padding: 1rem 1.5rem;
    font-weight: 500;
    transition: all 0.3s ease;
}

.settings-tabs .nav-link:hover {
    color: #e6edf3;
    background: rgba(255, 255, 255, 0.02) !important;
}

.settings-tabs .nav-link.active {
    color: #58a6ff; /* Ø£Ø²Ø±Ù‚ Ø³Ù…Ø§ÙˆÙŠ Ù…Ø¶ÙŠØ¡ */
    border-bottom-color: #58a6ff !important;
    background: linear-gradient(to top, rgba(88, 166, 255, 0.1), transparent) !important;
}

.settings-tabs .nav-link i {
    opacity: 0.7;
}
.settings-tabs .nav-link.active i {
    opacity: 1;
}

/* --- Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ (Inputs) --- */
.modern-input {
    background-color: #0d1117 !important; /* Ø®Ù„ÙÙŠØ© Ø£ØºÙ…Ù‚ Ù…Ù† Ø§Ù„ÙƒØ§Ø±Ø¯ Ù„Ù„Ø¹Ù…Ù‚ */
    border: 1px solid #30363d !important;
    color: #e6edf3 !important;
    padding: 12px 15px;
    border-radius: 8px !important;
    transition: all 0.2s ease-in-out;
}

.modern-input:focus {
    border-color: #58a6ff !important;
    box-shadow: 0 0 0 3px rgba(88, 166, 255, 0.15) !important;
    background-color: #10151c !important;
}

.input-group-text.modern-addon {
    background-color: #161b22;
    border: 1px solid #30363d;
    border-right: none;
    color: #8b949e;
}

/* --- Ø§Ù„Ù†ØµÙˆØµ (Labels) --- */
.form-label-modern {
    color: #8b949e;
    font-size: 0.85rem;
    font-weight: 600;
    margin-bottom: 8px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

/* --- Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª (Alerts) --- */
.alert-glass {
    background: rgba(56, 189, 248, 0.1);
    border: 1px solid rgba(56, 189, 248, 0.2);
    color: #7dd3fc;
    border-radius: 8px;
    backdrop-filter: blur(5px);
}

/* --- Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠØ© (Inner Cards) --- */
.inner-card {
    background: rgba(255, 255, 255, 0.03);
    border: 1px solid rgba(255, 255, 255, 0.05);
    border-radius: 12px;
    transition: transform 0.2s;
}
.inner-card:hover {
    border-color: rgba(255, 255, 255, 0.1);
}

/* --- Ø²Ø± Ø§Ù„Ø­ÙØ¸ --- */
.btn-save-glow {
    background: linear-gradient(135deg, #6366f1 0%, #a855f7 100%); /* ØªØ¯Ø±Ø¬ Ø¨Ù†ÙØ³Ø¬ÙŠ ÙŠÙ†Ø§Ø³Ø¨ Ø§Ù„Ø³Ø§ÙŠØ¯Ø¨Ø§Ø± */
    border: none;
    color: white;
    padding: 10px 30px;
    border-radius: 8px;
    font-weight: 600;
    box-shadow: 0 4px 15px rgba(168, 85, 247, 0.4);
    transition: all 0.3s;
}

.btn-save-glow:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(168, 85, 247, 0.6);
    color: white;
}
</style>
<div class="container-fluid p-4">
    <div class="mb-4">
        <h4 class="text-white fw-bold mb-1">
            <i class="fab fa-whatsapp text-success me-2"></i> Channel Configuration
        </h4>
        <p class="text-muted small">Manage your WhatsApp Business Profile, Automation, and Team preferences.</p>
    </div>

    <div class="card settings-card" style="position: relative;">
       
            <div id="settings_loader" class="loading-overlay d-none">
                <div class="text-center">
                    <div class="spinner-border text-primary mb-3" style="width: 3rem; height: 3rem;" role="status"></div>
                    <h6 class="text-white mt-2">Loading Configurations...</h6>
                </div>
            </div>
        
          
        <div class="card-header border-bottom border-secondary p-0 bg-transparent">
            <ul class="nav nav-tabs settings-tabs nav-fill" id="settingsTabs" role="tablist">
                
                {% if user.is_team_admin or user.is_superuser %}
                
            

                <li class="nav-item">
                    <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#content-profile">
                        <i class="fas fa-store me-2"></i> Business Profile
                    </button>
                </li>
                <li class="nav-item">
                    <button class="nav-link" data-bs-toggle="tab" data-bs-target="#content-automation">
                        <i class="fas fa-robot me-2"></i> Automation
                    </button>
                </li>
                {% endif %}

                <li class="nav-item">
                    <button class="nav-link {% if not user.is_team_admin %}active{% endif %}" data-bs-toggle="tab" data-bs-target="#content-personal">
                        <i class="fas fa-user-cog me-2"></i> Preferences
                    </button>
                </li>
            </ul>
        </div>

        <div class="card-body p-4">
            <form id="whatsappSettingsForm">
                <div class="tab-content">
                    
                    <div class="tab-pane fade show active" id="content-profile">
                        <div class="border-bottom border-secondary" style="margin-bottom: 9px;" > 
                            <h4 class="text-white fw-bold mb-1">
                                <i class="fab fa-whatsapp text-success me-2"></i> Channel Name 
                            </h4>
                           <div class="alert alert-glass d-flex align-items-center mb-4" role="alert">
                            <input type="text" name="channel_name" class="form-control modern-input" style="background-color: transparent;" id="channel_name" value="{{ channel.channel_name }}" placeholder="Channel Name">
                           </div>
                        
                           
                        </div>
                        <div class="alert alert-glass d-flex align-items-center mb-4" role="alert">
                            <i class="fas fa-info-circle me-3 fs-5"></i>
                            <div>
                                Changes here will be <strong class="text-white">synced with WhatsApp directly</strong>. Please update carefully.
                            </div>
                        </div>
                    
                        <div class="row g-4">
                            
                            <div class="col-lg-8 order-2 order-lg-1">
                                <div class="row g-4">
                                    <div class="col-12">
                                        <label class="form-label-modern">Business Description</label>
                                        <textarea name="business_description" class="form-control modern-input" id="business_description" rows="4" placeholder="Tell customers about your business...">{{ channel.business_description }}</textarea>
                                    </div>
                    
                                    <div class="col-md-6">
                                        <label class="form-label-modern">Address</label>
                                        <div class="input-group">
                                            <span class="input-group-text modern-addon"><i class="fas fa-map-marker-alt"></i></span>
                                            <input type="text" name="business_address"  id="business_address" class="form-control modern-input" value="{{ channel.business_address }}">
                                        </div>
                                    </div>
                    
                                    <div class="col-md-6">
                                        <label class="form-label-modern">Email Contact</label>
                                        <div class="input-group">
                                            <span class="input-group-text modern-addon"><i class="fas fa-envelope"></i></span>
                                            <input type="email"  id="business_email" name="business_email" class="form-control modern-input" value="{{ channel.business_email }}">
                                        </div>
                                    </div>
                    
                                    <div class="col-md-6">
                                        <label class="form-label-modern">Website</label>
                                        <div class="input-group">
                                            <span class="input-group-text modern-addon"><i class="fas fa-globe"></i></span>
                                            <input type="url" id="business_website" name="business_website" class="form-control modern-input" value="{{ channel.business_website }}">
                                        </div>
                                    </div>
                    
                                    <div class="col-md-6">
                                        <label class="form-label-modern">Status (About Info)</label>
                                        <input type="text" id="business_about" name="business_about" class="form-control modern-input" value="{{ channel.business_about }}" placeholder="e.g. Available 9AM - 5PM">
                                    </div>
                                </div>
                            </div>
                    
                            <div class="col-lg-4 order-1 order-lg-2 d-flex flex-column align-items-center justify-content-start pt-lg-2">
                                <div class="inner-card p-4 text-center w-100 h-100 d-flex flex-column align-items-center justify-content-center" style="min-height: 250px;">
                                    <div class="profile-upload-wrapper mb-3">
                                        <img id="profile_preview" src="{% if channel.profile_image %}{{ channel.profile_image.url }}{% else %}/static/img/default-wa.png{% endif %}" class="rounded-circle profile-img-lg shadow-lg" alt="Profile" style="width: 120px; height: 120px; border: 4px solid #30363d;">
                                        
                                        <label for="profile_image_input" class="upload-overlay" style="border-radius: 50%;">
                                            <i class="fas fa-camera text-white fs-4"></i>
                                        </label>
                                    </div>
                                    <input type="file" id="profile_image_input" name="profile_image" class="d-none" accept="image/*">
                                    
                                    <h5 class="text-white mb-1">Channel Icon</h5>
                                    <p class="text-muted small mb-0 px-3">Upload a high-quality logo (min 500x500px) for your dashboard & WhatsApp.</p>
                                </div>
                            </div>
                    
                        </div>
                    
                        <div class="mt-5 pt-4 border-top border-secondary">
                            <h6 class="text-danger text-uppercase fw-bold small ls-1 mb-3">Danger Zone</h6>
                            <div class="card border-danger bg-danger bg-opacity-10">
                                <div class="card-body d-flex justify-content-between align-items-center flex-wrap gap-3">
                                    <div>
                                        <h6 class="text-danger mb-1 fw-bold">Delete this Channel</h6>
                                        <p class="text-danger text-opacity-75 small mb-0">
                                            Once deleted, there is no going back. All messages and configurations will be permanently removed.
                                        </p>
                                    </div>
                                    <button type="button" class="btn btn-outline-danger" onclick="openDeleteModal()">
                                        <i class="fas fa-trash-alt me-2"></i> Delete Channel
                                    </button>
                                </div>
                            </div>
                        </div>
                    
                        <div class="modal fade" id="deleteOtpModal" tabindex="-1" data-bs-backdrop="static">
                            <div class="modal-dialog modal-dialog-centered">
                                <div class="modal-content bg-dark border-secondary">
                                    <div class="modal-header border-bottom border-secondary">
                                        <h5 class="modal-title text-danger"><i class="fas fa-exclamation-triangle me-2"></i> Confirm Deletion</h5>
                                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                                    </div>
                                    <div class="modal-body">
                                        <p class="text-white">To permanently delete <strong>{{ channel.name }}</strong>, we need to verify your identity.</p>
                                        <p class="text-muted small">We will send a verification code to <strong>{{ request.user.email }}</strong>.</p>
                                        
                                        <div id="step_request_otp" class="text-center py-3">
                                            <button type="button" class="btn btn-primary" onclick="requestDeleteOtp()">
                                                <i class="fas fa-paper-plane me-2"></i> Send Verification Code
                                            </button>
                                        </div>
                        
                                        <div id="step_verify_otp" class="d-none">
                                            <div class="alert alert-info small py-2"><i class="fas fa-envelope-open me-2"></i> Code sent! Check your email.</div>
                                            <label class="form-label text-secondary small">Enter 6-Digit Code</label>
                                            <input type="text" id="otp_input" class="form-control modern-input text-center fs-4 letter-spacing-2" maxlength="6" placeholder="000000">
                                            <div class="d-grid mt-3">
                                                <button type="button" class="btn btn-danger" onclick="confirmFinalDelete()">
                                                    Confirm Permanent Deletion
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    
                    </div>

                    <div class="tab-pane fade" id="content-automation">
                        <div class="row g-4">
                            <div class="col-lg-6">
                                <div class="p-4 inner-card h-100">
                                    <h6 class="text-white mb-3 d-flex align-items-center">
                                        <i class="fas fa-hand-sparkles text-warning me-2"></i> Welcome Message
                                    </h6>
                                    <div class="form-check form-switch mb-3">
                                        <input class="form-check-input" type="checkbox" name="enable_welcome_msg" id="switch_welcome" {% if channel.enable_welcome_msg %}checked{% endif %}>
                                        <label class="form-check-label text-muted" for="switch_welcome">Enable auto-greeting</label>
                                    </div>
                                    <div id="welcome_config_area" class="{% if not channel.enable_welcome_msg %}d-none{% endif %}">
                                        <textarea name="welcome_msg_body" class="form-control modern-input" rows="3">{{ channel.welcome_msg_body }}</textarea>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="col-lg-6">
                                <div class="p-4 inner-card h-100">
                                    <h6 class="text-white mb-3 d-flex align-items-center">
                                        <i class="fas fa-cogs text-info me-2"></i> Workflow
                                    </h6>
                                    <div class="d-flex justify-content-between align-items-center mb-3">
                                        <div>
                                            <span class="text-white d-block fw-bold" style="font-size: 0.9rem;">Collision Detection</span>
                                            <small class="text-muted" style="font-size: 0.75rem;">Show alert when agents overlap.</small>
                                        </div>
                                        <div class="form-check form-switch">
                                            <input class="form-check-input" type="checkbox" name="enable_collision_detection" {% if channel.enable_collision_detection %}checked{% endif %}>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="tab-pane fade" id="content-personal">
                        <div class="row">
                            <div class="col-md-8 mx-auto">
                                <div class="inner-card p-0 overflow-hidden">
                                    <div class="p-3 border-bottom border-secondary d-flex justify-content-between align-items-center">
                                        <div class="d-flex align-items-center">
                                            <div class="bg-dark p-2 rounded me-3 text-warning"><i class="fas fa-volume-up"></i></div>
                                            <div>
                                                <h6 class="mb-0 text-white">Sound Notifications</h6>
                                            </div>
                                        </div>
                                        <div class="form-check form-switch">
                                            <input class="form-check-input" type="checkbox" id="personal_sound_toggle">
                                        </div>
                                    </div>
                                    </div>
                            </div>
                        </div>
                    </div>

                </div>

                {% if user.is_team_admin or user.is_superuser %}
                <div class="mt-5 pt-3 border-top border-secondary d-flex justify-content-end">
                    <button type="button" class="btn btn-save-glow" id="btn_save_settings" onclick="submitChannelSettings()">
                        <i class="fas fa-save me-2"></i> Save Changes
                    </button>
                </div>
                {% endif %}

            </form>
        </div>
    </div>
</div>



<script>
    window.loadSetting = function (channel_id){      
     
    const loader = $('#settings_loader');
    loader.removeClass('d-none'); 
    
    // Ø¥Ø¸Ù‡Ø§Ø± Ù„ÙˆØ¯ÙŠÙ†Ø¬ Ø¨Ø³ÙŠØ· Ø¥Ù† Ø£Ø±Ø¯Øª
    $('#settings_modal').modal('show'); 
    
    $.ajax({
        url: '{% url "get_channel_settings" %}',  
        type: 'POST',
        dataType: 'json',
        data: {
            csrfmiddlewaretoken: '{{ csrf_token }}',
            channel_id: channel_id 
        },
        success: function(response) {
            if (response.status === 'success') {
                const data = response.data;

                // 1. Ù…Ù„Ø¡ Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù†ØµÙˆØµ (Ù†Ø³ØªØ®Ø¯Ù… .val Ù„Ù„Ø­Ù‚ÙˆÙ„)
                $('textarea[name="business_description"]').val(data.b_descr);
                $('input[name="business_address"]').val(data.b_address);
                $('input[name="business_email"]').val(data.b_email);
                $('input[name="business_website"]').val(data.b_website);
                $('input[name="business_about"]').val(data.b_about);
                
                // 2. ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙˆØ±Ø©
                $('#profile_preview').attr('src', data.b_img);

                // 3. ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø³ÙˆÙŠØªØ´ (Ø§Ù„ØªØ±Ø­ÙŠØ¨)
                $('input[name="enable_welcome_msg"]').prop('checked', data.b_welcom_enable);
                $('textarea[name="welcome_msg_body"]').val(data.b_welcom_body);
                $('input[name="channel_name"]').val(data.channel_name);

                // Ø§Ù„ØªØ­ÙƒÙ… ÙÙŠ Ø¸Ù‡ÙˆØ± Ù…Ù†Ø·Ù‚Ø© Ù†Øµ Ø§Ù„ØªØ±Ø­ÙŠØ¨
                if(data.b_welcom_enable) {
                    $('#welcome_config_area').removeClass('d-none');
                } else {
                    $('#welcome_config_area').addClass('d-none');
                }

            } else {
                console.error('Server returned error:', response.message);
            }
        },
        error: function(xhr, status, error) {
            console.error('AJAX Error:', error);
            console.log(xhr.responseText);
        },
        complete: function() {
            // 2. ğŸ”¥ Ø¥Ø®ÙØ§Ø¡ Ø·Ø¨Ù‚Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ø¨Ø¹Ø¯ Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„Ø¬Ù„Ø¨ (Ø¨Ù†Ø¬Ø§Ø­ Ø£Ùˆ ÙØ´Ù„) ğŸ”¥
            // Ù†Ø³ØªØ®Ø¯Ù… fadeOut Ù„ØªØ£Ø«ÙŠØ± Ù†Ø§Ø¹Ù…
            loader.fadeOut(300, function() {
                $(this).addClass('d-none').removeAttr('style'); // Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ÙƒÙ„Ø§Ø³ d-none ÙˆØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø³ØªØ§ÙŠÙ„ Ø§Ù„Ø°ÙŠ ÙŠØ¶ÙŠÙÙ‡ fadeOut
            });
        }
    });
};

$('#btn_open_settings').on('click', function() {
    loadSetting();
});


    window.loadSetting = loadSetting(currentChannelId);

    $(document).ready(function() {
  
        $('#profile_image_input').change(function(){
    const file = this.files[0];
    if (file){
        let reader = new FileReader();
        reader.onload = function(event){
            $('#profile_preview').attr('src', event.target.result);
        }
        reader.readAsDataURL(file);
    }
});  


    // --- Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØµÙˆØª ---
    const soundToggle = $('#personal_sound_toggle');
    // Ø§Ù„Ù‚Ø±Ø§Ø¡Ø© Ù…Ù† Ø§Ù„Ø°Ø§ÙƒØ±Ø© (Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ true Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù…Ø®Ø²Ù†Ø§Ù‹)
    const storedSound = localStorage.getItem('wa_sound_enabled');
    const isSoundEnabled = storedSound === null ? true : (storedSound === 'true');
    
    soundToggle.prop('checked', isSoundEnabled);
    window.soundEnabled = isSoundEnabled; // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…ØªØºÙŠØ± Ø§Ù„Ø¹Ø§Ù…

    soundToggle.on('change', function() {
        const isChecked = $(this).is(':checked');
        localStorage.setItem('wa_sound_enabled', isChecked);
        window.soundEnabled = isChecked;
        
        // ØªØ´ØºÙŠÙ„ ØµÙˆØª ØªØ¬Ø±ÙŠØ¨ÙŠ Ø¹Ù†Ø¯ Ø§Ù„ØªÙØ¹ÙŠÙ„
        if(isChecked) {
            const audio = new Audio('/static/sounds/notification.mp3'); // ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ù…Ø³Ø§Ø±
            audio.volume = 0.5;
            audio.play().catch(e => console.log('Audio test blocked'));
        }
    });

    // --- Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Enter Ù„Ù„Ø¥Ø±Ø³Ø§Ù„ ---
    const enterToggle = $('#personal_enter_send');
    const storedEnter = localStorage.getItem('wa_enter_to_send');
    const isEnterEnabled = storedEnter === null ? true : (storedEnter === 'true');

    enterToggle.prop('checked', isEnterEnabled);
    window.enterToSend = isEnterEnabled;

    enterToggle.on('change', function() {
        const isChecked = $(this).is(':checked');
        localStorage.setItem('wa_enter_to_send', isChecked);
        window.enterToSend = isChecked;
    });

    // ==========================================
    // 2. Admin UI Logic (UX) ğŸ”’
    // ==========================================
    
    // Ø¥Ø¸Ù‡Ø§Ø±/Ø¥Ø®ÙØ§Ø¡ Ù…Ù†Ø·Ù‚Ø© Ù†Øµ Ø§Ù„ØªØ±Ø­ÙŠØ¨ Ø¹Ù†Ø¯ ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø³ÙˆÙŠØªØ´
    $('#switch_welcome').on('change', function() {
        if ($(this).is(':checked')) {
            $('#welcome_config_area').removeClass('d-none').hide().slideDown(200);
        } else {
            $('#welcome_config_area').slideUp(200);
        }
    });

});

// ==========================================
// 3. Admin Save Logic (AJAX) ğŸ’¾
// ==========================================

function submitChannelSettings() {
    const btn = $('#btn_save_settings');
    const statusMsg = $('#save_status_msg');
    // const form = $('#whatsappSettingsForm');
    const formData = new FormData($('#whatsappSettingsForm')[0]);
    const originalBtnContent = btn.html();
    formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');
    formData.append('channel_id' , currentChannelId)
     

    // 1. Ø­Ø§Ù„Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„
    btn.prop('disabled', true).html('<i class="fas fa-circle-notch fa-spin me-2"></i> Saving...');
    statusMsg.text('Syncing with Server...').addClass('show');

    // 2. Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨
    $.ajax({
        url: '/discount/whatssapAPI/api/update-channel-settings/', // ØªØ£ÙƒØ¯ Ù…Ù† ØªØ·Ø§Ø¨Ù‚ Ø§Ù„Ø±Ø§Ø¨Ø· Ù…Ø¹ urls.py
        method: 'POST',
        // data: form.serialize(),
        data: formData,
        processData: false, // Ù…Ù‡Ù… Ø¬Ø¯Ø§Ù‹ Ù„Ø±ÙØ¹ Ø§Ù„Ù…Ù„ÙØ§Øª
        contentType: false, // Ù…Ù‡Ù… Ø¬Ø¯Ø§Ù‹ Ù„Ø±ÙØ¹ Ø§Ù„Ù…Ù„ÙØ§Øª
        dataType: 'json',
       
        success: function(response) {
            
            if (response.status === 'success') {
                
                // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ù…Ø¹ Ù…ÙŠØªØ§
                if (response.meta_sync && response.meta_sync.status === 'failed') {
                    // Ø­Ø§Ù„Ø© Ù†Ø¬Ø§Ø­ Ø¬Ø²Ø¦ÙŠ (Ø­ÙØ¸ Ù…Ø­Ù„ÙŠ + ÙØ´Ù„ Ù…ÙŠØªØ§)
                    btn.removeClass('btn-primary').addClass('btn-warning text-dark')
                       .html('<i class="fas fa-exclamation-triangle me-2"></i> Saved (Local Only)');
                    
                    showToast("Settings saved locally, but WhatsApp Sync failed: " + response.meta_sync.error, "warning");
                } else {
                    // Ù†Ø¬Ø§Ø­ ÙƒØ§Ù…Ù„
                    btn.removeClass('btn-primary').addClass('btn-success')
                       .html('<i class="fas fa-check-circle me-2"></i> Saved & Synced');
                    
                    showToast("Settings updated successfully!", "success");
                }

                // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø© Ù„Ù„ØªØ·Ø¨ÙŠÙ‚ ÙÙˆØ±Ø§Ù‹ (Live Update)
                if (response.config) {
                    window.collisionEnabled = response.config.enable_collision_detection;
                    console.log("System config updated:", response.config);
                }

            } else {
                // Ø®Ø·Ø£ Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ± (Ù…Ù†Ø·Ù‚ÙŠ)
                btn.removeClass('btn-primary').addClass('btn-danger')
                   .html('<i class="fas fa-times me-2"></i> Error');
                showToast(response.message || "Unknown error occurred", "error");
            }
        },
        error: function(xhr) {
            // Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø´Ø¨ÙƒØ© Ø£Ùˆ 500
            btn.removeClass('btn-primary').addClass('btn-danger')
               .html('<i class="fas fa-bomb me-2"></i> Server Error');
            showToast("Critical server error. Check console.", "error");
            console.error(xhr.responseText);
        },
        complete: function() {
            // 3. Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø²Ø± Ø¨Ø¹Ø¯ 3 Ø«ÙˆØ§Ù†ÙŠ
            setTimeout(() => {
                btn.prop('disabled', false)
                   .removeClass('btn-success btn-danger btn-warning text-dark')
                   .addClass('btn-primary')
                   .html(originalBtnContent);
                statusMsg.removeClass('show').text('');
            }, 3000);
        }
    });
}
// ==========================================
// 3. Delete Channel Logic (Secure Flow) ğŸ—‘ï¸
// ==========================================

function openDeleteModal() {
    // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø­Ø§Ù„Ø© Ø§Ù„Ù…ÙˆØ¯Ø§Ù„
    $('#step_request_otp').removeClass('d-none');
    $('#step_verify_otp').addClass('d-none');
    $('#otp_input').val('');
    $('#deleteOtpModal').modal('show');
}

function requestDeleteOtp() {
    const channelId =  currentChannelId;
    const btn = $('#step_request_otp button');
    
    btn.prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> Sending...');

    $.ajax({
        url: '/discount/whatssapAPI/api/trigger-delete-otp/', // Ø£Ù†Ø´Ø¦ Ù‡Ø°Ø§ Ø§Ù„Ø±Ø§Ø¨Ø·
        method: 'POST',
        data: {
            'channel_id': channelId,
            'csrfmiddlewaretoken': $('input[name="csrfmiddlewaretoken"]').val()
        },
        success: function(res) {
            // Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ù„Ù„Ø®Ø·ÙˆØ© Ø§Ù„Ø«Ø§Ù†ÙŠØ©
            $('#step_request_otp').addClass('d-none');
            $('#step_verify_otp').removeClass('d-none');
        },
        error: function(xhr) {
            alert("Error sending email: " + xhr.responseJSON.message);
            btn.prop('disabled', false).html('Try Again');
        }
    });
}

function confirmFinalDelete() {
    const channelId = currentChannelId;
    const code = $('#otp_input').val();
    const btn = $('#step_verify_otp button');

    if (code.length < 6) {
        alert("Please enter the 6-digit code.");
        return;
    }

    btn.prop('disabled', true).html('<i class="fas fa-skull-crossbones me-2"></i> Deleting...');

    $.ajax({
        url: '/discount/whatssapAPI/api/confirm-delete-channel/', // Ø£Ù†Ø´Ø¦ Ù‡Ø°Ø§ Ø§Ù„Ø±Ø§Ø¨Ø·
        method: 'POST',
        data: {
            'channel_id': channelId,
            'otp_code': code,
            'csrfmiddlewaretoken': $('input[name="csrfmiddlewaretoken"]').val()
        },
        success: function(res) {
            if (res.status === 'success') {
               
                $('#deleteOtpModal').modal('hide');
                showToast(res.message, success)
                setInterval(() => {
                    window.location.reload();
                } , 7000)
               


                // window.location.href = res.redirect_url; 
            }
        },
        error: function(xhr) {
            alert("Delete Failed: " + xhr.responseJSON.message);
            btn.prop('disabled', false).html('Confirm Permanent Deletion');
        }
    });
}

// Ø¯Ø§Ù„Ø© Ù…Ø³Ø§Ø¹Ø¯Ø© Ø¨Ø³ÙŠØ·Ø© Ù„Ø¹Ø±Ø¶ Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª (Ø§Ø³ØªØ®Ø¯Ù… Ù…ÙƒØªØ¨Ø© Toastr Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù„Ø¯ÙŠÙƒØŒ ÙˆØ¥Ù„Ø§ Ù‡Ø°Ø§ Ø¨Ø¯ÙŠÙ„ Ø¨Ø³ÙŠØ·)
function showToast(message, type) {
    // ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ù‡Ø°Ø§ Ø¨Ù€ alert Ø¨Ø³ÙŠØ·Ø© Ø£Ùˆ SweetAlert
    // alert(message); 
    
    // Ù…Ø«Ø§Ù„ Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… SweetAlert2 Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù…ØªÙˆÙØ±Ø© (Ø´ÙƒÙ„ Ø§Ø­ØªØ±Ø§ÙÙŠ)
    if (typeof Swal !== 'undefined') {
        Swal.fire({
            icon: type,
            title: type === 'success' ? 'Saved' : 'Notice',
            text: message,
            timer: 3000,
            showConfirmButton: false,
            background: '#1e293b',
            color: '#fff'
        });
    } else {
        console.log(`[${type.toUpperCase()}] ${message}`);
    }
}
</script>
{% load static %}
 
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/jerosoler/Drawflow@latest/dist/drawflow.min.css">

    <style>
        :root {
            --primary: #7C3AED;
            --primary-dark: #6D28D9;
            --secondary: #10B981;
            --danger: #EF4444;
            --warning: #F59E0B;
            --info: #3B82F6;
            --background: #0F172A;
            --surface: #1E293B;
            --surface-light: #334155;
            --surface-dark: #0F172A;
            --text-primary: #F8FAFC;
            --text-secondary: #CBD5E1;
            --text-muted: #64748B;
            --border: #334155;
            --radius: 12px;
            --shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.5);
            --sidebar-width: 320px;
            --header-height: 60px;
        }
        /* ØªÙ†Ø³ÙŠÙ‚ Ø£Ø¯ÙˆØ§Øª Ø§Ù„ØªØ­ÙƒÙ… */
/* 1. Ø¬Ø¹Ù„ Ø§Ù„Ø­Ø§ÙˆÙŠØ© Ù†Ø§ÙØ°Ø© Ø¹Ø±Ø¶ ÙÙ‚Ø· */
/*  */

.canvas-area:active {
    cursor: grabbing;
}

/* 2. Ø§Ù„Ø­Ù„ Ø§Ù„Ø¬Ø°Ø±ÙŠ: ÙƒØ§Ù†ÙØ§Ø³ Ø¹Ù…Ù„Ø§Ù‚ Ø¬Ø¯Ø§Ù‹ */
#flow-canvas {
    width: 5000px; /* Ø¹Ø±Ø¶ Ø¶Ø®Ù… */
    height: 5000px; /* Ø§Ø±ØªÙØ§Ø¹ Ø¶Ø®Ù… */
    position: absolute;
    top: 0;
    left: 0;
    transform-origin: 0 0; /* Ù†Ù‚Ø·Ø© Ø§Ù„Ø§Ø±ØªÙƒØ§Ø² ÙÙŠ Ø§Ù„Ø²Ø§ÙˆÙŠØ© */
    
    /* ØªØµÙ…ÙŠÙ… Ø§Ù„Ø´Ø¨ÙƒØ© (Grid) Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠ */
    background-image: 
        linear-gradient(rgba(255, 255, 255, 0.03) 1px, transparent 1px),
        linear-gradient(90deg, rgba(255, 255, 255, 0.03) 1px, transparent 1px);
    background-size: 40px 40px; /* Ø­Ø¬Ù… Ø§Ù„Ù…Ø±Ø¨Ø¹Ø§Øª */
    background-color: #09090b;
}

/* 3. ØªØµÙ…ÙŠÙ… Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªØ­ÙƒÙ… Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠ (Floating Dock) */
.canvas-controls {
    position: absolute;
    bottom: 25px;
    right: 25px; /* ØªÙ… Ø§Ù„Ù†Ù‚Ù„ Ù„Ù„ÙŠÙ…ÙŠÙ† */
    z-index: 100;
    
    display: flex;
    flex-direction: column; /* Ø¹Ù…ÙˆØ¯ÙŠ */
    gap: 6px;
    
    background: #ffffff;
    padding: 6px;
    border-radius: 12px;
    box-shadow: 0 10px 30px -5px rgba(0, 0, 0, 0.3);
    border: 1px solid rgba(0,0,0,0.1);
}

.control-btn {
    width: 36px;
    height: 36px;
    border: none;
    background: transparent;
    color: #18181b;
    border-radius: 8px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1rem;
    transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
}

.control-btn:hover {
    background: #f4f4f5;
    color: #22c55e; /* Ø£Ø®Ø¶Ø± Ø¹Ù†Ø¯ Ø§Ù„ØªØ­ÙˆÙŠÙ… */
    transform: scale(1.05);
}

.control-btn:active {
    transform: scale(0.95);
}

/* Ø®Ø· ÙØ§ØµÙ„ Ø£Ù†ÙŠÙ‚ */
.control-separator {
    height: 1px;
    background: #e4e4e7;
    margin: 2px 4px;
}

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Tajawal', sans-serif;
            /* background: var(--background); */
            color: var(--text-primary);
            line-height: 1.6;
            direction: ltr;
        }

        .none {
            display: none !important;
        }

        /* Container for automations list */
        .containerNew_auto {
            max-width: 100%;
            margin: 0 auto;
            padding: 2rem;
        }

        .containerNew_auto .header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 2rem;
            background-color: transparent;
            height: auto;
            padding: 0;
        }

        .containerNew_auto .title-section h1 {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }

        .containerNew_auto .title-section p {
            color: var(--text-secondary);
            font-size: 1rem;
        }

        /* Buttons */
        .btn {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 8px;
            font-family: inherit;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            text-decoration: none;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            transform: translateY(-1px);
            box-shadow: 0 5px 15px rgba(124, 58, 237, 0.4);
        }

        .btn-secondary {
            background: var(--surface-light);
            color: var(--text-primary);
            border: 1px solid var(--border);
        }

        .btn-secondary:hover:not(:disabled) {
            background: var(--surface);
            border-color: var(--primary);
        }

        .btn-danger {
            background: var(--danger);
            color: white;
        }

        .btn-sm {
            padding: 0.5rem 0.875rem;
            font-size: 0.75rem;
        }

        .btn-icon {
            padding: 0.5rem;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Search */
        .search-box {
            margin-bottom: 2rem;
        }

        .search-input {
            width: 100%;
            padding: 0.75rem 1rem;
            background: var(--surface);
            /* border: 1px solid var(--border); */
            border-radius: 8px;
            color: var(--text-primary);
            font-family: inherit;
            font-size: 0.875rem;
            border: 1px solid #202020 !important;
        }

        .search-input:focus {
            box-shadow: none;
            outline: none;
            border-color: var(--primary);
        }

        /* Table */
        .automations-table {
     
    border-radius: 12px;
    border: 1px solid #202020;
    overflow: hidden;
    
}

        .table-header {
          
    display: grid;
    grid-template-columns: 2fr 1fr 1fr 2fr 1fr;
    gap: 1rem;
    padding: 1rem 1.5rem;
    
    border-bottom: 1px solid #202020;
    font-weight: 600;
    color: var(--text-secondary);
}

        .table-row {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr 2fr 1fr;
            gap: 1rem;
            padding: 1rem 1.5rem;
            border-bottom: 1px solid var(--border);
            align-items: center;
        }

        .table-row:last-child {
            border-bottom: none;
        }

        .table-row:hover {
            background: var(--surface-light);
        }

        /* Status Badges */
        .status-active {
            background: var(--secondary);
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .status-inactive {
            background: var(--text-muted);
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        /* Actions */
        .actions {
            display: flex;
            gap: 0.5rem;
        }

        .menu-button {
            position: relative;
        }

        .menu-dropdown {
            position: absolute;
            top: 100%;
            right: 0;
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 0.5rem;
            min-width: 120px;
            box-shadow: var(--shadow);
            z-index: 100;
            display: none;
        }

        .menu-dropdown.show {
            display: block;
        }

        .menu-item {
            display: block;
            width: 100%;
            padding: 0.5rem;
            background: none;
            border: none;
            color: var(--text-primary);
            text-align: right;
            cursor: pointer;
            border-radius: 4px;
            font-family: inherit;
        }

        .menu-item:hover {
            background: var(--surface-light);
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 3rem;
            color: var(--text-secondary);
        }

        .empty-state .icon {
            font-size: 4rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }

        /* Utility Classes */
        .text-center {
            text-align: center;
        }

        .text-muted {
            color: var(--text-muted);
        }

        /* Flow Builder Styles */
        .app-container {
            display: none;
            flex-direction: row;
            height: 100%;
        }

        .flow-builder-active {
            display: flex !important;
        }

        /* Sidebar */
        .sidebar {
            width: var(--sidebar-width);
            background: var(--surface-dark);
            border-left: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            height: 100%;
            overflow: auto;
        }

        .sidebar-section {
            padding: 1.5rem;
            border-bottom: 1px solid var(--border);
        }

        .section-title {
            font-size: 0.875rem;
            font-weight: 700;
            color: var(--text-secondary);
            margin-bottom: 1rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .section-title .icon {
            font-size: 1rem;
        }

        /* Components Grid */
        .components-grid {
            display: grid;
            gap: 0.75rem;
        }

        .component-item {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 1rem;
            cursor: grab;
            transition: all 0.2s ease;
            text-align: right;
            user-select: none;
        }

        .component-item:hover {
            border-color: var(--primary);
            transform: translateY(-2px);
        }

        .component-header {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
        }

        .component-icon {
            width: 24px;
            height: 24px;
            background: var(--primary);
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
        }

        .component-title {
            font-weight: 600;
            font-size: 0.875rem;
        }

        .component-desc {
            font-size: 0.75rem;
            color: var(--text-muted);
            line-height: 1.4;
        }

        /* Main Content */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: var(--background);
        }

        /* Header */
        .header {
            height: var(--header-height);
            background: var(--surface);
            /* border-bottom: 1px solid var(--border); */
            padding: 0 1.5rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .header-title {
            font-size: 1.25rem;
            font-weight: 700;
        }

        .header-actions {
            display: flex;
            gap: 0.75rem;
            align-items: center;
        }

        /* Canvas Area */
.canvas-area {
    position: relative; /* Ø¶Ø±ÙˆØ±ÙŠ Ù„ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆØ§Ù‚Ø¹ Ø¨Ø¯Ø§Ø®Ù„Ù‡ */
    width: 100%;        /* ÙŠØ£Ø®Ø° Ø¹Ø±Ø¶ Ø§Ù„Ø´Ø§Ø´Ø© Ø§Ù„Ù…ØªØ§Ø­ ÙÙ‚Ø· */
    height: 100%;       /* ÙŠØ£Ø®Ø° Ø§Ø±ØªÙØ§Ø¹ Ø§Ù„Ø´Ø§Ø´Ø© Ø§Ù„Ù…ØªØ§Ø­ ÙÙ‚Ø· */
    overflow: hidden;   /* <--- Ù‡Ø°Ø§ Ù‡Ùˆ Ø§Ù„Ø­Ù„! ÙŠØ®ÙÙŠ Ø£ÙŠ Ø´ÙŠØ¡ Ø²Ø§Ø¦Ø¯ Ø¹Ù† Ø­Ø¬Ù… Ø§Ù„Ø´Ø§Ø´Ø© */
    background-color: #0F172A;
    cursor: grab;
}


   .canvas-area:active {
    cursor: grabbing;
}

/* 2. Ø§Ù„ÙƒØ§Ù†ÙØ§Ø³ Ø§Ù„Ø¹Ù…Ù„Ø§Ù‚ (Ø§Ù„Ø®Ø±ÙŠØ·Ø©): ÙŠØªØ­Ø±Ùƒ Ø¯Ø§Ø®Ù„ Ø§Ù„Ø¥Ø·Ø§Ø± Ø£Ø¹Ù„Ø§Ù‡ */
#flow-canvas {
    width: 5000px;
    height: 5000px;
    position: absolute;
    top: 0;
    left: 0;
    /* Ø§Ù„Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª Ø§Ù„ØªÙŠ ÙˆØ¶Ø¹Ù†Ø§Ù‡Ø§ ÙÙŠ JS Ø³ØªØ¶Ø¹Ù‡ ÙÙŠ Ø§Ù„Ù…Ù†ØªØµÙ */
    transform-origin: 0 0; 
    background-image: 
        linear-gradient(rgba(255, 255, 255, 0.03) 1px, transparent 1px),
        linear-gradient(90deg, rgba(255, 255, 255, 0.03) 1px, transparent 1px);
    background-size: 20px 20px;
}

        /* Flow Node Styles */
        .flow-node {
            position: absolute;
            width: 400px;
            background: var(--surface);
            border: 2px solid var(--border);
            border-radius: 12px;
            box-shadow: var(--shadow);
            transition: all 0.3s ease;
            cursor: move;
            z-index: 100;
        }

        .flow-node:hover {
            border-color: var(--primary);
            transform: translateY(-2px);
        }

        .flow-node.selected {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(124, 58, 237, 0.2);
        }

        .flow-node[data-node-type="google-sheets"] .node-header {
            background: linear-gradient(135deg, #0F9D58, #0B8043);
        }
        .flow-node[data-node-type="google-sheets"].selected {
            border-color: #0F9D58;
            box-shadow: 0 0 0 3px rgba(15, 157, 88, 0.25);
        }
        .flow-node[data-node-type="google-sheets"] .node-icon { background: rgba(255,255,255,0.25); }

        .node-header {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            padding: 1rem;
            border-radius: 10px 10px 0 0;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            color: white;
        }

        .node-icon {
            width: 32px;
            height: 32px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
        }

        .node-title {
            flex: 1;
            font-weight: 700;
            font-size: 0.875rem;
        }

        .node-type {
            font-size: 0.75rem;
            opacity: 0.9;
            background: rgba(255, 255, 255, 0.2);
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
        }

        .node-body {
            padding: 1rem;
        }

        .node-content {
            font-size: 0.875rem;
            color: var(--text-secondary);
            margin-bottom: 1rem;
        }

        .node-properties {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .node-property {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.75rem;
            padding: 0.5rem;
            background: var(--surface-light);
            border-radius: 6px;
        }

        .node-footer {
            padding: 1rem;
            border-top: 1px solid var(--border);
            display: flex;
            gap: 0.5rem;
            background: rgba(255, 255, 255, 0.02);
        }

        /* Overview Stats */
        .overview-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.75rem;
            margin-bottom: 1rem;
        }

        .stat-item {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 0.75rem;
            text-align: center;
        }

        .stat-value {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 0.25rem;
        }

        .stat-label {
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        /* Form Elements */
        .form-group {
            margin-bottom: 1rem;
        }

        .form-label {
            display: block;
            font-size: 0.875rem;
            font-weight: 500;
            margin-bottom: 0.5rem;
            color: var(--text-primary);
        }

        .form-input, .form-select, .form-textarea {
            width: 100%;
            padding: 0.75rem;
            background: var(--surface-light);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-primary);
            font-family: inherit;
            font-size: 0.875rem;
            transition: all 0.2s ease;
        }

        /* AI Agent node: product summary & required fields */
        .ai-agent-node-body .form-label.required::after { content: ' *'; color: #ef4444; }
        .ai-agent-product-summary {
            background: var(--surface-light);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 0.75rem 1rem;
            margin-top: 0.75rem;
        }
        .ai-agent-product-summary .summary-title {
            font-size: 0.7rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-muted);
            margin-bottom: 0.5rem;
            padding-bottom: 0.35rem;
            border-bottom: 1px solid var(--border);
        }
        .ai-agent-product-summary .summary-row {
            margin-top: 0.4rem;
            word-break: break-word;
            font-size: 0.8125rem;
            line-height: 1.4;
        }
        .ai-agent-product-summary .summary-row strong { color: var(--text-secondary); font-weight: 600; }
        .ai-agent-tab-btn {
    padding: 5px 13px;
    font-size: 0.8rem;
    font-weight: 700;
    border-radius: 4px;
    border: 1px solid #ddd;
    background: #f5f5f5;
    cursor: pointer;
    color: #1e293c;
}
        .ai-agent-tab-btn.active { background: #4d71ab; color: #fff; border-color: #4d71ab; }
        .form-input:focus, .form-select:focus, .form-textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(124, 58, 237, 0.2);
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-track {
            background: var(--surface-light);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--text-muted);
        }

        /* Connection Styles */
        .jtk-connector {
            cursor: pointer;
            z-index: 10;
        }

        .jtk-endpoint {
            cursor: pointer;
            z-index: 11;
        }

        .jtk-overlay {
            cursor: pointer;
            z-index: 12;
        }

        /* ØªØ£Ø«ÙŠØ±Ø§Øª Ù„Ù„Ø¹Ù‚Ø¯Ø© ÙÙŠ ÙˆØ¶Ø¹ Ø§Ù„Ø±Ø¨Ø· */
        .flow-node.connection-source {
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(16, 185, 129, 0); }
            100% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0); }
        }

        /* ØªØ­Ø³ÙŠÙ† Ù…Ø¸Ù‡Ø± Ø§Ù„Ø£Ø²Ø±Ø§Ø± */
        .btn-group {
            display: flex;
            gap: 0.75rem;
        }

        .w-full {
            width: 100%;
        }

        /* Ø£Ù†Ù…Ø§Ø· Ø¹Ù†Ø§ØµØ± Ø§Ù„ØªØ­ÙƒÙ… ÙÙŠ Ø§Ù„ØªÙƒØ¨ÙŠØ± */
        .zoom-controls {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 0.5rem;
        }

        .zoom-buttons {
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }

        .zoom-level {
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--text-primary);
            min-width: 45px;
            text-align: center;
        }

        /* Ø£Ù†Ù…Ø§Ø· Ø§Ù„Ù€ Trigger Ø§Ù„Ù…ØªÙ‚Ø¯Ù… */
        .trigger-node {
            width: 320px;
        }

        .trigger-conditions {
            max-height: 200px;
            overflow-y: auto;
            margin-bottom: 1rem;
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 0.75rem;
        }

        .condition-item {
            background: var(--surface-light);
            border-radius: 6px;
            padding: 0.75rem;
            margin-bottom: 0.5rem;
            border-left: 3px solid var(--primary);
        }

        .condition-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
            font-size: 0.875rem;
            font-weight: 600;
        }

        .trigger-actions {
            border-top: 1px solid var(--border);
            padding-top: 1rem;
        }

        .action-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem;
            background: var(--surface-light);
            border-radius: 6px;
        }

        /* Ø£Ù†Ù…Ø§Ø· Ø§Ù„Ù€ Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
        }

        .modal-content {
            background: var(--surface);
            border-radius: 12px;
            width: 90%;
            max-width: 500px;
            max-height: 100vh;
            overflow: auto;
        }

        .modal-header {
            padding: 1.5rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-body {
            padding: 1.5rem;
        }

        .modal-footer {
            padding: 1.5rem;
            border-top: 1px solid var(--border);
            display: flex;
            gap: 0.75rem;
            justify-content: flex-end;
        }

        /* Ø£Ù†Ù…Ø§Ø· Ø§Ù„ÙˆØ³ÙˆÙ… */
        .tags-list {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .tag-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem;
            background: var(--surface-light);
            border: 1px solid var(--border);
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .tag-item:hover {
            border-color: var(--primary);
        }

        .tag-item.selected {
            background: var(--primary);
            color: white;
        }

        .tag-color {
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }

        .tag-name {
            font-size: 0.875rem;
        }

        .tag-badge {
            display: inline-flex;
            align-items: center;
            padding: 0.25rem 0.5rem;
            background: var(--primary);
            color: white;
            border-radius: 4px;
            font-size: 0.75rem;
            margin: 0.125rem;
        }

        .tag-selector {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }

        .add-tag-section {
            border-top: 1px solid var(--border);
            padding-top: 1rem;
            margin-top: 1rem;
        }

        .add-tag-section .form-group {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }

        .add-tag-section input[type="text"] {
            flex: 1;
        }

        .add-tag-section input[type="color"] {
            width: 40px;
            height: 40px;
            padding: 0;
            border: none;
            background: transparent;
        }

        .mt-1 {
            margin-top: 0.25rem;
        }
    </style>
 
    <!-- Automations List -->
    <div class="containerNew_auto" id="automations-container">
        <!-- Header -->
        <div class="header">
            <div class="title-section">
                <h1>My Automations</h1>
                <p>Respond automatically to messages based on your own criteria</p>
            </div>
            <button class="btn btn-primary" id="new-automation-btn">
                <span>+</span>
                New Automation
            </button>
        </div>

        <!-- Search -->
        <div class="search-box">
            <input type="text" class="search-input" placeholder="Search by name or trigger text" id="search-input">
        </div>

        <!-- Automations Table -->
        <div class="automations-table">
            <div class="table-header">
                <div>Name</div>
                <div class="text-center">Runs</div>
                <div class="text-center">Status</div>
                <div>Last Updated</div>
                <div class="text-center">Actions</div>
            </div>
            <div id="automations-list" style="overflow: auto; max-height: 60vh;">
                <!-- Ø³ÙŠØªÙ… Ù…Ù„Ø¤Ù‡Ø§ Ø¨Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª -->
            </div>
        </div>
    </div>

    <!-- Flow Builder -->
    <div class="app-container none" id="flow-builder-container">
            <div id="flow-unsaved-modal" class="flow-unsaved-modal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.6); z-index:10000; align-items:center; justify-content:center;">
                <div class="flow-unsaved-modal-content" style="background:var(--surface, #1e293b); border-radius:12px; padding:24px; max-width:380px; box-shadow:0 25px 50px -12px rgba(0,0,0,0.5);">
                    <p class="flow-unsaved-modal-message" style="margin:0 0 20px; color:var(--text-primary, #f1f5f9); font-size:1rem;">You need to save your progress before leaving.</p>
                    <div id="flow-unsaved-modal-spinner" style="display:none; margin-bottom:16px; text-align:center;">
                        <span style="display:inline-block; width:28px; height:28px; border:3px solid rgba(255,255,255,0.2); border-top-color:#fff; border-radius:50%; animation: flow-unsaved-spin 0.8s linear infinite;"></span>
                    </div>
                    <div id="flow-unsaved-modal-buttons" style="display:flex; gap:12px; justify-content:flex-end;">
                        <button type="button" id="flow_unsaved_cancel" class="btn btn-secondary">Cancel</button>
                        <button type="button" id="flow_unsaved_save" class="btn btn-primary">Save now</button>
                    </div>
                </div>
            </div>
            <style>@keyframes flow-unsaved-spin { to { transform: rotate(360deg); } }</style>
        <!-- Main Content -->
        <main class="main-content">
            <!-- Header -->
            <header class="header"> 
                <div class="header-title">
                <button class="btn btn-primary" id="back_to_auto">
                <span> </span>
                Back
            </button>
            <script>
            (function() {
                function goBackToAutomations() {
                    document.getElementById('flow-builder-container').classList.add('none');
                    document.getElementById('flow-builder-container').classList.remove('flow-builder-active');
                    document.getElementById('automations-container').classList.remove('none');
                }
                var modal = document.getElementById('flow-unsaved-modal');
                var btnCancel = document.getElementById('flow_unsaved_cancel');
                var btnSave = document.getElementById('flow_unsaved_save');
                var spinner = document.getElementById('flow-unsaved-modal-spinner');
                var buttonsWrap = document.getElementById('flow-unsaved-modal-buttons');
                function showUnsavedModal() {
                    if (modal) { modal.style.display = 'flex'; if (spinner) spinner.style.display = 'none'; if (buttonsWrap) buttonsWrap.style.display = 'flex'; }
                }
                function hideUnsavedModal() {
                    if (modal) modal.style.display = 'none';
                }
                document.getElementById('back_to_auto').addEventListener('click', function() {
                    var fb = window.flowBuilder;
                    if (fb && fb.hasUnsavedChanges) { showUnsavedModal(); } else { goBackToAutomations(); }
                });
                if (btnCancel) btnCancel.addEventListener('click', hideUnsavedModal);
                if (btnSave) btnSave.addEventListener('click', function() {
                    var fb = window.flowBuilder;
                    if (!fb) { hideUnsavedModal(); goBackToAutomations(); return; }
                    if (spinner) spinner.style.display = 'block';
                    if (buttonsWrap) buttonsWrap.style.display = 'none';
                    fb.saveFlow().then(function(ok) {
                        if (spinner) spinner.style.display = 'none';
                        if (buttonsWrap) buttonsWrap.style.display = 'flex';
                        if (ok) { hideUnsavedModal(); goBackToAutomations(); }
                    }).catch(function() {
                        if (spinner) spinner.style.display = 'none';
                        if (buttonsWrap) buttonsWrap.style.display = 'flex';
                    });
                });
            })();
            </script>
        </div>
                <div class="header-actions">
                    <select class="form-select" id="flow-select" style="width: 200px;">
                        <option value="">-- Select Flow --</option>
                    </select>
                    <button class="btn btn-secondary" id="load-flow-btn">Load</button>
                    <button class="btn btn-primary" id="save-flow-btn">Save</button>
                    <button class="btn btn-secondary" id="layout-btn">Auto Layout</button>
                    <button class="btn btn-danger" id="clear-btn">Clear All</button>
                </div>
            </header>

            <!-- Canvas Area -->
            <div class="canvas-area">


  <div class="canvas-controls">
    <button class="control-btn" id="btn-zoom-in" title="Zoom In"><i class="fas fa-plus"></i></button>
    <button class="control-btn" id="btn-zoom-reset" title="Reset"><i class="fas fa-expand"></i></button>
    <button class="control-btn" id="btn-zoom-out" title="Zoom Out"><i class="fas fa-minus"></i></button>
    
    <div class="control-separator"></div> <button class="control-btn" id="btn-fullscreen" title="Full Screen"><i class="fas fa-compress"></i></button>
</div>
 
                <div id="flow-canvas">
             

  
 
                    <div class="empty-state">
                        <div class="icon">ğŸ¨</div>
                        <h3>Welcome to Flow Builder</h3>
                        <p>Drag components from the sidebar to start building your workflow</p>
                        <div class="btn-group">
                            <button class="btn btn-primary" id="sample-flow-btn">
                                Create Sample Flow
                            </button>
                            <button class="btn btn-secondary" id="load-existing-btn">
                                Load Existing Flow
                            </button>
                        </div>
                    </div>
                </div>
            </div>

        </main>

        <!-- Sidebar -->
        <aside class="sidebar">
            <!-- Overview Section -->
            <div class="sidebar-section">
                <h3 class="section-title">
                    <span class="icon">ğŸ“Š</span>
                    Overview
                </h3>
                <div class="overview-stats">
                    <div class="stat-item">
                        <div class="stat-value" id="node-count">0</div>
                        <div class="stat-label">Nodes</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="connection-count">0</div>
                        <div class="stat-label">Connections</div>
                    </div>
                </div>
                <button class="btn btn-primary w-full" id="add-variable-btn">
                    <span>+</span>
                    Add Variable
                </button>
            </div>

            <!-- Messages Section -->
            <div class="sidebar-section">
                <h3 class="section-title">
                    <span class="icon">ğŸ’¬</span>
                    Messages
                </h3>
                <div class="components-grid">
                    <div class="component-item" data-type="text-message" draggable="true">
                        <div class="component-header">
                            <div class="component-icon">ğŸ“</div>
                            <div class="component-title">Text Message</div>
                        </div>
                        <div class="component-desc">Send a simple text message</div>
                    </div>
                    <div class="component-item" data-type="media-message" draggable="true">
                        <div class="component-header">
                            <div class="component-icon">ğŸ–¼ï¸</div>
                            <div class="component-title">Media</div>
                        </div>
                        <div class="component-desc">Image, Video, Audio, File</div>
                    </div>
                    <div class="component-item" data-type="buttons-message" draggable="true">
                        <div class="component-header">
                            <div class="component-icon">ğŸ”˜</div>
                            <div class="component-title">Interactive Buttons</div>
                        </div>
                        <div class="component-desc">Button choices</div>
                    </div>
                    <div class="component-item" data-type="list-message" draggable="true">
                        <div class="component-header">
                            <div class="component-icon">ğŸ“‹</div>
                            <div class="component-title">Interactive List</div>
                        </div>
                        <div class="component-desc">Dropdown list for selections</div>
                    </div>
                </div>
            </div>

            <!-- Actions Section -->
            <div class="sidebar-section">
                <h3 class="section-title">
                    <span class="icon">âš¡</span>
                    Actions
                </h3>
                <div class="components-grid">
                    <div class="component-item" data-type="condition" draggable="true">
                        <div class="component-header">
                            <div class="component-icon">ğŸ”€</div>
                            <div class="component-title">Condition</div>
                        </div>
                        <div class="component-desc">Branch based on a condition</div>
                    </div>
                    <div class="component-item" data-type="trigger" draggable="true">
                        <div class="component-header">
                            <div class="component-icon">ğŸ””</div>
                            <div class="component-title">Flow Trigger</div>
                        </div>
                        <div class="component-desc">Start flow when conditions are met</div>
                    </div>
                    <div class="component-item" data-type="delay" draggable="true">
                        <div class="component-header">
                            <div class="component-icon">â±ï¸</div>
                            <div class="component-title">Delay</div>
                        </div>
                        <div class="component-desc">Delay before the next action</div>
                    </div>
                    <div class="component-item" data-type="ai-agent" draggable="true">
                        <div class="component-header">
                            <div class="component-icon">ğŸ¤–</div>
                            <div class="component-title">AI Sales Agent</div>
                        </div>
                        <div class="component-desc">Product context + GPT reply (text/voice)</div>
                    </div>
                    <div class="component-item" data-type="follow-up" draggable="true">
                        <div class="component-header">
                            <div class="component-icon">ğŸ“…</div>
                            <div class="component-title">AI Follow-up</div>
                        </div>
                        <div class="component-desc">Re-engage after delay (text/audio/image/video)</div>
                    </div>
                    <div class="component-item" data-type="google-sheets" draggable="true">
                        <div class="component-header">
                            <div class="component-icon">ğŸ“Š</div>
                            <div class="component-title">Google Sheets</div>
                        </div>
                        <div class="component-desc">Export order data to a sheet (Name, Phone, Addressâ€¦)</div>
                    </div>
                    <div class="component-item" data-type="webhook" draggable="true">
                        <div class="component-header">
                            <div class="component-icon">ğŸŒ</div>
                            <div class="component-title">Webhook</div>
                        </div>
                        <div class="component-desc">Call external API</div>
                    </div>
                </div>
            </div>

            <!-- Contact Management -->
            <div class="sidebar-section">
                <h3 class="section-title">
                    <span class="icon">ğŸ‘¥</span>
                    Contact Management
                </h3>
                <div class="components-grid">
                    <div class="component-item" data-type="add-contact" draggable="true">
                        <div class="component-header">
                            <div class="component-icon">â•</div>
                            <div class="component-title">Add Contact</div>
                        </div>
                        <div class="component-desc">Add a contact to the group</div>
                    </div>
                    <div class="component-item" data-type="update-contact" draggable="true">
                        <div class="component-header">
                            <div class="component-icon">âœï¸</div>
                            <div class="component-title">Update Contact</div>
                        </div>
                        <div class="component-desc">Update contact information</div>
                    </div>
                </div>
            </div>

            <!-- Tags Section -->
            <div class="sidebar-section">
                <h3 class="section-title">
                    <span class="icon">ğŸ·ï¸</span>
                    Tags
                </h3>
                <div class="components-grid">
                    <div class="component-item" data-type="add-tags" draggable="true">
                        <div class="component-header">
                            <div class="component-icon">â•</div>
                            <div class="component-title">Add Tags</div>
                        </div>
                        <div class="component-desc">Add tags to contacts</div>
                    </div>
                    <div class="component-item" data-type="remove-tags" draggable="true">
                        <div class="component-header">
                            <div class="component-icon">â–</div>
                            <div class="component-title">Remove Tags</div>
                        </div>
                        <div class="component-desc">Remove tags from contacts</div>
                    </div>
                </div>
            </div>
        </aside>
    </div>
 <script src="https://cdn.jsdelivr.net/gh/jerosoler/Drawflow@latest/dist/drawflow.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jsPlumb/2.15.6/js/jsplumb.min.js"></script>
  
  
  
  <script>
    // Ø¯Ø§Ù„Ø© Ø¹Ø§Ù„Ù…ÙŠØ© Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù‚ÙŠÙ…Ø© Ø§Ù„ÙƒÙˆÙƒÙŠ
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    /**
     * ÙƒÙ„Ø§Ø³ Ù„Ø¥Ø¯Ø§Ø±Ø© Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Øª
     */
    class AutomationsList {
        constructor() {
            this.apiBaseUrl = "/discount/whatssapAPI"; 
            this.flows = [];
            this.selectedFlowId = null;
            this.initializeEventListeners();
            this.loadAutomations();
        }

        initializeEventListeners() {
            document.getElementById('new-automation-btn').addEventListener('click', () => this.showCreateFlowForm());
            const searchInput = document.getElementById('search-input');
            searchInput.addEventListener('input', this.debounce((e) => this.searchAutomations(e.target.value), 300));
            document.addEventListener('click', (e) => {
                if (!e.target.closest('.menu-button')) this.closeAllMenus();
            });

 

        }

        debounce(func, delay) {
            let timeout;
            return (...args) => {
                clearTimeout(timeout);
                timeout = setTimeout(() => func(...args), delay);
            };
        }




  

      showCreateFlowForm() {
    document.getElementById('createFlowModal').style.display = 'flex';

    document.getElementById('cf-save').onclick = () => {
        const flowName = document.getElementById('cf-name').value.trim();
        const flowDescription = document.getElementById('cf-desc').value.trim();

        if (!flowName) {
            alert('Flow name is required');
            return;
        }

        this.createNewFlow(flowName, flowDescription);
        this.closeCreateFlowForm();
    };

    document.getElementById('cf-cancel').onclick = () => {
        this.closeCreateFlowForm();
    };
}

closeCreateFlowForm() {
    document.getElementById('createFlowModal').style.display = 'none';
    document.getElementById('cf-name').value = '';
    document.getElementById('cf-desc').value = '';
}


        async createNewFlow(name, description = '') {
            try {
                const newFlow = {
                    name,
                    description,
                    config: { nodes: [], connections: [] },
                    active: false,
                    count: 0 ,
                    channel_id :  window.currentChannelId
                };
                const response = await this.apiPost(`${this.apiBaseUrl}/api/flows/create/`, newFlow);
                if (response.success && response.item) {
                    this.showSuccess('Automation created successfully');
                    this.selectedFlowId = response.item.id;
                    this.showFlowBuilder();
                } else if (response.flow_id) {
                    this.selectedFlowId = response.flow_id;
                    this.showFlowBuilder();
                }
            } catch (error) {
                console.error('Error creating flow:', error);
                this.showError('Failed to create automation');
            }
        }

        async loadAutomations() {
            try {
                const response = await this.apiGet(`${this.apiBaseUrl}/api/flows?channel_id=${window.currentChannelId}`);
                this.flows = response.items || [];
                this.renderAutomations(this.flows);
            } catch (error) {
                console.error('Failed to load automations:', error);
                this.showError('Failed to load automations list');
            }
        }




        async refreshForChannel(channelId) {
        console.log("ğŸ”„ Reloading automations for channel:", channelId);
        
        // 1. ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ© ÙˆØ¹Ø±Ø¶ Ø±Ø³Ø§Ù„Ø© ØªØ­Ù…ÙŠÙ„
        const container = document.getElementById('automations-list');
        if (container) {
            container.innerHTML = '<div class="cls3741_loader_new"><div class="cls3741_spinner"></div></div>';
        }

        window.currentChannelId = channelId
        // Ù‡Ø°Ø§ Ø§Ù„Ø³Ø·Ø± Ø§Ø®ØªÙŠØ§Ø±ÙŠ Ù„Ø£Ù† loadAutomations ÙŠØ³ØªØ®Ø¯Ù… window.currentChannelId
        
        // 3. Ø¥Ø¹Ø§Ø¯Ø© Ø·Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        await this.loadAutomations();
    }



        renderAutomations(flows) {
            const container = document.getElementById('automations-list');
            if (!flows || flows.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="icon">ğŸ¤–</div>
                        <h3>No automations yet</h3>
                        <p>Create your first automation to get started</p>
                    </div>
                `;
                return;
            }
            container.innerHTML = flows.map(flow => `
                <div class="table-row" data-flow-id="${flow.id}">
                    <div class="flow-name">
                        <strong>${this.escapeHtml(flow.name)}</strong>
                        ${flow.description ? `<div class="flow-description">${this.escapeHtml(flow.description)}</div>` : ''}
                    </div>
                    <div class="text-center flow-runs">
                        ${flow.count || 0}
                    </div>
                    <div class="text-center flow-status">
                        <span class="${flow.active ? 'status-active' : 'status-inactive'}">
                            ${flow.active ? 'Active' : 'Inactive'}
                        </span>
                    </div>
                    <div class="flow-updated">
                        ${this.formatDate(flow.updated_at || flow.created_at)}
                    </div>
                    <div class="text-center actions">
                        <div class="menu-button">
                            <button class="btn btn-secondary btn-icon menu-toggle-btn" data-flow-id="${flow.id}">
                                â‹®
                            </button>
                            <div class="menu-dropdown" id="menu-${flow.id}">
                                <button class="menu-item" data-action="toggle" id="toggle-${flow.id}" data-flow-id="${flow.id}">
                                    ${flow.active ? 'â¸ï¸ Deactivate' : 'â–¶ï¸ Activate'}
                                </button>
                                <button class="menu-item" data-action="edit" data-flow-id="${flow.id}">
                                    âœï¸ Edit
                                </button>
                                <button class="menu-item" data-action="duplicate" data-flow-id="${flow.id}">
                                    â˜ Duplicate
                                </button>
                                <button class="menu-item" style="color: var(--danger);" data-action="delete" data-flow-id="${flow.id}">
                                    ğŸ—‘ï¸ Delete
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
            document.querySelectorAll('.menu-toggle-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const flowId = e.target.dataset.flowId;
                    this.toggleMenu(flowId);
                });
            });
            document.querySelectorAll('.menu-item').forEach(item => {
                item.addEventListener('click', (e) => {
                    const action = e.target.dataset.action;
                    const flowId = e.target.dataset.flowId;
                    if (action === 'toggle') this.toggleFlow(flowId);
                    else if (action === 'edit') this.editFlow(flowId);
                    else if (action === 'duplicate') this.duplicateFlow(flowId);
                    else if (action === 'delete') this.deleteFlow(flowId);
                });
            });
        }

      
        toggleMenu(flowId) {
            this.closeAllMenus();
            const menu = document.getElementById(`menu-${flowId}`);
            if (menu) menu.classList.toggle('show');
        }

        closeAllMenus() {
            document.querySelectorAll('.menu-dropdown').forEach(menu => menu.classList.remove('show'));
        }

        async toggleFlow(flowId) {
            try {
                const flow = flowId
                console.log('flow ' , flow)
                if (!flow) return;
                const updatedFlow = { ...flow, active: !flow.active };
                const response = await this.apiPost(`${this.apiBaseUrl}/api/flows/${flowId}/turnoff/`, updatedFlow);
                if (response.success && response.item) {
                    this.showSuccess(`Automation ${updatedFlow.active ? 'activated' : 'deactivated'} successfully`);
                    this.loadAutomations();
                }
            } catch (error) {
                console.error('Error toggling flow:', error);
                this.showError('Failed to change automation status');
            }
        }

        editFlow(flowId) {
            this.selectedFlowId = flowId;
            this.showFlowBuilder();
            if (window.flowBuilder) {
                window.flowBuilder.currentFlowId = flowId;
                window.flowBuilder.loadFlow(flowId);
            }
        }

        async duplicateFlow(flowId) {
            try {
                const flow = this.flows.find(f => f.id === flowId);
                if (!flow) return;
                const newFlow = {
                    name: `${flow.name} (Copy)`,
                    description: flow.description ? `${flow.description} (Copy)` : '',
                    config: flow.config,
                    active: false,
                    count: 0
                };
                const response = await this.apiPost(`${this.apiBaseUrl}/api/flows/create/`, newFlow);
                if (response.success && response.item) {
                    this.showSuccess('Automation duplicated successfully');
                    this.loadAutomations();
                }
            } catch (error) {
                console.error('Error duplicating flow:', error);
                this.showError('Failed to duplicate automation');
            }
        }

        async deleteFlow(flowId) {
            if (!confirm('Are you sure you want to delete this automation? This action cannot be undone.')) return;
            try {
                const response = await this.apiPost(`${this.apiBaseUrl}/api/flows/${flowId}/delete/`, {});
                if (response.ok || response.success) {
                    this.showSuccess('Automation deleted successfully');
                    this.loadAutomations();
                }
            } catch (error) {
                console.error('Error deleting flow:', error);
                this.showError('Failed to delete automation');
            }
        }

        searchAutomations(query) {
            const lowerQuery = query.toLowerCase();
            const filteredFlows = this.flows.filter(flow =>
                flow.name.toLowerCase().includes(lowerQuery) ||
                (flow.description && flow.description.toLowerCase().includes(lowerQuery))
            );
            this.renderAutomations(filteredFlows);
        }

        showFlowBuilder() {
            const automationsContainer = document.getElementById('automations-container');
            const flowBuilderContainer = document.getElementById('flow-builder-container');
            automationsContainer?.classList.add('none');
            flowBuilderContainer?.classList.remove('none');
            flowBuilderContainer?.classList.add('flow-builder-active');
            if (window.flowBuilder) {
                if (this.selectedFlowId) {
                    window.flowBuilder.loadFlow(this.selectedFlowId);
                } else {
                    window.flowBuilder.clearCanvas();
                }
            }
        }

        showAutomationsList() {
            this.selectedFlowId = null;
            const automationsContainer = document.getElementById('automations-container');
            const flowBuilderContainer = document.getElementById('flow-builder-container');
            automationsContainer?.classList.remove('none');
            flowBuilderContainer?.classList.add('none');
            flowBuilderContainer?.classList.remove('flow-builder-active');
        }

        async apiGet(url) {
            const response = await fetch(url, { headers: { 'Accept': 'application/json' } });
            if (!response.ok) throw new Error(`HTTP ${response.status}: ${await response.text()}`);
            return response.json();
        }

        async apiPost(url, data) {
            const response = await fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify(data)
            });
            if (!response.ok) throw new Error(`HTTP ${response.status}: ${await response.text()}`);
            return response.json();
        }

        async handleAiNodeMediaFile(file, nodeId, mediaListEl, saveHintEl) {
            const flowId = this.currentFlowId;
            if (!flowId) {
                if (saveHintEl) saveHintEl.style.display = 'block';
                return;
            }
            const isVideo = (file.type || '').toLowerCase().startsWith('video/');
            const fileType = isVideo ? 'Video' : 'Image';
            const desc = (file.name || 'Media').replace(/\.[^.]*$/, '');
            const form = new FormData();
            form.append('flow_id', flowId);
            form.append('node_id', nodeId);
            form.append('file', file);
            form.append('file_type', fileType);
            form.append('description', desc);
            form.append('csrfmiddlewaretoken', this.csrfToken || '');
            try {
                const r = await fetch(this.apiBaseUrl + '/api/flows/node-media-upload/', {
                    method: 'POST',
                    body: form,
                    headers: { 'X-CSRFToken': this.csrfToken || '' }
                });
                const j = await r.json();
                if (j.error) { alert(j.error); return; }
                const row = document.createElement('div');
                row.className = 'ai-agent-media-row';
                row.style.cssText = 'display:flex; align-items:center; gap:6px; margin-bottom:6px; font-size:0.8rem;';
                row.dataset.filePath = j.file_path || '';
                row.dataset.fileType = j.file_type || fileType;
                const labelInput = document.createElement('input');
                labelInput.type = 'text';
                labelInput.className = 'form-input ai-agent-media-description';
                labelInput.placeholder = 'Label for AI';
                labelInput.value = j.description || desc;
                labelInput.style.flex = '1';
                labelInput.style.minWidth = '0';
                const delBtn = document.createElement('button');
                delBtn.type = 'button';
                delBtn.className = 'btn btn-danger btn-sm';
                delBtn.textContent = 'âœ•';
                delBtn.addEventListener('click', () => row.remove());
                row.appendChild(labelInput);
                row.appendChild(delBtn);
                mediaListEl.appendChild(row);
                if (saveHintEl) saveHintEl.style.display = 'none';
            } catch (e) {
                alert('Upload failed: ' + (e.message || e));
            }
        }

        escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        formatDate(dateString) {
            if (!dateString) return 'Never';
            const date = new Date(dateString);
            const now = new Date();
            const diffTime = Math.abs(now - date);
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            if (diffDays === 1) return 'Yesterday';
            if (diffDays < 7) return `${diffDays} days ago`;
            return date.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
        }

        showSuccess(message) {
            this.showNotification(message, 'success');
        }

        showError(message) {
            this.showNotification(message, 'error');
        }

        showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed; top: 20px; right: 20px; padding: 12px 20px; border-radius: 8px;
                color: white; font-weight: 500; z-index: 10000; transition: all 0.3s ease;
                background: ${type === 'success' ? '#10B981' : type === 'error' ? '#EF4444' : '#3B82F6'};
                box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.5);
            `;
            notification.textContent = message;
            document.body.appendChild(notification);
            setTimeout(() => {
                notification.style.opacity = '0';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }
    }



    document.addEventListener('DOMContentLoaded', () => {
    // Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ÙƒØ§Ø¦Ù†
    const automationsList = new AutomationsList();
    
    // ğŸ”¥ Ø¬Ø¹Ù„ Ø§Ù„ÙƒØ§Ø¦Ù† Ø¹Ø§Ù…Ø§Ù‹ ğŸ”¥
    window.automationsListInstance = automationsList; 

    // ... Ø¨Ø§Ù‚ÙŠ ÙƒÙˆØ¯ Ø§Ù„ØªÙ‡ÙŠØ¦Ø© ...
});
 

 
 

class FlowBuilder {
    constructor() {
        this.apiBaseUrl = '/discount/whatssapAPI';
        this.csrfToken = getCookie('csrftoken');
        this.selectedNode = null;
        this.nodeCounter = 0;
        this.currentFlowId = null;
        this.currentFlowName = '';
        this.currentFlowDescription = '';
        this.jsPlumbInstance = null;
        this.connectionMode = false;
        this.connectionSource = null;
        this.connectionBranch = null;
        this.zoomLevel = 1.0;
        this.zoomStep = 0.02;
        this.minZoom = 0.3;
        this.maxZoom = 3.0;
        this.isLoadingFlow = false;
        this.hasUnsavedChanges = false;
        this.initializeElements();
        this.initializeEventListeners();
        this.initializeJsPlumb();
        this.setupDragAndDrop();
        this.initializeZoom();
        this.updateStats();
        this.initFileUploadListeners();


this.connectionBranch = null;
        
         
        this.zoomLevel = 1.0;
        // Ø§Ø¨Ø¯Ø£ Ù…Ù† Ù…Ù†ØªØµÙ Ø§Ù„ÙƒØ§Ù†ÙØ§Ø³ Ø§Ù„Ø¹Ù…Ù„Ø§Ù‚ (5000/2 = 2500 ØªÙ‚Ø±ÙŠØ¨Ø§Ù‹)
        this.pan = { x: -2000, y: -2000 }; 
        this.isPanning = false;
        // ----------------------------------

        this.isLoadingFlow = false;


    }

    // ==========================================
    // ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©
    // ==========================================
    initializeElements() {
        this.flowCanvas = document.getElementById('flow-canvas');
        this.saveFlowBtn = document.getElementById('save-flow-btn');
        this.clearBtn = document.getElementById('clear-btn');
        this.layoutBtn = document.getElementById('layout-btn');
        this.addVariableBtn = document.getElementById('add-variable-btn');
        this.sampleFlowBtn = document.getElementById('sample-flow-btn');
        // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø¹Ù†Ø§ØµØ± ØºÙŠØ± Ø§Ù„Ù…Ø±ØºÙˆØ¨Ø©
        const loadFlowBtn = document.getElementById('load-flow-btn');
        const flowSelect = document.getElementById('flow-select');
        const loadExistingBtn = document.getElementById('load-existing-btn');
        if (loadFlowBtn) loadFlowBtn.style.display = 'none';
        if (flowSelect) flowSelect.style.display = 'none';
        if (loadExistingBtn) loadExistingBtn.style.display = 'none';
        this.nodeCountEl = document.getElementById('node-count');
        this.connectionCountEl = document.getElementById('connection-count');
    }

    // ==========================================
    // ØªÙ‡ÙŠØ¦Ø© Event Listeners
    // ==========================================
    initializeEventListeners() {
        this.saveFlowBtn.addEventListener('click', () => this.saveFlow());
        this.clearBtn.addEventListener('click', () => this.clearCanvas());
        this.layoutBtn.addEventListener('click', () => this.autoLayout());
        this.addVariableBtn.addEventListener('click', () => this.addVariable());
        this.sampleFlowBtn.addEventListener('click', () => this.addSampleFlow());
    }

    // ==========================================
    // ØªÙ‡ÙŠØ¦Ø© jsPlumb
    // ==========================================
    initializeJsPlumb() {
        if (typeof jsPlumb === 'undefined') {
            console.error('jsPlumb not loaded, retrying...');
            setTimeout(() => this.initializeJsPlumb(), 100);
            return;
        }
        this.jsPlumbInstance = jsPlumb.getInstance({
            Connector: ["Flowchart", { cornerRadius: 5, stub: 5 }],
            PaintStyle: {
                stroke: "#7C3AED",
                strokeWidth: 2,
                outlineStroke: "transparent",
                outlineWidth: 10
            },
            EndpointStyle: {
                fill: "#7C3AED",
                radius: 5
            },
            HoverPaintStyle: {
                stroke: "#10B981",
                strokeWidth: 3
            },
            ConnectionOverlays: [
                ["Arrow", {
                    location: 1,
                    width: 12,
                    length: 12,
                    foldback: 0.8
                }]
            ],
            Container: "flow-canvas",
            DragOptions: { cursor: 'pointer', zIndex: 2000 },
            DropOptions: { hoverClass: 'drag-hover' }
        });
        this.setupJsPlumbEvents();
        console.log('âœ… jsPlumb initialized successfully');
    }

    // ==========================================
    // Ø¥Ø¹Ø¯Ø§Ø¯ Ø£Ø­Ø¯Ø§Ø« jsPlumb
    // ==========================================
    setupJsPlumbEvents() {
        this.jsPlumbInstance.bind("connection", (info) => {
            this.updateStats();
            this.hasUnsavedChanges = true;
            console.log('ğŸ”— Connection established:', info);
        });
        this.jsPlumbInstance.bind("connectionDetached", (info) => {
            this.updateStats();
            this.hasUnsavedChanges = true;
            console.log('ğŸ”— Connection detached:', info);
        });
        this.jsPlumbInstance.bind("click", (conn, originalEvent) => {
            if (confirm('Delete this connection?')) {
                this.jsPlumbInstance.deleteConnection(conn);
                this.showNotification('Connection deleted', 'success');
            }
        });
        this.jsPlumbInstance.bind("connectionMoved", (info) => {
            console.log('ğŸ”— Connection moved:', info);
        });
    }

    // ==========================================
    // Ø¥Ø¹Ø¯Ø§Ø¯ Drag & Drop
    // ==========================================
    setupDragAndDrop() {
        const components = document.querySelectorAll('.component-item');
      
        components.forEach(component => {
            component.addEventListener('dragstart', (e) => {
                e.dataTransfer.setData('component-type', component.dataset.type);
                e.dataTransfer.effectAllowed = 'copy';
            });
        });
        this.flowCanvas.addEventListener('dragover', (e) => {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'copy';
        });
        this.flowCanvas.addEventListener('drop', (e) => {
            e.preventDefault();
            const componentType = e.dataTransfer.getData('component-type');
            const rect = this.flowCanvas.getBoundingClientRect();
            const x = (e.clientX - rect.left) / this.zoomLevel - 140;
            const y = (e.clientY - rect.top) / this.zoomLevel - 50;
          
            this.createNode(componentType, x, y);
        });
    }

    // ==========================================
    // Ø¥Ù†Ø´Ø§Ø¡ Ø¹Ù‚Ø¯Ø© Ø¬Ø¯ÙŠØ¯Ø© (Drag & Drop)
    // ==========================================
    createNode(type, x, y) {
        this.nodeCounter++;
        const nodeId = `node-${this.nodeCounter}`;
      
        const node = document.createElement('div');
        node.className = 'flow-node';
        node.id = nodeId;
        node.dataset.nodeType = type;
        node.style.left = x + 'px';
        node.style.top = y + 'px';
      
        const emptyState = this.flowCanvas.querySelector('.empty-state');
        if (emptyState) {
            emptyState.remove();
        }
      
        node.innerHTML = this.getNodeTemplate(type)(nodeId);
      
        this.flowCanvas.appendChild(node);
        this.initializeNodeSafe(node);
        this.updateStats();
        this.hasUnsavedChanges = true;
      
        return nodeId;
    }

    // ==========================================
    // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù‚Ø§Ù„Ø¨ Ø§Ù„Ø¹Ù‚Ø¯Ø© Ø­Ø³Ø¨ Ø§Ù„Ù†ÙˆØ¹
    // ==========================================
    getNodeTemplate(type) {
        const templates = {
            'text-message': this.createTextMessageNodeTemplate,
            'media-message': this.createMediaMessageNodeTemplate,
            'buttons-message': this.createButtonsMessageNodeTemplate,
            'list-message': this.createListMessageNodeTemplate,
            'condition': this.createConditionNodeTemplate,
            'delay': this.createDelayNodeTemplate,
            'webhook': this.createWebhookNodeTemplate,
            'add-contact': this.createAddContactNodeTemplate,
            'update-contact': this.createUpdateContactNodeTemplate,
            'add-tags': this.createAddTagsNodeTemplate,
            'remove-tags': this.createRemoveTagsNodeTemplate,
            'trigger': this.createTriggerNodeTemplate,
            'ai-agent': this.createAiAgentNodeTemplate,
            'follow-up': this.createFollowUpNodeTemplate,
            'google-sheets': this.createGoogleSheetsNodeTemplate
        };
        return templates[type] || templates['text-message'];
    }

    // ==========================================
    // Ù‚ÙˆØ§Ù„Ø¨ Ø§Ù„Ø¹Ù‚Ø¯ (Templates)
    // ==========================================
    createTextMessageNodeTemplate(nodeId) {
        return `
            <div class="node-header">
                <div class="node-icon">ğŸ“</div>
                <div class="node-title">Text Message</div>
                <div class="node-type">text-message</div>
            </div>
            <div class="node-body">
                <div class="node-content">
                    <textarea class="message-content form-textarea" placeholder="Enter message text..." rows="3">Hello! How can I help you?</textarea>
                </div>
                <div class="node-properties">
                    <div class="node-property">
                        <span>Delay:</span>
                        <input type="number" value="0" min="0" class="delay-input form-input" style="width: 60px;"> seconds
                    </div>
                </div>
            </div>
            <div class="node-footer">
                <button class="btn btn-secondary btn-sm connect-btn" data-node-id="${nodeId}">Connect</button>
                <button class="btn btn-danger btn-sm delete-node-btn">Delete</button>
            </div>
        `;
    }

    createMediaMessageNodeTemplate(nodeId) {
        return `
            <div class="node-header">
                <div class="node-icon">ğŸ–¼ï¸</div>
                <div class="node-title">Media Message</div>
                <div class="node-type">media-message</div>
            </div>
            <div class="node-body">
                <div class="node-content">
                    <textarea class="caption-content form-textarea" placeholder="Caption (optional)..." rows="2"></textarea>
                </div>
                <div class="form-group">
                    <select class="media-type form-select">
                        <option value="image">Image</option>
                        <option value="video">Video</option>
                        <option value="audio">Audio</option>
                        <option value="file">File</option>
                    </select>
                </div>
                <div class="form-group set_media" id ="set_media">
                    <input type="file" class="media-file form-input" accept="image/*,video/*,audio/*,.pdf">
                </div>
                <div class="node-properties">
                    <div class="node-property">
                        <span>Delay:</span>
                        <input type="number" value="0" min="0" class="delay-input form-input" style="width: 60px;"> seconds
                    </div>
                </div>
            </div>
            <div class="node-footer">
                <button class="btn btn-secondary btn-sm connect-btn" data-node-id="${nodeId}">Connect</button>
                <button class="btn btn-danger btn-sm delete-node-btn">Delete</button>
            </div>
        `;
    }

    createButtonsMessageNodeTemplate(nodeId) {
        return `
            <div class="node-header">
                <div class="node-icon">ğŸ”˜</div>
                <div class="node-title">Interactive Buttons</div>
                <div class="node-type">buttons-message</div>
            </div>
            <div class="node-body">
                <textarea class="message-content form-textarea" placeholder="Message text..." rows="2"></textarea>
                <input type="text" class="buttons-list form-input" placeholder="Button labels (comma-separated, e.g., Yes,No)">
                <div class="node-properties">
                    <div class="node-property">
                        <span>Delay:</span>
                        <input type="number" value="0" min="0" class="delay-input form-input" style="width: 60px;"> seconds
                    </div>
                </div>
            </div>
            <div class="node-footer">
                <button class="btn btn-secondary btn-sm connect-btn" data-node-id="${nodeId}">Connect</button>
                <button class="btn btn-danger btn-sm delete-node-btn">Delete</button>
            </div>
        `;
    }

    createListMessageNodeTemplate(nodeId) {
        return `
            <div class="node-header">
                <div class="node-icon">ğŸ“‹</div>
                <div class="node-title">Interactive List</div>
                <div class="node-type">list-message</div>
            </div>
            <div class="node-body">
                <textarea class="message-content form-textarea" placeholder="List title..." rows="2"></textarea>
                <textarea class="list-items form-textarea" placeholder="List items (one per line)" rows="3"></textarea>
                <div class="node-properties">
                    <div class="node-property">
                        <span>Delay:</span>
                        <input type="number" value="0" min="0" class="delay-input form-input" style="width: 60px;"> seconds
                    </div>
                </div>
            </div>
            <div class="node-footer">
                <button class="btn btn-secondary btn-sm connect-btn" data-node-id="${nodeId}">Connect</button>
                <button class="btn btn-danger btn-sm delete-node-btn">Delete</button>
            </div>
        `;
    }

    createConditionNodeTemplate(nodeId) {
        return `
            <div class="node-header">
                <div class="node-icon">ğŸ”€</div>
                <div class="node-title">Condition</div>
                <div class="node-type">condition</div>
            </div>
            <div class="node-body">
                <div class="form-group">
                    <label class="form-label">Variable</label>
                    <input type="text" class="form-input condition-variable" placeholder="Variable name">
                </div>
                <div class="form-group">
                    <label class="form-label">Value</label>
                    <input type="text" class="form-input condition-value" placeholder="Value to compare">
                </div>
                <div class="form-group">
                    <label class="form-label">Comparison Type</label>
                    <select class="form-select condition-operator">
                        <option value="equals">Equals</option>
                        <option value="contains">Contains</option>
                        <option value="startsWith">Starts With</option>
                        <option value="endsWith">Ends With</option>
                        <option value="greaterThan">Greater Than</option>
                        <option value="lessThan">Less Than</option>
                    </select>
                </div>
            </div>
            <div class="node-footer">
                <button class="btn btn-secondary btn-sm connect-btn" data-node-id="${nodeId}" data-branch="true">True</button>
                <button class="btn btn-secondary btn-sm connect-btn" data-node-id="${nodeId}" data-branch="false">False</button>
                <button class="btn btn-danger btn-sm delete-node-btn">Delete</button>
            </div>
        `;
    }

    createDelayNodeTemplate(nodeId) {
        return `
            <div class="node-header">
                <div class="node-icon">â±ï¸</div>
                <div class="node-title">Delay</div>
                <div class="node-type">delay</div>
            </div>
            <div class="node-body">
                <div class="form-group">
                    <label class="form-label">Delay Duration</label>
                    <input type="number" class="form-input delay-duration" value="5" min="0" max="3600">
                    <div class="text-muted" style="font-size: 0.75rem; margin-top: 0.25rem;">Seconds</div>
                </div>
            </div>
            <div class="node-footer">
                <button class="btn btn-secondary btn-sm connect-btn" data-node-id="${nodeId}">Connect</button>
                <button class="btn btn-danger btn-sm delete-node-btn">Delete</button>
            </div>
        `;
    }

    createWebhookNodeTemplate(nodeId) {
        return `
            <div class="node-header">
                <div class="node-icon">ğŸŒ</div>
                <div class="node-title">Webhook</div>
                <div class="node-type">webhook</div>
            </div>
            <div class="node-body">
                <div class="form-group">
                    <label class="form-label">URL</label>
                    <input type="url" class="form-input webhook-url" placeholder="https://api.example.com/endpoint">
                </div>
                <div class="form-group">
                    <label class="form-label">Method</label>
                    <select class="form-select webhook-method">
                        <option value="GET">GET</option>
                        <option value="POST">POST</option>
                        <option value="PUT">PUT</option>
                        <option value="DELETE">DELETE</option>
                    </select>
                </div>
            </div>
            <div class="node-footer">
                <button class="btn btn-secondary btn-sm connect-btn" data-node-id="${nodeId}">Connect</button>
                <button class="btn btn-danger btn-sm delete-node-btn">Delete</button>
            </div>
        `;
    }

    createAddContactNodeTemplate(nodeId) {
        return `
            <div class="node-header">
                <div class="node-icon">ğŸ‘¤+</div>
                <div class="node-title">Add Contact</div>
                <div class="node-type">add-contact</div>
            </div>
            <div class="node-body">
                <input type="text" class="contact-name form-input" placeholder="Contact name">
                <input type="text" class="contact-phone form-input" placeholder="Phone number">
            </div>
            <div class="node-footer">
                <button class="btn btn-secondary btn-sm connect-btn" data-node-id="${nodeId}">Connect</button>
                <button class="btn btn-danger btn-sm delete-node-btn">Delete</button>
            </div>
        `;
    }

    createUpdateContactNodeTemplate(nodeId) {
        return `
            <div class="node-header">
                <div class="node-icon">ğŸ‘¤âœï¸</div>
                <div class="node-title">Update Contact</div>
                <div class="node-type">update-contact</div>
            </div>
            <div class="node-body">
                <input type="text" class="contact-id form-input" placeholder="Contact ID or variable">
                <input type="text" class="update-fields form-input" placeholder="Fields to update (JSON)">
            </div>
            <div class="node-footer">
                <button class="btn btn-secondary btn-sm connect-btn" data-node-id="${nodeId}">Connect</button>
                <button class="btn btn-danger btn-sm delete-node-btn">Delete</button>
            </div>
        `;
    }

    createAddTagsNodeTemplate(nodeId) {
        return `
            <div class="node-header">
                <div class="node-icon">ğŸ·ï¸+</div>
                <div class="node-title">Add Tags</div>
                <div class="node-type">add-tags</div>
            </div>
            <div class="node-body">
                <input type="text" class="tags-list form-input" placeholder="Tags (comma-separated)">
            </div>
            <div class="node-footer">
                <button class="btn btn-secondary btn-sm connect-btn" data-node-id="${nodeId}">Connect</button>
                <button class="btn btn-danger btn-sm delete-node-btn">Delete</button>
            </div>
        `;
    }

    createRemoveTagsNodeTemplate(nodeId) {
        return `
            <div class="node-header">
                <div class="node-icon">ğŸ·ï¸-</div>
                <div class="node-title">Remove Tags</div>
                <div class="node-type">remove-tags</div>
            </div>
            <div class="node-body">
                <input type="text" class="tags-list form-input" placeholder="Tags to remove (comma-separated)">
            </div>
            <div class="node-footer">
                <button class="btn btn-secondary btn-sm connect-btn" data-node-id="${nodeId}">Connect</button>
                <button class="btn btn-danger btn-sm delete-node-btn">Delete</button>
            </div>
        `;
    }

    createAiAgentNodeTemplate(nodeId) {
        return `
            <div class="node-header">
                <div class="node-icon">ğŸ¤–</div>
                <div class="node-title">AI Sales Agent</div>
                <div class="node-type">ai-agent</div>
            </div>
            <div class="node-body ai-agent-node-body">
                <div class="ai-agent-tabs" style="display:flex; gap:4px; margin-bottom:8px; flex-wrap:wrap;">
                    <button type="button" class="ai-agent-tab-btn active" data-tab="product">Product</button>
                    <button type="button" class="ai-agent-tab-btn" data-tab="identity">Identity</button>
                    <button type="button" class="ai-agent-tab-btn" data-tab="response">Response</button>
                    <button type="button" class="ai-agent-tab-btn" data-tab="media">Media</button>
                </div>
                <div class="ai-agent-tab-content" data-tab="product">
                    <div class="form-group">
                        <label class="form-label">Context source</label>
                        <select class="form-select ai-agent-context-source">
                            <option value="PRODUCT_SELECT">Select from my products</option>
                            <option value="MANUAL">Manual</option>
                            <option value="URL_SCRAPER">URL Scraper</option>
                        </select>
                    </div>
                    <div class="form-group ai-agent-product-select-row" style="display:none;" data-product-row-node="${nodeId}">
                        <label class="form-label required">Your products</label>
                        <select class="form-select ai-agent-product-select" style="width:100%;">
                            <option value="">â€” Load products â€”</option>
                        </select>
                        <p class="text-muted small mt-1 mb-0" style="font-size:0.75rem;">Products are from the Product section. Create products there first if the list is empty.</p>
                    </div>
                    <div class="form-group ai-agent-manual-context-row">
                        <label class="form-label required">Product details (Price, Shipping, Features)</label>
                        <textarea class="form-textarea ai-agent-product-context" rows="3" placeholder="Product name, SKU, Prices, Delivery/Shipping, Market..."></textarea>
                        <div class="form-group mt-2">
                            <label class="form-label">Delivery options</label>
                            <input type="text" class="form-input ai-agent-delivery-options" maxlength="500" placeholder="e.g. Free delivery, 30 MAD, Free above 200 MAD">
                            <p class="text-muted small mt-1 mb-0" style="font-size:0.75rem;">When the customer asks about delivery, the AI will use this. Filled automatically when you select a product.</p>
                        </div>
                        <div class="ai-agent-product-summary" style="display:none;">
                            <div class="summary-title">Saved product</div>
                            <div class="summary-row"><strong>Product name:</strong> <span class="ai-agent-summary-name"></span></div>
                            <div class="summary-row"><strong>Prices:</strong> <span class="ai-agent-summary-prices"></span></div>
                            <div class="summary-row"><strong>Shipping:</strong> <span class="ai-agent-summary-shipping"></span></div>
                            <div class="summary-row"><strong>Market:</strong> <span class="ai-agent-summary-market"></span></div>
                        </div>
                    </div>
                    <div class="form-group" style="display:none;" id="ai-agent-url-row-${nodeId}">
                        <label class="form-label">Product URL</label>
                        <input type="url" class="form-input ai-agent-product-url" placeholder="https://...">
                        <button type="button" class="btn btn-sm btn-outline-secondary mt-1 ai-agent-fetch-url" style="Background:#4d71ab; color:white;">Fetch from URL</button>
                    </div>
                    <div class="node-properties">
                        <div class="node-property">
                            <span>Delay:</span>
                            <input type="number" value="0" min="0" class="delay-input form-input ai-agent-delay" style="width: 60px;"> sec
                        </div>
                    </div>
                    <button type="button" class="btn btn-sm btn-outline-primary mt-2 ai-agent-test-btn">Test AI</button>
                </div>

 


                <!-- Identity tab -->
                <div class="ai-agent-tab-content" data-tab="identity" style="display:none;">
                    <!-- Language: always visible (needed for GPT text generation) -->
                    <div class="form-group ai-agent-language-row" style="margin-top:8px;">
                        <label class="form-label">Language</label>
                        <input type="text" class="form-input ai-agent-node-language" placeholder="e.g. AR_MA, EN_US" maxlength="20" style="font-size:0.8rem;">
                    </div>

                    <!-- Voice Settings: hidden when response_mode === TEXT_ONLY -->
                    <div class="ai-agent-voice-settings-section ai-agent-visibility-transition">
                        <div class="form-group mt-3 pt-3" style="border-top:1px solid rgba(255,255,255,0.1);">
                            <label class="form-label">Voice provider</label>
                            <select class="form-select ai-agent-voice-provider" style="font-size:0.8rem;">
                                <option value="ELEVENLABS">ElevenLabs</option>
                                <option value="OPENAI">OpenAI</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Fallback (legacy)</label>
                            <select class="form-select ai-agent-node-voice-id" style="font-size:0.8rem;">
                                <option value="">Default channel voice</option>
                                <option value="native">Native-sounding</option>
                            </select>
                            <select class="form-select ai-agent-node-gender mt-1" style="font-size:0.8rem;">
                                <option value="">â€”</option>
                                <option value="MALE">Male</option>
                                <option value="FEMALE">Female</option>
                            </select>
                        </div>

                        <!-- Sales Agent (Voice Selection) -->
                        <input type="hidden" class="ai-agent-persona-id" value="">
                        <div class="persona-section">
                            <div class="persona-section-header">
                                <h4 class="persona-section-title">Sales Agent</h4>
                                <p class="persona-section-desc">Choose a voice and personality for this node. Premium unlocks high-quality and cloned voices.</p>
                            </div>
                            <div class="ai-agent-no-voices-msg persona-gallery-empty" style="display:none;" role="status">
                                <span class="persona-gallery-empty-icon">ğŸ”‡</span>
                                <p class="persona-gallery-empty-text">No voices found for this selection.</p>
                            </div>
                            <div class="persona-tabs-wrap">
                                <div class="ai-agent-persona-tabs" role="tablist">
                                    <button type="button" class="ai-agent-persona-tab active" data-persona-tab="standard" role="tab" aria-selected="true">
                                        <span class="persona-tab-icon">ğŸ‘¤</span>
                                        <span>Standard Agents</span>
                                    </button>
                                    <button type="button" class="ai-agent-persona-tab" data-persona-tab="my" role="tab" aria-selected="false">
                                        <span class="persona-tab-icon">ğŸ™</span>
                                        <span>My Voices</span>
                                    </button>
                                </div>
                            </div>
                            <div class="persona-gallery-wrap">
                                <div class="ai-agent-persona-gallery ai-agent-persona-gallery-standard" data-tab="standard" role="tabpanel"></div>
                                <div class="ai-agent-persona-gallery ai-agent-persona-gallery-my" data-tab="my" role="tabpanel" style="display:none;"></div>
                            </div>
                            <div class="ai-agent-persona-premium-hint persona-premium-banner" style="display:none;">
                                <span class="persona-premium-icon">ğŸ‘‘</span>
                                <span>Upgrade to Premium to use high-quality and cloned voices.</span>
                            </div>
                        </div>

                        <!-- Voice customizer (ElevenLabs sliders; hidden for OpenAI) -->
                        <div class="form-group mt-3 pt-3 ai-agent-voice-sliders-wrap" style="border-top:1px solid rgba(255,255,255,0.1);">
                            <label class="form-label">Voice customizer</label>
                            <p class="ai-agent-openai-note text-muted small mb-2" style="display:none;">OpenAI uses standard optimized settings.</p>
                            <div class="ai-agent-sliders-inner">
                                <div class="d-flex justify-content-between small mb-1"><span class="text-muted">Stability</span><span class="ai-agent-voice-stability-val">0.5</span></div>
                                <input type="range" class="form-range ai-agent-voice-stability" min="0" max="1" step="0.05" value="0.5" style="width:100%;">
                                <div class="d-flex justify-content-between small mb-1 mt-2"><span class="text-muted">Similarity</span><span class="ai-agent-voice-similarity-val">0.75</span></div>
                                <input type="range" class="form-range ai-agent-voice-similarity" min="0" max="1" step="0.05" value="0.75" style="width:100%;">
                                <div class="d-flex justify-content-between small mb-1 mt-2"><span class="text-muted">Speed</span><span class="ai-agent-voice-speed-val">1</span></div>
                                <input type="range" class="form-range ai-agent-voice-speed" min="0.5" max="1.5" step="0.05" value="1" style="width:100%;">
                            </div>
                        </div>
                    </div>






                </div>
                <div class="ai-agent-tab-content" data-tab="response" style="display:none;">
                    <div class="form-group">
                        <label class="form-label">Response mode</label>
                        <select class="form-select ai-agent-response-mode">
                            <option value="TEXT_ONLY">Text only â€” Fast and cheap</option>
                            <option value="AUDIO_ONLY">Audio only â€” High-trust (voice)</option>
                            <option value="AUTO_SMART">Auto â€” Text for short, Audio for pitch/closing</option>
                        </select>
                    </div>
                    <div class="form-group form-check">
                        <input type="checkbox" class="form-check-input ai-agent-voice-enabled" id="ai-voice-${nodeId}">
                        <label class="form-check-label" for="ai-voice-${nodeId}">Voice response (legacy)</label>
                    </div>
                </div>
                <div class="ai-agent-tab-content" data-tab="media" style="display:none;">
                    <div class="form-group">
                        <label class="form-label">Media gallery</label>
                        <p class="text-muted" style="font-size:0.75rem; margin-bottom:6px;">Add product images/videos. Give each a label so the AI knows when to show it (e.g. &quot;Product Close-up&quot;, &quot;How-to-use Video&quot;).</p>
                        <div class="ai-agent-media-dropzone" style="border:2px dashed #ccc; border-radius:8px; padding:12px; text-align:center; margin-bottom:8px; min-height:60px;">
                            <span class="ai-agent-media-drop-text">Drop files here or click to upload</span>
                            <input type="file" class="ai-agent-media-file-input" accept="image/*,video/*" multiple style="display:none;">
                        </div>
                        <div class="ai-agent-media-list" data-node-id="${nodeId}"></div>
                        <p class="ai-agent-media-save-hint text-muted" style="font-size:0.7rem; display:none;">Save the flow first to upload media.</p>
                    </div>
                </div>
            </div>
            <div class="node-footer">
                <button type="button" class="btn btn-secondary btn-sm connect-btn" data-node-id="${nodeId}">Connect</button>
                <button type="button" class="btn btn-danger btn-sm delete-node-btn">Delete</button>
            </div>
        `;
    }



    createGoogleSheetsNodeTemplate(nodeId) {
        return `
            <div class="node-header">
                <div class="node-icon"><svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true"><path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zM9 17H7v-7h2v7zm4 0h-2V7h2v10zm4 0h-2v-4h2v4z"/></svg></div>
                <div class="node-title">Google Sheets</div>
                <div class="node-type">google-sheets</div>
            </div>
            <div class="node-body">
                <div class="form-group form-check mb-2">
                    <input type="checkbox" class="form-check-input google-sheets-send-all" id="gs-send-all-${nodeId}" checked>
                    <label class="form-check-label" for="gs-send-all-${nodeId}" style="font-size:0.85rem;">Send all conversation data</label>
                </div>
                <p class="text-muted" style="font-size:0.8rem; margin:0 0 8px 0;">This node exports current variables to your linked Google Sheet (Settings â†’ Integrations).</p>
                <div class="google-sheets-preview rounded p-2" style="background:rgba(0,0,0,0.15); font-size:0.75rem; color:var(--text-secondary); min-height:36px;">
                    <span class="google-sheets-preview-text">Quick preview: loadingâ€¦</span>
                </div>
                <input type="hidden" class="google-sheets-label" value="Export to Google Sheets">
            </div>
            <div class="node-footer">
                <button type="button" class="btn btn-secondary btn-sm connect-btn" data-node-id="${nodeId}">Connect</button>
                <button type="button" class="btn btn-danger btn-sm delete-node-btn">Delete</button>
            </div>
        `;
    }

    createFollowUpNodeTemplate(nodeId) {
        return `
            <div class="node-header">
                <div class="node-icon">ğŸ“…</div>
                <div class="node-title">AI Follow-up</div>
                <div class="node-type">follow-up</div>
            </div>
            <div class="node-body">
                <div class="form-group">
                    <label class="form-label">Delay (hours)</label>
                    <input type="number" class="form-input follow-up-delay-hours" value="6" min="1" max="168" step="1" style="width:80px;">
                    <span class="text-muted" style="font-size:0.75rem;">hours before re-engage</span>
                </div>
                <div class="form-group form-check">
                    <input type="checkbox" class="form-check-input follow-up-ai-personalized" id="follow-up-ai-${nodeId}">
                    <label class="form-check-label" for="follow-up-ai-${nodeId}">Use AI to personalize message</label>
                </div>
                <div class="form-group">
                    <label class="form-label">Response type</label>
                    <select class="form-select follow-up-response-type" style="font-size:0.85rem;">
                        <option value="TEXT">Text</option>
                        <option value="AUDIO">Audio</option>
                        <option value="IMAGE">Image</option>
                        <option value="VIDEO">Video</option>
                    </select>
                </div>
                <input type="hidden" class="follow-up-file-path" value="">
                <div class="form-group follow-up-media-wrap">
                    <label class="form-label">Media (optional)</label>
                    <div class="follow-up-media-dropzone" style="border:2px dashed #64748b; border-radius:8px; padding:12px; text-align:center; min-height:50px; font-size:0.8rem; color:#94a3b8;">
                        <span class="follow-up-media-text">Drop or click to upload</span>
                        <input type="file" class="follow-up-media-input" accept="image/*,video/*,audio/*" style="display:none;">
                    </div>
                    <p class="follow-up-file-name text-muted" style="font-size:0.7rem; margin-top:4px; display:none;"></p>
                </div>
                <div class="form-group">
                    <label class="form-label">Message / Caption</label>
                    <textarea class="form-textarea follow-up-caption" rows="2" placeholder="Default text or caption for media (e.g. Ù…Ø±Ø­Ø¨Ø§Ù‹ØŒ ØªØ°ÙƒØ±Ù†Ø§ Ø£Ù†Ùƒ Ù…Ù‡ØªÙ…...)" style="font-size:0.85rem;"></textarea>
                </div>
            </div>
            <div class="node-footer">
                <button type="button" class="btn btn-secondary btn-sm connect-btn" data-node-id="${nodeId}">Connect</button>
                <button type="button" class="btn btn-danger btn-sm delete-node-btn">Delete</button>
            </div>
        `;
    }

    createTriggerNodeTemplate(nodeId) {
        return `
            <div class="node-header">
                <div class="node-icon">ğŸ””</div>
                <div class="node-title">Flow Trigger</div>
                <div class="node-type">trigger</div>
            </div>
            <div class="node-body">
                <div class="form-group">
                    <label class="form-label">Trigger Type</label>
                    <select class="form-select trigger-match-type">
                        <option value="contains">Contains Keyword </option>
                        <option value="exact">Exact Match </option>
                        <option value="conversation_start">Conversation Start </option>
                    </select>
                </div>

                <div class="form-group" id="kw_container_${nodeId}">
                    <label class="form-label">Keywords</label>
                    <input type="text" class="form-input trigger-keywords"
                           placeholder="Enter keywords (e.g. hi, hello)">
                    <div class="text-muted" style="font-size: 0.70rem; margin-top: 0.25rem;">
                        Keywords separated by comma
                    </div>
                </div>
            </div>
            <div class="node-footer">
                <button class="btn btn-secondary btn-sm connect-btn" data-node-id="${nodeId}">Connect</button>
                <button class="btn btn-danger btn-sm delete-node-btn">Delete</button>
            </div>
        `;
    }
   
    // ==========================================
    // ØªÙ‡ÙŠØ¦Ø© Ø¹Ù‚Ø¯Ø© ÙˆØ§Ø­Ø¯Ø© Ø¨Ø´ÙƒÙ„ Ø¢Ù…Ù† (Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ù…Ø­Ø³Ù‘Ù†Ø©)
    // ==========================================
    async initializeNodeSafe(nodeElement) {
        return new Promise((resolve) => {
            const nodeId = nodeElement.id;
            if (!nodeId || !this.jsPlumbInstance) {
                return resolve();
            }
            try {
                // ØªÙ†Ø¸ÙŠÙ Ø£ÙŠ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø³Ø§Ø¨Ù‚Ø©
                this.jsPlumbInstance.unmakeSource(nodeId);
                this.jsPlumbInstance.unmakeTarget(nodeId);
              
                // Ø¥Ø²Ø§Ù„Ø© endpoints Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©
                const oldEndpoints = this.jsPlumbInstance.getEndpoints(nodeId);
                if (oldEndpoints) {
                    oldEndpoints.forEach(ep => this.jsPlumbInstance.deleteEndpoint(ep));
                }
                // ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø³Ø­Ø¨ ÙˆØ§Ù„Ø¥ÙÙ„Ø§Øª
                this.jsPlumbInstance.draggable(nodeId, {
                    containment: true,
                    grid: [10, 10],
                    stop: () => {
                        this.jsPlumbInstance.revalidate(nodeId);
                        this.jsPlumbInstance.repaint(nodeId);
                    }
                });
                // Ø¥Ø¶Ø§ÙØ© Ù†Ù‚Ø·Ø© Ø§Ù„Ù…ØµØ¯Ø± (ÙŠÙ…ÙŠÙ†)
                this.jsPlumbInstance.addEndpoint(nodeId, {
                    endpoint: "Dot",
                    paintStyle: { fill: "#7C3AED", radius: 7 },
                    hoverPaintStyle: { fill: "#10B981", radius: 8 },
                    isSource: true,
                    anchor: "RightMiddle",
                    maxConnections: -1,
                    connector: ["Flowchart", { stub: 5, gap: 5, cornerRadius: 5 }],
                    connectorStyle: {
                        stroke: "#7C3AED",
                        strokeWidth: 2,
                        outlineStroke: "transparent",
                        outlineWidth: 10
                    },
                    connectorHoverStyle: {
                        stroke: "#10B981",
                        strokeWidth: 3
                    }
                });
                // Ø¥Ø¶Ø§ÙØ© Ù†Ù‚Ø·Ø© Ø§Ù„Ù‡Ø¯Ù (ÙŠØ³Ø§Ø±)
                this.jsPlumbInstance.addEndpoint(nodeId, {
                    endpoint: "Dot",
                    paintStyle: { fill: "#10B981", radius: 7 },
                    hoverPaintStyle: { fill: "#7C3AED", radius: 8 },
                    isTarget: true,
                    anchor: "LeftMiddle",
                    maxConnections: -1
                });
                // Ø±Ø¨Ø· Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø§ØªØµØ§Ù„
                nodeElement.querySelectorAll('.connect-btn').forEach(btn => {
                    const newBtn = btn.cloneNode(true);
                    btn.parentNode.replaceChild(newBtn, btn);
                  
                    newBtn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        this.connectNode(nodeId, e.target.dataset.branch);
                    });
                });
                // Ø±Ø¨Ø· Ø²Ø± Ø§Ù„Ø­Ø°Ù
                const deleteBtn = nodeElement.querySelector('.delete-node-btn');
                if (deleteBtn) {
                    const newDeleteBtn = deleteBtn.cloneNode(true);
                    deleteBtn.parentNode.replaceChild(newDeleteBtn, deleteBtn);
                  
                    newDeleteBtn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        this.removeNode(nodeId);
                    });
                }
                // AI Agent: Fetch from URL â†’ modal edit â†’ confirm â†’ save & show summary
                if (nodeElement.dataset.nodeType === 'ai-agent') {
                    const self = this;
                    const fetchUrlBtn = nodeElement.querySelector('.ai-agent-fetch-url');
                    if (fetchUrlBtn) {
                        fetchUrlBtn.addEventListener('click', async (e) => {
                            e.stopPropagation();
                            const urlInput = nodeElement.querySelector('.ai-agent-product-url');
                            const ta = nodeElement.querySelector('.ai-agent-product-context');
                            if (!urlInput || !ta) return;
                            const url = urlInput.value.trim();
                            if (!url) { alert('Enter a product URL'); return; }
                            fetchUrlBtn.disabled = true;
                            try {
                                const fd = new FormData();
                                fd.append('url', url);
                                fd.append('csrfmiddlewaretoken', this.csrfToken || '');
                                const r = await fetch('{% url "api_scrape_product_url" %}', { method: 'POST', body: fd });
                                const j = await r.json();
                                if (j.error) { alert(j.error); fetchUrlBtn.disabled = false; return; }
                                // Open edit modal with extracted data
                                const modal = document.getElementById('aiProductConfirmModal');
                                const nameIn = document.getElementById('ai-product-edit-name');
                                const pricesIn = document.getElementById('ai-product-edit-prices');
                                const marketIn = document.getElementById('ai-product-edit-market');
                                const additionalIn = document.getElementById('ai-product-edit-additional');
                                const shippingIn = document.getElementById('ai-product-edit-shipping');
                                if (modal && nameIn && pricesIn && marketIn && additionalIn) {
                                    nameIn.value = j.product_name || '';
                                    pricesIn.value = j.prices || '';
                                    marketIn.value = (j.market || '').trim() || 'Morocco';
                                    additionalIn.value = j.additional || '';
                                    if (shippingIn) shippingIn.value = '';
                                    window.aiProductClearValidationErrors && window.aiProductClearValidationErrors();
                                    modal.style.display = 'flex';
                                    modal.dataset.targetNodeId = nodeId;
                                } else {
                                    ta.value = j.product_context || ta.value;
                                }
                            } catch (err) { alert('Request failed'); }
                            fetchUrlBtn.disabled = false;
                        });
                    }
                    const testBtn = nodeElement.querySelector('.ai-agent-test-btn');
                    if (testBtn) {
                        testBtn.addEventListener('click', (e) => {
                            e.stopPropagation();
                            alert('Save the flow and trigger it (e.g. with a keyword) to test the AI reply in chat.');
                        });
                    }
                    const contextSource = nodeElement.querySelector('.ai-agent-context-source');
                    const urlRow = nodeElement.querySelector('#ai-agent-url-row-' + nodeId);
                    const productSelectRow = nodeElement.querySelector('.ai-agent-product-select-row');
                    const manualContextRow = nodeElement.querySelector('.ai-agent-manual-context-row');
                    const productSelect = nodeElement.querySelector('.ai-agent-product-select');
                    const productContextTa = nodeElement.querySelector('.ai-agent-product-context');
                    function updateProductSourceVisibility() {
                        const v = contextSource ? contextSource.value : 'MANUAL';
                        if (urlRow) urlRow.style.display = v === 'URL_SCRAPER' ? 'block' : 'none';
                        if (productSelectRow) productSelectRow.style.display = v === 'PRODUCT_SELECT' ? 'block' : 'none';
                        if (manualContextRow) manualContextRow.style.display = (v === 'MANUAL' || v === 'URL_SCRAPER') ? 'block' : 'none';
                        if (v === 'PRODUCT_SELECT' && productSelect && productSelect.options.length <= 1) loadProductsForAiNode(nodeElement);
                    }
                    if (contextSource) {
                        contextSource.addEventListener('change', updateProductSourceVisibility);
                        updateProductSourceVisibility();
                    }
                    if (nodeElement.dataset.savedProductId) {
                        const pid = nodeElement.dataset.savedProductId;
                        loadProductsForAiNode(nodeElement).then(function() {
                            const sel = nodeElement.querySelector('.ai-agent-product-select');
                            if (sel && pid) {
                                sel.value = pid;
                                sel.dispatchEvent(new Event('change', { bubbles: true }));
                            }
                            delete nodeElement.dataset.savedProductId;
                        }).catch(function() { delete nodeElement.dataset.savedProductId; });
                    }
                    async function loadProductsForAiNode(nodeEl) {
                        const sel = nodeEl.querySelector('.ai-agent-product-select');
                        if (!sel) return;
                        const chId = window.currentChannelId || (typeof window.getCurrentChannelId === 'function' && window.getCurrentChannelId());
                        if (!chId) { sel.innerHTML = '<option value="">No channel selected</option>'; return; }
                        sel.innerHTML = '<option value="">Loadingâ€¦</option>';
                        const baseUrl = (typeof window.flowBuilder !== 'undefined' && window.flowBuilder.apiBaseUrl) ? window.flowBuilder.apiBaseUrl : (self.apiBaseUrl || '/discount/whatssapAPI');
                        const url = baseUrl + '/api_products/?channel_id=' + encodeURIComponent(chId);
                        try {
                            const r = await fetch(url, { credentials: 'same-origin', headers: { 'Accept': 'application/json' } });
                            const contentType = r.headers.get('Content-Type') || '';
                            if (!r.ok) {
                                const text = await r.text();
                                console.error('Products API error', r.status, url, text.slice(0, 200));
                                sel.innerHTML = '<option value="">Failed to load (' + r.status + ')</option>';
                                return;
                            }
                            const j = contentType.indexOf('json') >= 0 ? await r.json() : { products: [] };
                            const list = j.products || [];
                            sel.innerHTML = '<option value="">â€” Select a product â€”</option>';
                            list.forEach(p => {
                                const opt = document.createElement('option');
                                opt.value = p.id;
                                opt.textContent = (p.name || 'Product') + (p.price ? ' â€” ' + p.price + ' ' + (p.currency || 'MAD') : '');
                                opt.dataset.sku = p.sku || '';
                                opt.dataset.name = p.name || '';
                                opt.dataset.price = p.price != null ? String(p.price) : '';
                                opt.dataset.currency = p.currency || 'MAD';
                                opt.dataset.description = (p.description || '').slice(0, 500);
                                opt.dataset.deliveryOptions = (p.delivery_options || '').trim() || '';
                                sel.appendChild(opt);
                            });
                        } catch (e) {
                            console.error('Products load failed', e);
                            sel.innerHTML = '<option value="">Failed to load products</option>';
                        }
                    }
                    if (productSelect && productContextTa) {
                        productSelect.addEventListener('change', () => {
                            const opt = productSelect.options[productSelect.selectedIndex];
                            if (!opt || !opt.value) return;
                            const name = opt.dataset.name || opt.textContent.split('â€”')[0].trim();
                            const sku = opt.dataset.sku || '';
                            const price = opt.dataset.price || '';
                            const currency = opt.dataset.currency || 'MAD';
                            const desc = opt.dataset.description || '';
                            const deliveryOpts = (opt.dataset.deliveryoptions || opt.dataset.deliveryOptions || '').trim();
                            const deliveryLine = deliveryOpts ? deliveryOpts : 'Free or Paid';
                            const lines = [
                                'Product name: ' + name,
                                'SKU: ' + sku,
                                'Prices: ' + (price ? price + ' ' + currency : 'â€”'),
                                'Description: ' + (desc || 'â€”'),
                                'Delivery: ' + deliveryLine,
                                'Market: Morocco'
                            ];
                            productContextTa.value = lines.join('\n');
                            const deliveryInput = nodeElement.querySelector('.ai-agent-delivery-options');
                            if (deliveryInput) deliveryInput.value = deliveryLine;
                            const summary = nodeElement.querySelector('.ai-agent-product-summary');
                            if (summary) {
                                const nameSpan = nodeElement.querySelector('.ai-agent-summary-name');
                                const pricesSpan = nodeElement.querySelector('.ai-agent-summary-prices');
                                if (nameSpan) nameSpan.textContent = name || 'â€”';
                                if (pricesSpan) pricesSpan.textContent = (price ? price + ' ' + currency : 'â€”');
                                const shipEl = nodeElement.querySelector('.ai-agent-summary-shipping');
                                if (shipEl) shipEl.textContent = deliveryLine || 'â€”';
                                nodeElement.querySelector('.ai-agent-summary-market') && (nodeElement.querySelector('.ai-agent-summary-market').textContent = 'Morocco');
                                summary.style.display = 'block';
                            }
                        });
                    }
                    // Tabs
                    nodeElement.querySelectorAll('.ai-agent-tab-btn').forEach(btn => {
                        btn.addEventListener('click', (e) => {
                            e.stopPropagation();
                            const tab = btn.dataset.tab;
                            nodeElement.querySelectorAll('.ai-agent-tab-btn').forEach(b => b.classList.remove('active'));
                            btn.classList.add('active');
                            nodeElement.querySelectorAll('.ai-agent-tab-content').forEach(c => {
                                c.style.display = c.dataset.tab === tab ? 'block' : 'none';
                            });
                            if (tab === 'identity' && typeof window.loadAiAgentPersonaGalleries === 'function') {
                                const std = nodeElement.querySelector('.ai-agent-persona-gallery-standard');
                                if (std && !std.dataset.loaded) window.loadAiAgentPersonaGalleries(nodeElement);
                                if (typeof window.applyAiNodeVisibility === 'function') window.applyAiNodeVisibility(nodeElement);
                            }
                        });
                    });
                    nodeElement._loadProductsForAiNode = loadProductsForAiNode;
                    nodeElement._updateProductSourceVisibility = updateProductSourceVisibility;
                    // Conditional visibility: response_mode, voice_provider, gender
                    const responseModeEl = nodeElement.querySelector('.ai-agent-response-mode');
                    const voiceProviderEl = nodeElement.querySelector('.ai-agent-voice-provider');
                    const nodeGenderEl = nodeElement.querySelector('.ai-agent-node-gender');
                    [responseModeEl, voiceProviderEl, nodeGenderEl].forEach(el => {
                        if (el) el.addEventListener('change', () => { if (typeof window.applyAiNodeVisibility === 'function') window.applyAiNodeVisibility(nodeElement); });
                    });
                    if (typeof window.applyAiNodeVisibility === 'function') window.applyAiNodeVisibility(nodeElement);
                    // Persona sub-tabs (Standard Agents / My Voices) â€“ bind on node so click always works
                    nodeElement.querySelectorAll('.ai-agent-persona-tab').forEach(btn => {
                        btn.addEventListener('click', (e) => {
                            e.preventDefault();
                            e.stopPropagation();
                            const tabName = btn.getAttribute('data-persona-tab');
                            nodeElement.querySelectorAll('.ai-agent-persona-tab').forEach(t => {
                                t.classList.remove('active');
                                t.setAttribute('aria-selected', 'false');
                            });
                            btn.classList.add('active');
                            btn.setAttribute('aria-selected', 'true');
                            const stdGal = nodeElement.querySelector('.ai-agent-persona-gallery-standard');
                            const myGal = nodeElement.querySelector('.ai-agent-persona-gallery-my');
                            if (stdGal) stdGal.style.display = tabName === 'standard' ? 'grid' : 'none';
                            if (myGal) myGal.style.display = tabName === 'my' ? 'grid' : 'none';
                        });
                    });
                    // Persona: sliders update value labels
                    const stabSlider = nodeElement.querySelector('.ai-agent-voice-stability');
                    const stabVal = nodeElement.querySelector('.ai-agent-voice-stability-val');
                    if (stabSlider && stabVal) stabSlider.addEventListener('input', () => { stabVal.textContent = stabSlider.value; });
                    const simSlider = nodeElement.querySelector('.ai-agent-voice-similarity');
                    const simVal = nodeElement.querySelector('.ai-agent-voice-similarity-val');
                    if (simSlider && simVal) simSlider.addEventListener('input', () => { simVal.textContent = simSlider.value; });
                    const speedSlider = nodeElement.querySelector('.ai-agent-voice-speed');
                    const speedVal = nodeElement.querySelector('.ai-agent-voice-speed-val');
                    if (speedSlider && speedVal) speedSlider.addEventListener('input', () => { speedVal.textContent = speedSlider.value; });
                    // Media gallery: dropzone + upload
                    const dropzone = nodeElement.querySelector('.ai-agent-media-dropzone');
                    const fileInput = nodeElement.querySelector('.ai-agent-media-file-input');
                    const mediaList = nodeElement.querySelector('.ai-agent-media-list');
                    const saveHint = nodeElement.querySelector('.ai-agent-media-save-hint');
                    if (dropzone && fileInput && mediaList) {
                        dropzone.addEventListener('click', () => {
                            if (!self.currentFlowId) {
                                if (saveHint) saveHint.style.display = 'block';
                                return;
                            }
                            fileInput.click();
                        });
                        ['dragenter', 'dragover'].forEach(ev => {
                            dropzone.addEventListener(ev, (e) => { e.preventDefault(); e.stopPropagation(); dropzone.style.borderColor = '#4d71ab'; });
                        });
                        ['dragleave', 'drop'].forEach(ev => {
                            dropzone.addEventListener(ev, (e) => { e.preventDefault(); e.stopPropagation(); dropzone.style.borderColor = '#ccc'; });
                        });
                        dropzone.addEventListener('drop', (e) => {
                            if (!self.currentFlowId) { if (saveHint) saveHint.style.display = 'block'; return; }
                            const files = e.dataTransfer && e.dataTransfer.files;
                            if (files && files.length) Array.from(files).forEach(f => self.handleAiNodeMediaFile(f, nodeId, mediaList, saveHint));
                        });
                        fileInput.addEventListener('change', () => {
                            const files = fileInput.files;
                            if (files && files.length) Array.from(files).forEach(f => self.handleAiNodeMediaFile(f, nodeId, mediaList, saveHint));
                            fileInput.value = '';
                        });
                    }
                }
                // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¹Ù‚Ø¯Ø© Ø¨Ø¹Ø¯ Ø§Ù„ØªÙ‡ÙŠØ¦Ø©
                setTimeout(() => {
                    this.jsPlumbInstance.revalidate(nodeId);
                    resolve();
                }, 10);
            } catch (err) {
                console.error(`Error initializing node ${nodeId}:`, err);
                resolve();
            }
       


        // ============================================================
            // [Ø¥Ø¶Ø§ÙØ© Ø¬Ø¯ÙŠØ¯Ø©] Ù…Ù†Ø·Ù‚ Ø¥Ø®ÙØ§Ø¡/Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„ÙƒÙ„Ù…Ø§Øª Ø§Ù„Ù…ÙØªØ§Ø­ÙŠØ© Ø­Ø³Ø¨ Ø§Ù„Ù†ÙˆØ¹
            // ============================================================
            console.log('Initializing trigger node logic for:', nodeId , nodeElement.dataset.nodeType);
            if (nodeElement.dataset.nodeType === 'trigger') {
                const typeSelect = nodeElement.querySelector('.trigger-match-type');
                const kwContainer = nodeElement.querySelector(`#kw_container_${nodeId}`);

                if (typeSelect && kwContainer) {
                    // Ø¯Ø§Ù„Ø© Ù„Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù‚ÙŠÙ…Ø© ÙˆØªØºÙŠÙŠØ± Ø§Ù„Ø¹Ø±Ø¶
                    const toggleVisibility = () => {
                        if (typeSelect.value === 'conversation_start') {
                            kwContainer.style.display = 'none'; // Ø¥Ø®ÙØ§Ø¡
                        } else {
                            kwContainer.style.display = 'block'; // Ø¥Ø¸Ù‡Ø§Ø±
                        }
                    };

                    // Ø§Ø³ØªÙ…Ø¹ Ù„Ø£ÙŠ ØªØºÙŠÙŠØ± ÙŠÙ‚ÙˆÙ… Ø¨Ù‡ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
                    typeSelect.addEventListener('change', toggleVisibility);

                    // Ù‚Ù… Ø¨ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¯Ø§Ù„Ø© Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø© ÙÙŠ Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© (Ù„Ø¶Ø¨Ø· Ø§Ù„Ø­Ø§Ù„Ø© Ø¹Ù†Ø¯ Ø§Ù„ØªØ­Ù…ÙŠÙ„)
                    toggleVisibility();
                }
            }
            // ==========================================================
   }); 
 }

    // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù†ÙØ³ Ø§Ù„Ø¯Ø§Ù„Ø© Ù„Ù€ initializeNode Ø§Ù„Ø¹Ø§Ø¯ÙŠØ©
    initializeNode(nodeElement) {
        return this.initializeNodeSafe(nodeElement);
    }


    // Ø¯Ø§Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø© Ù„ØªØ¯Ù…ÙŠØ± Ø§Ù„Ù†Ø³Ø®Ø© ÙˆØ¥Ø¹Ø§Ø¯Ø© ØªÙ‡ÙŠØ¦ØªÙ‡Ø§ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„
    resetJsPlumb() {
        if (this.jsPlumbInstance) {
            // 1. Ù…Ø³Ø­ ÙƒÙ„ Ø´ÙŠØ¡ Ù…Ù† Ø§Ù„Ø°Ø§ÙƒØ±Ø©
            this.jsPlumbInstance.reset(); 
            // 2. ØªØ¯Ù…ÙŠØ± Ø§Ù„Ù…ØªØºÙŠØ±
            this.jsPlumbInstance = null;
        }
        // 3. ØªÙØ±ÙŠØº Ø§Ù„Ø­Ø§ÙˆÙŠØ© ÙŠØ¯ÙˆÙŠØ§Ù‹ Ù„Ù„ØªØ£ÙƒØ¯
        if (this.flowCanvas) {
            this.flowCanvas.innerHTML = '';
        }
        
        // 4. Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªÙ‡ÙŠØ¦Ø© Ù…Ù† Ø§Ù„ØµÙØ±
        this.initializeJsPlumb();
    }
    // ==========================================
    // ØªØ­Ù…ÙŠÙ„ Flow ÙƒØ§Ù…Ù„ (Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ù…Ø­Ø³Ù‘Ù†Ø©)
    // ==========================================
    async loadFlow(flowId) {
        this.resetJsPlumb(); 
        // ---------------------------------------------------------

        this.isLoadingFlow = true;
        this.currentFlowId = flowId;
        
        // ... (Ø¨Ø§Ù‚ÙŠ Ø§Ù„ÙƒÙˆØ¯ ÙƒÙ…Ø§ Ù‡Ùˆ: Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ù„ÙˆØ¯Ø± ÙˆØ¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª) ...
        this.showLoadingIndicator('Loading flow...');

        try {
            this.isLoadingFlow = true;
            this.currentFlowId = flowId;
          
            console.log(`ğŸ“¥ Loading flow ID: ${flowId}`);
          
            const response = await this.apiGet(`/discount/whatssapAPI/api/flows/${flowId}/`);
            console.log('ğŸ“¦ Flow data received:', response);
          
            if (response.item) {
                this.currentFlowName = response.item.name;
                this.currentFlowDescription = response.item.description;
                await this.renderFlow(response.item);
            } else if (response.config) {
                this.currentFlowName = response.name || 'Unnamed Flow';
                this.currentFlowDescription = response.description || '';
                await this.renderFlow(response);
            } else {
                throw new Error('Invalid flow data structure');
            }
          
            this.showNotification('Flow loaded successfully! âœ¨', 'success');
            this.hasUnsavedChanges = false;
        } catch (error) {
            console.error('âŒ Load flow error:', error);
            this.showNotification('Failed to load flow: ' + error.message, 'error');
        } finally {
            this.isLoadingFlow = false;
        }
    }

    // ==========================================
    // Ø±Ø³Ù… Flow ÙƒØ§Ù…Ù„ (Ø§Ù„Ø­Ù„ Ø§Ù„Ø´Ø§Ù…Ù„)
    // ==========================================
    // ==========================================
    // Ø±Ø³Ù… Flow ÙƒØ§Ù…Ù„ (Ù…Ø¹ Ø¥ØµÙ„Ø§Ø­ Ù…Ø´ÙƒÙ„Ø© Ø§Ù„Ø®Ø·ÙˆØ·)
    // ==========================================
    async renderFlow(flowData) {
        // Ø¥Ø¸Ù‡Ø§Ø± Ù…Ø¤Ø´Ø± Ø§Ù„ØªØ­Ù…ÙŠÙ„
        this.showLoadingIndicator('Loading flow...');
      
        try {
            this.clearCanvas(true);
          
            if (!flowData?.config?.nodes?.length) {
                this.hideLoadingIndicator();
                return;
            }

            const nodes = flowData.config.nodes;
            const connections = flowData.config.connections || [];

            // 1. Ø¥Ù†Ø´Ø§Ø¡ ÙƒÙ„ Ø§Ù„Ø¹Ù‚Ø¯ ÙÙŠ DOM
            await this.createAllNodes(nodes);
            
            // 2. Ø§Ù†ØªØ¸Ø§Ø± Ø§ÙƒØªÙ…Ø§Ù„ DOM
            await this.waitForDOMReady();

            // ---------------------------------------------------------
            // [Ø§Ù„Ø­Ù„ Ø§Ù„Ø¬Ø°Ø±ÙŠ] Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± Ø­ØªÙ‰ ÙŠØªÙ… ØªØ­Ù…ÙŠÙ„ ÙƒØ§ÙØ© Ø§Ù„ØµÙˆØ± Ø¯Ø§Ø®Ù„ Ø§Ù„Ø¹Ù‚Ø¯
            // ---------------------------------------------------------
            const images = Array.from(this.flowCanvas.querySelectorAll('img'));
            if (images.length > 0) {
                await Promise.all(images.map(img => {
                    if (img.complete) return Promise.resolve();
                    return new Promise(resolve => {
                        img.onload = resolve;
                        img.onerror = resolve; // Ù†ÙƒÙ…Ù„ Ø­ØªÙ‰ Ù„Ùˆ ÙØ´Ù„Øª Ø§Ù„ØµÙˆØ±Ø© Ù„ÙƒÙŠ Ù„Ø§ ÙŠØªÙˆÙ‚Ù Ø§Ù„Ù†Ø¸Ø§Ù…
                    });
                }));
            }
            // ---------------------------------------------------------

            // 3. ØªÙ‡ÙŠØ¦Ø© jsPlumb Ù„ÙƒÙ„ Ø§Ù„Ø¹Ù‚Ø¯
            await this.initializeAllNodes();

            // 3.5 Force reflow and one frame so node dimensions/positions are settled before drawing connectors
            if (this.flowCanvas) {
                void this.flowCanvas.offsetHeight;
            }
            await new Promise(resolve => requestAnimationFrame(resolve));
            await new Promise(resolve => requestAnimationFrame(resolve));

            // 4. Ø±Ø³Ù… Ø§Ù„Ø®Ø·ÙˆØ· (Ø§Ù„Ø¢Ù† Ø³ÙŠØªÙ… Ø±Ø³Ù…Ù‡Ø§ ÙÙŠ Ø§Ù„Ù…ÙƒØ§Ù† Ø§Ù„ØµØ­ÙŠØ­ Ù„Ø£Ù† Ø§Ù„ØµÙˆØ± Ø£Ø®Ø°Øª Ø­Ø¬Ù…Ù‡Ø§)
            await this.drawAllConnections(connections);

            // 5. Ø§Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©
            this.updateStats();

            // 6. Multiple repaints so connectors always show (handles late layout / visibility)
            const doRepaint = () => {
                if (this.jsPlumbInstance) {
                    this.jsPlumbInstance.repaintEverything();
                }
            };
            doRepaint();
            setTimeout(doRepaint, 50);
            setTimeout(doRepaint, 150);
            setTimeout(doRepaint, 400);
          
            this.hideLoadingIndicator();
          
        } catch (error) {
            console.error('Error in renderFlow:', error);
            this.hideLoadingIndicator();
            this.showNotification('Failed to load flow', 'error');
        }
    }
    // ==========================================
    // Ø¥Ù†Ø´Ø§Ø¡ ÙƒÙ„ Ø§Ù„Ø¹Ù‚Ø¯
    // ==========================================
    async createAllNodes(nodesData) {
        const promises = nodesData.map(nodeData => this.createNodeInDOM(nodeData));
        await Promise.all(promises);
    }

    // ==========================================
    // Ø¥Ù†Ø´Ø§Ø¡ Ø¹Ù‚Ø¯Ø© ÙÙŠ DOM ÙÙ‚Ø· (Ø¨Ø¯ÙˆÙ† jsPlumb)
    // ==========================================
    async createNodeInDOM(nodeData) {
        return new Promise((resolve) => {
            const nodeId = nodeData.id;
            if (!nodeId) {
                console.warn('Node without ID:', nodeData);
                return resolve();
            }
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø¯Ø§Ø¯
            const num = parseInt(nodeId.replace('node-', ''), 10);
            if (!isNaN(num) && num > this.nodeCounter) {
                this.nodeCounter = num;
            }
            // Ø¥Ù†Ø´Ø§Ø¡ Ø¹Ù†ØµØ± Ø§Ù„Ø¹Ù‚Ø¯Ø©
            const node = document.createElement('div');
            node.className = 'flow-node';
            node.id = nodeId;
            node.dataset.nodeType = nodeData.type;
            node.style.left = `${nodeData.position?.x || 100}px`;
            node.style.top = `${nodeData.position?.y || 100}px`;
            // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ù‚Ø§Ù„Ø¨
            const template = this.getNodeTemplate(nodeData.type);
            node.innerHTML = typeof template === 'function'
                ? template(nodeId)
                : this.createTextMessageNodeTemplate(nodeId);
            // Ø¥Ø¶Ø§ÙØ© Ù„Ù„Ù€ DOM
            this.flowCanvas.appendChild(node);
            // Ù…Ù„Ø¡ Ø§Ù„Ù…Ø­ØªÙˆÙ‰
            let content = nodeData.content;
            if (typeof content === 'string') {
                try {
                    content = JSON.parse(content);
                } catch (e) {
                    content = { text: content };
                }
            }
            this.fillNodeContent(node, content);
            resolve(nodeId);
        });
    }

    // ==========================================
    // Ø§Ù†ØªØ¸Ø§Ø± Ø§ÙƒØªÙ…Ø§Ù„ DOM
    // ==========================================
    async waitForDOMReady() {
        return new Promise((resolve) => {
            requestAnimationFrame(() => {
                requestAnimationFrame(() => {
                    requestAnimationFrame(() => {
                        setTimeout(resolve, 50);
                    });
                });
            });
        });
    }

    // ==========================================
    // ØªÙ‡ÙŠØ¦Ø© ÙƒÙ„ Ø§Ù„Ø¹Ù‚Ø¯ Ù…Ø¹ jsPlumb
    // ==========================================
    async initializeAllNodes() {
        const nodes = document.querySelectorAll('.flow-node');
        console.log(`ğŸ”§ Initializing ${nodes.length} nodes with jsPlumb...`);
      
        for (const node of nodes) {
            await this.initializeNodeSafe(node);
        }
    }

    // ==========================================
    // Ø±Ø³Ù… ÙƒÙ„ Ø§Ù„Ø®Ø·ÙˆØ·
    // ==========================================
    async drawAllConnections(connections) {
        if (!this.jsPlumbInstance || !connections || connections.length === 0) {
            return;
        }
        for (const conn of connections) {
            await this.drawSingleConnection(conn);
        }
        this.jsPlumbInstance.repaintEverything();
        await new Promise(resolve => setTimeout(resolve, 50));
        this.jsPlumbInstance.repaintEverything();
    }

    // ==========================================
    // Ø±Ø³Ù… Ø®Ø· ÙˆØ§Ø­Ø¯
    // ==========================================
    async drawSingleConnection(conn) {
        return new Promise((resolve) => {
            try {
                const sourceId = conn.source != null ? String(conn.source) : (conn.sourceId != null ? String(conn.sourceId) : '');
                const targetId = conn.target != null ? String(conn.target) : (conn.targetId != null ? String(conn.targetId) : '');
                if (!sourceId || !targetId) {
                    console.warn('âŒ Connection missing source or target:', conn);
                    return resolve();
                }
                const sourceEl = document.getElementById(sourceId);
                const targetEl = document.getElementById(targetId);
                if (!sourceEl || !targetEl) {
                    console.warn(`âŒ Missing nodes: ${sourceId} -> ${targetId}`);
                    return resolve();
                }
                const existingConnections = this.jsPlumbInstance.getConnections({
                    source: sourceId,
                    target: targetId
                });
                if (existingConnections && existingConnections.length > 0) {
                    return resolve();
                }
                const connection = this.jsPlumbInstance.connect({
                    source: sourceId,
                    target: targetId,
                    anchors: ["RightMiddle", "LeftMiddle"],
                    endpoint: "Dot",
                    connector: ["Flowchart", {
                        stub: 5,
                        gap: 5,
                        cornerRadius: 5
                    }],
                    paintStyle: {
                        stroke: "#7C3AED",
                        strokeWidth: 2,
                        outlineStroke: "transparent",
                        outlineWidth: 10
                    },
                    hoverPaintStyle: {
                        stroke: "#10B981",
                        strokeWidth: 3
                    },
                    overlays: [
                        ["Arrow", {
                            location: 1,
                            width: 12,
                            length: 12,
                            foldback: 0.8
                        }]
                    ]
                });
                if (connection && conn.data) {
                    connection.setData(conn.data);
                }
                resolve();
            } catch (err) {
                console.error('âŒ Failed to draw connection:', err);
                resolve();
            }
        });
    }

    // ==========================================
    // Ù…Ù„Ø¡ Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø¹Ù‚Ø¯Ø©
    // ==========================================
    fillNodeContent(node, content) {
        if (!content) return;
      
        const nodeType = node.dataset.nodeType;
      
        try {
            switch(nodeType) {
                case 'text-message':
                    const textarea = node.querySelector('textarea');
                    if (textarea && content.text) textarea.value = content.text;
                  
                    const delayInput = node.querySelector('.delay-input');
                    if (delayInput && content.delay !== undefined) delayInput.value = content.delay;
                    break;
                  
                case 'media-message':
                    const captionTextarea = node.querySelector('textarea');
                    if (captionTextarea && content.caption) captionTextarea.value = content.caption;
                  
                    const mediaTypeSelect = node.querySelector('.media-type');
                    if (mediaTypeSelect && content.mediaType) mediaTypeSelect.value = content.mediaType;
                  
                    const mediaDelayInput = node.querySelector('.delay-input');
                    if (mediaDelayInput && content.delay !== undefined) mediaDelayInput.value = content.delay;
                    break;
                  
                case 'buttons-message':
                    const messageTextarea = node.querySelector('.message-content');
                    if (messageTextarea && content.text) messageTextarea.value = content.text;
                  
                    const buttonsInput = node.querySelector('.buttons-list');
                    if (buttonsInput && content.buttons) buttonsInput.value = content.buttons;
                  
                    const buttonsDelayInput = node.querySelector('.delay-input');
                    if (buttonsDelayInput && content.delay !== undefined) buttonsDelayInput.value = content.delay;
                    break;
                  
                case 'list-message':
                    const titleTextarea = node.querySelector('.message-content');
                    if (titleTextarea && content.title) titleTextarea.value = content.title;
                  
                    const itemsTextarea = node.querySelector('.list-items');
                    if (itemsTextarea && content.items) itemsTextarea.value = content.items;
                  
                    const listDelayInput = node.querySelector('.delay-input');
                    if (listDelayInput && content.delay !== undefined) listDelayInput.value = content.delay;
                    break;
                  
                case 'condition':
                    const variableInput = node.querySelector('.condition-variable');
                    if (variableInput && content.variable) variableInput.value = content.variable;
                  
                    const valueInput = node.querySelector('.condition-value');
                    if (valueInput && content.value) valueInput.value = content.value;
                  
                    const operatorSelect = node.querySelector('.condition-operator');
                    if (operatorSelect && content.operator) operatorSelect.value = content.operator;
                    break;
                  
                case 'delay':
                    const durationInput = node.querySelector('.delay-duration');
                    if (durationInput && content.duration) durationInput.value = content.duration;
                    break;
                  
                case 'webhook':
                    const urlInput = node.querySelector('.webhook-url');
                    if (urlInput && content.url) urlInput.value = content.url;
                  
                    const methodSelect = node.querySelector('.webhook-method');
                    if (methodSelect && content.method) methodSelect.value = content.method;
                    break;
                  
                case 'add-contact':
                    const nameInput = node.querySelector('.contact-name');
                    if (nameInput && content.name) nameInput.value = content.name;
                  
                    const phoneInput = node.querySelector('.contact-phone');
                    if (phoneInput && content.phone) phoneInput.value = content.phone;
                    break;
                  
                case 'update-contact':
                    const idInput = node.querySelector('.contact-id');
                    if (idInput && content.id) idInput.value = content.id;
                  
                    const fieldsInput = node.querySelector('.update-fields');
                    if (fieldsInput && content.fields) fieldsInput.value = content.fields;
                    break;
                  
                case 'add-tags':
                case 'remove-tags':
                    const tagsInput = node.querySelector('.tags-list');
                    if (tagsInput && content.tags) tagsInput.value = content.tags;
                    break;

                case 'ai-agent': {
                    const productContextEl = node.querySelector('.ai-agent-product-context');
                    if (productContextEl && content.product_context !== undefined) productContextEl.value = content.product_context || '';
                    const deliveryOptsEl = node.querySelector('.ai-agent-delivery-options');
                    if (deliveryOptsEl && (content.product_context || '').trim()) {
                        const deliveryM = (content.product_context || '').match(/(?:Delivery|Shipping)\s*:\s*(.+?)(?=\n|$)/i);
                        deliveryOptsEl.value = (deliveryM && deliveryM[1]) ? deliveryM[1].trim() : '';
                    }
                    const contextSourceEl = node.querySelector('.ai-agent-context-source');
                    if (contextSourceEl && content.context_source) contextSourceEl.value = content.context_source;
                    if (contextSourceEl && !contextSourceEl.querySelector('option[value="PRODUCT_SELECT"]')) {
                        const opt = document.createElement('option');
                        opt.value = 'PRODUCT_SELECT';
                        opt.textContent = 'Select from my products';
                        contextSourceEl.insertBefore(opt, contextSourceEl.firstChild);
                    }
                    if (typeof node._updateProductSourceVisibility === 'function') node._updateProductSourceVisibility();
                    const productId = content.product_id != null ? String(content.product_id) : '';
                    const productSelectEl = node.querySelector('.ai-agent-product-select');
                    if (productId && productSelectEl) {
                        if (typeof node._loadProductsForAiNode === 'function') {
                            node._loadProductsForAiNode(node).then(() => { productSelectEl.value = productId; productSelectEl.dispatchEvent(new Event('change', { bubbles: true })); }).catch(() => {});
                        } else {
                            node.dataset.savedProductId = productId;
                        }
                    }
                    const voiceCheckEl = node.querySelector('.ai-agent-voice-enabled');
                    if (voiceCheckEl) voiceCheckEl.checked = !!content.voice_enabled;
                    const aiDelayEl = node.querySelector('.ai-agent-delay');
                    if (aiDelayEl && content.delay !== undefined) aiDelayEl.value = content.delay;
                    const responseModeEl = node.querySelector('.ai-agent-response-mode');
                    if (responseModeEl && content.response_mode) responseModeEl.value = content.response_mode;
                    const personaIdEl = node.querySelector('.ai-agent-persona-id');
                    if (personaIdEl && content.persona_id != null) personaIdEl.value = content.persona_id;
                    const stabEl = node.querySelector('.ai-agent-voice-stability');
                    if (stabEl && content.voice_stability != null) { stabEl.value = content.voice_stability; node.querySelector('.ai-agent-voice-stability-val').textContent = content.voice_stability; }
                    const simEl = node.querySelector('.ai-agent-voice-similarity');
                    if (simEl && content.voice_similarity != null) { simEl.value = content.voice_similarity; node.querySelector('.ai-agent-voice-similarity-val').textContent = content.voice_similarity; }
                    const speedEl = node.querySelector('.ai-agent-voice-speed');
                    if (speedEl && content.voice_speed != null) { speedEl.value = content.voice_speed; node.querySelector('.ai-agent-voice-speed-val').textContent = content.voice_speed; }
                    const nodeVoiceEl = node.querySelector('.ai-agent-node-voice-id');
                    if (nodeVoiceEl && content.node_voice_id !== undefined) nodeVoiceEl.value = content.node_voice_id || '';
                    const nodeLangEl = node.querySelector('.ai-agent-node-language');
                    if (nodeLangEl && content.node_language !== undefined) nodeLangEl.value = content.node_language || '';
                    const nodeGenderEl = node.querySelector('.ai-agent-node-gender');
                    if (nodeGenderEl && content.node_gender !== undefined) nodeGenderEl.value = content.node_gender || '';
                    const voiceProviderEl = node.querySelector('.ai-agent-voice-provider');
                    if (voiceProviderEl && content.voice_provider) voiceProviderEl.value = content.voice_provider;
                    if (node.querySelector('.ai-agent-persona-gallery-standard') && !node.querySelector('.ai-agent-persona-gallery-standard').dataset.loaded) window.loadAiAgentPersonaGalleries && window.loadAiAgentPersonaGalleries(node);
                    if (typeof window.applyAiNodeVisibility === 'function') window.applyAiNodeVisibility(node);
                    const mediaListEl = node.querySelector('.ai-agent-media-list');
                    if (mediaListEl && Array.isArray(content.media)) {
                        mediaListEl.innerHTML = '';
                        content.media.forEach(m => {
                            const row = document.createElement('div');
                            row.className = 'ai-agent-media-row';
                            row.style.cssText = 'display:flex; align-items:center; gap:6px; margin-bottom:6px; font-size:0.8rem;';
                            row.dataset.filePath = m.file_path || '';
                            row.dataset.fileType = m.file_type || 'Image';
                            const labelInput = document.createElement('input');
                            labelInput.type = 'text';
                            labelInput.className = 'form-input ai-agent-media-description';
                            labelInput.placeholder = 'Label for AI';
                            labelInput.value = m.description || '';
                            labelInput.style.flex = '1';
                            labelInput.style.minWidth = '0';
                            const delBtn = document.createElement('button');
                            delBtn.type = 'button';
                            delBtn.className = 'btn btn-danger btn-sm';
                            delBtn.textContent = 'âœ•';
                            delBtn.addEventListener('click', () => row.remove());
                            row.appendChild(labelInput);
                            row.appendChild(delBtn);
                            mediaListEl.appendChild(row);
                        });
                    }
                    const text = (content.product_context || '').trim();
                    const summary = node.querySelector('.ai-agent-product-summary');
                    if (summary && text) {
                        const nameM = text.match(/Product name\s*:\s*(.+?)(?=\n\n|\nPrices|$)/is);
                        const pricesM = text.match(/Prices\s*:\s*(.+?)(?=\n\n|\nShipping|$)/is);
                        const shippingM = text.match(/(?:Delivery|Shipping)\s*:\s*(.+?)(?=\n|$)/i);
                        const marketM = text.match(/Market\s*:\s*(.+?)(?=\n\n|$)/is);
                        const nameSpan = node.querySelector('.ai-agent-summary-name');
                        const pricesSpan = node.querySelector('.ai-agent-summary-prices');
                        const shippingSpan = node.querySelector('.ai-agent-summary-shipping');
                        const marketSpan = node.querySelector('.ai-agent-summary-market');
                        if (nameSpan) nameSpan.textContent = (nameM && nameM[1].trim()) || 'â€”';
                        if (pricesSpan) pricesSpan.textContent = pricesM && pricesM[1] ? (pricesM[1].trim().length > 80 ? pricesM[1].trim().slice(0, 80) + 'â€¦' : pricesM[1].trim()) : 'â€”';
                        if (shippingSpan) shippingSpan.textContent = (shippingM && shippingM[1].trim()) || 'â€”';
                        if (marketSpan) marketSpan.textContent = (marketM && marketM[1].trim()) || 'Morocco';
                        summary.style.display = 'block';
                    }
                    break;
                }

                case 'follow-up': {
                    const delayEl = node.querySelector('.follow-up-delay-hours');
                    if (delayEl && content.delay_hours != null) delayEl.value = content.delay_hours;
                    const responseTypeEl = node.querySelector('.follow-up-response-type');
                    if (responseTypeEl && content.response_type) responseTypeEl.value = content.response_type;
                    const aiCheckEl = node.querySelector('.follow-up-ai-personalized');
                    if (aiCheckEl) aiCheckEl.checked = !!content.ai_personalized;
                    const captionEl = node.querySelector('.follow-up-caption');
                    if (captionEl && content.caption !== undefined) captionEl.value = content.caption || '';
                    const filePathEl = node.querySelector('.follow-up-file-path');
                    if (filePathEl && content.file_path !== undefined) filePathEl.value = content.file_path || '';
                    break;
                }

                case 'google-sheets': {
                    const labelEl = node.querySelector('.google-sheets-label');
                    if (labelEl && content.label !== undefined) labelEl.value = content.label || 'Export to Google Sheets';
                    const sendAllEl = node.querySelector('.google-sheets-send-all');
                    if (sendAllEl) sendAllEl.checked = content.send_all_data !== false;
                    const previewEl = node.querySelector('.google-sheets-preview-text');
                    if (previewEl) {
                        if (content.column_mapping_preview) {
                            previewEl.textContent = content.column_mapping_preview;
                        } else {
                            previewEl.textContent = 'Columns: set in Settings â†’ Integrations';
                            if (typeof window.__loadGoogleSheetsPreview === 'function') window.__loadGoogleSheetsPreview(node);
                        }
                    }
                    break;
                }
                  
                case 'trigger':

// 1. ØªØ¹Ø¨Ø¦Ø© Ø§Ù„ÙƒÙ„Ù…Ø§Øª Ø§Ù„Ù…ÙØªØ§Ø­ÙŠØ©
                const keywordsInput = node.querySelector('.trigger-keywords');
                if (keywordsInput) keywordsInput.value = content.keywords || '';

                // 2. ØªØ­Ø¯ÙŠØ¯ Ù†ÙˆØ¹ Ø§Ù„Ù…Ø­ÙØ² ÙÙŠ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
                const typeSelect = node.querySelector('.trigger-match-type');
                if (typeSelect && content.match_type) {
                    typeSelect.value = content.match_type;
                    
                    // [Ù‡Ø§Ù… Ø¬Ø¯Ø§Ù‹] Ø¥Ø¬Ø¨Ø§Ø± Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ø¹Ù„Ù‰ ØªØ­Ø¯ÙŠØ« Ù†ÙØ³Ù‡Ø§ (Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø­Ù‚Ù„)
                    // Ù†Ù‚ÙˆÙ… ÙŠØ¯ÙˆÙŠØ§Ù‹ Ø¨ØªÙØ¹ÙŠÙ„ Ø­Ø¯Ø« Ø§Ù„ØªØºÙŠÙŠØ± Ù„ÙŠÙ‚ÙˆÙ… Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ initializeNodeSafe Ø¨Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø­Ù‚Ù„
                    typeSelect.dispatchEvent(new Event('change')); }
                break;

            }
        } catch (error) {
            console.error(`Error filling content for ${node.id}:`, error);
        }
    }

    // ==========================================
    // Ø­ÙØ¸ Flow
    // ==========================================
    validateAiAgentNodesBeforeSave() {
        const nodes = document.querySelectorAll('.flow-node[data-node-type="ai-agent"]');
        for (const node of nodes) {
            const contextSource = node.querySelector('.ai-agent-context-source');
            const source = contextSource ? contextSource.value : 'MANUAL';
            const productSelect = node.querySelector('.ai-agent-product-select');
            const productId = productSelect ? (productSelect.value || '').trim() : '';
            const ta = node.querySelector('.ai-agent-product-context');
            const text = (ta && ta.value) ? ta.value.trim() : '';
            if (source === 'PRODUCT_SELECT') {
                if (!productId) {
                    return { valid: false, message: 'When Context source is "Select from my products", you must select a product from the "Your products" dropdown. Either select a product or change the context source to Manual/URL.' };
                }
                if (!text) return { valid: false, message: 'Select a product from "Your products" dropdown, or switch to Manual/URL to fill product details.' };
                continue;
            }
            if (!text) continue;
            const hasName = /Product name\s*:/i.test(text);
            const hasPrices = /(?:Prices?|Price)\s*:/i.test(text);
            const hasShipping = /(?:Delivery|Shipping)\s*:/i.test(text);
            const hasMarket = /Market\s*:/i.test(text);
            if (!hasName || !hasPrices || !hasShipping || !hasMarket) {
                const missing = [];
                if (!hasName) missing.push('Product name');
                if (!hasPrices) missing.push('Prices');
                if (!hasShipping) missing.push('Shipping');
                if (!hasMarket) missing.push('Market');
                return { valid: false, message: 'AI Sales Agent node is missing required product fields: ' + missing.join(', ') + '. Use "Select from my products", "Fetch from URL", or fill the product details manually with Product name, Prices, Shipping, Market.' };
            }
        }
        return { valid: true };
    }

    async saveFlow() {
        try {
            const aiCheck = this.validateAiAgentNodesBeforeSave();
            if (!aiCheck.valid) {
                this.showNotification(aiCheck.message, 'error');
                return false;
            }
            const flowData = await this.collectFlowData();
            let response;
            if (this.currentFlowId) {
                const payload = {
                    name: this.currentFlowName || '',
                    description: this.currentFlowDescription || '',
                    config: flowData,
                    trigger_keywords: this.extractTriggerKeywords(flowData.nodes)
                };
                response = await this.apiPost(
                    `/discount/whatssapAPI/api/flows/${this.currentFlowId}/update/`,
                    payload
                );
            } else {
                const flowName = prompt('Enter flow name:');
                if (!flowName) return false;
                const flowDescription = prompt('Enter flow description (optional):') || '';
                const payload = {
                    name: flowName,
                    description: flowDescription,
                    config: flowData,
                    trigger_keywords: this.extractTriggerKeywords(flowData.nodes)
                };
                response = await this.apiPost('/discount/whatssapAPI/api/flows/create/', payload);
                if (response.item && response.item.id) {
                    this.currentFlowId = response.item.id;
                    this.currentFlowName = flowName;
                    this.currentFlowDescription = flowDescription;
                }
            }
            if (response && (response.success || response.item)) {
                this.hasUnsavedChanges = false;
                this.showNotification('Flow saved successfully! âœ¨', 'success');
                if (window.automationsList) {
                    window.automationsList.loadAutomations();
                }
                return true;
            }
            throw new Error(response.error || 'Unknown error');
        } catch (error) {
            console.error('Save error:', error);
            this.showNotification('Failed to save flow: ' + error.message, 'error');
            return false;
        }
    }

    // ==========================================
    // Ø¬Ù…Ø¹ Ø¨ÙŠØ§Ù†Ø§Øª Flow
    // ==========================================
    async collectFlowData() {
        const nodes = [];
        const nodeElements = document.querySelectorAll('.flow-node');
        for (const node of nodeElements) {
            const nodeType = node.dataset.nodeType || 'text-message';
            const nodeData = {
                id: node.id,
                type: nodeType,
                position: {
                    x: parseInt(node.style.left) || 0,
                    y: parseInt(node.style.top) || 0
                },
                content: await this.getNodeContent(node, nodeType)
            };
            nodes.push(nodeData);
        }
        const connections = this.jsPlumbInstance
            ? this.jsPlumbInstance.getAllConnections().map(conn => ({
                  source: conn.sourceId,
                  target: conn.targetId,
                  data: conn.getData() || {}
              }))
            : [];
        return {
            nodes,
            connections,
            metadata: {
                version: '1.0',
                created: new Date().toISOString(),
                nodeCount: nodes.length,
                connectionCount: connections.length
            }
        };
    }

    // ==========================================
    // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø¹Ù‚Ø¯Ø©
    // ==========================================
    async getNodeContent(node, nodeType) {
        const content = {};
      
        try {
            switch(nodeType) {
                case 'trigger':
                    const keywordsInput = node.querySelector('.trigger-keywords');
                    content.keywords = keywordsInput ? keywordsInput.value.trim() : '';
                    // Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ù†ÙˆØ¹ Ø§Ù„Ù…Ø­ÙØ² (Ø§Ù„Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©)
                    const typeSelect = node.querySelector('.trigger-match-type');
                    content.match_type = typeSelect ? typeSelect.value : 'contains'; // Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©
                    break;
                  
                case 'text-message':
                    const textarea = node.querySelector('textarea');
                    content.text = textarea ? textarea.value.trim() : '';
                  
                    const delayInput = node.querySelector('.delay-input');
                    content.delay = delayInput ? parseInt(delayInput.value) || 0 : 0;
                    break;
                  
                case 'media-message':
                    content.caption = node.querySelector('textarea')?.value?.trim() || '';
                    content.mediaType = node.querySelector('.media-type')?.value || 'image';
                    content.delay = parseInt(node.querySelector('.delay-input')?.value) || 0;
                    const fileInput = node.querySelector('.media-file');
                    if (fileInput && fileInput.files && fileInput.files.length > 0) {
                        const file = fileInput.files[0];
                        content.media_name = file.name;
                        const mediaUrl = await this.uploadMediaFile(file);
                        content.media_url = mediaUrl;
                    } else {
                        content.media_url = "";
                    }
                    break;
                  
                case 'condition':
                    content.variable = node.querySelector('.condition-variable')?.value?.trim() || '';
                    content.value = node.querySelector('.condition-value')?.value?.trim() || '';
                    content.operator = node.querySelector('.condition-operator')?.value || 'equals';
                    break;
                  
                case 'delay':
                    content.duration = parseInt(node.querySelector('.delay-duration')?.value) || 5;
                    break;

                case 'ai-agent': {
                    let productContextText = node.querySelector('.ai-agent-product-context')?.value?.trim() || '';
                    const deliveryOptsInput = node.querySelector('.ai-agent-delivery-options');
                    const deliveryOptsVal = (deliveryOptsInput && deliveryOptsInput.value) ? deliveryOptsInput.value.trim() : '';
                    if (deliveryOptsVal) {
                        productContextText = productContextText.replace(/\n?(?:Delivery|Shipping)\s*:\s*[^\n]*/gi, '').trim();
                        productContextText = (productContextText + '\nDelivery: ' + deliveryOptsVal).trim();
                    }
                    content.product_context = productContextText;
                    content.context_source = node.querySelector('.ai-agent-context-source')?.value || 'MANUAL';
                    const productSelectVal = node.querySelector('.ai-agent-product-select')?.value;
                    content.product_id = (productSelectVal && content.context_source === 'PRODUCT_SELECT') ? parseInt(productSelectVal, 10) : null;
                    content.voice_enabled = node.querySelector('.ai-agent-voice-enabled')?.checked || false;
                    content.delay = parseInt(node.querySelector('.ai-agent-delay')?.value) || 0;
                    content.ai_model_config = {};
                    content.response_mode = node.querySelector('.ai-agent-response-mode')?.value || 'TEXT_ONLY';
                    const personaIdEl = node.querySelector('.ai-agent-persona-id');
                    content.persona_id = (personaIdEl && personaIdEl.value) ? parseInt(personaIdEl.value, 10) : null;
                    const stab = node.querySelector('.ai-agent-voice-stability')?.value;
                    content.voice_stability = stab != null ? parseFloat(stab) : null;
                    const sim = node.querySelector('.ai-agent-voice-similarity')?.value;
                    content.voice_similarity = sim != null ? parseFloat(sim) : null;
                    const spd = node.querySelector('.ai-agent-voice-speed')?.value;
                    content.voice_speed = spd != null ? parseFloat(spd) : null;
                    content.node_voice_id = node.querySelector('.ai-agent-node-voice-id')?.value?.trim() || '';
                    content.node_language = node.querySelector('.ai-agent-node-language')?.value?.trim() || '';
                    content.node_gender = node.querySelector('.ai-agent-node-gender')?.value?.trim() || '';
                    content.voice_provider = node.querySelector('.ai-agent-voice-provider')?.value?.trim() || 'ELEVENLABS';
                    content.media = [];
                    node.querySelectorAll('.ai-agent-media-row').forEach(row => {
                        const fp = row.dataset.filePath;
                        if (fp) content.media.push({
                            file_path: fp,
                            file_type: row.dataset.fileType || 'Image',
                            description: row.querySelector('.ai-agent-media-description')?.value?.trim() || ''
                        });
                    });
                    break;
                }

                case 'follow-up': {
                    const delayEl = node.querySelector('.follow-up-delay-hours');
                    content.delay_hours = delayEl ? parseInt(delayEl.value, 10) : 6;
                    if (isNaN(content.delay_hours) || content.delay_hours < 1) content.delay_hours = 6;
                    content.response_type = node.querySelector('.follow-up-response-type')?.value?.trim() || 'TEXT';
                    content.ai_personalized = node.querySelector('.follow-up-ai-personalized')?.checked || false;
                    content.caption = node.querySelector('.follow-up-caption')?.value?.trim() || '';
                    content.file_path = node.querySelector('.follow-up-file-path')?.value?.trim() || '';
                    break;
                }

                case 'google-sheets': {
                    content.label = node.querySelector('.google-sheets-label')?.value?.trim() || 'Export to Google Sheets';
                    content.send_all_data = node.querySelector('.google-sheets-send-all')?.checked !== false;
                    break;
                }
                  
                case 'webhook':
                    content.url = node.querySelector('.webhook-url')?.value?.trim() || '';
                    content.method = node.querySelector('.webhook-method')?.value || 'POST';
                    break;
                  
                default:
                    const inputs = node.querySelectorAll('input, textarea, select');
                    inputs.forEach(input => {
                        if (input.type !== 'button' && input.type !== 'submit' && !input.classList.contains('connect-btn')) {
                            const fieldName = this.getFieldName(input);
                            if (fieldName) {
                                content[fieldName] = input.value;
                            }
                        }
                    });
            }
        } catch (error) {
            console.error(`Error getting content for node ${node.id}:`, error);
            content.error = error.message;
        }
      
        return content;
    }

    // ==========================================
    // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ø³Ù… Ø§Ù„Ø­Ù‚Ù„
    // ==========================================
    getFieldName(element) {
        const className = element.className;
        if (className.includes('form-input') || className.includes('form-textarea') || className.includes('form-select')) {
            const match = className.match(/(?:node-|form-)(\w+)/);
            return match ? match[1] : element.name || 'unknown';
        }
        return null;
    }

    // ==========================================
    // Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„ÙƒÙ„Ù…Ø§Øª Ø§Ù„Ù…ÙØªØ§Ø­ÙŠØ©
    // ==========================================
    extractTriggerKeywords(nodes) {
        const triggerNode = nodes.find(node => node.type === 'trigger');
        if (triggerNode && triggerNode.content) {
            let content = triggerNode.content;
            if (typeof content === 'string') {
                try {
                    content = JSON.parse(content);
                } catch (e) {
                    content = { keywords: content };
                }
            }
            return content.keywords || '';
        }
        return '';
    }

    // ==========================================
    // Ø±ÙØ¹ Ù…Ù„Ù ÙˆØ³Ø§Ø¦Ø·
    // ==========================================
    async uploadMediaFile(file) {
        try {
            const formData = new FormData();
            formData.append('media', file);
            const res = await fetch('{% url "upload_media" %}', {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': this.csrfToken || ''
                }
            });
            if (!res.ok) {
                const text = await res.text();
                throw new Error(`Upload failed ${res.status}: ${text}`);
            }
            const data = await res.json();
            const url = data.url || data.data?.url || (data.success ? data.url : null);
            if (!url) throw new Error('No URL returned from upload');
            return url;
        } catch (err) {
            console.error('Upload error:', err);
            return null;
        }
    }

    // ==========================================
    // Ù…Ø¹Ø§Ù„Ø¬Ø© Ø±ÙØ¹ Ø§Ù„Ù…Ù„Ù
    // ==========================================
    async handleFileUpload(event) {
        const fileInput = event.target;
        const nodeEl = fileInput.closest('.flow-node');
        if (!nodeEl) return;
        if (!fileInput.files || fileInput.files.length === 0) return;
        const file = fileInput.files[0];
        // Ø­Ø§Ù„Ø© Ø§Ù„Ø±ÙØ¹ (Ø¥Ù†Ø´Ø§Ø¤Ù‡Ø§ Ø¥Ù† Ù„Ù… ØªÙˆØ¬Ø¯)
        let status = nodeEl.querySelector('.upload-status');
         
        if (!status) {
            status = document.createElement('span');
            status.className = 'upload-status';
            status.style.marginLeft = '8px';
            status.style.fontSize = '0.9rem';
            status.textContent = 'Uploading...';
            fileInput.parentNode.appendChild(status);
        } else {
            status.textContent = 'Uploading...';
        }
        // call uploadMediaFile (Ù…ÙˆØ¬ÙˆØ¯ Ø¯Ø§Ø®Ù„ Ù†ÙØ³ Ø§Ù„ÙƒÙ„Ø§Ø³)
        const mediaUrl = await this.uploadMediaFile(file);
        if (mediaUrl) {
            // Ø®Ø²Ù‘Ù† Ø§Ù„Ø±Ø§Ø¨Ø· ÙÙŠ data attribute Ù„Ù„Ø¹Ù‚Ø¯Ø© Ù„ÙƒÙŠ ÙŠÙ„ØªÙ‚Ø·Ù‡ collectFlowData / getNodeContent Ù„Ø§Ø­Ù‚Ù‹Ø§
            const contentData = JSON.parse(nodeEl.dataset.content || '{}');
            contentData.media_url = mediaUrl;
            contentData.media_name = file.name;
            nodeEl.dataset.content = JSON.stringify(contentData);
            status.textContent = 'Uploaded';
            let set_media = nodeEl.querySelector('.set_media')
            let media_file_input = nodeEl.querySelector('.media-file')
            const setimg = document.createElement('img')
            media_file_input.style.display = 'none'
            setimg.style.width = '100%'
            // setimg.style.height = '100%'
            setimg.src = mediaUrl
            
            const close_icon = document.createElement('span')
            close_icon.innerHTML = 'âœ•'
            close_icon.style.cssText = `
                position: absolute;
                top: 5px;
                right: 5px;
                width: 24px;
                height: 24px;
                background: rgba(0, 0, 0, 0.6);
                color: white;
                border-radius: 50%;
                display: flex;
                align-items: center;
                justify-content: center;
                cursor: pointer;
                font-weight: bold;
                z-index: 10;
                transition: all 0.2s ease;
            `
            
            close_icon.addEventListener('mouseover', () => {
                close_icon.style.background = 'rgba(239, 68, 68, 0.9)'
            })
            
            close_icon.addEventListener('mouseout', () => {
                close_icon.style.background = 'rgba(0, 0, 0, 0.6)'
            })
            
            close_icon.addEventListener('click', () => {
                setimg.remove()
                close_icon.remove()
                media_file_input.style.display = 'block'
                media_file_input.value = ''
                status?.remove()
            })
            
            const container = document.createElement('div')
            container.style.cssText = `
                position: relative;
                width: 100%;
                // height: 150px;
                margin-bottom: 0.75rem;
            `
            
            container.appendChild(setimg)
            container.appendChild(close_icon)
            set_media.appendChild(container)
            
            setTimeout(() => { status?.remove() }, 2500)
        } else {
            status.textContent = 'Upload failed'
        }
    }

    // ==========================================
    // ØªÙ‡ÙŠØ¦Ø© listeners Ù„Ø±ÙØ¹ Ø§Ù„Ù…Ù„ÙØ§Øª
    // ==========================================
    initFileUploadListeners() {
        this.flowCanvas.addEventListener('change', (e) => {
            if (e.target.classList.contains('media-file')) {
                this.handleFileUpload(e);
            } else if (e.target.closest('.flow-node')) {
                this.hasUnsavedChanges = true;
            }
        });
        this.flowCanvas.addEventListener('input', (e) => {
            if (e.target.closest('.flow-node')) this.hasUnsavedChanges = true;
        });
    }

    // ==========================================
    // Ù…Ø¤Ø´Ø±Ø§Øª Ø§Ù„ØªØ­Ù…ÙŠÙ„
    // ==========================================
    showLoadingIndicator(message = 'Loading...') {
        // Ø¥Ø²Ø§Ù„Ø© Ø£ÙŠ Ù…Ø¤Ø´Ø± Ù‚Ø¯ÙŠÙ…
        this.hideLoadingIndicator();
      
        const loader = document.createElement('div');
        loader.id = 'flow-loader';
        loader.style.cssText = `
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 99999;
            backdrop-filter: blur(4px);
        `;
      
        loader.innerHTML = `
            <div style="
                background: white;
                padding: 30px 40px;
                border-radius: 12px;
                box-shadow: 0 20px 60px rgba(0,0,0,0.3);
                text-align: center;
            ">
                <div style="
                    width: 50px;
                    height: 50px;
                    border: 4px solid #f3f3f3;
                    border-top: 4px solid #7C3AED;
                    border-radius: 50%;
                    animation: spin 1s linear infinite;
                    margin: 0 auto 20px;
                "></div>
                <div style="
                    font-size: 16px;
                    font-weight: 500;
                    color: #333;
                ">${message}</div>
            </div>
        `;
      
        // Ø¥Ø¶Ø§ÙØ© CSS Ù„Ù„Ø£Ù†ÙŠÙ…ÙŠØ´Ù†
        if (!document.getElementById('loader-style')) {
            const style = document.createElement('style');
            style.id = 'loader-style';
            style.textContent = `
                @keyframes spin {
                    0% { transform: rotate(0deg); }
                    100% { transform: rotate(360deg); }
                }
            `;
            document.head.appendChild(style);
        }
      
        document.body.appendChild(loader);
    }

    hideLoadingIndicator() {
        const loader = document.getElementById('flow-loader');
        if (loader) {
            loader.remove();
        }
    }

    // ==========================================
    // Ø§Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ©
    // ==========================================
    updateStats() {
        if (this.nodeCountEl) {
            this.nodeCountEl.textContent = document.querySelectorAll('.flow-node').length;
        }
        if (this.connectionCountEl) {
            this.connectionCountEl.textContent = this.jsPlumbInstance ? this.jsPlumbInstance.getAllConnections().length : 0;
        }
    }

    // ==========================================
    // ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø²ÙˆÙ…
    // ==========================================
// ==========================================
    // ØªÙ‡ÙŠØ¦Ø© Ø£Ø¯ÙˆØ§Øª Ø§Ù„ØªØ­ÙƒÙ… (Ø§Ù„Ø²ÙˆÙ… ÙˆØ§Ù„Ø´Ø§Ø´Ø©) - Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
    // ==========================================
    
    
    
initializeZoom() {
        // 1. Ø±Ø¨Ø· Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªØ­ÙƒÙ…
        const btnIn = document.getElementById('btn-zoom-in');
        const btnOut = document.getElementById('btn-zoom-out');
        const btnReset = document.getElementById('btn-zoom-reset');
        const btnFull = document.getElementById('btn-fullscreen');

        if(btnIn) btnIn.onclick = () => this.applyZoom(0.1);
        if(btnOut) btnOut.onclick = () => this.applyZoom(-0.1);
        
        // Ø²Ø± Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ¹ÙŠÙŠÙ†: ÙŠØ¹ÙŠØ¯Ùƒ Ù„Ù„Ù…Ù†ØªØµÙ
        if(btnReset) btnReset.onclick = () => {
            this.zoomLevel = 0.8;
            this.pan = { x: 1, y:1 };
            this.updateTransform();
        };

        if(btnFull) btnFull.onclick = () => this.toggleFullscreen();

        // 2. Ù…Ù†Ø·Ù‚ Ø³Ø­Ø¨ Ø§Ù„Ø®Ù„ÙÙŠØ© (Infinite Panning)
        // Ù†Ø³ØªØ®Ø¯Ù… parentElement Ù„Ø£Ù† flowCanvas Ø£ØµØ¨Ø­ ÙŠØªØ­Ø±Ùƒ
        const container = this.flowCanvas.parentElement; 
        
        container.addEventListener('mousedown', (e) => {
            // Ø§Ù„ØªØ­Ø±ÙŠÙƒ ÙÙ‚Ø· Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ù„Ø®Ù„ÙÙŠØ© Ø£Ùˆ Ø§Ù„ÙƒØ§Ù†ÙØ§Ø³ Ø§Ù„ÙØ§Ø±Øº
            if (e.target === container || e.target === this.flowCanvas) {
                this.isPanning = true;
                this.lastMouse = { x: e.clientX, y: e.clientY };
                container.style.cursor = 'grabbing';
                e.preventDefault();  
            }
        });

        window.addEventListener('mousemove', (e) => {
            if (!this.isPanning) return;
            e.preventDefault();
            
            const dx = e.clientX - this.lastMouse.x;
            const dy = e.clientY - this.lastMouse.y;
            
            this.pan.x += dx;
            this.pan.y += dy;
            
            this.lastMouse = { x: e.clientX, y: e.clientY };
            this.updateTransform();
        });

        window.addEventListener('mouseup', () => {
            this.isPanning = false;
            container.style.cursor = 'grab';
        });
    }

    // Ø¯ÙˆØ§Ù„ Ù…Ø³Ø§Ø¹Ø¯Ø© Ø¬Ø¯ÙŠØ¯Ø© (Ø£Ø¶ÙÙ‡Ø§ ØªØ­Øª initializeZoom)
    applyZoom(delta) {
        this.zoomLevel = Math.min(Math.max(0.4, this.zoomLevel + delta), 2.0);
        this.updateTransform();
    }

    updateTransform() {
        this.flowCanvas.style.transform = `translate(${this.pan.x}px, ${this.pan.y}px) scale(${this.zoomLevel})`;
        // Ù…Ù‡Ù… Ø¬Ø¯Ø§Ù‹: ØªØ­Ø¯ÙŠØ« jsPlumb Ù„ÙŠØ¹Ø±Ù Ø§Ù„Ù…Ù‚ÙŠØ§Ø³ Ø§Ù„Ø¬Ø¯ÙŠØ¯
        if(this.jsPlumbInstance) this.jsPlumbInstance.setZoom(this.zoomLevel);
    }

    toggleFullscreen() {
        const elem = document.getElementById('flow-builder-container');
        if (!document.fullscreenElement) {
            elem.requestFullscreen().catch(err => console.log(err));
        } else {
            document.exitFullscreen();
        }
    }

    // Ø¯Ø§Ù„Ø© Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ¹ÙŠÙŠÙ†
    resetZoom() {
        this.zoomLevel = 1.0;
        this.flowCanvas.style.transform = `scale(1)`;
        this.flowCanvas.style.transformOrigin = "0 0";
        if(this.jsPlumbInstance) {
            this.jsPlumbInstance.setZoom(1);
        }
    }





    saveNodePositions() {
        // ÙŠÙ…ÙƒÙ† Ø­ÙØ¸ Ø§Ù„Ù…ÙˆØ§Ù‚Ø¹ Ø¥Ø°Ø§ Ù„Ø²Ù… Ø§Ù„Ø£Ù…Ø±
    }

    addVariable() {
        const variableName = prompt('Enter variable name:');
        if (!variableName) return;
        const variableValue = prompt('Enter variable value:');
        this.showNotification(`Variable added: ${variableName}`, 'success');
    }

    clearCanvas(silent = false) {
        if (!silent && !confirm('Are you sure you want to clear the canvas? All nodes and connections will be lost.')) {
            return;
        }
        // Ø¥Ø²Ø§Ù„Ø© Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¹Ù‚Ø¯
        document.querySelectorAll('.flow-node').forEach(node => {
            if (this.jsPlumbInstance) {
                this.jsPlumbInstance.removeAllEndpoints(node.id);
            }
            node.remove();
        });
      
        // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø¹Ø¯Ø§Ø¯
        this.nodeCounter = 0;
        this.updateStats();
        this.hasUnsavedChanges = false;
        if (!silent) {
            this.showNotification('Canvas cleared successfully', 'success');
        }
    }

    autoLayout() {
        const nodes = document.querySelectorAll('.flow-node');
        if (nodes.length === 0) {
            this.showNotification('No nodes to arrange', 'warning');
            return;
        }
      
        const canvasWidth = this.flowCanvas.clientWidth;
        const nodeWidth = 280;
        const horizontalSpacing = 100;
        const verticalSpacing = 120;
      
        let x = 100;
        let y = 100;
        let rowHeight = 0;
      
        nodes.forEach((node, index) => {
            node.style.left = x + 'px';
            node.style.top = y + 'px';
          
            const nodeHeight = node.offsetHeight;
            rowHeight = Math.max(rowHeight, nodeHeight);
          
            x += nodeWidth + horizontalSpacing;
          
            if (x + nodeWidth > canvasWidth - 100) {
                x = 100;
                y += rowHeight + verticalSpacing;
                rowHeight = 0;
            }
          
            if (this.jsPlumbInstance) {
                this.jsPlumbInstance.revalidate(node.id);
            }
        });
      
        if (this.jsPlumbInstance) {
            this.jsPlumbInstance.repaintEverything();
        }
        this.showNotification('Nodes auto-arranged successfully', 'success');
    }

    removeNode(nodeId) {
        if (confirm('Are you sure you want to delete this node?')) {
            if (this.jsPlumbInstance) {
                this.jsPlumbInstance.removeAllEndpoints(nodeId);
                this.jsPlumbInstance.deleteConnectionsForElement(nodeId);
            }
          
            document.getElementById(nodeId)?.remove();
          
            if (this.selectedNode && this.selectedNode.id === nodeId) {
                this.selectedNode = null;
            }
            this.hasUnsavedChanges = true;
            this.updateStats();
            this.showNotification('Node deleted', 'success');
        }
    }

    connectNode(nodeId, branch = null) {
        if (this.connectionMode && this.connectionSource === nodeId) {
            this.cancelConnectionMode();
        } else {
            this.enableConnectionMode(nodeId, branch);
        }
    }

    enableConnectionMode(sourceNodeId, branch = null) {
        this.connectionMode = true;
        this.connectionSource = sourceNodeId;
        this.connectionBranch = branch;
      
        const sourceNode = document.getElementById(sourceNodeId);
        if (sourceNode) {
            sourceNode.style.boxShadow = '0 0 0 3px #10b981';
            sourceNode.classList.add('connection-source');
        }
      
        document.body.style.cursor = 'crosshair';
        this.showNotification('Click on target node to connect. Press ESC to cancel.', 'info');
      
        this.escapeHandler = (e) => {
            if (e.key === 'Escape') {
                this.cancelConnectionMode();
            }
        };
        document.addEventListener('keydown', this.escapeHandler);
      
        this.connectionClickHandler = (e) => this.handleConnectionTarget(e);
        this.flowCanvas.addEventListener('click', this.connectionClickHandler);
    }

    cancelConnectionMode() {
        this.connectionMode = false;
        if (this.connectionSource) {
            const sourceNode = document.getElementById(this.connectionSource);
            if (sourceNode) {
                sourceNode.style.boxShadow = '';
                sourceNode.classList.remove('connection-source');
            }
        }
        this.connectionSource = null;
        this.connectionBranch = null;
        document.body.style.cursor = '';
      
        if (this.escapeHandler) {
            document.removeEventListener('keydown', this.escapeHandler);
        }
        if (this.connectionClickHandler) {
            this.flowCanvas.removeEventListener('click', this.connectionClickHandler);
        }
      
        this.showNotification('Connection mode cancelled', 'info');
    }

    handleConnectionTarget(e) {
        if (!this.connectionMode) return;
      
        const targetNode = e.target.closest('.flow-node');
        if (!targetNode) return;
      
        const targetNodeId = targetNode.id;
      
        if (targetNodeId === this.connectionSource) {
            this.showNotification('Cannot connect to the same node', 'error');
            return;
        }
      
        this.createConnection(this.connectionSource, targetNodeId, this.connectionBranch);
        this.cancelConnectionMode();
    }

    createConnection(sourceId, targetId, branch = null) {
        console.log('Creating connection fromb-----------', sourceId, 'to', targetId);
      
        if (!this.jsPlumbInstance) return;
        try {
            const existing = this.jsPlumbInstance.getConnections({
                source: sourceId,
                target: targetId
            });
            if (existing && existing.length > 0) {
                this.showNotification('Connection already exists', 'warning');
                return;
            }
            const connection = this.jsPlumbInstance.connect({
                source: sourceId,
                target: targetId,
                overlays: [
                    ["Arrow", {
                        location: 1,
                        width: 12,
                        length: 12,
                        foldback: 0.8
                    }]
                ],
                anchors: ["Right", "Left"],
                paintStyle: {
                    stroke: "#7C3AED",
                    strokeWidth: 2
                },
                hoverPaintStyle: {
                    stroke: "#10B981",
                    strokeWidth: 3
                }
            });
            if (connection) {
                if (branch) {
                    connection.setData({ branch: branch });
                }
                this.showNotification('Connection created successfully', 'success');
                this.updateStats();
            }
        } catch (error) {
            console.error('Error creating connection:', error);
            this.showNotification('Failed to create connection', 'error');
        }
    }

    selectNode(nodeId) {
        if (this.selectedNode) {
            this.selectedNode.classList.remove('selected');
        }
      
        this.selectedNode = document.getElementById(nodeId);
        if (this.selectedNode) {
            this.selectedNode.classList.add('selected');
        }
    }

    addSampleFlow() {
        this.createNode('trigger', 100, 100);
        this.createNode('text-message', 450, 100);
        this.createNode('condition', 800, 100);
        this.createNode('text-message', 600, 250);
        this.createNode('media-message', 900, 250);
    }

    async apiGet(url) {
        const response = await fetch(url, {
            headers: { 'Accept': 'application/json' }
        });
        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        return response.json();
    }

    async apiPost(url, data) {
        try {
            const response = await fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': this.csrfToken
                },
                body: JSON.stringify(data)
            });
            if (!response.ok) {
                let errorMessage = `HTTP ${response.status}`;
                try {
                    const errorData = await response.json();
                    errorMessage = errorData.error || errorData.details || errorMessage;
                } catch (e) {
                    const text = await response.text();
                    errorMessage = text || errorMessage;
                }
                throw new Error(errorMessage);
            }
          
            return await response.json();
        } catch (error) {
            console.error('API POST Error:', error);
            throw error;
        }
    }

    async handleAiNodeMediaFile(file, nodeId, mediaListEl, saveHintEl) {
        const flowId = this.currentFlowId;
        if (!flowId) {
            if (saveHintEl) saveHintEl.style.display = 'block';
            return;
        }
        const isVideo = (file.type || '').toLowerCase().startsWith('video/');
        const fileType = isVideo ? 'Video' : 'Image';
        const desc = (file.name || 'Media').replace(/\.[^.]*$/, '');
        const form = new FormData();
        form.append('flow_id', flowId);
        form.append('node_id', nodeId);
        form.append('file', file);
        form.append('file_type', fileType);
        form.append('description', desc);
        form.append('csrfmiddlewaretoken', this.csrfToken || '');
        try {
            const baseUrl = '/discount/whatssapAPI';
            const r = await fetch(baseUrl + '/api/flows/node-media-upload/', {
                method: 'POST',
                body: form,
                headers: { 'X-CSRFToken': this.csrfToken || '' }
            });
            const j = await r.json();
            if (j.error) { alert(j.error); return; }
            const row = document.createElement('div');
            row.className = 'ai-agent-media-row';
            row.style.cssText = 'display:flex; align-items:center; gap:6px; margin-bottom:6px; font-size:0.8rem;';
            row.dataset.filePath = j.file_path || '';
            row.dataset.fileType = j.file_type || fileType;
            const labelInput = document.createElement('input');
            labelInput.type = 'text';
            labelInput.className = 'form-input ai-agent-media-description';
            labelInput.placeholder = 'Label for AI';
            labelInput.value = j.description || desc;
            labelInput.style.flex = '1';
            labelInput.style.minWidth = '0';
            const delBtn = document.createElement('button');
            delBtn.type = 'button';
            delBtn.className = 'btn btn-danger btn-sm';
            delBtn.textContent = 'âœ•';
            delBtn.addEventListener('click', () => row.remove());
            row.appendChild(labelInput);
            row.appendChild(delBtn);
            mediaListEl.appendChild(row);
            if (saveHintEl) saveHintEl.style.display = 'none';
        } catch (e) {
            alert('Upload failed: ' + (e.message || e));
        }
    }

    showNotification(message, type = 'info') {
        const notification = document.createElement('div');
        notification.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 12px 20px;
            border-radius: 8px;
            color: white;
            font-weight: 500;
            z-index: 10000;
            transition: all 0.3s ease;
            background: ${type === 'success' ? '#10B981' : type === 'error' ? '#EF4444' : '#3B82F6'};
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.5);
        `;
        notification.textContent = message;
        document.body.appendChild(notification);
        setTimeout(() => {
            notification.style.opacity = '0';
            setTimeout(() => notification.remove(), 300);
        }, 3000);
    }
}
    // ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
    let automationsList;
    let flowBuilder;
    document.addEventListener('DOMContentLoaded', () => {
        automationsList = new AutomationsList();
       
        function initializeFlowBuilder() {
            if (typeof jsPlumb !== 'undefined') {
                flowBuilder = new FlowBuilder();
                window.flowBuilder = flowBuilder;
                console.log('âœ… FlowBuilder initialized successfully');
            } else {
                console.log('â³ Waiting for jsPlumb to load...');
                setTimeout(initializeFlowBuilder, 100);
            }
        }
       
        initializeFlowBuilder();

        // AI Product modal: Confirm & Cancel (one-time bind)
        const aiProductModal = document.getElementById('aiProductConfirmModal');
        const aiProductCancelBtn = document.getElementById('ai-product-confirm-cancel');
        const aiProductOkBtn = document.getElementById('ai-product-confirm-ok');
        if (aiProductModal && aiProductCancelBtn && aiProductOkBtn) {
            document.querySelectorAll('.ai-product-field').forEach(field => {
                field.addEventListener('input', () => { field.classList.remove('is-invalid'); });
                field.addEventListener('change', () => { field.classList.remove('is-invalid'); });
            });
            const errName = document.getElementById('ai-product-err-name');
            const errPrices = document.getElementById('ai-product-err-prices');
            const errShipping = document.getElementById('ai-product-err-shipping');
            document.getElementById('ai-product-edit-name')?.addEventListener('input', () => { if (errName) errName.textContent = ''; });
            document.getElementById('ai-product-edit-prices')?.addEventListener('input', () => { if (errPrices) errPrices.textContent = ''; });
            document.getElementById('ai-product-edit-shipping')?.addEventListener('change', () => { if (errShipping) errShipping.textContent = ''; });
            aiProductCancelBtn.addEventListener('click', () => {
                aiProductModal.style.display = 'none';
                delete aiProductModal.dataset.targetNodeId;
                window.aiProductClearValidationErrors && window.aiProductClearValidationErrors();
            });
            const apmBackdrop = aiProductModal.querySelector('.apm-backdrop');
            if (apmBackdrop) apmBackdrop.addEventListener('click', () => {
                aiProductModal.style.display = 'none';
                delete aiProductModal.dataset.targetNodeId;
                window.aiProductClearValidationErrors && window.aiProductClearValidationErrors();
            });

            window.aiProductClearValidationErrors = function() {
                ['ai-product-err-name', 'ai-product-err-prices', 'ai-product-err-shipping'].forEach(id => {
                    const el = document.getElementById(id);
                    if (el) { el.textContent = ''; el.classList.remove('is-visible'); }
                });
                document.querySelectorAll('.ai-product-field').forEach(f => f.classList.remove('is-invalid'));
            };

            window.aiProductValidateForm = function() {
                window.aiProductClearValidationErrors();
                const name = (document.getElementById('ai-product-edit-name')?.value || '').trim();
                const prices = (document.getElementById('ai-product-edit-prices')?.value || '').trim();
                const shipping = (document.getElementById('ai-product-edit-shipping')?.value || '').trim();
                let valid = true;
                const errName = document.getElementById('ai-product-err-name');
                const errPrices = document.getElementById('ai-product-err-prices');
                const errShipping = document.getElementById('ai-product-err-shipping');
                const nameIn = document.getElementById('ai-product-edit-name');
                const pricesIn = document.getElementById('ai-product-edit-prices');
                const shippingIn = document.getElementById('ai-product-edit-shipping');
                if (!name) {
                    if (errName) { errName.textContent = 'Product name is required.'; errName.classList.add('is-visible'); }
                    if (nameIn) nameIn.classList.add('is-invalid');
                    valid = false;
                }
                if (!prices) {
                    if (errPrices) { errPrices.textContent = 'Prices are required.'; errPrices.classList.add('is-visible'); }
                    if (pricesIn) pricesIn.classList.add('is-invalid');
                    valid = false;
                }
                if (shipping !== 'Free' && shipping !== 'Paid') {
                    if (errShipping) { errShipping.textContent = 'Please select Free or Paid.'; errShipping.classList.add('is-visible'); }
                    if (shippingIn) shippingIn.classList.add('is-invalid');
                    valid = false;
                }
                return valid;
            };

            aiProductOkBtn.addEventListener('click', () => {
                if (!window.aiProductValidateForm()) return;
                const nodeId = aiProductModal.dataset.targetNodeId;
                if (!nodeId) { aiProductModal.style.display = 'none'; return; }
                const nodeEl = document.getElementById(nodeId);
                const name = (document.getElementById('ai-product-edit-name')?.value || '').trim();
                const prices = (document.getElementById('ai-product-edit-prices')?.value || '').trim();
                const shipping = (document.getElementById('ai-product-edit-shipping')?.value || '').trim();
                const market = (document.getElementById('ai-product-edit-market')?.value || '').trim() || 'Morocco';
                const additional = (document.getElementById('ai-product-edit-additional')?.value || '').trim();
                const parts = [];
                parts.push('Product name: ' + name);
                parts.push('Prices: ' + prices);
                parts.push('Shipping: ' + (shipping === 'Free' || shipping === 'Paid' ? shipping : ''));
                parts.push('Market: ' + market);
                if (additional) parts.push(additional);
                const fullText = parts.join('\n\n');
                if (nodeEl) {
                    const ta = nodeEl.querySelector('.ai-agent-product-context');
                    const summary = nodeEl.querySelector('.ai-agent-product-summary');
                    const nameSpan = nodeEl.querySelector('.ai-agent-summary-name');
                    const pricesSpan = nodeEl.querySelector('.ai-agent-summary-prices');
                    const shippingSpan = nodeEl.querySelector('.ai-agent-summary-shipping');
                    const marketSpan = nodeEl.querySelector('.ai-agent-summary-market');
                    if (ta) ta.value = fullText;
                    if (summary && nameSpan && pricesSpan && marketSpan) {
                        nameSpan.textContent = name || 'â€”';
                        pricesSpan.textContent = prices ? (prices.length > 80 ? prices.slice(0, 80) + 'â€¦' : prices) : 'â€”';
                        if (shippingSpan) shippingSpan.textContent = shipping === 'Free' || shipping === 'Paid' ? shipping : 'â€”';
                        marketSpan.textContent = market || 'Morocco';
                        summary.style.display = 'block';
                    }
                }
                aiProductModal.style.display = 'none';
                delete aiProductModal.dataset.targetNodeId;
                window.aiProductClearValidationErrors && window.aiProductClearValidationErrors();
            });
        }
    });

    function showAutomationsList() {
        if (automationsList) {
            automationsList.showAutomationsList();
        }
    }
</script>



<!-- AI Product Edit & Confirm Modal -->
<div id="aiProductConfirmModal" class="apm-overlay" style="display: none;" aria-modal="true" role="dialog" aria-labelledby="apm-title">
    <div class="apm-backdrop" data-dismiss="modal"></div>
    <div class="apm-card">
        <header class="apm-header">
            <div class="apm-header-icon" aria-hidden="true">ğŸ“¦</div>
            <h2 id="apm-title" class="apm-title">Edit product data</h2>
            <p class="apm-subtitle">Review and edit the extracted data. Fields marked with <span class="apm-asterisk">*</span> are required.</p>
        </header>
        <div class="apm-body">
            <section class="apm-section">
                <label class="apm-label apm-label-required" for="ai-product-edit-name">Product name <span class="apm-asterisk">*</span></label>
                <input type="text" id="ai-product-edit-name" class="apm-input ai-product-field" placeholder="e.g. Wireless Headphones Pro" maxlength="500" autocomplete="off">
                <span class="apm-error" id="ai-product-err-name" aria-live="polite"></span>
            </section>
            <section class="apm-section">
                <label class="apm-label apm-label-required" for="ai-product-edit-prices">Prices <span class="apm-asterisk">*</span></label>
                <textarea id="ai-product-edit-prices" class="apm-textarea ai-product-field" rows="2" placeholder="e.g. 299 MAD, 29.99 USD" maxlength="1500"></textarea>
                <span class="apm-error" id="ai-product-err-prices" aria-live="polite"></span>
            </section>
            <section class="apm-section">
                <label class="apm-label apm-label-required" for="ai-product-edit-shipping">Shipping method <span class="apm-asterisk">*</span></label>
                <select id="ai-product-edit-shipping" class="apm-select ai-product-field" aria-describedby="ai-product-err-shipping">
                    <option value="">Select...</option>
                    <option value="Free">Free</option>
                    <option value="Paid">Paid</option>
                </select>
                <span class="apm-error" id="ai-product-err-shipping" aria-live="polite"></span>
            </section>
            <section class="apm-section">
                <label class="apm-label" for="ai-product-edit-market">Market</label>
                <input type="text" id="ai-product-edit-market" class="apm-input ai-product-field" placeholder="e.g. Morocco" value="Morocco" maxlength="500">
            </section>
            <section class="apm-section">
                <label class="apm-label" for="ai-product-edit-additional">Additional details</label>
                <textarea id="ai-product-edit-additional"  style="min-height: 186px;" class="apm-textarea ai-product-field" rows="3" placeholder="Specs, features, delivery info..."></textarea>
            </section>
        </div>
        <footer class="apm-footer">
            <button type="button" id="ai-product-confirm-cancel" class="apm-btn apm-btn-secondary">Cancel</button>
            <button type="button" id="ai-product-confirm-ok" class="apm-btn apm-btn-primary">Confirm &amp; save</button>
        </footer>
    </div>
</div>

<!-- Create Flow Modal -->
<div id="createFlowModal" class="cf-modal">
    <div class="cf-modal-content">
        <h2 style="color: black;">Create New Flow</h2>

        <label>Flow Name</label>
        <input type="text" id="cf-name" class="cf-input" placeholder="Enter flow name">

        <label>Description</label>
        <textarea id="cf-desc" class="cf-textarea" placeholder="Enter description"></textarea>

        <div class="cf-actions">
            <button id="cf-cancel" class="cf-btn cf-cancel">Cancel</button>
            <button id="cf-save" class="cf-btn cf-save">Save</button>
        </div>
    </div>
</div>

<style> 
.cf-modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    display: none;
    background: rgba(0,0,0,0.45);
    backdrop-filter: blur(3px);
    justify-content: center;
    align-items: center;
    z-index: 9999;
}



.cf-modal label {
    font-size: 14px;
    font-weight: 500;
    margin-bottom: 6px;
    display: block;
    color:#0F172A;
    font-family: 'Franklin Gothic Medium', 'Arial Narrow', Arial, sans-serif;
}
.cf-modal-content {
    width: 380px;
    background: #fff;
    padding: 22px;
    border-radius: 14px;
    box-shadow: 0 8px 25px rgba(0,0,0,0.15);
    display: flex;
    flex-direction: column;
    gap: 12px;
    font-family: sans-serif;
}

.cf-modal-content h2 {
    margin: 0;
    font-size: 20px;
    font-weight: 600;
}

.cf-input, .cf-textarea {
    width: 100%;
    padding: 10px;
    border-radius: 8px;
    border: 1.5px solid #ddd;
    font-size: 15px;
}

.cf-textarea {
    min-height: 80px;
    resize: vertical;
}

.cf-actions {
    display: flex;
    justify-content: flex-end;
    gap: 10px;
    margin-top: 8px;
}

.cf-btn {
    padding: 10px 18px;
    font-size: 15px;
    border-radius: 8px;
    cursor: pointer;
    border: none;
    transition: 0.2s;
}

.cf-cancel {
    border: 1px solid #4b7cff;
    color: black;
    background: #0000002b;
}

.cf-cancel:hover {
    background: #ddd;
}

.cf-save {
    background: #4a7cff;
    color: white;
}

.cf-save:hover {
    background: #3a68d8;
}

/* AI Product modal: validation & layout */
/* ========== AI Product Modal â€” professional overlay ========== */
#aiProductConfirmModal.apm-overlay {
    position: fixed;
    inset: 0;
    z-index: 9999;
    display: none;
    align-items: center;
    justify-content: center;
    padding: 1.5rem;
    box-sizing: border-box;
}
.apm-backdrop {
    position: absolute;
    inset: 0;
    background: rgba(15, 23, 42, 0.52);
    backdrop-filter: blur(8px);
    -webkit-backdrop-filter: blur(8px);
}
.apm-card {
    position: relative;
    width: 100%;
    max-width: 520px;
    max-height: calc(100vh - 3rem);
    overflow: hidden;
    display: flex;
    flex-direction: column;
    background: #ffffff;
    border-radius: 16px;
    box-shadow: 0 24px 48px rgba(15, 23, 42, 0.18), 0 0 0 1px rgba(15, 23, 42, 0.06);
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
}
.apm-header {
    flex-shrink: 0;
    padding: 1.5rem 1.75rem 0;
    text-align: center;
}
.apm-header-icon {
    width: 48px;
    height: 48px;
    margin: 0 auto 0.75rem;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.5rem;
    background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
    border-radius: 12px;
    color: #0c4a6e;
}
.apm-title {
    margin: 0 0 0.25rem 0;
    font-size: 1.35rem;
    font-weight: 700;
    color: #0f172a;
    letter-spacing: -0.02em;
    line-height: 1.3;
}
.apm-subtitle {
    margin: 0 0 0 0;
    font-size: 0.8125rem;
    color: #64748b;
    line-height: 1.45;
    max-width: 36ch;
    margin-left: auto;
    margin-right: auto;
}
.apm-asterisk { color: #b91c1c; font-weight: 600; }
.apm-body {
    flex: 1;
    overflow-y: auto;
    padding: 1.25rem 1.75rem 1rem;
}
.apm-section {
    margin-bottom: 1.1rem;
}
.apm-section:last-of-type { margin-bottom: 0; }
.apm-label {
    display: block;
    font-size: 0.8125rem;
    font-weight: 600;
    color: #334155;
    margin-bottom: 0.4rem;
    letter-spacing: 0.01em;
}
.apm-label-required { color: #1e293b; }
.apm-input,
.apm-textarea,
.apm-select {
    width: 100%;
    padding: 0.625rem 0.875rem;
    font-size: 0.9375rem;
    line-height: 1.45;
    color: #0f172a;
    background: #f8fafc;
    border: 1px solid #e2e8f0;
    border-radius: 10px;
    transition: border-color 0.2s ease, box-shadow 0.2s ease, background-color 0.2s ease;
    box-sizing: border-box;
}
.apm-input::placeholder,
.apm-textarea::placeholder { color: #94a3b8; }
.apm-input:hover,
.apm-textarea:hover,
.apm-select:hover {
    border-color: #cbd5e1;
}
.apm-input:focus,
.apm-textarea:focus,
.apm-select:focus {
    outline: none;
    border-color: #3b82f6;
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.18);
    background: #fff;
}
.apm-textarea {
    min-height: 72px;
    resize: vertical;
}
.apm-select {
    cursor: pointer;
    appearance: none;
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%2364748b' stroke-width='2'%3E%3Cpath d='M6 9l6 6 6-6'/%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: right 0.75rem center;
    padding-right: 2.25rem;
}
.apm-error {
    display: block;
    font-size: 0.75rem;
    color: #b91c1c;
    margin-top: 0.35rem;
    min-height: 1.125rem;
    visibility: hidden;
}
.apm-error.is-visible { visibility: visible; }
.ai-product-field.is-invalid {
    border-color: #b91c1c !important;
    box-shadow: 0 0 0 2px rgba(185, 28, 28, 0.12) !important;
    background: #fef2f2 !important;
}
.apm-footer {
    flex-shrink: 0;
    display: flex;
    justify-content: flex-end;
    gap: 0.75rem;
    padding: 1rem 1.75rem 1.5rem;
    border-top: 1px solid #f1f5f9;
    background: #fafbfc;
}
.apm-btn {
    padding: 0.625rem 1.25rem;
    font-size: 0.9375rem;
    font-weight: 600;
    border-radius: 10px;
    cursor: pointer;
    transition: background-color 0.2s ease, color 0.2s ease, border-color 0.2s ease, box-shadow 0.2s ease;
    border: none;
    font-family: inherit;
}
.apm-btn-secondary {
    color: #475569;
    background: #fff;
    border: 1px solid #e2e8f0;
}
.apm-btn-secondary:hover {
    background: #f8fafc;
    border-color: #cbd5e1;
    color: #334155;
}
.apm-btn-primary {
    color: #fff;
    background: linear-gradient(180deg, #2563eb 0%, #1d4ed8 100%);
    box-shadow: 0 1px 2px rgba(0,0,0,0.06);
}
.apm-btn-primary:hover {
    background: linear-gradient(180deg, #1d4ed8 0%, #1e40af 100%);
    box-shadow: 0 2px 8px rgba(37, 99, 235, 0.35);
}
/* â€”â€” Persona section (Identity tab) â€”â€” */
.persona-section { margin-bottom: 0; }
.persona-section-header { margin-bottom: 14px; }
.persona-section-title {
  font-size: 0.95rem;
  font-weight: 600;
  color: #e2e8f0;
  margin: 0 0 4px 0;
  letter-spacing: -0.01em;
}
.persona-section-desc {
  font-size: 0.75rem;
  color: #94a3b8;
  line-height: 1.4;
  margin: 0;
}
.persona-tabs-wrap {
  margin-bottom: 12px;
}
.ai-agent-persona-tabs {
  display: flex;
  gap: 6px;
  padding: 4px;
  background: rgba(0,0,0,0.2);
  border-radius: 10px;
  width: fit-content;
}
.ai-agent-persona-tab {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  padding: 8px 14px;
  font-size: 0.8rem;
  font-weight: 500;
  color: #94a3b8;
  background: transparent;
  border: none;
  border-radius: 8px;
  cursor: pointer;
  transition: color 0.2s, background 0.2s;
}
.ai-agent-persona-tab:hover {
  color: #e2e8f0;
  background: rgba(255,255,255,0.06);
}
.ai-agent-persona-tab.active {
  color: #fff;
  background: #4d71ab;
  box-shadow: 0 1px 3px rgba(0,0,0,0.2);
}
.persona-tab-icon { font-size: 0.9rem; opacity: 0.9; }
.persona-gallery-wrap {
  min-height: 120px;
  padding: 12px;
  background: rgba(0,0,0,0.15);
  border: 1px solid rgba(255,255,255,0.08);
  border-radius: 12px;
}
.ai-agent-persona-gallery {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
  gap: 10px;
  max-height: 220px;
  overflow-y: auto;
  overflow-x: hidden;
}
.ai-agent-persona-gallery::-webkit-scrollbar { width: 6px; }
.ai-agent-persona-gallery::-webkit-scrollbar-track { background: rgba(255,255,255,0.05); border-radius: 3px; }
.ai-agent-persona-gallery::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.15); border-radius: 3px; }
.persona-premium-banner {
  display: flex;
  align-items: center;
  gap: 8px;
  margin-top: 12px;
  padding: 10px 12px;
  font-size: 0.75rem;
  color: #f59e0b;
  background: rgba(245, 158, 11, 0.1);
  border: 1px solid rgba(245, 158, 11, 0.25);
  border-radius: 8px;
}
.persona-premium-icon { font-size: 1rem; }
/* â€”â€” Persona cards (injected by JS) â€”â€” */
.ai-agent-persona-card {
  border: 1px solid rgba(255,255,255,0.1);
  border-radius: 12px;
  padding: 12px;
  cursor: pointer;
  text-align: center;
  transition: border-color 0.2s, background 0.2s, box-shadow 0.2s;
  background: rgba(255,255,255,0.04);
  position: relative;
}
.ai-agent-persona-card:hover {
  border-color: rgba(77, 113, 171, 0.5);
  background: rgba(77, 113, 171, 0.12);
  box-shadow: 0 2px 8px rgba(0,0,0,0.15);
}
.ai-agent-persona-card.selected {
  border-color: #4d71ab;
  background: rgba(77, 113, 171, 0.2);
  box-shadow: 0 0 0 1px #4d71ab;
}
.ai-agent-persona-card .name {
  font-weight: 600;
  font-size: 0.8rem;
  color: #e2e8f0;
  margin-bottom: 6px;
  line-height: 1.3;
  min-height: 2.6em;
  display: -webkit-box;
  -webkit-line-clamp: 2;
  -webkit-box-orient: vertical;
  overflow: hidden;
}
.ai-agent-persona-card .desc {
  font-size: 0.7rem;
  color: #94a3b8;
  margin-bottom: 10px;
  line-height: 1.35;
  display: -webkit-box;
  -webkit-line-clamp: 2;
  -webkit-box-orient: vertical;
  overflow: hidden;
}
.ai-agent-persona-card .play-btn {
  font-size: 0.7rem;
  padding: 5px 10px;
  border-radius: 6px;
  border: 1px solid rgba(255,255,255,0.2);
  background: rgba(255,255,255,0.06);
  color: #94a3b8;
  cursor: pointer;
  transition: background 0.2s, color 0.2s;
}
.ai-agent-persona-card .play-btn:hover {
  background: rgba(77, 113, 171, 0.3);
  color: #e2e8f0;
  border-color: #4d71ab;
}
/* Empty state when no personas / no cloned voices */
.persona-gallery-empty {
  grid-column: 1 / -1;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  padding: 24px 16px;
  text-align: center;
  color: #94a3b8;
  background: rgba(255,255,255,0.03);
  border: 1px dashed rgba(255,255,255,0.12);
  border-radius: 10px;
  min-height: 100px;
}
.persona-gallery-empty-icon { font-size: 1.5rem; margin-bottom: 8px; opacity: 0.7; }
.persona-gallery-empty-text { font-size: 0.8rem; margin: 0 0 4px 0; color: #94a3b8; }
.persona-gallery-empty-hint { font-size: 0.7rem; margin: 0; color: #64748b; }

/* â€”â€” AI Node conditional visibility (Voice Settings / Provider / Gender) â€”â€” */
.ai-agent-visibility-transition {
  transition: opacity 0.25s ease, max-height 0.3s ease;
  overflow: hidden;
}
.ai-agent-voice-settings-section.ai-agent-visibility-hidden {
  max-height: 0 !important;
  opacity: 0;
  pointer-events: none;
  visibility: hidden;
  margin: 0 !important;
  padding: 0 !important;
  border: none !important;
}
.ai-agent-voice-settings-section:not(.ai-agent-visibility-hidden) {
  max-height: 1200px;
  opacity: 1;
}
.ai-agent-sliders-inner {
  transition: opacity 0.2s ease;
}
.ai-agent-voice-sliders-wrap.ai-agent-visibility-hidden .ai-agent-sliders-inner {
  opacity: 0;
  pointer-events: none;
  max-height: 0;
  overflow: hidden;
}
.ai-agent-persona-card.ai-agent-persona-filtered-out {
  display: none !important;
}
 </style>
<script>
(function() {
  function getChannelId() {
    return (typeof window.currentChannelId !== 'undefined' && window.currentChannelId) || (document.querySelector('[data-current-channel-id]') && document.querySelector('[data-current-channel-id]').getAttribute('data-current-channel-id')) || '';
  }

  /** OpenAI tts-1 voice_id -> gender (for filtering) */
  var OPENAI_VOICE_GENDER = { alloy: 'MALE', onyx: 'MALE', nova: 'FEMALE', shimmer: 'FEMALE', echo: 'MALE', fable: 'MALE' };

  /**
   * Apply conditional visibility for AI Node: response_mode, provider, gender.
   * Call on load, when response_mode/voice_provider/gender change, and after persona gallery load.
   */
  window.applyAiNodeVisibility = function(node) {
    if (!node || !node.querySelector) return;
    var responseModeEl = node.querySelector('.ai-agent-response-mode');
    var voiceSection = node.querySelector('.ai-agent-voice-settings-section');
    var providerEl = node.querySelector('.ai-agent-voice-provider');
    var genderEl = node.querySelector('.ai-agent-node-gender');
    var slidersWrap = node.querySelector('.ai-agent-voice-sliders-wrap');
    var openaiNote = node.querySelector('.ai-agent-openai-note');
    var noVoicesMsg = node.querySelector('.ai-agent-no-voices-msg');
    var personaIdInput = node.querySelector('.ai-agent-persona-id');

    var responseMode = (responseModeEl && responseModeEl.value) ? responseModeEl.value : 'TEXT_ONLY';
    var provider = (providerEl && providerEl.value) ? providerEl.value.trim().toUpperCase() : 'ELEVENLABS';
    var gender = (genderEl && genderEl.value) ? genderEl.value.trim() : '';

    // Level 1: Response mode -> hide/show entire Voice Settings (Language stays visible)
    if (voiceSection) {
      if (responseMode === 'TEXT_ONLY') {
        voiceSection.classList.add('ai-agent-visibility-hidden');
      } else {
        voiceSection.classList.remove('ai-agent-visibility-hidden');
      }
    }

    // Level 2: Provider -> hide sliders for OpenAI, show note
    if (slidersWrap) {
      if (provider === 'OPENAI') {
        slidersWrap.classList.add('ai-agent-visibility-hidden');
      } else {
        slidersWrap.classList.remove('ai-agent-visibility-hidden');
      }
    }
    if (openaiNote) {
      openaiNote.style.display = provider === 'OPENAI' ? 'block' : 'none';
    }

    // Level 3: Filter persona cards by provider + gender; reset selection if invalid
    var cards = node.querySelectorAll('.ai-agent-persona-card');
    var visibleCount = 0;
    var firstVisibleId = null;
    cards.forEach(function(card) {
      var cardProvider = (card.dataset.provider || 'ELEVENLABS').toUpperCase();
      var cardGender = (card.dataset.gender || '').trim();
      var providerMatch = cardProvider === provider;
      var genderMatch = !gender || !cardGender || cardGender === gender;
      var show = providerMatch && genderMatch;
      if (show) {
        card.classList.remove('ai-agent-persona-filtered-out');
        visibleCount++;
        if (firstVisibleId === null) firstVisibleId = card.dataset.personaId;
      } else {
        card.classList.add('ai-agent-persona-filtered-out');
      }
    });
    if (personaIdInput && visibleCount > 0) {
      var currentId = personaIdInput.value ? parseInt(personaIdInput.value, 10) : null;
      var currentCard = node.querySelector('.ai-agent-persona-card.selected');
      var currentStillVisible = currentCard && !currentCard.classList.contains('ai-agent-persona-filtered-out');
      if (currentId && !currentStillVisible) {
        personaIdInput.value = firstVisibleId || '';
        node.querySelectorAll('.ai-agent-persona-card').forEach(function(c) { c.classList.remove('selected'); });
        var firstCard = node.querySelector('.ai-agent-persona-card:not(.ai-agent-persona-filtered-out)');
        if (firstCard) firstCard.classList.add('selected');
      }
    }
    if (noVoicesMsg) {
      noVoicesMsg.style.display = visibleCount === 0 ? 'flex' : 'none';
    }
  };

  window.loadAiAgentPersonaGalleries = function(node) {
    var stdGallery = node && node.querySelector('.ai-agent-persona-gallery-standard');
    var myGallery = node && node.querySelector('.ai-agent-persona-gallery-my');
    var personaIdInput = node && node.querySelector('.ai-agent-persona-id');
    var selectedId = personaIdInput ? (personaIdInput.value ? parseInt(personaIdInput.value, 10) : null) : null;
    if (!stdGallery) return;
    var base = (typeof window.location !== 'undefined' && window.location.origin) ? window.location.origin : '';
    var apiBase = base + '/discount/whatssapAPI';
    fetch(apiBase + '/api/personas/')
      .then(function(r) { return r.json(); })
      .then(function(data) {
        if (!data.success) return;
        function renderCard(p) {
          var card = document.createElement('div');
          card.className = 'ai-agent-persona-card';
          card.dataset.personaId = p.id;
          card.dataset.provider = (p.provider || 'ELEVENLABS').toUpperCase();
          var voiceId = (p.voice_id || '').toLowerCase();
          if (card.dataset.provider === 'OPENAI' && OPENAI_VOICE_GENDER[voiceId]) card.dataset.gender = OPENAI_VOICE_GENDER[voiceId];
          else if (p.gender) card.dataset.gender = (p.gender || '').toUpperCase();
          if (selectedId === p.id) card.classList.add('selected');
          card.innerHTML = '<div class="name">' + (p.name || '') + '</div><div class="desc">' + (p.description || '').substring(0, 60) + '</div><button type="button" class="btn btn-sm btn-outline-secondary play-btn ai-agent-play-sample">Play</button>';
          card.querySelector('.ai-agent-play-sample').addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            var chId = getChannelId();
            var form = new FormData();
            form.append('persona_id', p.id);
            form.append('channel_id', chId);
            form.append('text', 'Ù…Ø±Ø­Ø¨Ø§Ù‹ØŒ Ø£Ù†Ø§ Ù…Ø³Ø§Ø¹Ø¯Ùƒ Ø§Ù„Ø°ÙƒÙŠ.');
            fetch(apiBase + '/api/preview-voice/', { method: 'POST', body: form, credentials: 'same-origin', headers: { 'X-CSRFToken': (document.querySelector('[name=csrfmiddlewaretoken]') && document.querySelector('[name=csrfmiddlewaretoken]').value) || '' } })
              .then(function(res) {
                if (!res.ok) return res.json().then(function(j) { alert(j.message || 'Preview failed'); });
                return res.blob();
              })
              .then(function(blob) {
                if (!blob) return;
                var url = URL.createObjectURL(blob);
                var audio = new Audio(url);
                audio.play();
                audio.onended = function() { URL.revokeObjectURL(url); };
              });
          });
          card.addEventListener('click', function(e) {
            if (e.target.classList.contains('ai-agent-play-sample')) return;
            node.querySelectorAll('.ai-agent-persona-card').forEach(function(c) { c.classList.remove('selected'); });
            card.classList.add('selected');
            if (personaIdInput) personaIdInput.value = p.id;
          });
          return card;
        }
        stdGallery.innerHTML = '';
        var standardList = data.standard_agents || [];
        standardList.forEach(function(p) {
          stdGallery.appendChild(renderCard(p));
        });
        if (standardList.length === 0) {
          var emptyStd = document.createElement('div');
          emptyStd.className = 'persona-gallery-empty';
          emptyStd.innerHTML = '<span class="persona-gallery-empty-icon">ğŸ‘¤</span><p class="persona-gallery-empty-text">No standard agents found.</p>';
          stdGallery.appendChild(emptyStd);
        }
        stdGallery.dataset.loaded = '1';
        if (myGallery) {
          myGallery.innerHTML = '';
          var myList = data.my_voices || [];
          myList.forEach(function(p) {
            myGallery.appendChild(renderCard(p));
          });
          if (myList.length === 0) {
            var emptyMy = document.createElement('div');
            emptyMy.className = 'persona-gallery-empty';
            emptyMy.innerHTML = '<span class="persona-gallery-empty-icon">ğŸ™</span><p class="persona-gallery-empty-text">No cloned voices found.</p><p class="persona-gallery-empty-hint">Clone your voice in Settings â†’ Automation â†’ Voice Identity.</p>';
            myGallery.appendChild(emptyMy);
          }
          myGallery.dataset.loaded = '1';
        }
        if (data.can_use_premium === false && node.querySelector('.ai-agent-persona-premium-hint')) {
          node.querySelector('.ai-agent-persona-premium-hint').style.display = 'block';
        }
        if (typeof window.applyAiNodeVisibility === 'function') window.applyAiNodeVisibility(node);
      })
      .catch(function() {
        stdGallery.dataset.loaded = '1';
        stdGallery.innerHTML = '<div class="persona-gallery-empty"><span class="persona-gallery-empty-icon">âš ï¸</span><p class="persona-gallery-empty-text">Could not load agents. Try again.</p></div>';
      });
  };
})();

window.__loadGoogleSheetsPreview = function(node) {
  if (!node || !node.querySelector) return;
  var previewEl = node.querySelector('.google-sheets-preview-text');
  if (!previewEl) return;
  var apiBase = typeof window.flowBuilder !== 'undefined' && window.flowBuilder.apiBaseUrl ? window.flowBuilder.apiBaseUrl : '/discount/whatssapAPI';
  fetch(apiBase + '/api/google-sheets/config/', { method: 'GET', credentials: 'same-origin' })
    .then(function(r) { return r.json(); })
    .then(function(data) {
      var sheetName = (data.sheet_name || 'Orders').trim() || 'Orders';
      var count = typeof data.orders_exported_count === 'number' ? data.orders_exported_count : 0;
      var configured = data.configured && (data.spreadsheet_id || '').trim();
      if (!configured) {
        previewEl.textContent = 'Sheet: not linked. Configure in Settings \u2192 Integrations';
        return;
      }
      var text = 'Sheet: \u201C' + sheetName + '\u201D';
      if (count >= 0) text += ' \u00B7 ' + count + ' order' + (count === 1 ? '' : 's') + ' exported';
      previewEl.textContent = text;
    })
    .catch(function() { previewEl.textContent = 'Quick preview: load failed. Check Settings \u2192 Integrations'; });
};
</script>
 
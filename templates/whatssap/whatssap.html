{% load static %}
<link rel="stylesheet" href="{% static 'style/styleup.css' %}">

<script src="{% static 'js/whatssap.js' %}"></script>
 
</head>
<!-- <body> -->
  <script>
    // Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø¹Ø§Ù…Ø© Ù„ØªÙ…Ø±ÙŠØ± Ø¨ÙŠØ§Ù†Ø§Øª Ø¬Ø§Ù†ØºÙˆ Ø¥Ù„Ù‰ Ù…Ù„Ù Ø§Ù„Ø¬Ø§ÙØ§Ø³ÙƒØ±Ø¨Øª Ø§Ù„Ø®Ø§Ø±Ø¬ÙŠ
    window.TEMPLATE_CONFIG = {
        initialChannelId: '{{ initial_channel_id|default:"null" }}',
        csrfToken: document.querySelector('[name=csrfmiddlewaretoken]')?.value,
        urls: {
            apiTemplates: "{% url 'api_templates' %}",
            createTemplate: "{% url 'create_template' %}",
            syncTemplates: "{% url 'sync_pending_templates' %}",
            templateShow: "/discount/whatssapAPI/api/templateShow/" // Ø±Ø§Ø¨Ø· Ø«Ø§Ø¨Øª Ø£Ùˆ ÙŠÙ…ÙƒÙ† Ø§Ø³ØªØ®Ø¯Ø§Ù… url tag
        }
    };
</script>
  
  {% if user_channels %}
    <div class="cls3741_container">
      <aside class="workspace-sidebar">
      
        
  
        <div class="workspace-list">
       
          {% for channel in user_channels %}
          <div class="workspace-item {% if channel.id == initial_channel_id %}active{% endif %}" 
               data-channel-id="{{ channel.id }}"
               
               /* ğŸ”¥ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø®Ø²Ù†Ø© Ù„Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„ÙÙˆØ±ÙŠ ğŸ”¥ */
               data-name="{{ channel.name }}"
               data-agents="{{ channel.assigned_agents.count }}" 
               
               onclick="switchChannel('{{ channel.id }}')"
               title="{{ channel.name }}">
               
               {{ channel.name|slice:":1"|upper }}
              
               {% if channel.unread_count > 0 %}
                  <span class="unread-dot"></span>
               {% endif %}
          </div>
          {% endfor %}
  
          <div class="workspace-item add-new" onclick="openAddChannelModal()">
            <svg viewBox="0 0 24 24" width="24" height="24" stroke="currentColor" stroke-width="2" fill="none">
              <line x1="12" y1="5" x2="12" y2="19"></line>
              <line x1="5" y1="12" x2="19" y2="12"></line>
            </svg>
          </div>
        </div>
  
        

<style>
  /* --- 1. Ø´Ø±ÙŠØ· Ø§Ù„Ù‚Ù†ÙˆØ§Øª (Ø£Ù‚ØµÙ‰ Ø§Ù„ÙŠØ³Ø§Ø±) --- */
.workspace-sidebar {
  width: 80px; /* Ø¹Ø±Ø¶ Ø£ÙˆØ³Ø¹ Ù‚Ù„ÙŠÙ„Ø§Ù‹ */
 
  display: flex;
  flex-direction: column;
  align-items: center;
  padding: 20px 0;
  z-index: 50;
  flex-shrink: 0;
}

.workspace-list {
  display: flex;
  flex-direction: column;
  gap: 16px; /* Ù…Ø³Ø§ÙØ© Ø£ÙƒØ¨Ø± Ø¨ÙŠÙ† Ø§Ù„Ø¹Ù†Ø§ØµØ± */
  width: 100%;
  align-items: center;
}

/* --- Ø¹Ù†ØµØ± Ø§Ù„Ù‚Ù†Ø§Ø© --- */
.workspace-item {
  width: 52px;
  height: 52px;
  border-radius: 50%; /* Ø¯Ø§Ø¦Ø±Ø© ÙƒØ§Ù…Ù„Ø© Ø§ÙØªØ±Ø§Ø¶ÙŠØ§Ù‹ */
  background-color: #ffffff; /* Ø£Ø¨ÙŠØ¶ */
  color: #374151;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: 700;
  font-size: 20px;
  cursor: pointer;
  transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1); /* Ø­Ø±ÙƒØ© Ù†Ø§Ø¹Ù…Ø© */
  position: relative;
  box-shadow: 0 2px 5px rgba(0,0,0,0.05);
}

/* Ø¹Ù†Ø¯ Ø§Ù„ØªØ­ÙˆÙŠÙ… */
.workspace-item:hover {
  border-radius: 16px; /* ÙŠØªØ­ÙˆÙ„ Ù„Ù…Ø±Ø¨Ø¹ Ù†Ø§Ø¹Ù… */
  background-color: #4f46e5; /* Ù„ÙˆÙ† Ø§Ù„Ø¨Ø±Ø§Ù†Ø¯ (Ø¨Ù†ÙØ³Ø¬ÙŠ/Ø£Ø²Ø±Ù‚) */
  color: white;
}

/* --- Ø§Ù„Ù‚Ù†Ø§Ø© Ø§Ù„Ù†Ø´Ø·Ø© (Ø§Ù„ØªØµÙ…ÙŠÙ… Ø§Ù„Ù…ØªØµÙ„) --- */
.workspace-item.active {
  border-radius: 16px;
  background-color: #4f46e5; /* Ù„ÙˆÙ† Ø§Ù„Ù†Ø´Ø§Ø· */
  color: white;
  box-shadow: 0 4px 12px rgba(79, 70, 229, 0.3);
  position: relative;
}

/* Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø£Ø¨ÙŠØ¶ Ø§Ù„Ù…Ù†Ø­Ù†ÙŠ (Ø§Ù„ÙƒÙŠØ±Ù) Ø¨Ø¬Ø§Ù†Ø¨ Ø§Ù„Ù‚Ù†Ø§Ø© Ø§Ù„Ù†Ø´Ø·Ø© */
/* Ù‡Ø°Ø§ Ø§Ù„Ø¬Ø²Ø¡ ÙŠØ®Ù„Ù‚ ÙˆÙ‡Ù… Ø§Ù„Ø§ØªØµØ§Ù„ Ù…Ø¹ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø£Ø¨ÙŠØ¶ */
.workspace-item.active::after {
  content: '';
  position: absolute;
  right: -26px; /* ÙŠØ®Ø±Ø¬ Ù…Ù† Ø§Ù„Ø´Ø±ÙŠØ· */
  top: 50%;
  transform: translateY(-50%);
  width: 20px;
  height: 40px;
  background-color: #ffffff; /* Ù†ÙØ³ Ù„ÙˆÙ† Ø®Ù„ÙÙŠØ© Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ */
  border-radius: 20px 0 0 20px; /* Ù†ØµÙ Ø¯Ø§Ø¦Ø±Ø© Ù„Ù„ÙŠØ³Ø§Ø± */
  z-index: -1; /* Ø®Ù„Ù Ø§Ù„Ø¯Ø§Ø¦Ø±Ø© */
  opacity: 0; /* ÙŠÙ…ÙƒÙ† ØªÙØ¹ÙŠÙ„Ù‡ Ù„Ùˆ Ø£Ø±Ø¯Øª Ø§Ù„ØªØµÙ…ÙŠÙ… Ø§Ù„Ù…ØªØµÙ„ ØªÙ…Ø§Ù…Ø§Ù‹ */
}

/* Ù…Ø¤Ø´Ø± Ø¬Ø§Ù†Ø¨ÙŠ ØµØºÙŠØ± (Ø®Ø· Ø£Ø¨ÙŠØ¶) */
.workspace-item::before {
  content: '';
  position: absolute;
  left: -12px;
  top: 50%;
  transform: translateY(-50%);
  width: 4px;
  height: 0; /* Ù…Ø®ÙÙŠ */
  background-color: #000;
  border-radius: 0 4px 4px 0;
  transition: height 0.2s;
}

/* Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ù…Ø¤Ø´Ø± Ø¹Ù†Ø¯ Ø§Ù„ØªØ­ÙˆÙŠÙ… */
.workspace-item:hover::before {
  height: 20px;
}
.workspace-item.active::before {
  height: 36px; /* Ø£Ø·ÙˆÙ„ Ø¹Ù†Ø¯ Ø§Ù„Ù†Ø´Ø§Ø· */
  background-color: #4f46e5;
}

/* --- Ø²Ø± Ø§Ù„Ø¥Ø¶Ø§ÙØ© --- */
.workspace-item.add-new {
  background-color: transparent;
  border: 2px dashed #d1d5db;
  color: #9ca3af;
  box-shadow: none;
}
.workspace-item.add-new:hover {
  border-color: #4f46e5;
  color: #4f46e5;
  background-color: rgba(79, 70, 229, 0.1);
}

/* Ù†Ù‚Ø·Ø© Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡ (Unread) */
.unread-dot {
  position: absolute;
  top: -2px;
  right: -2px;
  width: 14px;
  height: 14px;
  background-color: #ef4444;
  border: 3px solid #f3f4f6; /* Ù„ÙˆÙ† Ø§Ù„Ø­Ø¯ÙˆØ¯ Ù†ÙØ³ Ù„ÙˆÙ† Ø®Ù„ÙÙŠØ© Ø§Ù„Ø´Ø±ÙŠØ· */
  border-radius: 50%;
}

/* --- ØªØ­Ø³ÙŠÙ† Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ Ù„ÙŠÙ†Ø§Ø³Ø¨ Ø§Ù„ØªØµÙ…ÙŠÙ… --- */
.main-content-wrapper {
  background-color: #ffffff; /* Ø£Ø¨ÙŠØ¶ Ù†Ù‚ÙŠ */
  border-radius: 30px 0 0 30px; /* Ø§Ù†Ø­Ù†Ø§Ø¡ ÙƒØ¨ÙŠØ± ÙÙŠ Ø§Ù„Ø²Ø§ÙˆÙŠØ© Ø§Ù„ÙŠØ³Ø±Ù‰ */
  margin: 10px 10px 10px 0; /* Ù…Ø³Ø§ÙØ© ØµØºÙŠØ±Ø© Ù…Ù† Ø§Ù„Ø£Ø¹Ù„Ù‰ ÙˆØ§Ù„Ø£Ø³ÙÙ„ */
  box-shadow: -5px 0 20px rgba(0,0,0,0.05); /* Ø¸Ù„ Ø®ÙÙŠÙ Ù„Ù„ÙØµÙ„ */
  overflow: hidden;
  flex: 1;
}
</style>
      </aside>


    <!-- sidebar -->
    <aside class="cls3741_sidebar" role="navigation" aria-label="Sidebar">
      <div class="cls3741_brand">
        <div class="cls3741_logo" id="current_channel_logo">
            {{ active_channel.name|slice:":1"|upper|default:"?" }}
        </div>
        
        <div>
            <div class="cls3741_title" id="current_channel_name">
                {{ active_channel.name|default:"Select Channel" }}
            </div>
            
            <div class="cls3741_sub" id="current_channel_agents_count">
                {{ active_channel.assigned_agents.count|default:"0" }} Agents
            </div> 
        </div>
    </div>
      <!-- </div> -->
<!-- notifications  -->

<style>
  /* --- New Toast Notification (Based on Uiverse Design) --- */
.cls3741_toast_container {
    position: fixed;
    top: 20px;
    right: 20px;
    z-index: 100000;
    display: flex;
    flex-direction: column;
    gap: 12px;
}

.cls3741_toast_new {
    width: 320px;
    max-width: 100%;
    background-color: #1f2937; /* Dark Gray (Tailwind Gray-800) */
    border: 1px solid var(--border-color);
    border-radius: 12px;
    box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.5);
    padding: 16px;
    color: #e5e7eb;
    font-family: 'Inter', sans-serif;
    animation: slideInToast 0.4s cubic-bezier(0.16, 1, 0.3, 1), fadeOutToast 0.5s ease-in 4.5s forwards;
    cursor: pointer;
    transition: transform 0.2s;
}

.cls3741_toast_new:hover {
    transform: translateY(-2px);
    background-color: #374151;
}

/* Header Section */
.cls3741_toast_header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 12px;
}

.cls3741_toast_title {
    font-size: 14px;
    font-weight: 600;
    color: white;
}

.cls3741_toast_close {
    background: transparent;
    border: none;
    color: #9ca3af;
    cursor: pointer;
    padding: 4px;
    border-radius: 6px;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s;
}
.cls3741_toast_close:hover {
    background-color: rgba(255, 255, 255, 0.1);
    color: white;
}

/* Body Section */
.cls3741_toast_body {
    display: flex;
    align-items: flex-start;
    gap: 12px;
}

.cls3741_toast_avatar_frame {
    position: relative;
    flex-shrink: 0;
}

.cls3741_toast_avatar {
    width: 48px;
    height: 48px;
    background: linear-gradient(135deg, var(--accent), #2563eb);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 20px;
    font-weight: bold;
    color: white;
    text-transform: uppercase;
}

.cls3741_toast_icon_badge {
    position: absolute;
    bottom: -2px;
    right: -2px;
    width: 20px;
    height: 20px;
    background-color: var(--success); /* Green for WhatsApp */
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    border: 2px solid #1f2937; /* Match toast bg */
    color: white;
    font-size: 10px;
}

.cls3741_toast_content {
    flex: 1;
    min-width: 0;
}

.cls3741_toast_sender {
    font-size: 14px;
    font-weight: 600;
    color: white;
    margin-bottom: 2px;
}

.cls3741_toast_msg {
    font-size: 13px;
    color: #9ca3af;
    display: -webkit-box;
    -webkit-line-clamp: 2; /* Ø³Ø·Ø±ÙŠÙ† ÙÙ‚Ø· */
    -webkit-box-orient: vertical;
    overflow: hidden;
    line-height: 1.4;
}

.cls3741_toast_time {
    font-size: 11px;
    color: var(--accent);
    margin-top: 4px;
    display: block;
}

@keyframes slideInToast {
    from { transform: translateX(100%); opacity: 0; }
    to { transform: translateX(0); opacity: 1; }
}
@keyframes fadeOutToast {
    to { opacity: 0; visibility: hidden; }
}
</style>
<audio id="notification_sound" src="https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3" preload="auto"></audio>

<div id="toast_container" class="cls3741_toast_container"></div>


 
<script>
  // Ø·Ù„Ø¨ Ø§Ù„Ø¥Ø°Ù† Ø¹Ù†Ø¯ ÙØªØ­ Ø§Ù„Ù…ÙˆÙ‚Ø¹
// Ø¯Ø§Ù„Ø© Ù„Ø·Ù„Ø¨ Ø§Ù„Ø¥Ø°Ù† (ØªØ³ØªØ¯Ø¹Ù‰ Ø¹Ù†Ø¯ Ø§Ù„Ù†Ù‚Ø±)
function askForNotificationPermission() {
    if (!("Notification" in window)) return;
    
    if (Notification.permission === "default") {
        Notification.requestPermission().then(permission => {
            if (permission === "granted") {
                console.log("âœ… ØªÙ… ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø¨Ù†Ø¬Ø§Ø­!");
                // ØªØ¬Ø±Ø¨Ø© Ø¥Ø´Ø¹Ø§Ø± ØªØ±Ø­ÙŠØ¨ÙŠ
                new Notification("Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ", { 
                    body: "ØªÙ… ØªÙØ¹ÙŠÙ„ Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª Ø¨Ù†Ø¬Ø§Ø­ âœ…", 
                    icon: 'https://cdn-icons-png.flaticon.com/512/733/733585.png'
                });
            }
        });
    }
}

// ğŸ”¥ Ø§Ù„Ø­Ù„ Ø§Ù„Ø³Ø­Ø±ÙŠ: Ø·Ù„Ø¨ Ø§Ù„Ø¥Ø°Ù† Ø¹Ù†Ø¯ Ø£ÙˆÙ„ Ù†Ù‚Ø±Ø© ÙÙŠ Ø£ÙŠ Ù…ÙƒØ§Ù† ÙÙŠ Ø§Ù„ØµÙØ­Ø© ğŸ”¥
document.addEventListener('click', function() {
    if (Notification.permission === 'default') {
        askForNotificationPermission();
    }
}, { once: true }); // once: true ØªØ¹Ù†ÙŠ Ø£Ù† Ù‡Ø°Ø§ Ø§Ù„Ø­Ø¯Ø« Ø³ÙŠØ¹Ù…Ù„ Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø© ÙÙ‚Ø·
  // Ø¯Ø§Ù„Ø© Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø¥Ø´Ø¹Ø§Ø± ÙˆØªØ´ØºÙŠÙ„ Ø§Ù„ØµÙˆØª
  window.showNotification = function(title, message, onClickCallback) {
    // 1. Ø§Ù„ØµÙˆØª ÙˆØ§Ù„Ø¹Ù†ÙˆØ§Ù† (ÙƒÙ…Ø§ Ù‡Ùˆ)
    const audio = document.getElementById('notification_sound');
    if (audio) { audio.currentTime = 0; audio.play().catch(() => {}); }
    
    // 2. Ø§Ù„Ø­Ø§ÙˆÙŠØ©
    let container = document.getElementById('toast_container');
    if (!container) {
        container = document.createElement('div');
        container.id = 'toast_container';
        container.className = 'cls3741_toast_container';
        document.body.appendChild(container);
    }

    // Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ø­Ø±Ù Ø§Ù„Ø£ÙˆÙ„ Ù„Ù„Ø§ÙØªØ§Ø±
    // (Ù†ÙØªØ±Ø¶ Ø£Ù† Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ù‡Ùˆ Ø§Ø³Ù… Ø§Ù„Ù…Ø±Ø³Ù„ØŒ Ø£Ùˆ Ù†Ø£Ø®Ø° Ø£ÙˆÙ„ Ø­Ø±Ù Ù…Ù† Ø§Ù„Ø¹Ù†ÙˆØ§Ù†)
    const initial = title.charAt(0).toUpperCase();

    // 3. Ø¨Ù†Ø§Ø¡ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø± Ø§Ù„Ø¬Ø¯ÙŠØ¯
    const toast = document.createElement('div');
    toast.className = 'cls3741_toast_new';
    
    toast.innerHTML = `
        <div class="cls3741_toast_header">
            <span class="cls3741_toast_title">New Message</span>
            <button type="button" class="cls3741_toast_close" aria-label="Close">
                <svg class="w-3 h-3" width="14" height="14" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 14 14">
                    <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m1 1 6 6m0 0 6 6M7 7l6-6M7 7l-6 6"></path>
                </svg>
            </button>
        </div>
        <div class="cls3741_toast_body">
            <div class="cls3741_toast_avatar_frame">
                <div class="cls3741_toast_avatar">${initial}</div>
                <span class="cls3741_toast_icon_badge">
                    <svg width="10" height="10" viewBox="0 0 24 24" fill="currentColor"><path d="M.057 24l1.687-6.163c-1.041-1.804-1.588-3.849-1.587-5.946.003-6.556 5.338-11.891 11.893-11.891 3.181.001 6.167 1.24 8.413 3.488 2.245 2.248 3.481 5.236 3.48 8.414-.003 6.557-5.338 11.892-11.893 11.892-1.99-.001-3.951-.5-5.688-1.448l-6.305 1.654z"/></svg>
                </span>
            </div>
            <div class="cls3741_toast_content">
                <div class="cls3741_toast_sender">New Message from ${escapeHtml(title)}</div>
                <div class="cls3741_toast_msg">${escapeHtml(message)}</div>
                <span class="cls3741_toast_time"> a few seconds ago</span>
            </div>
        </div>
    `;

    // 4. Ø§Ù„Ø£Ø­Ø¯Ø§Ø« (Events)
    
    // Ø¹Ù†Ø¯ Ø§Ù„Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ø²Ø± Ø§Ù„Ø¥ØºÙ„Ø§Ù‚ (ÙŠÙ…Ù†Ø¹ ÙØªØ­ Ø§Ù„Ø´Ø§Øª)
    const closeBtn = toast.querySelector('.cls3741_toast_close');
    closeBtn.onclick = function(e) {
        e.stopPropagation();
        toast.remove();
    };

    // Ø¹Ù†Ø¯ Ø§Ù„Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ø¬Ø³Ù… Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±
    toast.onclick = function() {
        window.focus();
        if (onClickCallback) onClickCallback();
        toast.remove();
    };

    container.appendChild(toast);

    // Ø§Ù„Ø­Ø°Ù Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ
    setTimeout(() => {
        if (toast.parentElement) toast.remove();
    }, 8000);

    // 5. Ø¥Ø´Ø¹Ø§Ø± Ø³Ø·Ø­ Ø§Ù„Ù…ÙƒØªØ¨ (Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„ØµÙØ­Ø© Ù…Ø®ÙÙŠØ©)
    if ("Notification" in window && Notification.permission === "granted" && document.hidden) {
        const noti = new Notification(title, {
            body: message,
            icon: 'https://cdn-icons-png.flaticon.com/512/733/733585.png',
            tag: 'new-msg'
        });
        noti.onclick = function() {
            window.focus();
            if (onClickCallback) onClickCallback();
            this.close();
        };
    }
};

// Ø¯Ø§Ù„Ø© Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„Ø¶Ù…Ø§Ù† Ø£Ù…Ø§Ù† Ø§Ù„Ù†ØµÙˆØµ
function escapeHtml(text) {
    if (!text) return '';
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}


</script>
      <nav class="cls3741_nav" aria-label="Main menu">
        <button class="cls3741_btn cls3741_btn_active" data-target="dashboard">Dashboard
          <span class="cls3741_badge">â€”</span>
        </button>

        <button class="cls3741_btn" data-target="chats">Chats
          <span class="cls3741_badge" id="badge_chats"></span>
        </button>

        <button class="cls3741_btn" data-target="orders">Orders
          <span class="cls3741_badge" id="badge_orders"></span>
        </button>

        <button class="cls3741_btn" data-target="contacts">Contacts
          <span class="cls3741_badge" id="badge_contacts"></span>
        </button>

        <button class="cls3741_btn" data-target="campaigns">Campaigns
          <span class="cls3741_badge" id="badge_campaigns"></span>
        </button>

        <button class="cls3741_btn" data-target="templates">Templates
          <span class="cls3741_badge" id="badge_templates"></span>
        </button>

        <button class="cls3741_btn" data-target="automation">Automation
          <span class="cls3741_badge" id="badge_automation"></span>
        </button>
      </nav>

     <script>
      // update badge_chats 
//       window.updateinterface = function(msg) {
//     // 1. ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø²Ø± Ø§Ù„Ù…Ø³ØªÙ‡Ø¯Ù (Ù‡Ù„ Ù‡Ùˆ 'chats' Ù„Ù„Ø±Ø³Ø§Ø¦Ù„ Ø£Ù… 'orders'ØŸ)
//     // Ù„Ù‚Ø¯ Ø¬Ø¹Ù„ØªÙ‡ 'chats' Ù„Ø£Ù†Ù‡ Ø§Ù„Ø£Ù†Ø³Ø¨ Ù„Ù„Ø±Ø³Ø§Ø¦Ù„ØŒ ÙŠÙ…ÙƒÙ†Ùƒ ØªØºÙŠÙŠØ±Ù‡ Ù„Ù€ 'orders' Ø¥Ø°Ø§ Ø£Ø±Ø¯Øª
//     const targetName = 'chats'; 
//     const targetBtn = document.querySelector(`[data-target="${targetName}"]`);
    
//     if (!targetBtn) return;

//     // 2. Ø§Ù„ØªØ­Ù‚Ù‚: Ù‡Ù„ Ù†Ø­Ù† ÙØ§ØªØ­ÙŠÙ† Ù‡Ø°Ø§ Ø§Ù„ØªØ¨ÙˆÙŠØ¨ Ø§Ù„Ø¢Ù†ØŸ
//     // (Ø§Ø®ØªÙŠØ§Ø±ÙŠ: Ø¥Ø°Ø§ Ø£Ø±Ø¯Øª Ø§Ù„ØªØ­Ø¯ÙŠØ« Ø­ØªÙ‰ Ù„Ùˆ ÙƒØ§Ù† Ù…ÙØªÙˆØ­Ø§Ù‹ØŒ Ø§Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø´Ø±Ø·)
//     // if (targetBtn.classList.contains('cls3741_btn_active')) return;

//     // 3. Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ø¨Ø§Ø¯Ø¬ (Badge) Ø£Ùˆ Ø¥Ù†Ø´Ø§Ø¤Ù‡ Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù…ÙˆØ¬ÙˆØ¯Ø§Ù‹
//     let badge = targetBtn.querySelector('.cls3741_badge');
    
//     if (!badge) {
//         // Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø¹Ù†ØµØ± Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ§Ù‹ Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù…ÙˆØ¬ÙˆØ¯Ø§Ù‹ ÙÙŠ HTML
//         badge = document.createElement('span');
//         badge.className = 'cls3741_badge';
//         // Ø¥Ø¶Ø§ÙØ© ØªÙ†Ø³ÙŠÙ‚ Ø§ÙØªØ±Ø§Ø¶ÙŠ Ø³Ø±ÙŠØ¹ (Ø£Ùˆ ÙŠØ¹ØªÙ…Ø¯ Ø¹Ù„Ù‰ CSS Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ)
//         badge.style.cssText = `
//             background: #ef4444; 
//             color: white; 
//             padding: 2px 8px; 
//             border-radius: 12px; 
//             font-size: 11px; 
//             font-weight: bold;
//             margin-left: auto;
//         `;
//         targetBtn.appendChild(badge);
//     }

//     // 4. Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ø¹Ø¯Ø¯ (Ø¯Ø¹Ù… ØµÙŠØº Ù…Ø®ØªÙ„ÙØ© Ù„Ù„Ø¨ÙŠØ§Ù†Ø§Øª)
//     // Ø£Ø­ÙŠØ§Ù†Ø§Ù‹ ØªØ£ØªÙŠ msg.count ÙˆØ£Ø­ÙŠØ§Ù†Ø§Ù‹ msg.unread_count
//     const count = msg.count || msg.unread_count || msg.unread || 0;

//     // 5. Ø§Ù„ØªØ­Ø¯ÙŠØ« ÙˆØ§Ù„Ø¹Ø±Ø¶
//     if (count > 0) {
//         badge.textContent = count;
//         badge.style.display = 'inline-flex';
        
//         // ÙˆÙ…Ø¶Ø© Ø¨Ø³ÙŠØ·Ø© Ù„Ø¬Ø°Ø¨ Ø§Ù„Ø§Ù†ØªØ¨Ø§Ù‡ (Animation)
//         badge.animate([
//             { transform: 'scale(1)' },
//             { transform: 'scale(1.3)' },
//             { transform: 'scale(1)' }
//         ], { duration: 200 });
        
//     } else {
//         badge.style.display = 'none'; // Ø¥Ø®ÙØ§Ø¡ Ø¥Ø°Ø§ ÙƒØ§Ù† 0
//     }
// };
     

      </script>
      <!-- <div class="cls3741_spacer"></div> -->

      <div style="font-size:13px;color:var(--muted);padding:8px 10px">
        <div>Ø­Ø§Ù„Ø© Ø§Ù„Ø­Ø³Ø§Ø¨</div>
        <div style="margin-top:6px;color:#84e7f0;font-weight:700">Ù…ØªØµÙ„</div>
      </div>
    </aside>

    <!-- main content + side card -->
    <!-- Ù…Ø«Ø§Ù„ Ø¹Ù„Ù‰ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª -->
<main class="cls3741_main">

  <section class="cls3741_panel cls3741_panel_dashboard">
    
    <div class="cls3741_dash_header">
        <h2>Dashboard</h2>
        <div class="cls3741_dash_actions">
            <span class="status_badge connected">
                <span class="dot"></span> connected
            </span>
            <button class="cls3741_btn_refresh" onclick="window.location.reload()">
             Refresh 
            </button>
        </div>
    </div>
<div class="main1" style="    overflow: auto;
overflow-anchor: inherit;
scrollbar-width: none;
height: 675px;
width: 100%;">

 
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<script>
  // Ø¯Ø§Ù„Ø© Ù„ØªÙˆÙ„ÙŠØ¯ QR Code
function generateWhatsAppQR(phoneNumber) {
    const container = document.getElementById('qrcode_container');
    if (!container) return;
    
    // ØªÙ†Ø¸ÙŠÙ Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ù‚Ø¯ÙŠÙ… (ÙÙŠ Ø­Ø§Ù„ ØªØºÙŠÙŠØ± Ø§Ù„Ù‚Ù†Ø§Ø©)
    container.innerHTML = '';
    
    // ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø±Ù‚Ù… (Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ù…Ø³Ø§ÙØ§Øª ÙˆØ§Ù„Ø±Ù…ÙˆØ²)
    const cleanPhone = phoneNumber.replace(/\D/g, '');
    const waLink = `https://wa.me/${cleanPhone}`;
    
    // Ø¥Ù†Ø´Ø§Ø¡ QR Ø¬Ø¯ÙŠØ¯
    new QRCode(container, {
        text: waLink,
        width: 100,
        height: 100,
        colorDark : "#000000",
        colorLight : "#ffffff",
        correctLevel : QRCode.CorrectLevel.H
    });
}

// ---------------------------------------------------
// ØªØ­Ø¯ÙŠØ« Ø¯Ø§Ù„Ø© loadDashboardData Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…Ù‡Ø§
// ---------------------------------------------------
 
</script> 
        {% if user.is_team_admin or user.is_superuser %}
    <div class="cls3741_account_card">
        <div class="account_qr_section">
          <div id="qrcode_container" class="qr_img_wrapper" style="
            width: 120px;
            height: 120px;
            background: white; /* Ø§Ù„Ù€ QR ÙŠØ­ØªØ§Ø¬ Ø®Ù„ÙÙŠØ© Ø¨ÙŠØ¶Ø§Ø¡ Ù„ÙŠØ¹Ù…Ù„ */
            padding: 8px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        "></div>
            <div class="scan_hint">Scan to conntact</div>
        </div>
        
        <div class="account_info_grid">
            <div class="info_item">
                <label>Display Name</label>
                <div class="val" id="dash_display_name"> </div>
            </div>
            <div class="info_item">
                <label>Connected Number</label>
                <div class="val highlight" id="dash_phone_number">+{{ active_channel.phone_number }}</div>
            </div>
            <div class="info_item">
                <label>WABA ID</label>
                <div class="val mono" id="dash_waba_id">{{ active_channel.business_account_id }}</div>
            </div>
            <div class="info_item">
                <label>Messaging Limit</label>
                <div class="val" id="dash_messaging_limit">TIER_250</div>
            </div>
            <div class="info_item">
                <label>Quality Rating</label>
                <div class="val text-green" id="dash_quality_rating">GREEN â—</div>
            </div>
            <div class="info_item">
                <label>Account Status</label>
                <div class="val status_tag" id="dash_account_status">APPROVED</div>
            </div>
        </div>
    </div>
    {% else %}

  {% include 'teams.html' %}
  <div style="padding-bottom: 24px;"></div>
    {% endif %}

    <div class="cls3741_stats_grid">
        <div class="stat_card">
            <div class="stat_icon purple">ğŸ‘¥</div>
            <div class="stat_content">
                <div class="stat_label">Total Contacts</div>
                <div class="stat_number" id="dash_contacts_count">0</div>
                <a href="#" class="stat_link">View Contacts &rarr;</a>
            </div>
        </div>

        <div class="stat_card">
            <div class="stat_icon blue">ğŸ“¢</div>
            <div class="stat_content">
                <div class="stat_label">Active Campaigns</div>
                <div class="stat_number" id="dash_campaigns_count">0</div>
                <a href="#" class="stat_link">Manage Campaigns &rarr;</a>
            </div>
        </div>

        <div class="stat_card">
          <div class="stat_icon green">ğŸ’¬</div>
          <div class="stat_content">
              <div class="stat_label">Total Messages</div>
              
              <div class="stat_number" id="dash_messages_count">0</div>
              
              <div style="font-size: 11px; color: var(--text-secondary); margin-top: -4px;">
                  <span style="color: #4f46e5;">â¬† <span id="dash_sent_count">0</span></span>
                  <span style="margin: 0 4px;">|</span>
                  <span style="color: #22c55e;">â¬‡ <span id="dash_received_count">0</span></span>
              </div>
          </div>
      </div>


        <div class="support_card">
            <div class="support_text">
                <h3>Need Help?</h3>
                <p>Contact our support team via WhatsApp directly.</p>
            </div>
            <div class="support_icon">ğŸ§</div>
        </div>
    </div>

    <div class="cls3741_chart_section">
        <div class="chart_header">
            <h3>ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ (Ø¢Ø®Ø± 7 Ø£ÙŠØ§Ù…)</h3>
            <div class="chart_legend">
                <span class="legend_item"><span class="dot sent"></span> Ù…Ø±Ø³Ù„Ø©</span>
                <span class="legend_item"><span class="dot received"></span> Ù…Ø³ØªÙ„Ù…Ø©</span>
            </div>
        </div>
        <div class="chart_container">
            <canvas id="messagesChart"></canvas>
        </div>
    </div>


 {% if user.is_team_admin or user.is_superuser %}
<div style="margin-top: 24px;"></div>
{% include 'teams.html' %}

{% endif %}

 
  </div>
<style>
  /* --- Dashboard Layout --- */
.cls3741_panel_dashboard {
    padding: 24px;
    max-width: 1400px;
    margin: 0 auto;
}

.cls3741_dash_header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 24px;
}
.cls3741_dash_header h2 { font-size: 24px; font-weight: 700; color: var(--text-primary); }

.cls3741_dash_actions { display: flex; gap: 12px; align-items: center; }

.cls3741_btn_refresh {
    background: var(--bg-tertiary); border: 1px solid var(--border-color);
    color: var(--text-secondary); padding: 8px 16px; border-radius: 8px; cursor: pointer;
    transition: all 0.2s;
}
.cls3741_btn_refresh:hover { background: var(--bg-hover); color: var(--text-primary); }

/* Status Badge */
.status_badge {
    display: flex; align-items: center; gap: 6px;
    padding: 6px 12px; border-radius: 20px;
    font-size: 12px; font-weight: bold;
    background: rgba(34, 197, 94, 0.1); color: #22c55e; border: 1px solid rgba(34, 197, 94, 0.2);
}
.status_badge .dot { width: 8px; height: 8px; background: #22c55e; border-radius: 50%; box-shadow: 0 0 8px #22c55e; }

/* --- 1. Account Card (Top) --- */
.cls3741_account_card {
    background: var(--bg-primary);
    border: 1px solid var(--border-color);
    border-radius: 16px;
    padding: 24px;
    display: flex;
    gap: 30px;
    margin-bottom: 24px;
    align-items: center;
    box-shadow: var(--shadow-md);
}

.account_qr_section {
    text-align: center;
    padding-right: 30px;
    border-right: 1px solid var(--border-color);
}
.qr_img { width: 100px; height: 100px; border-radius: 8px; background: white; padding: 4px; }
.scan_hint { font-size: 11px; color: var(--text-secondary); margin-top: 8px; }

.account_info_grid {
    flex: 1;
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
    gap: 20px;
}

.info_item label { display: block; font-size: 11px; color: var(--text-secondary); text-transform: uppercase; margin-bottom: 6px; letter-spacing: 0.5px; }
.info_item .val { font-size: 15px; font-weight: 600; color: var(--text-primary); }
.info_item .val.mono { font-family: 'Courier New', monospace; letter-spacing: -0.5px; opacity: 0.9; }
.info_item .val.highlight { color: var(--accent); }
.info_item .val.text-green { color: #22c55e; }
.info_item .val.status_tag { 
    display: inline-block; background: rgba(34, 197, 94, 0.15); 
    color: #22c55e; padding: 2px 8px; border-radius: 4px; font-size: 12px; 
}

/* --- 2. KPI Stats Grid --- */
.cls3741_stats_grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
    gap: 18px;
    margin-bottom: 24px;
}

.stat_card {
    background: var(--bg-primary);
    border: 1px solid var(--border-color);
    border-radius: 16px;
    padding: 20px;
    display: flex;
    align-items: flex-start;
    gap: 16px;
    transition: transform 0.2s;
}
.stat_card:hover { transform: translateY(-2px); border-color: var(--border-light); }

.stat_icon {
    width: 48px; height: 48px; border-radius: 12px;
    display: flex; align-items: center; justify-content: center;
    font-size: 22px;
}
.stat_icon.purple { background: rgba(124, 58, 237, 0.15); color: #a78bfa; }
.stat_icon.blue { background: rgba(59, 130, 246, 0.15); color: #60a5fa; }
.stat_icon.green { background: rgba(34, 197, 94, 0.15); color: #4ade80; }

.stat_content { flex: 1; }
.stat_label { font-size: 13px; color: var(--text-secondary); margin-bottom: 4px; }
.stat_number { font-size: 28px; font-weight: 800; color: var(--text-primary); margin-bottom: 8px; }
.stat_link { font-size: 12px; color: var(--accent); text-decoration: none; font-weight: 600; }
.stat_link:hover { text-decoration: underline; }

/* Support Card */
.support_card {
    background: linear-gradient(135deg, #4f46e5, #3730a3);
    border-radius: 16px;
    padding: 20px;
    color: white;
    display: flex;
    justify-content: space-between;
    align-items: center;
    box-shadow: 0 10px 20px rgba(79, 70, 229, 0.2);
}
.support_text h3 { margin: 0 0 6px 0; font-size: 18px; }
.support_text p { margin: 0; font-size: 12px; opacity: 0.8; line-height: 1.4; }
.support_icon { font-size: 32px; opacity: 0.8; }

/* --- 3. Chart Section --- */
.cls3741_chart_section {
    background: var(--bg-primary);
    border: 1px solid var(--border-color);
    border-radius: 16px;
    padding: 24px;
    position: relative;
}
.chart_header { display: flex; justify-content: space-between; margin-bottom: 20px; }
.chart_header h3 { margin: 0; font-size: 16px; color: var(--text-primary); }
.chart_legend { display: flex; gap: 12px; font-size: 12px; color: var(--text-secondary); }
.legend_item .dot { display: inline-block; width: 8px; height: 8px; border-radius: 50%; margin-right: 4px; }
.legend_item .dot.sent { background: #4f46e5; }
.legend_item .dot.received { background: #22c55e; }

.chart_container {
    height: 300px;
    width: 100%;
}

/* Mobile Responsive */
@media (max-width: 768px) {
    .cls3741_account_card { flex-direction: column; text-align: center; }
    .account_qr_section { border-right: none; border-bottom: 1px solid var(--border-color); padding-bottom: 20px; padding-right: 0; margin-bottom: 20px; width: 100%; }
    .account_info_grid { grid-template-columns: 1fr 1fr; width: 100%; text-align: left; }
}
</style>
</section>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <script>
    // Ù…ØªØºÙŠØ± Ø¹Ø§Ù„Ù…ÙŠ Ù„Ù„Ø±Ø³Ù… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠ (Ù„ØªØ­Ø¯ÙŠØ«Ù‡ Ù„Ø§Ø­Ù‚Ø§Ù‹)
let dashboardChartInstance = null;

async function loadDashboardData(channelId) {
    // Ø¥Ø°Ø§ Ù„Ù… Ù†ÙƒÙ† ÙÙŠ ØµÙØ­Ø© Ø§Ù„Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ØŒ Ù†ØªÙˆÙ‚Ù
    if (!document.getElementById('messagesChart')) return;

    const activeId = channelId || window.currentChannelId;
    if (!activeId || activeId === 'null') return;

    console.log("ğŸ“Š Loading Dashboard for channel:", activeId);

    try {
        const response = await fetch(`/discount/whatssapAPI/api/dashboard/stats/?channel_id=${activeId}`);
        const data = await response.json();
        console.log('ğŸ‘Œ dasb data' , data)

        if (data.success) {
            // 1. ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù†ØµÙˆØµ ÙˆØ§Ù„Ø£Ø±Ù‚Ø§Ù…
            updateText('dash_display_name', data.account.display_name);
            updateText('dash_phone_number', data.account.phone_number);
            updateText('dash_waba_id', data.account.waba_id);
            
            updateText('dash_contacts_count', data.stats.contacts);
            updateText('dash_messages_count', data.stats.messages);
            updateText('dash_campaigns_count', data.stats.campaigns);
            updateText('dash_sent_count', data.stats.sent);
            updateText('dash_received_count', data.stats.received);

            // 2. ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø±Ø³Ù… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠ
            updateChart(data.chart);
        }
        if (data.account.phone_number) {
            generateWhatsAppQR(data.account.phone_number);
        }

    } catch (error) {
        console.error("Dashboard Load Error:", error);
    }
}

// Ø¯Ø§Ù„Ø© Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù†ØµÙˆØµ Ø¨Ø£Ù…Ø§Ù†
function updateText(id, value) {
    const el = document.getElementById(id);
    if (el) el.textContent = value || '-';
}

// Ø¯Ø§Ù„Ø© Ø¨Ù†Ø§Ø¡/ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø±Ø³Ù… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠ
function updateChart(chartData) {
    const ctx = document.getElementById('messagesChart');
    if (!ctx) return;

    // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø±Ø³Ù… Ù…ÙˆØ¬ÙˆØ¯Ø§Ù‹ Ù…Ø³Ø¨Ù‚Ø§Ù‹ØŒ Ù†Ù‚ÙˆÙ… Ø¨ØªØ¯Ù…ÙŠØ±Ù‡ Ù„Ø¥Ù†Ø´Ø§Ø¡ ÙˆØ§Ø­Ø¯ Ø¬Ø¯ÙŠØ¯ (Ø£Ùˆ Ù†Ø­Ø¯Ø« Ø¨ÙŠØ§Ù†Ø§ØªÙ‡)
    if (dashboardChartInstance) {
        dashboardChartInstance.data.labels = chartData.labels;
        dashboardChartInstance.data.datasets[0].data = chartData.sent;
        dashboardChartInstance.data.datasets[1].data = chartData.received;
        dashboardChartInstance.update();
    } else {
        // Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø±Ø³Ù… Ù„Ø£ÙˆÙ„ Ù…Ø±Ø©
        const chartCanvas = ctx.getContext('2d');
        
        // Ø§Ù„ØªØ¯Ø±Ø¬Ø§Øª Ø§Ù„Ù„ÙˆÙ†ÙŠØ© (Ù†ÙØ³ Ø§Ù„ØªØµÙ…ÙŠÙ… Ø§Ù„Ø¬Ù…ÙŠÙ„ Ø§Ù„Ø³Ø§Ø¨Ù‚)
        const gradientSent = chartCanvas.createLinearGradient(0, 0, 0, 400);
        gradientSent.addColorStop(0, 'rgba(79, 70, 229, 0.5)');
        gradientSent.addColorStop(1, 'rgba(79, 70, 229, 0.0)');

        const gradientReceived = chartCanvas.createLinearGradient(0, 0, 0, 400);
        gradientReceived.addColorStop(0, 'rgba(34, 197, 94, 0.5)');
        gradientReceived.addColorStop(1, 'rgba(34, 197, 94, 0.0)');

        dashboardChartInstance = new Chart(ctx, {
            type: 'line',
            data: {
                labels: chartData.labels, // ['Mon', 'Tue'...]
                datasets: [
                    {
                        label: 'Sent',
                        data: chartData.sent,
                        borderColor: '#4f46e5',
                        backgroundColor: gradientSent,
                        borderWidth: 3,
                        tension: 0.4,
                        fill: true,
                        pointRadius: 3
                    },
                    {
                        label: 'Received',
                        data: chartData.received,
                        borderColor: '#22c55e',
                        backgroundColor: gradientReceived,
                        borderWidth: 3,
                        tension: 0.4,
                        fill: true,
                        pointRadius: 3
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: {
                    y: { beginAtZero: true, grid: { color: '#374151' }, ticks: { color: '#9ca3af' } },
                    x: { grid: { display: false }, ticks: { color: '#9ca3af' } }
                }
            }
        });
    }
}

// ÙƒØ´Ù Ø§Ù„Ø¯Ø§Ù„Ø© Ù„Ù„Ø¹Ø§Ù…Ø©
loadDashboardData(window.currentChannelId || {{ initial_channel_id }} || 0);
window.loadDashboardData = loadDashboardData;
  </script>

<!-- START: Chats 3-column layout (put this inside your template) -->
<div id="cls3741_template_modal" class="cls3741_modal_overlay" style="display: none;">
  <div class="cls3741_modal_content cls3741_modal_wide">
      
      <div class="cls3741_modal_header">
          <h3>Send WhatsApp Template</h3>
          <button type="button" onclick="closeTemplateModalchat()" class="cls3741_modal_close">&times;</button>
      </div>

      <div class="cls3741_modal_grid">
          
          <div class="cls3741_col_list">
              <div class="cls3741_search_bar">
                  <input type="text" id="tpl_search_input" placeholder="Search templates..." class="cls3741_input_field">
              </div>
              <div id="tpl_list_container" class="cls3741_tpl_list">
                  <div class="cls3741_loader_new"><div class="cls3741_spinner"></div></div>
              </div>
          </div>

          <div class="cls3741_col_preview">
              
              <div id="tpl_empty_state" class="cls3741_preview_empty">
                  <span>ğŸ‘ˆ Select a template to configure</span>
              </div>

              <div id="tpl_config_area" style="display: none;">
                  
                  <div class="cls3741_wa_mockup">
                      <div class="cls3741_wa_bubble">
                          <div id="preview_header_container" class="cls3741_wa_header"></div>
                          
                          <div id="preview_body_text" class="cls3741_wa_body"></div>
                          
                          <div id="preview_footer_text" class="cls3741_wa_footer"></div>
                          
                          <div class="cls3741_wa_time">10:30 AM</div>
                      </div>
                      <div id="preview_buttons_container" class="cls3741_wa_buttons"></div>
                  </div>

                  <div class="cls3741_inputs_section">
                      <h4>Template Configuration</h4>
                      <div id="dynamic_inputs_container"></div>
                  </div>

                  <div class="cls3741_action_footer">
                      <button id="btn_send_template" class="cls3741_btn_send_final">
                          Send Message
                      </button>
                  </div>
              </div>
          </div>
      </div>
  </div>
</div>

<style>
  /* Modal Layout */
.cls3741_modal_wide {
    width: 900px;
    max-width: 95vw;
    height: 85vh;
    display: flex;
    flex-direction: column;
    padding: 0;
    background: var(--bg-primary);
    overflow: hidden;
}

.cls3741_modal_grid {
    display: flex;
    flex: 1;
    overflow: hidden;
}

/* Left Column: List */
.cls3741_col_list {
    width: 320px;
    border-right: 1px solid var(--border-color);
    display: flex;
    flex-direction: column;
    background: var(--bg-secondary);
}

.cls3741_search_bar {
    padding: 12px;
    border-bottom: 1px solid var(--border-color);
}

.cls3741_tpl_list {
    flex: 1;
    overflow-y: auto;
}

/* Template Item Style */
.tpl-item {
    padding: 14px;
    border-bottom: 1px solid var(--border-color);
    cursor: pointer;
    transition: all 0.2s;
    border-left: 3px solid transparent;
}
.tpl-item:hover { background: var(--bg-hover); }
.tpl-item.active { 
    background: var(--bg-tertiary); 
    border-left-color: var(--accent); 
}

.tpl-category { 
    font-size: 10px; text-transform: uppercase; 
    color: var(--text-secondary); background: rgba(255,255,255,0.05); 
    padding: 2px 6px; border-radius: 4px;
}

/* Right Column: Preview & Config */
.cls3741_col_preview {
    flex: 1;
    display: flex;
    flex-direction: column;
    background: #0b141a; /* WhatsApp Dark Background */
    background-image: url('https://user-images.githubusercontent.com/15075759/28719144-86dc0f70-73b1-11e7-911d-60d70fcded21.png');
    background-blend-mode: overlay;
    opacity: 0.98;
    overflow-y: auto;
    position: relative;
}

.cls3741_preview_empty {
    display: flex; align-items: center; justify-content: center;
    height: 100%; color: #8696a0; font-size: 16px;
}

/* WhatsApp Mockup Styles */
.cls3741_wa_mockup {
    padding: 20px;
    display: flex;
    flex-direction: column;
    align-items: flex-start; /* Ù…Ø­Ø§Ø°Ø§Ø© Ù„Ù„ÙŠØ³Ø§Ø± (Ø±Ø³Ø§Ù„Ø© ÙˆØ§Ø±Ø¯Ø©) */
    max-width: 400px;
    margin: 0 auto;
}

.cls3741_wa_bubble {
    background: #202c33;
    color: #e9edef;
    padding: 8px;
    border-radius: 8px;
    border-top-left-radius: 0;
    box-shadow: 0 1px 2px rgba(0,0,0,0.3);
    width: 100%;
    position: relative;
}

.cls3741_wa_header img, .cls3741_wa_header video {
    width: 100%; border-radius: 6px; margin-bottom: 6px;
}
.cls3741_wa_header { font-weight: bold; margin-bottom: 6px; color: #fff; }
.cls3741_wa_body { font-size: 14px; line-height: 1.5; white-space: pre-wrap; }
.cls3741_wa_footer { font-size: 11px; color: #8696a0; margin-top: 6px; }
.cls3741_wa_time { font-size: 10px; color: #8696a0; text-align: right; margin-top: 4px; }

.cls3741_wa_buttons {
    width: 100%; margin-top: 4px; display: flex; flex-direction: column; gap: 4px;
}
.wa-btn-preview {
    background: #202c33; color: #00a884;
    text-align: center; padding: 10px; border-radius: 6px;
    font-size: 14px; font-weight: 500; cursor: default;
    box-shadow: 0 1px 2px rgba(0,0,0,0.3);
}

/* Inputs Section (The Configuration Panel) */
.cls3741_inputs_section {
    background: var(--bg-primary);
    border-top: 1px solid var(--border-color);
    padding: 20px;
    margin-top: auto; /* ÙŠØ¯ÙØ¹Ù‡Ø§ Ù„Ù„Ø£Ø³ÙÙ„ */
}

.cls3741_inputs_section h4 { margin: 0 0 12px 0; color: var(--text-secondary); font-size: 13px; text-transform: uppercase; }

.var-input-group { margin-bottom: 12px; }
.var-label { display: block; font-size: 12px; color: var(--text-secondary); margin-bottom: 4px; }
.var-input { 
    width: 100%; padding: 10px; border-radius: 8px; 
    background: var(--bg-tertiary); border: 1px solid var(--border-color); 
    color: var(--text-primary); outline: none;
}
.var-input:focus { border-color: var(--accent); }

.cls3741_btn_send_final {
    width: 100%; padding: 12px; background: var(--accent); 
    color: white; border: none; border-radius: 8px; 
    font-weight: bold; cursor: pointer; margin-top: 10px;
}
.cls3741_btn_send_final:hover { background: var(--accent-hover); }
</style>

<script>
  (function() {
    // --- Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø© ---
    let currentSelectedTemplate = null;
    let variableValues = {}; // Ù„ØªØ®Ø²ÙŠÙ† Ù‚ÙŠÙ… Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª: { "1": "Ø£Ø­Ù…Ø¯", "2": "Ø§ÙŠÙÙˆÙ†" }
    let headerMediaFile = null; // Ù„ØªØ®Ø²ÙŠÙ† Ù…Ù„Ù Ø§Ù„Ù‡ÙŠØ¯Ø± Ø§Ù„Ù…Ø±ÙÙˆØ¹
    let headerVariableValue = ''; // Ù„ØªØ®Ø²ÙŠÙ† Ù…ØªØºÙŠØ± Ø§Ù„Ù‡ÙŠØ¯Ø± Ø§Ù„Ù†ØµÙŠ

    // --- Ø¹Ù†Ø§ØµØ± Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© ---
    const listContainer = document.getElementById('tpl_list_container');
    const emptyState = document.getElementById('tpl_empty_state');
    const configArea = document.getElementById('tpl_config_area');
    const inputsContainer = document.getElementById('dynamic_inputs_container');
    const sendBtn = document.getElementById('btn_send_template');

    // Ø¹Ù†Ø§ØµØ± Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø© (Preview Elements)
    const previewHeader = document.getElementById('preview_header_container');
    const previewBody = document.getElementById('preview_body_text');
    const previewFooter = document.getElementById('preview_footer_text');
    const previewButtons = document.getElementById('preview_buttons_container');

    // --- 1. Ø¯Ø§Ù„Ø© Ø§Ù„Ø¬Ù„Ø¨ (Fetching) ---
    window.loadTemplate = async function(channelId = null) {
        if (!listContainer) return;
        
        const activeChannel = channelId || window.currentChannelId || '{{ initial_channel_id|default:"null" }}';
        if (!activeChannel || activeChannel === 'null') {
            listContainer.innerHTML = '<div style="padding:20px;text-align:center;color:gray;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù‚Ù†Ø§Ø© Ù…Ø­Ø¯Ø¯Ø©</div>';
            return;
        }

        listContainer.innerHTML = '<div class="cls3741_loader_new"><div class="cls3741_spinner"></div></div>';

        try {
            const url = `{% url 'api_get_templates' %}?channel_id=${activeChannel}`;
            const response = await fetch(url, { headers: { 'Accept': 'application/json' } });
            const data = await response.json();

            if (data.templates) {
                renderTemplateList(data.templates);
            } else {
                listContainer.innerHTML = '<div style="padding:20px;text-align:center;">Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© ÙØ§Ø±ØºØ©</div>';
            }
        } catch (error) {
            console.error("Error loading templates:", error);
            listContainer.innerHTML = '<div style="color:red;text-align:center;padding:20px;">ÙØ´Ù„ Ø§Ù„ØªØ­Ù…ÙŠÙ„</div>';
        }
    };

    // --- 2. Ø±Ø³Ù… Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ© ---
    function renderTemplateList(templates) {
        listContainer.innerHTML = '';
        if (templates.length === 0) {
            listContainer.innerHTML = '<div style="padding:20px;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù‚ÙˆØ§Ù„Ø¨.</div>';
            return;
        }

        templates.forEach(tpl => {
            const item = document.createElement('div');
            item.className = 'tpl-item';
            // Ø¹Ù†Ø¯ Ø§Ù„Ù†Ù‚Ø±: Ù†Ù†ØªÙ‚Ù„ Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø© ÙˆØ§Ù„ØªØ¹Ø¨Ø¦Ø© (ÙˆÙ„ÙŠØ³ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù…Ø¨Ø§Ø´Ø±)
            item.onclick = () => selectTemplateForPreview(tpl, item);
            
            item.innerHTML = `
                <div class="tpl-header">
                    <span class="tpl-name">${escapeHtml(tpl.name)}</span>
                    <span class="tpl-meta">${tpl.status}</span>
                </div>
                <div class="tpl-body">${escapeHtml(tpl.body)}</div>
            `;
            listContainer.appendChild(item);
        });

        // ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¨Ø­Ø«
        const searchInput = document.getElementById('tpl_search_input');
        if (searchInput) {
            searchInput.oninput = (e) => {
                const val = e.target.value.toLowerCase();
                document.querySelectorAll('.tpl-item').forEach(el => {
                    el.style.display = el.innerText.toLowerCase().includes(val) ? 'block' : 'none';
                });
            };
        }
    }

    // --- 3. Ø§Ù„Ù…Ù†Ø·Ù‚ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ: Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù‚Ø§Ù„Ø¨ ÙˆØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ø­Ù‚ÙˆÙ„ (Core Logic) ---
    function selectTemplateForPreview(tpl, itemElement) {
        currentSelectedTemplate = tpl;
        variableValues = {}; 
        headerMediaFile = null;
        headerVariableValue = '';

        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø³ØªØ§ÙŠÙ„ (Active)
        document.querySelectorAll('.tpl-item').forEach(el => el.classList.remove('active'));
        if (itemElement) itemElement.classList.add('active');

        // Ø¥Ø¸Ù‡Ø§Ø± Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯ ÙˆØ¥Ø®ÙØ§Ø¡ Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„ÙØ§Ø±ØºØ©
        if (emptyState) emptyState.style.display = 'none';
        if (configArea) {
            configArea.style.display = 'flex';
            configArea.style.flexDirection = 'column';
        }

        // 1. ØªÙˆÙ„ÙŠØ¯ Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ§Ù‹
        generateInputFields(tpl);

        // 2. Ø±Ø³Ù… Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ø£ÙˆÙ„ÙŠØ©
        updatePreview(tpl);
    }

    // ØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ù‚Ø§Ù„Ø¨
    function generateInputFields(tpl) {
        inputsContainer.innerHTML = '';
        let hasInputs = false;

        // Ø£) Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ù‡ÙŠØ¯Ø± (Header Handling)
        if (tpl.header_type && tpl.header_type !== 'NONE') {
            const headerDiv = document.createElement('div');
            headerDiv.className = 'var-input-group';
            
            if (tpl.header_type === 'TEXT') {
                // Ø§Ù„ØªØ­Ù‚Ù‚ Ù‡Ù„ Ø§Ù„Ù‡ÙŠØ¯Ø± Ø§Ù„Ù†ØµÙŠ ÙŠØ­ØªÙˆÙŠ Ù…ØªØºÙŠØ± {{1}}ØŸ
                if (tpl.header_text && tpl.header_text.includes('{{1}}')) {
                    hasInputs = true;
                    headerDiv.innerHTML = `
                        <label class="var-label">Header Variable {{1}}</label>
                        <input type="text" class="var-input header-var" placeholder="Ù‚ÙŠÙ…Ø© Ù…ØªØºÙŠØ± Ø§Ù„Ø¹Ù†ÙˆØ§Ù†">
                    `;
                    headerDiv.querySelector('input').addEventListener('input', (e) => {
                        headerVariableValue = e.target.value;
                        updatePreview(tpl);
                    });
                    inputsContainer.appendChild(headerDiv);
                }
            } 
            else if (['IMAGE', 'VIDEO', 'DOCUMENT'].includes(tpl.header_type)) {
                hasInputs = true;
                headerDiv.innerHTML = `
                    <label class="var-label">Header Attachment (${tpl.header_type})</label>
                    <input type="file" class="var-input header-file" accept="${getAcceptType(tpl.header_type)}">
                `;
                headerDiv.querySelector('input').addEventListener('change', (e) => {
                    if (e.target.files[0]) {
                        headerMediaFile = e.target.files[0];
                        updatePreview(tpl); // Ù„ØªØ­Ø¯ÙŠØ« ØµÙˆØ±Ø© Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø©
                    }
                });
                inputsContainer.appendChild(headerDiv);
            }
        }

        // Ø¨) Ù…Ø¹Ø§Ù„Ø¬Ø© Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ù†Øµ (Body Variables) {{1}}, {{2}}...
        const bodyVars = extractPlaceholders(tpl.body);
        if (bodyVars.length > 0) {
            hasInputs = true;
            bodyVars.forEach(num => {
                const div = document.createElement('div');
                div.className = 'var-input-group';
                div.innerHTML = `
                    <label class="var-label">Body Variable [[${num}]]</label>
                    <input type="text" class="var-input body-var" data-id="${num}" placeholder="Ù‚ÙŠÙ…Ø© Ø§Ù„Ù…ØªØºÙŠØ± [[${num}]]">
                `;
                div.querySelector('input').addEventListener('input', (e) => {
                    variableValues[num] = e.target.value;
                    updatePreview(tpl);
                });
                inputsContainer.appendChild(div);
            });
        }

        // Ø¬) Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø£Ø²Ø±Ø§Ø± (Buttons) - Ø¥Ø°Ø§ ÙƒØ§Ù† Ø²Ø± Ø±Ø§Ø¨Ø· Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠ
        // (Ù‡Ø°Ù‡ Ø®Ø·ÙˆØ© Ù…ØªÙ‚Ø¯Ù…Ø©ØŒ Ø¥Ø°Ø§ Ø§Ø­ØªØ¬ØªÙ‡Ø§ Ø³Ø£Ø¶ÙŠÙÙ‡Ø§ØŒ Ø­Ø§Ù„ÙŠØ§Ù‹ Ù†Ø±ÙƒØ² Ø¹Ù„Ù‰ Ø§Ù„Ù€ Body/Header)

        if (!hasInputs) {
            inputsContainer.innerHTML = '<div style="padding:10px; color:#8696a0; font-size:13px; font-style:italic;">Ù‡Ø°Ø§ Ø§Ù„Ù‚Ø§Ù„Ø¨ Ù„Ø§ ÙŠØ­ØªØ§Ø¬ Ø¥Ù„Ù‰ Ù…Ø¯Ø®Ù„Ø§Øª. Ø¬Ø§Ù‡Ø² Ù„Ù„Ø¥Ø±Ø³Ø§Ù„.</div>';
        }
    }

    // Ø¯Ø§Ù„Ø© ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ø­ÙŠØ© (Live Preview)
    function updatePreview(tpl) {
        // 1. ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù‡ÙŠØ¯Ø±
        previewHeader.innerHTML = '';
        if (tpl.header_type === 'TEXT' && tpl.header_text) {
            let text = tpl.header_text;
            if (headerVariableValue) text = text.replace('{{1}}', headerVariableValue);
            previewHeader.innerHTML = `<div style="font-weight:bold; margin-bottom:8px;">${escapeHtml(text)}</div>`;
        } 
        else if (['IMAGE', 'VIDEO', 'DOCUMENT'].includes(tpl.header_type)) {
            if (headerMediaFile) {
                const url = URL.createObjectURL(headerMediaFile);
                if (tpl.header_type === 'IMAGE') {
                    previewHeader.innerHTML = `<img src="${url}" style="width:100%; border-radius:8px; margin-bottom:8px;">`;
                } else if (tpl.header_type === 'VIDEO') {
                    previewHeader.innerHTML = `<video src="${url}" controls style="width:100%; border-radius:8px; margin-bottom:8px;"></video>`;
                } else {
                    previewHeader.innerHTML = `<div style="background:#f0f2f5; padding:10px; border-radius:6px; color:#333;">ğŸ“„ ${headerMediaFile.name}</div>`;
                }
            } else {
                // Placeholder
                previewHeader.innerHTML = `<div style="background:#374151; height:120px; border-radius:8px; display:flex; align-items:center; justify-content:center; color:#9ca3af; margin-bottom:8px;">${tpl.header_type} Media</div>`;
            }
        }

        // 2. ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù†Øµ (Body)
        let text = tpl.body;
        // Ø§Ø³ØªØ¨Ø¯Ø§Ù„ ÙƒÙ„ {{x}} Ø¨Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ù…Ø¯Ø®Ù„Ø©
        Object.keys(variableValues).forEach(key => {
            const val = variableValues[key];
            if (val) {
                // Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ù…Ø¹ Ø¬Ø¹Ù„ Ø§Ù„Ù‚ÙŠÙ…Ø© ØºØ§Ù…Ù‚Ø© Bold Ù„ØªÙˆØ¶ÙŠØ­Ù‡Ø§ ÙÙŠ Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø©
                text = text.replace(new RegExp(`\\{\\{${key}\\}\\}`, 'g'), `<b>${escapeHtml(val)}</b>`);
            }
        });
        previewBody.innerHTML = nl2br(text); // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø®Ø§Ù… Ù…Ø¹ Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ©

        // 3. Ø§Ù„ÙÙˆØªØ±
        previewFooter.textContent = tpl.footer || '';

        // 4. Ø§Ù„Ø£Ø²Ø±Ø§Ø± (Mockup)
        // Ù†Ø­ØªØ§Ø¬ Ù„Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ buttons Ø¥Ø°Ø§ ÙƒØ§Ù†Øª ØªØ£ØªÙŠ Ù…Ù† Ø§Ù„Ù€ APIØŒ Ø­Ø§Ù„ÙŠØ§Ù‹ Ø³Ù†Ø¹Ø±Ø¶Ù‡Ø§ ÙƒØ´ÙƒÙ„ ÙÙ‚Ø·
        previewButtons.innerHTML = '';
        // (ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ø¶Ø§ÙØ© Ù…Ù†Ø·Ù‚ Ø¹Ø±Ø¶ Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ù‡Ù†Ø§ Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…ØªÙˆÙØ±Ø© ÙÙŠ tpl.buttons)
    }

    // --- 4. Ø¯Ø§Ù„Ø© Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ© (Submit) ---
    sendBtn.onclick = async function() {
    if (!currentSelectedTemplate) return;

    const phone = window.getCurrentChatPhone ? window.getCurrentChatPhone() : null;
    if (!phone) { alert("Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø­Ø§Ø¯Ø«Ø© Ù…ÙØªÙˆØ­Ø© Ù„Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù‚Ø§Ù„Ø¨ Ø¥Ù„ÙŠÙ‡Ø§."); return; }

    // ØªØ¹Ø·ÙŠÙ„ Ø§Ù„Ø²Ø±
    sendBtn.disabled = true;
    sendBtn.textContent = 'Sending...';

    try {
        const formData = new FormData();
        
        // Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©
        formData.append('type', 'template');
        formData.append('template_name', currentSelectedTemplate.name);
        formData.append('language', currentSelectedTemplate.language);
        formData.append('to', phone);
        formData.append('channel_id', window.currentChannelId);

        // ============================================================
        // ğŸ”¥ Ø§Ù„ØªØµØ­ÙŠØ­ Ù‡Ù†Ø§: Ø¨Ù†Ø§Ø¡ Ù‡ÙŠÙƒÙ„ components Ø§Ù„Ø°ÙŠ ÙŠØ·Ù„Ø¨Ù‡ ÙˆØ§ØªØ³Ø§Ø¨ ğŸ”¥
        // ============================================================
        
        const components = [];

        // 1. Ù…Ø¹Ø§Ù„Ø¬Ø© Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ù†Øµ (Body)
        const bodyParams = [];
        const sortedKeys = Object.keys(variableValues).map(Number).sort((a,b)=>a-b);
        
        sortedKeys.forEach(k => {
            // ÙˆØ§ØªØ³Ø§Ø¨ ÙŠØ±ÙŠØ¯ ÙƒÙ„ Ù…ØªØºÙŠØ± ÙƒÙƒØ§Ø¦Ù† {type: "text", text: "Ø§Ù„Ù‚ÙŠÙ…Ø©"}
            bodyParams.push({ 
                type: "text", 
                text: variableValues[k] 
            });
        });

        if (bodyParams.length > 0) {
            components.push({
                type: "body",
                parameters: bodyParams
            });
        }

        // 2. Ù…Ø¹Ø§Ù„Ø¬Ø© Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ù‡ÙŠØ¯Ø± (Header) - Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù†ØµÙŠØ©
        // (Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù‡ÙŠØ¯Ø± ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ {{1}})
        if (headerVariableValue) {
             components.push({
                type: "header",
                parameters: [
                    { type: "text", text: headerVariableValue }
                ]
            });
        }

        // Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù€ components ÙƒÙ€ JSON String
        // Ø§Ù„Ø¨Ø§Ùƒ Ø¥Ù†Ø¯ Ø³ÙŠØ³ØªÙ„Ù…Ù‡Ø§ØŒ ÙŠÙÙƒ ØªØ´ÙÙŠØ±Ù‡Ø§ØŒ ÙˆÙŠØ±Ø³Ù„Ù‡Ø§ Ù„Ù…ÙŠØªØ§ ÙƒÙ…Ø§ Ù‡ÙŠ
        if (components.length > 0) {
            formData.append('components', JSON.stringify(components));
        }

        // 3. Ù…Ø¹Ø§Ù„Ø¬Ø© Ù…Ù„ÙØ§Øª Ø§Ù„Ù‡ÙŠØ¯Ø± (Ø¥Ø°Ø§ ÙƒØ§Ù†Øª ØµÙˆØ±Ø©/ÙÙŠØ¯ÙŠÙˆ)
        // Ù‡Ø°Ù‡ ØªØ¸Ù„ Ù…Ù†ÙØµÙ„Ø© Ù„Ø£Ù†Ù‡Ø§ Ù…Ù„ÙØ§ØªØŒ ÙˆØ§Ù„Ø¨Ø§Ùƒ Ø¥Ù†Ø¯ Ø³ÙŠØ¹Ø§Ù„Ø¬Ù‡Ø§
        if (headerMediaFile) {
            formData.append('header_file', headerMediaFile);
            formData.append('header_type', currentSelectedTemplate.header_type);
        }

        // ============================================================

        // Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨
        const response = await fetch("{% url 'send_message' %}", {
            method: 'POST',
            headers: { 'X-CSRFToken': getCsrfToken() }, 
            body: formData
        });

        const res = await response.json();
        
        if (response.ok) {
            window.closeTemplateModal();
            if (window.fetchMessagesForCurrentws) window.fetchMessagesForCurrentws();
            alert("ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù‚Ø§Ù„Ø¨ Ø¨Ù†Ø¬Ø§Ø­ âœ…");
        } else {
            console.error("Server Error:", res);
            alert("ÙØ´Ù„ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„: " + (res.error || JSON.stringify(res)));
        }

    } catch (e) {
        console.error(e);
        alert("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø³ÙŠØ±ÙØ±");
    } finally {
        sendBtn.disabled = false;
        sendBtn.textContent = 'Send Message';
    }
};
    // --- Ø¯ÙˆØ§Ù„ Ù…Ø³Ø§Ø¹Ø¯Ø© ---
    function extractPlaceholders(text) {
        const re = /\{\{(\d+)\}\}/g;
        const nums = new Set();
        let m;
        while ((m = re.exec(text)) !== null) {
            nums.add(parseInt(m[1]));
        }
        return Array.from(nums).sort((a,b)=>a-b);
    }

    function getAcceptType(type) {
        if (type === 'IMAGE') return 'image/*';
        if (type === 'VIDEO') return 'video/*';
        if (type === 'DOCUMENT') return '.pdf,.doc,.docx,.xls,.xlsx,.ppt,.pptx';
        return '*/*';
    }

    function getCsrfToken() { return document.querySelector('[name=csrfmiddlewaretoken]')?.value || ''; }
    function escapeHtml(s) { return (s || '').toString().replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
    function nl2br(s) { return (s || '').replace(/\r?\n/g, '<br>'); }

    // --- Ø¯ÙˆØ§Ù„ Ø§Ù„ÙØªØ­ ÙˆØ§Ù„Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ø¹Ø§Ù…Ø© ---
    window.openTemplatePanel = function() {
        const modal = document.getElementById('cls3741_template_modal');
        if(modal) modal.style.display = 'flex';
        window.loadTemplate();
    };
    
    window.closeTemplateModalchat = function() {
        const modal = document.getElementById('cls3741_template_modal');
        if(modal) modal.style.display = 'none';
        // ØªÙ†Ø¸ÙŠÙ
        currentSelectedTemplate = null;
        variableValues = {};
        headerMediaFile = null;
        if(inputsContainer) inputsContainer.innerHTML = '';
        if(previewBody) previewBody.innerHTML = '';
    };
// Ø¶Ø¹Ù‡ ÙÙŠ Ø£ÙŠ Ù…ÙƒØ§Ù† ÙÙŠ Ù…Ù„Ù JS (Ø®Ø§Ø±Ø¬ Ø§Ù„Ø¯ÙˆØ§Ù„ Ø§Ù„Ø£Ø®Ø±Ù‰)
 
})();
  
  
  </script>



<section class="cls3741_panel cls3741_panel_chats" style="display:none;">
 
  <div class="cls3741_chats_root">

    <!-- LEFT: contacts list -->
    <div class="cls3741_contacts_col" role="navigation" aria-label="Contacts">
      <!-- ğŸ”¥ Ø´Ø±ÙŠØ· Ø§Ù„Ø¨Ø­Ø« ÙˆØ§Ù„ÙÙ„ØªØ±Ø© Ø§Ù„Ù…Ø­Ø³Ù‘Ù† -->
      <div class="cls3741_search_filter_bar">
        <div class="cls3741_search_wrapper_new">
          <svg class="cls3741_search_icon_new" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="11" cy="11" r="8"></circle>
            <path d="m21 21-4.35-4.35"></path>
          </svg>
          <input 
            type="text" 
            id="cls3741_search" 
            class="cls3741_search_input_new"
            placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† Ø§Ø³Ù… Ø£Ùˆ Ø±Ù‚Ù…..." 
            aria-label="Search contacts"
            autocomplete="off"
          />
          <button class="cls3741_search_clear" id="cls3741_search_clear" style="display:none;" aria-label="Clear search">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <line x1="18" y1="6" x2="6" y2="18"></line>
              <line x1="6" y1="6" x2="18" y2="18"></line>
            </svg>
          </button>
      </div>

        <!-- ğŸ”¥ Ø£Ø²Ø±Ø§Ø± Ø§Ù„ÙÙ„ØªØ±Ø© -->
        <div class="cls3741_filter_buttons">
          <button class="cls3741_filter_btn active" data-filter="all" title="Ø§Ù„ÙƒÙ„">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M3 3h18v18H3z"></path>
            </svg>
            <span>Ø§Ù„ÙƒÙ„</span>
          </button>
          <button class="cls3741_filter_btn" data-filter="unread" title="ØºÙŠØ± Ù…Ù‚Ø±ÙˆØ¡">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="12" cy="12" r="10"></circle>
            </svg>
            <span>ØºÙŠØ± Ù…Ù‚Ø±ÙˆØ¡</span>
          </button>
          <button class="cls3741_filter_btn" data-filter="read" title="Ù…Ù‚Ø±ÙˆØ¡">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M20 6L9 17l-5-5"></path>
            </svg>
            <span>Ù…Ù‚Ø±ÙˆØ¡</span>
          </button>
        </div>
      </div>

      <div class="cls3741_contacts_list" id="cls3741_contacts_list" role="list">
        <div id="cls3741_contacts_loader" class="cls3741_loader_new">
          <div class="cls3741_spinner"></div>
          <span>Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</span>
        </div>
      </div>
    </div>

 
    <!-- CENTER: chat conversation -->
    
     <!-- CENTER: chat conversation -->
    <div class="cls3741_chat_col" id="cls3741_chat_col" aria-live="polite">
      <div class="cls3741_chat_header">
        <div style="display:flex;align-items:center;gap:10px">
          <div class="cls3741_contact_avatar" id="cls3741_active_avatar">B</div>
          <div>
            <div class="title" id="cls3741_active_name"></div>
            <div style="font-size:13px;color:var(--muted)" id ="last_seen_"></div>
          </div>
          
        </div>
        <div style="margin-left:auto;display:flex;gap:8px">
         <!-- <button id="make_important" class="cls3741_action_btn" title="Make important">important</button> -->
          <button id="cls3741_open_info" class="cls3741_action_btn" title="Open contact info">Create order</button>
        </div>
      </div>

      <div class="cls3741_messages_area" id="cls3741_messages_area" tabindex="0">
        <div class="flex items-center justify-center" style="
    display: flex;
    align-content: space-between;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    height: 100%;">
          <img src="https://leadr.space/build/assets/choose-conversation-Cj2zZ2gp.svg" alt="choose a conversation image" class="w-lg">
        <span >Select a conversation to start chatting</span>
        </div>

        <!-- sample messages -->
        <!-- <div class="cls3741_msg_bubble">Ø£Ù‡Ù„Ù‹Ø§! Ù‡Ù„ Ø§Ù„Ù…Ù†ØªØ¬ Ù…ØªÙˆÙØ±ØŸ <span class="cls3741_msg_time">10:12</span></div>
        <div class="cls3741_msg_bubble me">Ù†Ø¹Ù… Ù…ØªÙˆÙØ±ØŒ Ù†Ø±Ø³Ù„ Ù„Ùƒ Ø§Ù„ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¢Ù†. <span class="cls3741_msg_time">10:13</span></div>
        <div class="cls3741_msg_bubble">ÙƒÙ… Ø§Ù„Ø«Ù…Ù† ÙˆÙˆÙ‚Øª Ø§Ù„ØªÙˆØµÙŠÙ„ØŸ <span class="cls3741_msg_time">10:15</span></div>
        <div class="cls3741_msg_bubble me">Ø§Ù„Ø³Ø¹Ø± 250 Ø¯Ø±Ù‡Ù… ÙˆØ§Ù„ØªÙˆØµÙŠÙ„ Ø®Ù„Ø§Ù„ 48 Ø³Ø§Ø¹Ø© <span class="cls3741_msg_time">10:16</span></div>
        <div class="cls3741_msg_bubble">Ø´ÙƒØ±Ù‹Ø§ Ù„Ùƒ! Ø³Ø£Ø·Ù„Ø¨ Ø§Ù„Ø¢Ù† <span class="cls3741_msg_time">10:17</span></div> -->
      </div>

      <!-- Ù…Ù†Ø·Ù‚Ø© Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ ÙˆØ§Ù„ÙˆØ³Ø§Ø¦Ø· - ØªØµÙ…ÙŠÙ… Ù…Ø´Ø§Ø¨Ù‡ Ù„Ù„ÙˆØ§ØªØ³Ø§Ø¨ -->
      <div class="cls3741_chat_input_wrapper">
        <!-- Ù…Ù†Ø·Ù‚Ø© Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„ÙˆØ³Ø§Ø¦Ø· -->
        <div class="cls3741_media_preview" id="cls3741_media_preview"></div>
        
        <div class="cls3741_chat_input_container">
          <!-- Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø¹Ù„Ù‰ Ø§Ù„ÙŠØ³Ø§Ø± -->
          <div class="cls3741_input_actions">
            <!-- Ø²Ø± Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ØµÙˆØªÙŠ -->
            <!-- <button type="button" class="cls3741_icon_btn" id="cls3741_audio_btn" title="ØªØ³Ø¬ÙŠÙ„ ØµÙˆØªÙŠ">
              ğŸ¤
            </button> -->

        
            <!-- Ø²Ø± Ø±ÙØ¹ Ø§Ù„ØµÙˆØ± -->
            <button type="button" class="cls3741_icon_btn" id="cls3741_image_btn" title="Ø±ÙØ¹ ØµÙˆØ±Ø©">
              ğŸ“·
            </button>
            
            <!-- Ø²Ø± Ø±ÙØ¹ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ -->
            <button type="button" class="cls3741_icon_btn" id="cls3741_video_btn" title="Ø±ÙØ¹ ÙÙŠØ¯ÙŠÙˆ">
              ğŸ¬
            </button> 
               <button aria-label="Dictate button" type="button" id="cls3741_audio_btn" title="ØªØ³Ø¬ÙŠÙ„ ØµÙˆØªÙŠ" class="composer-btn cls3741_icon_btn"><svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor" xmlns="http://www.w3.org/2000/svg" aria-label="" class="icon" font-size="inherit"><path d="M15.7806 10.1963C16.1326 10.3011 16.3336 10.6714 16.2288 11.0234L16.1487 11.2725C15.3429 13.6262 13.2236 15.3697 10.6644 15.6299L10.6653 16.835H12.0833L12.2171 16.8486C12.5202 16.9106 12.7484 17.1786 12.7484 17.5C12.7484 17.8214 12.5202 18.0894 12.2171 18.1514L12.0833 18.165H7.91632C7.5492 18.1649 7.25128 17.8672 7.25128 17.5C7.25128 17.1328 7.5492 16.8351 7.91632 16.835H9.33527L9.33429 15.6299C6.775 15.3697 4.6558 13.6262 3.84992 11.2725L3.76984 11.0234L3.74445 10.8906C3.71751 10.5825 3.91011 10.2879 4.21808 10.1963C4.52615 10.1047 4.84769 10.2466 4.99347 10.5195L5.04523 10.6436L5.10871 10.8418C5.8047 12.8745 7.73211 14.335 9.99933 14.335C12.3396 14.3349 14.3179 12.7789 14.9534 10.6436L15.0052 10.5195C15.151 10.2466 15.4725 10.1046 15.7806 10.1963ZM12.2513 5.41699C12.2513 4.17354 11.2437 3.16521 10.0003 3.16504C8.75675 3.16504 7.74835 4.17343 7.74835 5.41699V9.16699C7.74853 10.4104 8.75685 11.418 10.0003 11.418C11.2436 11.4178 12.2511 10.4103 12.2513 9.16699V5.41699ZM13.5814 9.16699C13.5812 11.1448 11.9781 12.7479 10.0003 12.748C8.02232 12.748 6.41845 11.1449 6.41828 9.16699V5.41699C6.41828 3.43889 8.02221 1.83496 10.0003 1.83496C11.9783 1.83514 13.5814 3.439 13.5814 5.41699V9.16699Z"></path></svg></button>
            
          </div>

          <!-- Ø­Ù‚Ù„ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ù†Øµ -->
          <textarea 
            class="cls3741_chat_textarea" 
            id="cls3741_message_input" 
            placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„Ø©..."
            rows="1"
          ></textarea>

          <!-- Ø²Ø± Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ -->
          <button class="cls3741_send_btn" id="cls3741_send_btn" title="Ø¥Ø±Ø³Ø§Ù„">
            <svg class="cls3741_send_icon" viewBox="0 0 24 24" fill="currentColor">
              <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/>
            </svg>
          </button>
        </div>
      </div>

      <!-- Ø¹Ù†Ø§ØµØ± Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ù…Ø®ÙÙŠØ© Ù„Ù„Ù…Ù„ÙØ§Øª -->
      <input type="file" id="cls3741_image_input" class="cls3741_hidden_input" accept="image/*">
      <input type="file" id="cls3741_video_input" class="cls3741_hidden_input" accept="video/*">
    </div>


    <!-- RIGHT: user info card -->
    <aside class="cls3741_user_col" style="width: 400px; padding:0px !important;  scrollbar-width: none;" id="cls3741_user_col" aria-label="Contact info">
      <div id="sidebar-main-wrapper" class="quick-sidebar-container" style=" scrollbar-width: none;">

        <div id="crm_view_panel" class="view-panel fade-in">
            
            <div class="crm-profile-section">
                <div class="crm-avatar" id="crm-avatar_sidbar">
                    <span>{{ active_contact.name|slice:":1"|upper }}</span>
                </div>
                <h3 class="crm-name">{{ active_contact.name }}</h3>
                <p class="crm-phone">{{ active_contact.phone }}</p>
                
                <div class="crm-actions">
                    <a href="#" class="crm-action-btn">
                        <i class="fas fa-edit"></i> Edit
                    </a>
                </div>
            </div>
    
            <div class="quick-body custom-scroll">
                
                <div class="form-group mb-4">
                    <label class="input-label">Assign to Agent</label>
                    <div class="product-select-wrapper">
                        <select id="crm_assign_agent" class="modern-select">
                            <option value="">Unassigned</option>
                            
                            {% for agent in team_members %}

                                <option value="{{ agent.id }}">{{ agent.user_name }}</option>
                            {% endfor %}
                        </select>
                        <i class="fas fa-chevron-down select-arrow"></i>
                    </div>
                </div>
    
                <div class="form-group mb-4">
                    <label class="input-label">Tags</label>
                    <div class="modern-tags-input" onclick="openTagsModal()">
                        <span class="placeholder-text">Select tags...</span>
                        <i class="fas fa-plus tag-icon"></i>
                    </div>
                </div>
    
                <div class="form-group mb-4">
                    <label class="input-label">Pipeline Stage</label>
                    <div class="product-select-wrapper">
                        <select id="crm_pipeline_stage" class="modern-select">
                            <option value="new">ğŸ†• New Chat</option>
                            <option value="interested">ğŸ”¥ Interested</option>
                            <option value="follow_up">ğŸ“… Follow Up</option>
                            <option value="closed">âœ… Closed / Won</option>
                            <option value="rejected">âŒ Not Interested</option>
                        </select>
                        <i class="fas fa-chevron-down select-arrow"></i>
                    </div>
                </div>
    
                <div class="crm-orders-section">
                    <div class="section-header">
                        <span>Previous Orders (0)</span>
                    </div>
                    
                    <div class="empty-orders-state">
                        <i class="fas fa-box-open"></i>
                        <p>No orders yet for this customer</p>
                        
                        <button onclick="switchSidebarView('order')" class="create-order-btn-lg">
                            Create Order
                        </button>
                    </div>
                </div>
    
            </div>
        </div>
    
    
        <div id="order_form_panel" class="view-panel" style="display: none;">
            
            <!-- <div class="quick-header bg-highlight"> -->
               
                <div class="quick-header" style="width:100%;">
                
                  <!-- <div class="header-icon"> -->
                    <button onclick="switchSidebarView('crm')" class="back-btn">
                      <i class="fas fa-arrow-left"></i>
                  </button>
                  <!-- </div> -->
                  <div>
                      <h6 class="header-title">Quick Order</h6>
                      <p class="header-subtitle">Create a new order instantly</p>
                  </div>
              </div>
            <!-- </div> -->
    
            <div class="quick-body custom-scroll">
              <form id="quick_order_form" autocomplete="off">
                {% csrf_token %}
                
                <div class="form-group mb-4">
                    <label class="input-label">Select Product</label>
                    <div class="product-select-wrapper">
                        <select id="quick_product_select" class="modern-select">
                            <option value="" selected disabled>Choose a product...</option>
                            {% for product in productslist %}
                                <option value="{{ product.sku }}" data-name="{{ product.name }}">{{ product.name }}</option>
                            {% endfor %}
                        </select>
                        <i class="fas fa-chevron-down select-arrow"></i>
                    </div>
                </div>
    
                <div class="form-group mb-3">
                    <label class="input-label">Customer Details</label>
                    <div class="input-icon-wrapper mb-2">
                        <i class="fas fa-user field-icon"></i>
                        <input type="text" name="name" id="quick_name" class="modern-input" placeholder="Full Name" required>
                    </div>
                    <div class="input-icon-wrapper">
                        <i class="fas fa-phone field-icon"></i>
                        <input type="tel" name="phone" id="quick_phone" class="modern-input" placeholder="Phone Number" required>
                    </div>
                </div>
    
                <div class="row g-2 mb-3">
                    <div class="col-7">
                        <label class="input-label">City</label>
                        <input type="text" name="city" class="modern-input" placeholder="Riyadh...">
                    </div>
                    <div class="col-5">
                        <label class="input-label">Price</label>
                        <input type="number" name="product_price" id="quick_price" class="modern-input" placeholder="0.00">
                    </div>
                </div>
    
                <div class="form-group mb-4">
                    <label class="input-label">Address / Notes</label>
                    <textarea name="address" class="modern-input textarea-resize" rows="2" placeholder="Street, Building, etc..."></textarea>
                </div>
    
                <div class="qty-container mb-4">
                    <span class="qty-label">Quantity</span>
                    <div class="qty-controls">
                        <button type="button" class="qty-btn" onclick="adjQuickQty(-1)">âˆ’</button>
                        <input type="number" name="product_quantity" id="quick_qty" value="1" min="1" class="qty-input" readonly>
                        <button type="button" class="qty-btn" onclick="adjQuickQty(1)">+</button>
                    </div>
                </div>
    
                <div class="footer-action">
                    <button type="submit" id="quick_submit_btn" class="submit-btn-modern">
                        <span>Create Order</span>
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
            </form>
            </div>
        </div>
    
    </div>
      <div class="cls3741_user_head d-none">
        <div class="quick-header" style="width:100%;">
          <div class="header-icon">
              <i class="fas fa-bolt"></i>
          </div>
          <div>
              <h6 class="header-title">Quick Order</h6>
              <p class="header-subtitle">Create a new order instantly</p>
          </div>
      </div>
      </div>
 
      <script>

        document.addEventListener("DOMContentLoaded", function() {
            // Ø§Ù„ØªØ¨Ø¯ÙŠÙ„ Ø¨ÙŠÙ† ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù€ CRM ÙˆÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø·Ù„Ø¨
window.switchSidebarView = function(viewName) {
    const crmPanel = document.getElementById('crm_view_panel');
    const orderPanel = document.getElementById('order_form_panel');
    
    if (viewName === 'order') {
        crmPanel.style.display = 'none';
        orderPanel.style.display = 'flex';
        // Ø¥Ø¶Ø§ÙØ© Ø£Ù†ÙŠÙ…ÙŠØ´Ù† Ø¨Ø³ÙŠØ·
        orderPanel.classList.add('fade-in');
    } else {
        orderPanel.style.display = 'none';
        crmPanel.style.display = 'flex';
        crmPanel.classList.add('fade-in');
    }
};

// Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©ØŒ ØªØ£ÙƒØ¯ Ø£Ù† Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„ ÙÙŠ ÙÙˆØ±Ù… Ø§Ù„Ø·Ù„Ø¨ ÙŠØ·Ø§Ø¨Ù‚ Ø§Ù„Ø¨Ø±ÙˆÙØ§ÙŠÙ„
document.addEventListener("DOMContentLoaded", function() {
    // ÙŠÙ…ÙƒÙ†Ùƒ Ù‡Ù†Ø§ Ø¥Ø¶Ø§ÙØ© ÙƒÙˆØ¯ Ù„Ù…Ù„Ø¡ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¹Ù†Ø¯ ÙØªØ­ Ø´Ø§Øª Ø¬Ø¯ÙŠØ¯
});
            // 1. Ø§Ù„ØªØ­ÙƒÙ… ÙÙŠ Ø§Ù„ÙƒÙ…ÙŠØ©
            window.adjQuickQty = function(change) {
                const input = document.getElementById('quick_qty');
                let val = parseInt(input.value) || 1;
                val += change;
                if(val < 1) val = 1;
                input.value = val;
            };
        
            // 2. Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬
            const quickForm = document.getElementById('quick_order_form');
            
            if(quickForm) {
                quickForm.addEventListener('submit', async function(e) {
                    e.preventDefault();
                    
                    const btn = document.getElementById('quick_submit_btn');
                    const originalContent = btn.innerHTML;
                    const productSelect = document.getElementById('quick_product_select');
        
                    if(!productSelect.value) {
                        // ØªØ£Ø«ÙŠØ± Ø§Ù‡ØªØ²Ø§Ø² Ø¨Ø³ÙŠØ· Ù„Ù„Ø­Ù‚Ù„ ÙÙŠ Ø­Ø§Ù„ Ø§Ù„Ø®Ø·Ø£
                        productSelect.style.borderColor = '#ef4444';
                        setTimeout(() => productSelect.style.borderColor = '', 2000);
                        return;
                    }
        
                    const formData = new FormData(quickForm);
                    // Ø¥Ø¶Ø§ÙØ© SKU ÙŠØ¯ÙˆÙŠØ§Ù‹
                    formData.append('selected_sku', productSelect.value);
                    
                    // Loading State
                    btn.disabled = true;
                    btn.innerHTML = '<span class="spinner-border spinner-border-sm" style="width:1rem;height:1rem;"></span> Processing...';
        
                    try {
                        // âš ï¸ Ø§Ø³ØªØ¨Ø¯Ù„ Ø§Ù„Ø±Ø§Ø¨Ø· Ø£Ø¯Ù†Ø§Ù‡ Ø¨Ø±Ø§Ø¨Ø· Ø§Ù„Ù€ View Ø§Ù„Ø®Ø§Øµ Ø¨Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø·Ù„Ø¨
                        const response = await fetch('/your/create-order-url/', { 
                            method: 'POST',
                            body: formData,
                            headers: { 'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value }
                        });
        
                        const result = await response.json();
        
                        if(result.success || response.ok) {
                            // Ù†Ø¬Ø§Ø­: Ù†Ø¹ÙŠØ¯ Ø§Ù„Ø²Ø± Ù„Ù„ÙˆÙ† Ø§Ù„Ø£Ø®Ø¶Ø± Ù„Ù„Ø­Ø¸Ø©
                            btn.style.background = '#10b981';
                            btn.innerHTML = '<i class="fas fa-check"></i> Success';
                            setTimeout(() => {
                                btn.style.background = ''; // Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„ÙˆÙ† Ø§Ù„Ø£ØµÙ„ÙŠ
                                btn.innerHTML = originalContent;
                                quickForm.reset();
                                document.getElementById('quick_qty').value = 1;
                            }, 2000);
                        } else {
                            alert("Error: " + (result.message || "Failed to create order"));
                            btn.disabled = false;
                            btn.innerHTML = originalContent;
                        }
        
                    } catch (err) {
                        console.error(err);
                        alert("Connection Error");
                        btn.disabled = false;
                        btn.innerHTML = originalContent;
                    }
                });
            }
        });
            </script>
        
        <div id="quick-order-sidebar" class="quick-sidebar-container d-none">
    
   
   
      </div>
        
        <style>
          /* --- CRM View Styles --- */

/* Animation for switching */
.fade-in { animation: fadeIn 0.3s ease-in-out; }
@keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

/* Profile Section */
.crm-profile-section {
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 30px 20px 20px;
    border-bottom: 1px solid var(--qs-border);
    background: linear-gradient(to bottom, rgba(255,255,255,0.02), transparent);
}

.crm-avatar {
    width: 80px;
    height: 80px;
    border-radius: 50%;
    background: linear-gradient(135deg, #0891b2 0%, #67e8f9 100%); /* Cyan Gradient */
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 2.5rem;
    font-weight: 300;
    color: white;
    box-shadow: 0 10px 20px rgba(8, 145, 178, 0.3);
    margin-bottom: 12px;
}

.crm-name { font-size: 1.1rem; font-weight: 700; color: var(--qs-text); margin: 0; }
.crm-phone { font-size: 0.9rem; color: var(--qs-text-muted); margin: 4px 0 12px; }

.crm-action-btn {
    font-size: 0.8rem;
    padding: 6px 16px;
    border-radius: 20px;
    background: var(--qs-surface);
    color: var(--qs-text);
    text-decoration: none;
    border: 1px solid var(--qs-border);
    transition: all 0.2s;
}
.crm-action-btn:hover { background: var(--qs-border); color: white; }

/* Tags Input Mockup */
.modern-tags-input {
    min-height: 42px;
    background: var(--qs-surface);
    border: 1px solid var(--qs-border);
    border-radius: var(--qs-radius);
    padding: 8px 12px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    cursor: pointer;
}
.modern-tags-input .placeholder-text { font-size: 0.85rem; color: #6b7280; }
.modern-tags-input .tag-icon { color: var(--qs-accent); font-size: 0.9rem; }

/* Orders Section */
.crm-orders-section {
    margin-top: 20px;
    background: rgba(0,0,0,0.2);
    border-radius: var(--qs-radius);
    overflow: hidden;
    border: 1px solid var(--qs-border);
}

.section-header {
    background: rgba(255,255,255,0.03);
    padding: 10px 15px;
    font-size: 0.85rem;
    font-weight: 600;
    color: var(--qs-accent);
    border-bottom: 1px solid var(--qs-border);
}

.empty-orders-state {
    padding: 30px 20px;
    text-align: center;
    color: var(--qs-text-muted);
}
.empty-orders-state i { font-size: 2rem; margin-bottom: 10px; opacity: 0.5; }
.empty-orders-state p { font-size: 0.9rem; margin-bottom: 15px; }

/* Main CTA Button */
.create-order-btn-lg {
    background: var(--qs-accent);
    color: white;
    border: none;
    padding: 10px 20px;
    border-radius: 8px;
    font-weight: 600;
    font-size: 0.9rem;
    cursor: pointer;
    box-shadow: 0 4px 15px rgba(99, 102, 241, 0.4);
    transition: transform 0.2s;
}
.create-order-btn-lg:hover { transform: translateY(-2px); background: var(--qs-accent-hover); }

/* Back Button for Order Form */
.back-btn {
    background: transparent;
    border: none;
    color: var(--qs-text-muted);
    font-size: 1.1rem;
    cursor: pointer;
    margin-right: 10px;
    padding: 4px;
}
.back-btn:hover { color: white; }

/* Cancel Button */
.btn-cancel-modern {
    width: 100%;
    background: transparent;
    border: 1px solid var(--qs-border);
    color: var(--qs-text-muted);
    padding: 10px;
    border-radius: var(--qs-radius);
    margin-top: 8px;
    cursor: pointer;
}
.btn-cancel-modern:hover { background: var(--qs-surface); color: white; }

/* Helpers */
.view-panel { height: 100%; display: flex; flex-direction: column; }
.bg-highlight { background: rgba(99, 102, 241, 0.08); }




          /* --- Quick Sidebar Variables --- */
        :root {
            --qs-bg: #111827;           /* Ø®Ù„ÙÙŠØ© Ø¯Ø§ÙƒÙ†Ø© Ø¬Ø¯Ø§Ù‹ */
            --qs-surface: #1f2937;      /* Ø®Ù„ÙÙŠØ© Ø§Ù„Ø­Ù‚ÙˆÙ„ */
            --qs-border: #374151;       /* Ù„ÙˆÙ† Ø§Ù„Ø­Ø¯ÙˆØ¯ */
            --qs-text: #f3f4f6;         /* Ø§Ù„Ù†Øµ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ */
            --qs-text-muted: #9ca3af;   /* Ø§Ù„Ù†Øµ Ø§Ù„Ø«Ø§Ù†ÙˆÙŠ */
            --qs-accent: #6366f1;       /* Ø§Ù„Ù„ÙˆÙ† Ø§Ù„Ù…Ù…ÙŠØ² (Indigo) */
            --qs-accent-hover: #4f46e5;
            --qs-radius: 10px;
        }
        
        /* Container */
        .quick-sidebar-container {
            height: 100%;
            display: flex;
            flex-direction: column;
            background-color: var(--qs-bg);
            /* border-left: 1px solid var(--qs-border); */
            color: var(--qs-text);
            font-family: 'Inter', system-ui, sans-serif;
            width: 100%; /* Ø³ÙŠØ£Ø®Ø° Ø¹Ø±Ø¶ Ø§Ù„Ù€ 400px Ù…Ù† Ø§Ù„Ø£Ø¨ */
        }
        
        /* Header */
        .quick-header {
            padding: 20px;
            border-bottom: 1px solid var(--qs-border);
            display: flex;
            align-items: center;
            gap: 12px;
            background: rgba(255,255,255,0.02);
        }
        .header-icon {
            width: 36px;
            height: 36px;
            background: rgba(99, 102, 241, 0.15);
            color: var(--qs-accent);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.1rem;
        }
        .header-title { margin: 0; font-weight: 700; font-size: 0.95rem; color: var(--qs-text); }
        .header-subtitle { margin: 0; font-size: 0.75rem; color: var(--qs-text-muted); }
        
        /* Body & Scroll */
        .quick-body {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
        }
        /* Custom Scrollbar */
        .custom-scroll::-webkit-scrollbar { width: 5px; }
        .custom-scroll::-webkit-scrollbar-track { background: transparent; }
        .custom-scroll::-webkit-scrollbar-thumb { background: var(--qs-border); border-radius: 10px; }
        
        /* Labels */
        .input-label {
            display: block;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            color: var(--qs-text-muted);
            margin-bottom: 6px;
            letter-spacing: 0.5px;
        }
        
        /* Modern Inputs */
        .modern-input, .modern-select {
            width: 100%;
            background: var(--qs-surface);
            border: 1px solid var(--qs-border);
            color: var(--qs-text);
            border-radius: var(--qs-radius);
            padding: 10px 12px;
            font-size: 0.9rem;
            transition: all 0.2s;
            outline: none;
        }
        .modern-input:focus, .modern-select:focus {
            border-color: var(--qs-accent);
            box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.2);
            background: #252f3f; /* Ø£ÙØªØ­ Ù‚Ù„ÙŠÙ„Ø§Ù‹ Ø¹Ù†Ø¯ Ø§Ù„ØªØ±ÙƒÙŠØ² */
        }
        .modern-input::placeholder { color: #4b5563; }
        
        /* Input with Icon Wrapper */
        .input-icon-wrapper { position: relative; }
        .input-icon-wrapper .field-icon {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: #6b7280;
            font-size: 0.9rem;
            pointer-events: none;
        }
        .input-icon-wrapper .modern-input { padding-left: 36px; }
        
        /* Select Wrapper */
        .product-select-wrapper { position: relative; }
        .modern-select { appearance: none; cursor: pointer; }
        .select-arrow {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--qs-text-muted);
            pointer-events: none;
            font-size: 0.8rem;
        }
        
        /* Quantity Stepper */
        .qty-container {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: var(--qs-surface);
            border: 1px solid var(--qs-border);
            padding: 8px 12px;
            border-radius: var(--qs-radius);
        }
        .qty-label { font-size: 0.85rem; font-weight: 500; }
        .qty-controls { display: flex; align-items: center; gap: 8px; }
        .qty-btn {
            width: 28px;
            height: 28px;
            border-radius: 6px;
            border: none;
            background: #374151;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.1rem;
            line-height: 0;
            transition: background 0.2s;
        }
        .qty-btn:hover { background: #4b5563; }
        .qty-input {
            width: 30px;
            background: transparent;
            border: none;
            color: white;
            text-align: center;
            font-weight: 700;
            padding: 0;
        }
        /* Ø¥Ø®ÙØ§Ø¡ Ø£Ø³Ù‡Ù… Ø§Ù„Ø±Ù‚Ù… ÙÙŠ input number */
        .qty-input::-webkit-outer-spin-button, .qty-input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        
        /* Submit Button */
        .submit-btn-modern {
            width: 100%;
            padding: 12px;
            background: linear-gradient(135deg, var(--qs-accent), var(--qs-accent-hover));
            color: white;
            border: none;
            border-radius: var(--qs-radius);
            font-weight: 600;
            font-size: 0.95rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: transform 0.1s, box-shadow 0.2s;
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
        }
        .submit-btn-modern:hover {
            transform: translateY(-1px);
            box-shadow: 0 6px 16px rgba(99, 102, 241, 0.4);
        }
        .submit-btn-modern:active { transform: translateY(0); }
        </style>
    </aside>



    <script>
      document.addEventListener("DOMContentLoaded", function() {
    
    // 1. Ø§Ù„ØªØ­ÙƒÙ… ÙÙŠ Ø§Ù„ÙƒÙ…ÙŠØ© (+/-)
    window.adjSidebarQty = function(change) {
        const input = document.getElementById('sidebar_qty');
        let val = parseInt(input.value) || 1;
        val += change;
        if(val < 1) val = 1;
        input.value = val;
    };

    // 2. Ø¹Ù†Ø¯ Ø§Ø®ØªÙŠØ§Ø± Ù…Ù†ØªØ¬ØŒ Ù†Ù…Ù„Ø£ Ø§Ù„Ø³Ø¹Ø± ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)
    const productSelect = document.getElementById('sidebar_product_select');
    if(productSelect) {
        productSelect.addEventListener('change', function() {
            // Ù‡Ù†Ø§ ÙŠÙ…ÙƒÙ†Ùƒ Ø¬Ù„Ø¨ Ø§Ù„Ø³Ø¹Ø± Ù…Ù† data-price Ø¥Ø°Ø§ Ø£Ø¶ÙØªÙ‡ ÙÙŠ Ø§Ù„Ù€ HTML
            // const price = this.options[this.selectedIndex].dataset.price;
            // document.getElementById('sidebar_price').value = price;
        });
    }

    // 3. Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ (AJAX)
    const sidebarForm = document.getElementById('sidebar_order_form');
    if(sidebarForm) {
        sidebarForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const btn = document.getElementById('sidebar_submit_btn');
            const originalText = btn.innerHTML;
            
            // Ø§Ù„ØªØ­Ù‚Ù‚ Ø§Ù„Ø³Ø±ÙŠØ¹
            if(!document.getElementById('sidebar_product_select').value) {
                alert("ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ù†ØªØ¬ Ø£ÙˆÙ„Ø§Ù‹");
                return;
            }

            // ØªØ­Ø¶ÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (Mapping IDs to Backend Names)
            // Ù„Ø§Ø­Ø¸: Ù†Ø­Ù† Ù†Ø¬Ù…Ø¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙŠØ¯ÙˆÙŠØ§Ù‹ Ù„Ø£Ù† Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ù‚Ø¯ ØªØ®ØªÙ„Ù Ø£Ùˆ ØªØ­ØªØ§Ø¬ ØªÙ†Ø³ÙŠÙ‚
            const formData = new FormData(sidebarForm);
            
            // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù€ SKU ÙŠØ¯ÙˆÙŠØ§Ù‹ Ù„Ø£Ù† Ø§Ù„Ù€ Select Ù„Ù‡ Ø§Ø³Ù… Ù…Ø®ØªÙ„Ù
            formData.append('selected_sku', document.getElementById('sidebar_product_select').value);
            
            // Ø­Ø§Ù„Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„...';

            try {
                const response = await fetch('/path/to/create_order/', { // âš ï¸ Ø¶Ø¹ Ø±Ø§Ø¨Ø· Ø§Ù„Ù€ View Ø§Ù„ØµØ­ÙŠØ­ Ù‡Ù†Ø§
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                    }
                });

                const result = await response.json();

                if(result.success || response.ok) {
                    // Ù†Ø¬Ø§Ø­
                    alert("âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø·Ù„Ø¨ Ø¨Ù†Ø¬Ø§Ø­!");
                    sidebarForm.reset(); // ØªÙØ±ÙŠØº Ø§Ù„Ù†Ù…ÙˆØ°Ø¬
                } else {
                    alert("âŒ Ø®Ø·Ø£: " + (result.message || "Ø­Ø¯Ø« Ø®Ø·Ø£ Ù…Ø§"));
                }

            } catch (err) {
                console.error(err);
                alert("Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„");
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalText;
            }
        });
    }
});
    </script>
  </div>

  
<script>
  document.addEventListener("DOMContentLoaded", function() {
    const sidebar = document.getElementById("cls3741_user_col");
    const sidebarClose = document.getElementById("cls3741_open_info");

    sidebarClose.addEventListener("click", function() {
      if (sidebar.classList.contains("d-none")) {
        sidebar.classList.remove("d-none");
        this.textContent = "Close";

      } else {
        this.textContent = "Create order";
        sidebar.classList.add("d-none");  
      }
     

    });
  });
  </script>
</section>
<!-- END: Chats 3-column layout -->




  <section class="cls3741_panel cls3741_panel_orders" style="display: none;     height: 100%;">
    <h2>Orders</h2>
    <p>Manage Orders</p>
  </br>
 <div style="display:flex;gap:18px;align-items:flex-start;flex-wrap:wrap;">
        <!-- LEFT: contacts list -->
         
        <div style="flex:1;min-width:260px;max-width:520px;">
            <div style="margin-bottom:10px">
                <input id="contacts_panel_search" placeholder="Search by name or number..." style="width:100%;padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,0.04);background:rgba(2,6,23,0.35);color:#eafcff">
            </div>

          
        </div>
    </div>
            <div id="templates_table_wrap" style="background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.005));padding:8px;border-radius:10px;border:1px solid rgba(255,255,255,0.03);overflow:auto">
            <table id="templates_table" style="width:100%;border-collapse:collapse">
                <thead>
                    <tr style="text-align:left;text-align: right;
                    border-bottom: 2px solid #202020;
                   
                ;">
                        <th style="padding:10px;font-weight:700;color:#eafcff">Customer</th>
                        <th style="padding:10px;font-weight:700;color:#eafcff">Agent</th>
                        <th style="padding:10px;font-weight:700;color:#eafcff">Address</th>
                        <th style="padding:10px;font-weight:700;color:#eafcff">Prices</th>
                        <th style="padding:10px;font-weight:700;color:#eafcff">Created at</th>
                    </tr>
                </thead>
                <tbody id="orders_tbody" style="    border-color: inherit;
                border-style: solid;
                border-width: 0;
            ">
                    <!-- sample empty state -->
                    <tr> 
                        <td colspan="5" style="padding:18px;color:var(--muted);text-align:center">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù‚ÙˆØ§Ù„Ø¨ Ø¨Ø¹Ø¯ â€” Ø§Ø¶ØºØ· "Ø¥Ù†Ø´Ø§Ø¡ Ù‚Ø§Ù„Ø¨" Ù„Ø¥Ø¶Ø§ÙØ© ÙˆØ§Ø­Ø¯</td>
                    </tr>
                </tbody>
            </table>
        </div>


     <script>
  // ğŸ”’ Ø¯Ø§Ù„Ø© Ù„ØªØ­ØµÙŠÙ† Ø§Ù„Ù†ØµÙˆØµ Ø¶Ø¯ Ø¥Ø¯Ø®Ø§Ù„ HTML Ø®Ø¨ÙŠØ« (XSS)
  function escapeHtml(str) {
    if (!str) return '';
    return String(str)
      .replace(/&/g, "&amp;")
      .replace(/</g, "&lt;")
      .replace(/>/g, "&gt;")
      .replace(/"/g, "&quot;")
      .replace(/'/g, "&#039;");
  }

  const tbody = document.getElementById('orders_tbody');


  async function loadTemplates(channel_id_arg=null){
   
    // 1. ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ù…Ø¯Ø®Ù„Ø§Øª: Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù…Ø¹Ø§Ù…Ù„ Ù‡Ùˆ Ø­Ø¯Ø« (Event) Ù†Ø¬Ø¹Ù„Ù‡ null
    let activeChannelId = channel_id_arg;
    
    if (activeChannelId && (typeof activeChannelId === 'object' || activeChannelId instanceof Event)) {
        activeChannelId = null;
    }

    // 2. Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ù…Ù…Ø±Ø±Ø© Ø£Ùˆ Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ø¹Ø§Ù…Ø©
    const channel_id = activeChannelId || window.currentChannelId || '{{ initial_channel_id }}';

    if(!tbody) return;
    tbody.innerHTML = `<tr><td colspan="5" style="padding:18px;color:var(--muted);text-align:center">Loading orders...</td></tr>`;
    try{
      const url = `/discount/whatssapAPI/api_orders/?channel_id=${channel_id}`;
      const res = await fetch(url, {
        cache: 'no-store',
        headers: { 'Accept': 'application/json' }
      });

      if(!res.ok) throw new Error('network');
      const data = await res.json();
      const list = data.orders || data || [];
      console.log('Orders loaded', list);

      if(!Array.isArray(list) || list.length === 0){
        tbody.innerHTML = `<tr><td colspan="5" style="padding:18px;color:var(--muted);text-align:center">There are no orders yet</td></tr>`;
        return;
      }

      tbody.innerHTML = '';
      list.forEach(item => {
        const name = escapeHtml(item.customer_name || item.title || '');
        const useremail = escapeHtml(item.user || item.cat || '-');
        const customer_city = escapeHtml(item.customer_city || item.body || '-');
        const Tamount = escapeHtml(item.total_amount || '-');
        const updated = escapeHtml(item.created_at || item.last_updated || item.updated_at || '');

        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td style="padding:10px">${name}</td>
          <td style="padding:10px">${useremail}</td>
          <td style="padding:10px;color:var(--muted);max-width:320px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${customer_city}</td>
          <td style="padding:10px">${Tamount}</td>
          <td style="padding:10px">${updated}</td>
        `;
        tbody.appendChild(tr);
      });
    } catch(err) {
      console.error('loadOrders error', err);
      tbody.innerHTML = `<tr><td colspan="5" style="padding:18px;color:var(--muted);text-align:center">Failed to load orders</td></tr>`;
    }
  }

  // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ù„Ø²Ø±
  const templatesNavBtn = document.querySelector('.cls3741_btn[data-target="orders"]');
  if(templatesNavBtn && !templatesNavBtn.dataset._boundTemplatesLoader){
    templatesNavBtn.addEventListener('click', loadTemplates);
    templatesNavBtn.dataset._boundTemplatesLoader = '1';
  }
</script>


  </section>


 <!-- -------------------contcat --------------  -->
 <!-- Ù‚Ø³Ù… Ø¬Ù‡Ø§Øª Ø§Ù„Ø§ØªØµØ§Ù„ Ø§Ù„Ù…Ø­Ø³Ù† -->
<section class="cls3741_panel cls3741_panel_contacts" style="display: none;     height: 100%;">
  <style>
    /* --- Design Tokens & Variables --- */
.cls3741_contacts_panel {
    /* --primary-color: #05ab53; */
    /* --primary-hover: #1d4ed8; */
    /* --bg-canvas: #f3f4f6; */
    /* --bg-surface: #ffffff; */
    --bg-surface-hover: #000000;
    /* --text-primary: #111827; */
    --text-secondary: #6b7280;
    /* --text-muted: #9ca3af; */
    --border-color: #343436;
    --vip-color: #f59e0b;
    --danger-color: #ef4444;
    --radius-lg: 16px;
    --radius-md :12px;
    --radius-sm: 8px;
    --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
    --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
    font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
    padding: 24px;
    /* min-height: 100vh; */
    background-color: var(--bg-canvas);
    box-sizing: border-box;
}

    /* --- Layout Grid --- */
    .cls3741_contacts_layout {
      display: grid;
      grid-template-columns: 380px 1fr; /* Fixed list width, fluid details */
      gap: 24px;
      max-width: 1400px;
      margin: 0 auto;
      height: calc(100vh - 278px);
    }

    /* --- Header --- */
    .cls3741_contacts_header {
    margin-bottom: 20px;
    display: flex;
    align-items: center;
    flex-direction: column;
}

    .cls3741_contacts_title {
      font-size: 24px;
      font-weight: 700;
      color: var(--text-primary);
      letter-spacing: -0.5px;
      margin: 0;
    }

    /* --- Left Column: Search & List --- */
    .cls3741_list_container {
      background: var(--bg-surface);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-md);
      display: flex;
      flex-direction: column;
      overflow: hidden;
      border: 1px solid var(--border-color);
    }

    .cls3741_search_wrapper {
      padding: 16px;
      border-bottom: 1px solid var(--border-color);
    }

    .cls3741_search_input_group {
      position: relative;
    }

    .cls3741_search_icon {
      position: absolute;
      left: 12px;
      top: 50%;
      transform: translateY(-50%);
      color: var(--text-muted);
      pointer-events: none;
    }

    .cls3741_contacts_search {
      width: 100%;
      padding: 12px 12px 12px 40px;
      border-radius: var(--radius-md);
      border: 1px solid var(--border-color);
      background: var(--bg-surface-hover);
      color: var(--text-primary);
      font-size: 14px;
      outline: none;
      transition: all 0.2s ease;
    }

    .cls3741_contacts_search:focus {
      border-color: var(--primary-color);
      background: #fff;
      box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
    }

    /* --- Tabs (Filters) --- */
    .cls3741_tabs {
      display: flex;
      padding: 0 16px 12px 16px;
      gap: 8px;
      border-bottom: 1px solid var(--border-color);
    }

    .cls3741_tab_btn {
      border: none;
      background: transparent;
      padding: 8px 16px;
      font-size: 13px;
      font-weight: 600;
      color: var(--text-secondary);
      border-radius: 20px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .cls3741_tab_btn:hover {
      background: var(--bg-canvas);
      color: var(--text-primary);
    }

    .cls3741_tab_btn.active {
      background: var(--primary-color);
      color: white;
    }
    
    .cls3741_tab_btn.vip-tab.active {
        background: var(--vip-color);
        color: white;
    }

    /* --- Contact List Items --- */
    .cls3741_contacts_list {
      flex: 1;
      overflow-y: auto;
      padding: 8px;
    }
    
    /* Custom Scrollbar */
    .cls3741_contacts_list::-webkit-scrollbar { width: 6px; }
    .cls3741_contacts_list::-webkit-scrollbar-thumb { background-color: #d1d5db; border-radius: 3px; }

    .cls3741_contact_card {
      display: flex;
      align-items: center;
      padding: 12px;
      margin-bottom: 4px;
      border-radius: var(--radius-md);
      cursor: pointer;
      transition: all 0.2s ease;
      border: 1px solid transparent;
    }

    .cls3741_contact_card:hover {
      background-color: var(--bg-surface-hover);
    }

.cls3741_contact_card.active {
    background-color: #2d2b2b;
    border-color: #343436;
}

    /* VIP Styling */
    .cls3741_contact_card.is_vip {
      border-left: 3px solid var(--vip-color);
    }
    
    .cls3741_contact_card.is_vip .cls3741_avatar {
        background: linear-gradient(135deg, var(--vip-color), #b45309);
    }

    .cls3741_avatar {
      width: 44px;
      height: 44px;
      border-radius: 12px;
      background: linear-gradient(135deg, #4b5563, #1f2937);
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
      font-weight: 700;
      flex-shrink: 0;
      margin-right: 12px;
      position: relative;
    }

    .cls3741_vip_icon {
      position: absolute;
      top: -4px;
      right: -4px;
      background: #fff;
      border-radius: 50%;
      color: var(--vip-color);
      font-size: 12px;
      padding: 1px;
    }

    .cls3741_card_info {
      flex: 1;
      min-width: 0;
    }

    .cls3741_card_name {
      font-size: 15px;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 2px;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .cls3741_card_meta {
      font-size: 12px;
      color: var(--text-secondary);
      display: flex;
      justify-content: space-between;
    }

    .cls3741_badge {
      background: var(--danger-color);
      color: white;
      padding: 2px 8px;
      border-radius: 10px;
      font-size: 11px;
      font-weight: 700;
      margin-left: 8px;
    }

    /* --- Right Column: Details --- */
    .cls3741_details_panel {
      background: var(--bg-surface);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-md);
      border: 1px solid var(--border-color);
      padding: 32px;
      display: flex;
      flex-direction: column;
      align-items: center;
      text-align: center;
      overflow-y: auto;
    }

    .cls3741_profile_header {
      margin-bottom: 32px;
      width: 100%;
      position: relative;
    }
    
    .cls3741_vip_badge_large {
        display: none;
        background: #fffbeb;
        color: #b45309;
        padding: 6px 12px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: 700;
        margin: 0 auto 16px;
        width: fit-content;
        border: 1px solid #fcd34d;
    }

    .cls3741_profile_avatar {
      width: 100px;
      height: 100px;
      border-radius: 24px;
      background: #e5e7eb;
      margin: 0 auto 16px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 36px;
      font-weight: 800;
      color: var(--text-secondary);
    }

    .cls3741_profile_name {
      font-size: 24px;
      font-weight: 800;
      color: var(--text-primary);
      margin-bottom: 4px;
    }

    .cls3741_profile_phone {
      font-size: 16px;
      color: var(--text-secondary);
      font-family: monospace;
    }

    .cls3741_stats_container {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
      width: 100%;
      margin-bottom: 32px;
    }

    .cls3741_stat_box {
      background: var(--bg-canvas);
      padding: 16px;
      border-radius: var(--radius-md);
      text-align: center;
    }

    .cls3741_stat_value {
      font-size: 20px;
      font-weight: 700;
      color: var(--text-primary);
      margin-bottom: 4px;
    }

    .cls3741_stat_label {
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: var(--text-secondary);
    }

    .cls3741_info_grid {
      width: 100%;
      display: grid;
      grid-template-columns: 1fr;
      gap: 16px;
      margin-bottom: 32px;
      text-align: left;
    }

    .cls3741_info_item {
      display: flex;
      justify-content: space-between;
      padding-bottom: 12px;
      border-bottom: 1px solid var(--border-color);
    }

    .cls3741_info_label { color: var(--text-secondary); font-size: 14px; }
    .cls3741_info_text { color: var(--text-primary); font-weight: 500; font-size: 14px; }

    .cls3741_actions {
      width: 100%;
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }

     .cls3741_btn1 {
      padding: 14px;
      border-radius: var(--radius-md);
      font-weight: 600;
      cursor: pointer;
      border: none;
      transition: transform 0.1s;
      font-size: 14px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }
    
    .cls3741_btn1:active { transform: scale(0.98); }

    .cls3741_btn_primary { background: var(--primary-color); color: white; }
    .cls3741_btn_primary:hover { background: var(--primary-hover); }

    .cls3741_btn_secondary { background: rgb(0, 0, 0); border: 1px solid var(--border-color); color: var(--text-primary); }
    .cls3741_btn_secondary:hover { background: var(--bg-canvas); }

    /* --- Utilities --- */
    .cls3741_hidden { display: none !important; }
    
    .cls3741_loader {
        border: 3px solid #f3f3f3;
        border-top: 3px solid var(--primary-color);
        border-radius: 50%;
        width: 24px;
        height: 24px;
        animation: spin 1s linear infinite;
        margin: 40px auto;
    }

    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

    @media (max-width: 900px) {
      .cls3741_contacts_layout { grid-template-columns: 1fr; }
      .cls3741_details_panel { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 50; }
      .cls3741_details_panel.mobile-active { display: flex; }
    }
  </style> 

<div class="cls3741_contacts_panel">
 

  <div class="cls3741_contacts_layout">
    
    <div class="cls3741_list_container">
      
      <div class="cls3741_search_wrapper">
        <div class="cls3741_search_input_group">
          <span class="cls3741_search_icon">
             <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
          </span>
          <input type="text" class="cls3741_contacts_search" placeholder="Search name, phone..." id="cls3741_search_input">
        </div>
      </div>

      <div class="cls3741_tabs" id="cls3741_tabs_container">
          <button class="cls3741_tab_btn active" data-filter="all">All</button>
          <button class="cls3741_tab_btn vip-tab" data-filter="important">â­ VIP</button>
          <button class="cls3741_tab_btn" data-filter="unread">ğŸ’¬ Unread</button>
      </div>

      <div class="cls3741_contacts_list" id="cls3741_contacts_list_el">
          <div class="cls3741_loader_new"><div class="cls3741_spinner"></div></div>
      </div>

      <div class="cls3741_pagination_container" id="main_pagination_controls" style="border-top:1px solid var(--border-color); padding:12px; display:flex; justify-content:center; gap:8px;">
          </div>
    </div>

    <div class="cls3741_details_panel" id="cls3741_details_panel">
      
      <div class="cls3741_empty_state" id="cls3741_empty_details" style="margin-top: 100px;">
        <div style="font-size: 48px; margin-bottom: 16px; opacity: 0.3;">ğŸ‘†</div>
        <div class="cls3741_contacts_header">
          <h2 class="cls3741_contacts_title">Contacts Directory</h2>
          <div class="cls3741_header_actions" style="display:flex; gap:10px;">
              <button class="cls3741_btn1 cls3741_btn_secondary" onclick="window.openImportModal()">
                  ğŸ“¤ Import CSV
              </button>
              <button class="cls3741_btn1 cls3741_btn_primary" onclick="window.openAddContactModal()">
                  + Add Contact
              </button>
          </div>
        </div>
      </div>

      <div id="cls3741_active_contact_content" class="cls3741_hidden" style="width: 100%;">
          
          <div class="cls3741_profile_header">
              <div class="cls3741_vip_badge_large" id="cls3741_vip_badge">â­ High Value Client</div>
              <div class="cls3741_profile_avatar" id="cls3741_detail_avatar"></div>
              <div class="cls3741_profile_name" id="cls3741_detail_name"></div>
              <div class="cls3741_profile_phone" id="cls3741_detail_phone"></div>
          </div>

          <div class="cls3741_stats_container">
              <div class="cls3741_stat_box">
                  <div class="cls3741_stat_value" id="cls3741_stat_orders">0</div>
                  <div class="cls3741_stat_label">Total Orders</div>
              </div>
              <div class="cls3741_stat_box">
                  <div class="cls3741_stat_value" id="cls3741_stat_spent">$0.00</div>
                  <div class="cls3741_stat_label">Lifetime Value</div>
              </div>
          </div>

          <div class="cls3741_info_grid">
              <div class="cls3741_info_item">
                  <span class="cls3741_info_label">Last Active</span>
                  <span class="cls3741_info_text" id="cls3741_detail_seen">-</span>
              </div>
              <div class="cls3741_info_item">
                  <span class="cls3741_info_label">Joined</span>
                  <span class="cls3741_info_text" id="cls3741_detail_contacted">-</span>
              </div>
          </div>

          <div class="cls3741_actions">
              <button class="cls3741_btn1 cls3741_btn_secondary" id="cls3741_btn_msg">
                  <span>ğŸ’¬ Message</span>
              </button>
              <button class="cls3741_btn1 cls3741_btn_primary" id="cls3741_btn_call">
                  <span>ğŸ“ Call Now</span>
              </button>
          </div>
          
          <button class="cls3741_btn1 cls3741_btn_secondary" style="width:100%; margin-top: 12px; display:none;" id="cls3741_close_mobile" onclick="closeDetailsPanel()">
              Close Details
          </button>
      </div>
    </div>
  </div>
</div>
  
<script>
  document.addEventListener("DOMContentLoaded", function() {
      
      // --- State ---
      const STATE = {
          page: 1,
          totalPages: 1,
          search: '',
          filter: 'all',
          isLoading: false,
          selectedContactId: null
      };
  
      // --- Elements ---
      const listContainer = document.getElementById('cls3741_contacts_list_el');
      const paginationContainer = document.getElementById('main_pagination_controls');
      const searchInput = document.getElementById('cls3741_search_input');
      const tabsContainer = document.getElementById('cls3741_tabs_container');
      
      // Details Elements
      const els = {
          emptyDetails: document.getElementById('cls3741_empty_details'),
          contentDetails: document.getElementById('cls3741_active_contact_content'),
          detailsPanel: document.getElementById('cls3741_details_panel'),
          // Fields
          dName: document.getElementById('cls3741_detail_name'),
          dPhone: document.getElementById('cls3741_detail_phone'),
          dAvatar: document.getElementById('cls3741_detail_avatar'),
          dVipBadge: document.getElementById('cls3741_vip_badge'),
          dOrders: document.getElementById('cls3741_stat_orders'),
          dSpent: document.getElementById('cls3741_stat_spent'),
          dSeen: document.getElementById('cls3741_detail_seen'),
          dContacted: document.getElementById('cls3741_detail_contacted'),
          // Buttons
          btnCall: document.getElementById('cls3741_btn_call'),
          btnMsg: document.getElementById('cls3741_btn_msg')
      };
  
      // --- Main Fetch Function ---
      window.loadContactsListForChannel = async function(channelId, resetPage = true) {
          const activeId = channelId || window.currentChannelId;
          if (!activeId) return;
  
          if (resetPage) STATE.page = 1;
          if (STATE.isLoading) return;
          STATE.isLoading = true;
  
          listContainer.innerHTML = '<div class="cls3741_loader_new"><div class="cls3741_spinner"></div></div>';
  
          try {
              let url = `{% url 'api_contactslist' %}?channel_id=${activeId}&page=${STATE.page}`;
              if (STATE.search) url += `&q=${encodeURIComponent(STATE.search)}`;
              if (STATE.filter !== 'all') url += `&filter=${STATE.filter}`;
  
              const res = await fetch(url, { headers: { 'Accept': 'application/json' } });
              const data = await res.json();
  
              if (data.contacts && data.contacts.length > 0) {
                  STATE.totalPages = data.total_pages || 1;
                  renderMainList(data.contacts);
                  renderPaginationControls(data.has_next, data.current_page);
              } else {
                  listContainer.innerHTML = '<div style="padding:40px;text-align:center;color:var(--text-secondary);">No contacts found</div>';
                  paginationContainer.innerHTML = ''; // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø£Ø²Ø±Ø§Ø±
              }
  
          } catch (error) {
              console.error("Error:", error);
              listContainer.innerHTML = '<div style="color:red;text-align:center;padding:20px;">Failed to load data</div>';
          } finally {
              STATE.isLoading = false;
          }
      };
  
      // --- Render List ---
      function renderMainList(contacts) {
          const frag = document.createDocumentFragment();
          contacts.forEach(c => {
              const el = document.createElement('div');
              // Ø¥Ø¶Ø§ÙØ© ÙƒÙ„Ø§Ø³ VIP Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…Ù‡Ù…Ø§Ù‹
              const vipClass = c.is_important ? 'is_vip' : '';
              const activeClass = (STATE.selectedContactId === c.id) ? 'active' : '';
              
              el.className = `cls3741_contact_card ${vipClass} ${activeClass}`;
              el.onclick = () => selectContact(c, el);
  
              // Ø§Ù„Ø£ÙØ§ØªØ§Ø±
              const initial = c.name.charAt(0).toUpperCase();
              let avatarHtml = initial;
              if(c.profile_picture) {
                  avatarHtml = `<img src="${c.profile_picture}" style="width:100%;height:100%;border-radius:12px;object-fit:cover;">`;
              }
  
              el.innerHTML = `
                  <div class="cls3741_avatar">
                      ${avatarHtml}
                      ${c.is_important ? '<div class="cls3741_vip_icon">â˜…</div>' : ''}
                  </div>
                  <div class="cls3741_card_info">
                      <div class="cls3741_card_name">
                          ${c.name}
                          ${c.unread > 0 ? `<span class="cls3741_badge">${c.unread}</span>` : ''}
                      </div>
                      <div class="cls3741_card_meta">
                          <span>${c.phone}</span>
                          <span>${c.timestamp || ''}</span>
                      </div>
                  </div>
              `;
              frag.appendChild(el);
          });
  
          listContainer.innerHTML = '';
          listContainer.appendChild(frag);
      }
  
      // --- Select Contact (Ø§Ù„Ù…ÙŠØ²Ø© Ø§Ù„ØªÙŠ ÙƒØ§Ù†Øª Ù…ÙÙ‚ÙˆØ¯Ø©) ---
      function selectContact(contact, cardElement) {
          STATE.selectedContactId = contact.id;
  
          // Highlight Card
          document.querySelectorAll('.cls3741_contact_card').forEach(c => c.classList.remove('active'));
          if(cardElement) cardElement.classList.add('active');
  
          // Populate Details
          const initial = contact.name.charAt(0).toUpperCase();
          if (contact.profile_picture) {
              els.dAvatar.innerHTML = `<img src="${contact.profile_picture}" style="width:100%;height:100%;border-radius:24px;object-fit:cover;">`;
          } else {
              els.dAvatar.innerHTML = initial;
          }
  
          els.dName.textContent = contact.name || "Unknown";
          els.dPhone.textContent = contact.phone || "";
          els.dSeen.textContent = contact.timestamp || "Recently";
          // Ø§Ø³ØªØ®Ø¯Ù…Ù†Ø§ ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡ ÙƒÙ€ "ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù…"
          els.dContacted.textContent = contact.created_at ? new Date(contact.created_at).toLocaleDateString() : '-';
  
          // VIP Badge
          if (contact.is_important) {
              els.dVipBadge.style.display = 'block';
              els.dAvatar.style.border = '2px solid var(--vip-color)';
          } else {
              els.dVipBadge.style.display = 'none';
              els.dAvatar.style.border = 'none';
          }
  
          // Actions
          els.btnCall.onclick = () => window.location.href = `tel:${contact.phone}`;
          els.btnMsg.onclick = () => {
              // Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ù„ØªØ¨ÙˆÙŠØ¨ Ø§Ù„Ø´Ø§Øª ÙˆÙØªØ­ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©
              if(window.__chatSelectPhone) window.__chatSelectPhone(contact.phone, contact.name);
              document.querySelector('[data-target="chats"]')?.click();
          };
  
          // Show Panel
          els.emptyDetails.classList.add('cls3741_hidden');
          els.contentDetails.classList.remove('cls3741_hidden');
          
          // Mobile View
          if (window.innerWidth < 900) {
              els.detailsPanel.classList.add('mobile-active');
              document.getElementById('cls3741_close_mobile').style.display = 'block';
          }
      }
  
      window.closeDetailsPanel = function() {
          els.detailsPanel.classList.remove('mobile-active');
      };
  
      // --- Pagination Controls ---
      function renderPaginationControls(hasNext, currentPage) {
          let html = '';
          // Previous
          html += `<button class="cls3741_page_btn" onclick="changeMainPage(${currentPage - 1})" ${currentPage === 1 ? 'disabled' : ''}>&laquo;</button>`;
          
          // Page Info
          html += `<span style="font-size:13px; color:var(--text-secondary);">Page ${currentPage} of ${STATE.totalPages}</span>`;
  
          // Next
          html += `<button class="cls3741_page_btn" onclick="changeMainPage(${currentPage + 1})" ${!hasNext ? 'disabled' : ''}>&raquo;</button>`;
  
          paginationContainer.innerHTML = html;
      }
  
      window.changeMainPage = (newPage) => {
          if (newPage > 0 && newPage <= STATE.totalPages) {
              STATE.page = newPage;
              window.loadContactsListForChannel(null, false); // false = keep current details visible
          }
      };
  
      // --- Event Listeners ---
      let debounceTimer;
      if(searchInput) {
          searchInput.addEventListener('input', (e) => {
              clearTimeout(debounceTimer);
              debounceTimer = setTimeout(() => {
                  STATE.search = e.target.value.trim();
                  window.loadContactsListForChannel(null, true);
              }, 500);
          });
      }
  
      if(tabsContainer) {
          tabsContainer.addEventListener('click', (e) => {
              if (e.target.classList.contains('cls3741_tab_btn')) {
                  document.querySelectorAll('.cls3741_tab_btn').forEach(b => b.classList.remove('active'));
                  e.target.classList.add('active');
                  STATE.filter = e.target.dataset.filter;
                  window.loadContactsListForChannel(null, true);
              }
          });
      }
  
      // Modal Placeholders
      window.openAddContactModal = () => alert("Add Contact Modal - Coming Soon");
      window.openImportModal = () => alert("Import CSV Modal - Coming Soon");
  
      // Initial Load
      if (window.currentChannelId) {
          window.loadContactsListForChannel(window.currentChannelId);
      }
      
      // Export Refresh Function for Channel Switcher
      window.reloadMainContactsDir = () => window.loadContactsListForChannel(null, true);
  });
  </script>

</section>

  <!-- --------------end contact ---------------- -->

  <section class="cls3741_panel cls3741_panel_campaigns" style="display: none;     height: 100%;">
    <h2>Ø§Ù„Ø­Ù…Ù„Ø§Øª</h2>
    <p>Ø§Ø¯Ø§Ø±Ø© Ø§Ù„Ø­Ù…Ù„Ø§Øª.</p>
  </section>

 <section class="cls3741_panel cls3741_panel_templates" style="display: none;     height: 100%;">
    <div style="display:flex;flex-direction:column;gap:12px;">
        <!-- action buttons (above table) -->
        <div style="display: flex; direction: rtl; gap: 8px; align-items: center; justify-content: space-between; flex-wrap: wrap;">
            <div style="display: flex; gap: 8px;">
                <button id="templates_create_btn" class="cls3741_action_btn" style="padding:8px 16px; background-color: #10B981; color:white; border:none; border-radius:6px; cursor:pointer;">Ø¥Ù†Ø´Ø§Ø¡ Ù‚Ø§Ù„Ø¨</button>
                <button id="templates_refresh_btn" class="cls3741_send_btn" style="padding:8px 16px; background-color: transparent; border:1px solid #10B981; color:#10B981; border-radius:6px; cursor:pointer; width:auto;">Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ù‚ÙˆØ§Ù„Ø¨</button>
            </div>
            <div>
                <div style="color:var(--muted);font-size:16px;font-weight:600">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù‚ÙˆØ§Ù„Ø¨</div>
            </div>
        </div>

        <!-- create form (hidden by default, will appear in place of table) -->
        <div id="template_create_section" style="display:none;background:var(--surface);padding:20px;border-radius:12px;border:1px solid var(--border);margin-bottom:20px;">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;padding-bottom:12px;border-bottom:1px solid var(--border);">
                <div style="font-weight:700;color:var(--text-primary);font-size:18px;">Ø¥Ù†Ø´Ø§Ø¡ Ù‚Ø§Ù„Ø¨ Ø¬Ø¯ÙŠØ¯</div>
                <div style="display:flex;gap:8px;">
                    <button id="template_cancel_btn" class="cls3741_btn" style="padding:8px 16px;background:transparent;color:var(--text-muted);border:1px solid var(--border);border-radius:6px;cursor:pointer;">Ø¥Ù„ØºØ§Ø¡</button>
                    <button id="template_save_btn" class="cls3741_action_btn" style="padding:8px 16px;background:#10B981;color:white;border:none;border-radius:6px;cursor:pointer;">Ø­ÙØ¸ (Ù…Ø³ÙˆØ¯Ø©)</button>
                </div>
            </div>
 
            <!-- Template Form -->
            <style>/* preview buttons */
.wa-buttons { display:flex; flex-direction:column; gap:8px; }
.wa-buttons .wa-btn { padding:8px 12px; border-radius:8px; border:1px solid #e2e8f0; background:#fff; font-size:13px; cursor:pointer; max-width:260px; text-align:center; }
.wa-btn--primary { background:#eef2ff; border-color:#c7d2fe; color:#3730a3; }
.buttons-list-item { display:flex; gap:8px; align-items:center; margin-bottom:8px; padding:8px; background:var(--surface-light); border-radius:8px; }
.buttons-list-item input, .buttons-list-item select { padding:6px; border-radius:6px; border:1px solid #d1d5db; }
.buttons-list-item .btn-remove { margin-left:auto; background:transparent; border:none; color:#ef4444; cursor:pointer; }




 

 
.msg-status-icon.pending {
    fill: #8696a0;
    color: #8696a0;
}

.msg-status-icon.failed {
    fill: #ef4444; /* Ø£Ø­Ù…Ø± Ù„Ù„Ø®Ø·Ø£ */
    color: #ef4444;
}



.msg-status-icon {
    width: 18px;        /* Ø­Ø¬Ù… Ù…Ù†Ø§Ø³Ø¨ Ù„Ù„Ù‚Ø±Ø§Ø¡Ø© */
    height: 18px;
    display: inline-block;
    vertical-align: middle;
    margin-top: -3px;   /* Ø¶Ø¨Ø· Ø§Ù„Ù…Ø­Ø§Ø°Ø§Ø© */
}

/* Ø§Ù„Ø£Ù„ÙˆØ§Ù† ÙƒÙ…Ø§ Ø§ØªÙÙ‚Ù†Ø§ Ø³Ø§Ø¨Ù‚Ø§Ù‹ */
.msg-status-icon.sent, 
.msg-status-icon.delivered {
    color: #8696a0; /* Ø±Ù…Ø§Ø¯ÙŠ */
    fill: currentColor;
}

.msg-status-icon.read {
    color: #53bdeb; /* Ø£Ø²Ø±Ù‚ */
    fill: currentColor;
}


                .template-container {
                    width: 100%;
                    margin: 0 auto;
                    display: grid;
                    grid-template-columns: 1fr 400px;
                    gap: 20px;
                    align-items: start;
                }
                .form-panel {
                    background:transparent;
                    padding: 20px;
                    border-radius: 12px;
                    border: 1px solid var(--border);
                    min-height: 500px;
                    overflow: auto;
                    max-height: 600px;
                }
                .preview-panel {
                    background: var(--surface);
                    border-radius: 12px;
                    border: 1px solid var(--border);
                    padding: 20px;
                    position: sticky;
                    top: 20px;
                }
                .form-row {
                    display: flex;
                    gap: 16px;
                    align-items: center;
                    margin-bottom: 16px;
                }
                .form-col {
                    flex: 1;
                }
                .form-label {
                    display: block;
                    font-size: 14px;
                    color: var(--text-primary);
                    margin-bottom: 8px;
                    font-weight: 500;
                }
                .form-input, .form-select, .form-textarea {
                    width: 100%;
                    padding: 12px;
                    border-radius: 8px;
                    border: 1px solid var(--border);
                    background: var(--background);
                    color: var(--text-primary);
                    font-size: 14px;
                    font-family: inherit;
                }
                .form-input:focus, .form-select:focus, .form-textarea:focus {
                    outline: none;
                    border-color: #7C3AED;
                    box-shadow: 0 0 0 3px rgba(124, 58, 237, 0.1);
                }
                .form-textarea {
                    min-height: 120px;
                    resize: vertical;
                }
                .form-field {
                    margin-bottom: 20px;
                }
                .small-muted {
                    font-size: 12px;
                    color: var(--text-muted);
                    margin-top: 6px;
                }
                .section-title {
                    font-weight: 600;
                    margin: 16px 0 8px;
                    color: var(--text-primary);
                    font-size: 16px;
                }
                .media-tabs {
                    display: flex;
                    gap: 8px;
                    background: var(--surface-light);
                    padding: 4px;
                    border-radius: 8px;
                    margin: 12px 0;
                }
                .media-tab {
                    flex: 1;
                    padding: 10px;
                    border-radius: 6px;
                    border: none;
                    background: transparent;
                    color: var(--text-secondary);
                    cursor: pointer;
                    font-weight: 500;
                    transition: all 0.2s ease;
                }
                .media-tab.active {
                    background: #7C3AED;
                    color: white;
                    box-shadow: 0 2px 8px rgba(124, 58, 237, 0.3);
                }
                .file-uploader {
                    display: flex;
                    align-items: center;
                    gap: 12px;
                    padding: 16px;
                    border-radius: 8px;
                    background: var(--surface-light);
                    border: 2px dashed var(--border);
                    margin: 12px 0;
                }
                .upload-btn {
                    padding: 8px 16px;
                    border-radius: 6px;
                    border: none;
                    background: #7C3AED;
                    color: white;
                    cursor: pointer;
                    font-weight: 500;
                }
                .wa-preview {
                    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                    border-radius: 12px;
                    padding: 30px;
                    min-height: 400px;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                }
                .wa-card {
                    width: 100%;
                    max-width: 320px;
                }
                .wa-message {
                    display: flex;
                    align-items: flex-end;
                    gap: 8px;
                    margin-bottom: 8px;
                }
                .wa-avatar {
                    width: 40px;
                    height: 40px;
                    border-radius: 50%;
                    background: linear-gradient(135deg, #7C3AED, #6D28D9);
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    color: white;
                    font-weight: 700;
                    font-size: 14px;
                    flex-shrink: 0;
                }
                .wa-bubble {
                    background: white;
                    color: #1a1a1a;
                    padding: 12px 16px;
                    border-radius: 18px;
                    border-bottom-right-radius: 4px;
                    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
                    max-width: 280px;
                }
                .wa-header {
                    font-weight: 600;
                    margin-bottom: 6px;
                    color: #1a1a1a;
                    font-size: 14px;
                }
                .wa-body {
                    font-size: 14px;
                    line-height: 1.4;
                    color: #1a1a1a;
                }
                .wa-footer {
                    font-size: 11px;
                    color: #666;
                    margin-top: 6px;
                    border-top: 1px solid #f0f0f0;
                    padding-top: 4px;
                }
                .wa-time {
                    font-size: 11px;
                    color: rgba(255,255,255,0.7);
                    text-align: right;
                    margin-top: 4px;
                }

                @media (max-width: 1024px) {
                    .template-container {
                        grid-template-columns: 1fr;
                    }
                    .preview-panel {
                        position: relative;
                        top: 0;
                    }
                }
            </style>

            <div class="template-container">
             
                <div class="form-panel">
                    <div class="form-field">
                        <label class="form-label">Ø§Ø³Ù… Ø§Ù„Ù‚Ø§Ù„Ø¨</label>
                        <input id="template_name" type="text" class="form-input" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ù‚Ø§Ù„Ø¨">
                    </div>

                    <div class="form-row">
                        <div class="form-col">
                            <label class="form-label">Ø§Ù„ÙØ¦Ø©</label>
                            <select id="template_category_select" class="form-select">
                                <option value="utility">Ø®Ø¯Ù…ÙŠ</option>
                                <option value="marketing">ØªØ³ÙˆÙŠÙ‚ÙŠ</option>
                                <option value="notification">Ø¥Ø´Ø¹Ø§Ø±</option>
                                <option value="support">Ø¯Ø¹Ù…</option>
                            </select>
                        </div>
                        <div class="form-col">
                            <label class="form-label">Ø§Ù„Ù„ØºØ©</label>
                            <select id="template_language" class="form-select">
                                <option value="ar">Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©</option>
                                <option value="en">English</option>
                                <option value="fr">FranÃ§ais</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-field">
                        <div class="section-title">Ø§Ù„Ø±Ø£Ø³ <span class="small-muted">(Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</span></div>
                        <div class="small-muted">Ø§Ø®ØªØ± Ù†ÙˆØ¹ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ù„Ù„Ø±Ø£Ø³</div>
                        
                        <div class="media-tabs">
                            <button type="button" id="btn_text" class="media-tab active">Ù†Øµ</button>
                            <button type="button" id="btn_image" class="media-tab">ØµÙˆØ±Ø©</button>
                            <button type="button" id="btn_video" class="media-tab">ÙÙŠØ¯ÙŠÙˆ</button>
                            <button type="button" id="btn_doc" class="media-tab">Ù…Ù„Ù</button>
                        </div>
                        
                        <div id="input_area"></div>
                        <div class="small-muted">Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø­Ø±Ù: <span id="chars_count">0</span>/1098</div>
                    </div>

                    <div class="form-field">
                        <div class="section-title">Ø§Ù„Ù…Ø­ØªÙˆÙ‰ <span class="small-muted">(Ù…Ø·Ù„ÙˆØ¨)</span></div>
                        <div class="small-muted">Ø£Ø¯Ø®Ù„ Ù†Øµ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø¨Ø§Ù„Ù„ØºØ© Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©</div>
                        <textarea id="body_text" class="form-textarea" placeholder="Ø£Ø¯Ø®Ù„ Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ù‡Ù†Ø§..."></textarea>
                        <div class="small-muted">Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø­Ø±Ù: <span id="body_count">0</span>/1098</div>
                        <!-- Variables UI (will be auto-managed by script) -->
<div id="body_vars" style="margin-top:8px;"></div>
<!-- Global add variable button (script creates it automatically if not present) -->

                    </div>
                    <!-- Buttons section -->
<div class="form-field">
  <div class="section-title">Ø§Ù„Ø£Ø²Ø±Ø§Ø± <span class="small-muted">(Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</span></div>
  <div class="small-muted">Ø£Ø¶Ù Ø­ØªÙ‰ 3 Ø£Ø²Ø±Ø§Ø±. Ø£Ù†ÙˆØ§Ø¹: Quick Reply, URL, Call, Copy Code, Custom</div>

  <div style="display:flex;gap:8px;align-items:center;margin-top:8px;">
    <select id="new_button_type" class="form-select" style="width:180px;">
      <option value="quick_reply">Ø±Ø¯ Ø³Ø±ÙŠØ¹</option>
      <option value="url">Ø±Ø§Ø¨Ø· Ù…ÙˆÙ‚Ø¹</option>
      <option value="call">Ø§ØªØµØ§Ù„</option>
      <option value="copy">Ù†Ø³Ø® ÙƒÙˆØ¯</option>
      <option value="custom">Ù…Ø®ØµØµ</option>
    </select>
    <button type="button" id="btn_add_button" class="upload-btn">Ø£Ø¶Ù Ø²Ø±</button>
  </div>

  <div id="buttons_list" style="margin-top:12px;"></div>
  <div class="small-muted" style="margin-top:6px;">Ø£Ù…Ø«Ù„Ø©: Ø²Ø± Ø±Ø§Ø¨Ø· -> Ù†Øµ Ø§Ù„Ø²Ø± + Ø±Ø§Ø¨Ø· Ø› Ø²Ø± Ø§ØªØµØ§Ù„ -> Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ</div>
</div>



                    <div class="form-field">
                        <label class="form-label">Ø§Ù„ØªØ°ÙŠÙŠÙ„ <span class="small-muted">(Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</span></label>
                        <input id="template_footer" type="text" class="form-input" placeholder="Ù†Øµ Ø§Ù„ØªØ°ÙŠÙŠÙ„">
<!-- hidden id to know if we are editing -->
<input type="hidden" id="editing_template_id" value="">

                    </div>

                    <div class="form-row">
                        <div class="form-col">
                            <label class="form-label">Ø§Ù„Ø­Ø§Ù„Ø©</label>
                            <select id="template_status" class="form-select">
                                <option value="draft">Ù…Ø³ÙˆØ¯Ø©</option>
                                <option value="active">Ù†Ø´Ø·</option>
                                <option value="inactive">ØºÙŠØ± Ù†Ø´Ø·</option>
                            </select>
                        </div>
                        <div class="form-col">
                            <label class="form-label">Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«</label>
                            <input id="template_updated" type="date" class="form-input">
                        </div>
                    </div>

                    <input id="file_image" type="file" accept="image/*" style="display:none">
                    <input id="file_video" type="file" accept="video/*" style="display:none">
                    <input id="file_doc" type="file" accept=".pdf,.doc,.docx" style="display:none">
                </div>

                <div class="preview-panel">
                    <div style="margin-bottom:16px;font-weight:600;color:var(--text-primary);">Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„ÙˆØ§ØªØ³Ø§Ø¨</div>
                    <div class="wa-preview">
                        <div class="wa-card">
                            <div class="wa-message">
                                <div class="wa-bubble">
                                    <div id="wa_header" class="wa-header"></div>
                                    <div id="wa_body" class="wa-body">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø¹Ø§ÙŠÙ†Ø© Ø¨Ø¹Ø¯.</div>
                                    <div id="wa_footer_area" class="wa-footer"></div>
                                    <!-- Ø¯Ø§Ø®Ù„ wa-bubble -->
<div id="wa_buttons" class="wa-buttons" style="margin-top:8px;"></div>

<!-- preview area for existing header file (when editing) -->
<div id="existing_header_preview" style="margin-top:8px;display:none;"></div>
                                </div>
                                <div class="wa-avatar">BB</div>
                            </div>
                            <div class="wa-time">9:15 AM</div>
                        </div>
                    </div>
                </div>
                  <div id="formErrors" style="display:none;background:#fee;border:1px solid #f99;color:#900;padding:10px;margin-bottom:10px;border-radius:6px;"></div>

            </div>
        </div>

        <!-- templates table -->
        <div id="templates_table_wrap" style="padding:16px;border-radius:12px;border:1px solid var(--border);overflow:auto ;background: linear-gradient(180deg, rgba(255, 255, 255, 0.01), rgba(255, 255, 255, 0.005));padding: 8px;border-radius: 10px;border: 1px solid rgba(255, 255, 255, 0.03);overflow: auto;">
            <table id="templates_table" style="width:100%;border-collapse:collapse;min-width:600px;     border-color: #202020;border-style: solid;border-width: 0;">
                <thead>
                    <tr style="text-align:right;border-bottom: 1px solid #202020;">
                        <th style="padding:12px;font-weight:600;color:var(--text-primary);text-align:right;">Ø§Ù„Ø§Ø³Ù…</th>
                        <th style="padding:12px;font-weight:600;color:var(--text-primary);text-align:right;">Ø§Ù„ÙØ¦Ø©</th>
                        <th style="padding:12px;font-weight:600;color:var(--text-primary);text-align:right;">Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø©</th>
                        <th style="padding:12px;font-weight:600;color:var(--text-primary);text-align:center;">Ø§Ù„Ø­Ø§Ù„Ø©</th>
                        <th style="padding:12px;font-weight:600;color:var(--text-primary);text-align:right;">Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«</th>
                        <th style="padding:12px;font-weight:600;color:var(--text-primary);text-align:center;">Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                    </tr>
                </thead>
                <tbody id="templates_tbody" style="border-color: inherit;
                border-style: solid;
                border-width: 0;
            ">
                    <tr>
                        <td colspan="6" style="padding:40px;color:var(--text-muted);text-align:center;font-style:italic;">
                            Ù„Ø§ ØªÙˆØ¬Ø¯ Ù‚ÙˆØ§Ù„Ø¨ Ø¨Ø¹Ø¯ â€” Ø§Ø¶ØºØ· "Ø¥Ù†Ø´Ø§Ø¡ Ù‚Ø§Ù„Ø¨" Ù„Ø¥Ø¶Ø§ÙØ© ÙˆØ§Ø­Ø¯
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
 
    
 

</section>

  <section class="cls3741_panel cls3741_panel_automation" style="display: none; padding: 0px;     height: 100%;">
     

    {% include 'whatssap/flowbiulder.html' %}
  </section>

</main>

  </div>
{% else %}


<div class="empty-whatsapp-state">
  <div class="empty-content">
      <div class="icon-container">
          <i class="fab fa-whatsapp"></i>
          <span class="status-dot"></span>
      </div>

      <h3 class="empty-title">There are no WhatsApp accounts</h3>
      <p class="empty-subtitle">
          You can add a new WhatsApp account by clicking the button below.
      </p>

      <div class="action-area">
          <div class="workspace-item add-new" onclick="openAddChannelModal()">
              <svg viewBox="0 0 24 24" width="24" height="24" stroke="currentColor" stroke-width="2" fill="none">
                  <line x1="12" y1="5" x2="12" y2="19"></line>
                  <line x1="5" y1="12" x2="19" y2="12"></line>
              </svg>
              <span class="btn-label"> Add now</span>
          </div>
      </div>
  </div>
</div>
<style>
  /* Ø­Ø§ÙˆÙŠØ© ØªØ¶Ù…Ù† Ø§Ù„ØªÙˆØ³Ø· ÙÙŠ Ø§Ù„ØµÙØ­Ø© */
.empty-whatsapp-state {
    display: flex;
    justify-content: center;
    align-items: center;
    min-height: 400px; /* Ø§Ø±ØªÙØ§Ø¹ Ù…Ù†Ø§Ø³Ø¨ Ù„Ù…Ù„Ø¡ Ø§Ù„ÙØ±Ø§Øº */
    width: 100%;
    text-align: center;
    background-color: transparent;
}

/* Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ù…Ø­ØªÙˆÙ‰ */
.empty-content {
    background: rgba(255, 255, 255, 0.03); /* Ø®Ù„ÙÙŠØ© Ø®ÙÙŠÙØ© Ø¬Ø¯Ø§Ù‹ */
    border: 1px dashed var(--border-card); /* Ø­Ø¯ÙˆØ¯ Ù…ØªÙ‚Ø·Ø¹Ø© Ø¹ØµØ±ÙŠØ© */
    border-radius: 20px;
    padding: 3rem 2rem;
    max-width: 450px;
    width: 100%;
    transition: transform 0.3s ease;
}

.empty-content:hover {
    border-color: var(--accent-color);
    background: rgba(255, 255, 255, 0.05);
}

/* ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø© */
.icon-container {
    position: relative;
    display: inline-block;
    margin-bottom: 1.5rem;
}

.icon-container i {
    font-size: 4rem;
    color: var(--text-muted); /* Ù„ÙˆÙ† Ø¨Ø§Ù‡Øª */
    opacity: 0.5;
}

.status-dot {
    position: absolute;
    bottom: 5px;
    right: -5px;
    width: 15px;
    height: 15px;
    background-color: #ffc107; /* Ù„ÙˆÙ† ØªÙ†Ø¨ÙŠÙ‡ Ø¨Ø±ØªÙ‚Ø§Ù„ÙŠ */
    border: 3px solid var(--background-primary);
    border-radius: 50%;
}

/* ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ù†ØµÙˆØµ */
.empty-title {
    font-size: 1.25rem;
    font-weight: 700;
    color: var(--text-light);
    margin-bottom: 0.5rem;
}

.empty-subtitle {
    font-size: 0.9rem;
    color: var(--text-muted);
    line-height: 1.6;
    margin-bottom: 2rem;
}

/* ØªÙ†Ø³ÙŠÙ‚ Ø²Ø± Ø§Ù„Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ */
.workspace-item.add-new {
    background: var(--accent-color); /* Ø§Ù„Ù„ÙˆÙ† Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ Ù„Ù„Ù…ÙˆÙ‚Ø¹ */
    color: #fff; /* Ù„ÙˆÙ† Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø© ÙˆØ§Ù„Ù†Øµ */
    width: auto; /* Ù„ÙŠØªÙ†Ø§Ø³Ø¨ Ù…Ø¹ Ø§Ù„Ù†Øµ */
    height: auto;
    padding: 12px 24px;
    border-radius: 50px; /* Ø­ÙˆØ§Ù Ø¯Ø§Ø¦Ø±ÙŠØ© Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ */
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
    cursor: pointer;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    box-shadow: 0 4px 15px rgba(0, 230, 118, 0.2); /* Ø¸Ù„ Ù†Ø§Ø¹Ù… Ø¨Ù„ÙˆÙ† Ø§Ù„Ø£ÙƒØ³Ù†Øª */
}

.workspace-item.add-new:hover {
    transform: translateY(-3px);
    box-shadow: 0 8px 25px rgba(0, 230, 118, 0.3);
}

.workspace-item.add-new:active {
    transform: translateY(-1px);
}

.workspace-item.add-new svg {
    stroke-width: 2.5; /* Ø¬Ø¹Ù„ Ø®Ø·ÙˆØ· Ø§Ù„Ø²Ø§Ø¦Ø¯ Ø£ÙƒØ«Ø± ÙˆØ¶ÙˆØ­Ø§Ù‹ */
}

.btn-label {
    font-weight: 600;
    font-size: 0.95rem;
}
</style>
{% endif %}

<style>
/* Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø£Ù„ÙˆØ§Ù† â€” ÙŠÙ…ÙƒÙ†Ùƒ ØªØ¹Ø¯ÙŠÙ„Ù‡Ø§ Ø¨Ø³Ù‡ÙˆÙ„Ø© */
.error-banner {
  --bg: #fff6f6;
  --border: #ff4d4d;
  --accent: #b30000;
  --muted: #6b2020;
  --btn-bg: #fff;
  --btn-border: #ffd6d6;
  --radius: 10px;
  --font-family: "Inter", "Arial", sans-serif;
  display: flex;
  gap: 12px;
  align-items: flex-start;
  padding: 12px;
  border-radius: var(--radius);
  border: 1px solid var(--border);
  background: linear-gradient(180deg, var(--bg), #fff0f0);
  color: var(--accent);
  box-shadow: 0 6px 18px rgba(179, 0, 0, 0.08);
  font-family: var(--font-family);
  font-size: 14px;
  line-height: 1.3;
  position: relative;
  overflow: hidden;
  margin: 6px 0;
  animation: slideUpFade 260ms ease;
}

/* Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø§Ù„ÙŠØ³Ø§Ø± */
.error-banner .icon {
  flex: 0 0 36px;
  width: 36px;
  height: 36px;
  display: grid;
  place-items: center;
  background: rgba(179,0,0,0.08);
  border-radius: 8px;
  color: var(--accent);
  font-size: 18px;
}

/* Ø§Ù„Ù†ØµÙˆØµ */
.error-banner .texts {
  flex: 1 1 auto;
  display: flex;
  flex-direction: column;
  gap: 4px;
  min-width: 0;
}
.error-banner .title {
  font-weight: 700;
  color: var(--accent);
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}
.error-banner .reason {
  color: var(--muted);
  font-size: 13px;
  word-break: break-word;
}

/* Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª */
.error-banner .actions {
  display: flex;
  gap: 8px;
  margin-top: 8px;
}
.error-banner button.action-btn {
  display: inline-flex;
  align-items: center;
  gap: 8px;
  padding: 6px 10px;
  border-radius: 8px;
  border: 1px solid var(--btn-border);
  background: var(--btn-bg);
  cursor: pointer;
  font-weight: 600;
  font-size: 13px;
  color: var(--accent);
}
.error-banner button.action-btn.secondary {
  background: transparent;
  border: 1px dashed rgba(179,0,0,0.12);
}

/* Ø²Ø± Ø¥ØºÙ„Ø§Ù‚ */
.error-banner .close-btn {
  position: absolute;
  top: 6px;
  right: 8px;
  width: 28px;
  height: 28px;
  border: none;
  background: transparent;
  color: var(--accent);
  cursor: pointer;
  font-size: 18px;
  display: grid;
  place-items: center;
  line-height: 1;
}

/* ØªÙ„Ù…ÙŠØ­ Ø¹Ù†Ø¯ hover Ø¹Ù„Ù‰ Ø²Ø± Ø§Ù„Ù‚Ø§Ù„Ø¨ */
.error-banner .template-hint {
  font-size: 12px;
  color: #7a1b1b;
  margin-left: 6px;
  display: none;
}
.error-banner .tpl-wrap:hover .template-hint { display: inline-block; }

/* Ø£Ù†ÙŠÙ…ÙŠØ´Ù† */
@keyframes slideUpFade {
  from { transform: translateY(6px); opacity: 0; }
  to   { transform: translateY(0);   opacity: 1; }
}

/* ÙˆØ¶Ø¹ÙŠÙ‘Ø© Ø¯Ø§ÙƒÙ†Ø© ØªØ¹ØªÙ…Ø¯ Ø¹Ù„Ù‰ prefers-color-scheme */
@media (prefers-color-scheme: dark) {
  .error-banner {
    --bg: #2a1111;
    --border: rgba(255,77,77,0.18);
    --accent: #ffb3b3;
    --muted: #f4dede;
    --btn-bg: rgba(255,255,255,0.03);
    --btn-border: rgba(255,255,255,0.04);
    background: linear-gradient(180deg, #2f1111, #260a0a);
    box-shadow: 0 6px 20px rgba(0,0,0,0.5);
  }
}

/* Ù‚Ø§Ø¨Ù„ÙŠØ© Ø§Ù„Ø§Ø³ØªØ¬Ø§Ø¨Ø© Ù„Ù‡ÙˆØ§ØªÙ ØµØºÙŠØ±Ø© */
@media (max-width:420px) {
  .error-banner { font-size: 13px; padding: 10px; gap: 8px; }
  .error-banner .icon { width: 34px; height: 34px; font-size: 16px; }
  .error-banner .actions { flex-wrap: wrap; gap: 6px; }
}
</style>

<!-- <script>
    const navBtns = document.querySelectorAll('.cls3741_btn');
const panels = document.querySelectorAll('.cls3741_panel');
const sideCards = document.querySelectorAll('.cls3741_sidecard');

navBtns.forEach(btn => {
  btn.addEventListener('click', () => {
    const target = btn.getAttribute('data-target');

    // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø§ÙƒØªÙ Ù…Ù† Ø§Ù„Ø£Ø²Ø±Ø§Ø±
    navBtns.forEach(b => b.classList.remove('cls3741_btn_active'));
    btn.classList.add('cls3741_btn_active');

    // Ø¥Ø®ÙØ§Ø¡ ÙƒÙ„ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª
    panels.forEach(p => p.style.display = 'none');
    sideCards.forEach(s => s.classList.remove('cls3741_sidecard_visible'));

    // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ù…Ù†Ø§Ø³Ø¨Ø©
    const panel = document.querySelector(`.cls3741_panel_${target}`);
    if (panel) panel.style.display = 'block';

    const side = document.querySelector(`.cls3741_sidecard_${target}`);
    if (side) side.classList.add('cls3741_sidecard_visible');
  });
});

// Ø§ØºÙ„Ø§Ù‚ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ©
document.querySelectorAll('.cls3741_close_side').forEach(btn => {
  btn.addEventListener('click', (e) => {
    e.target.closest('.cls3741_sidecard').classList.remove('cls3741_sidecard_visible');
  });
});



</script>
  -->

<!-- <script>
/**
 * showSendError(resData, options)
 *   - resData: JSON response from backend { error: "...", reason: "..." }
 *   - options: optional { wrapperSelector, onRetry, onSelectTemplate, autoDismissMs }
 *
 * Usage:
 *   await resData = await res.json();
 *   showSendError(resData, {
 *     onRetry: () => sendMessageLocal(...),           // ØªÙˆØµÙŠÙ„ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù„Ø¯ÙŠÙƒ
 *     onSelectTemplate: () => openTemplatePanel(),   // ÙØªØ­ ÙˆØ§Ø¬Ù‡Ø© Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù‚Ø§Ù„Ø¨
 *   });
 */
function showSendErrorchat(resData = {}, options = {}) {
  const {
    wrapperSelector = '.cls3741_chat_input_wrapper',
    onRetry = null,
    onSelectTemplate = null,
    autoDismissMs = 8000
  } = options;

  const wrapper = document.querySelector(wrapperSelector);
  if (!wrapper) return console.log('showSendError: wrapper not found:', wrapperSelector);
    

  // Ù†ØµÙˆØµ Ø¢Ù…Ù†Ø©
  const title = (resData.error && String(resData.error).trim()) || 'Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„';
  const reason = (resData.reason && String(resData.reason).trim()) || (resData.details && String(resData.details).trim()) || '';

  // Ø§Ø­Ø°Ù Ø£ÙŠ Ø¨Ø§Ù†Ø± Ù‚Ø¯ÙŠÙ…
  const existing = wrapper.querySelector('.error-banner');
  if (existing) existing.remove();

  // Ø¨Ù†Ø§Ø¡ Ø§Ù„Ø¹Ù†ØµØ±

  const el = document.createElement('div');
  el.className = 'error-banner';
  el.setAttribute('role', 'alert');
  el.innerHTML = `
    <div class="icon" aria-hidden="true">âš ï¸</div>
    <div class="texts">
      <div class="title">${escapeHtml(title)}</div>
      <div class="reason">${escapeHtml(reason)}</div>
      <div class="actions">
        <button class="action-btn retry-btn" type="button"> Try again</button>
        <span class="tpl-wrap">
          <button class="action-btn secondary select-tpl-btn" type="button"> Select Templaite</button>
          <span class="template-hint">Ù…Ø±Ù‘Ø± Ù‡Ù†Ø§ Ù„Ø¥Ø±Ø³Ø§Ù„ Ù‚Ø§Ù„Ø¨ Ø¬Ø§Ù‡Ø²</span>
        </span>
      </div>
    </div>
    <button class="close-btn" aria-label="Ø¥ØºÙ„Ø§Ù‚">âœ•</button>
  `;

  // Ø¥Ø¯Ø±Ø§Ø¬ ÙÙŠ DOM (Ù†Ø¶Ø¹Ù‡ Ø£Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø¯Ø§Ø®Ù„ wrapper)
  wrapper.prepend(el);
document.querySelector('.cls3741_chat_input_container').classList.add('d-none')
  // Ø£Ø­Ø¯Ø§Ø« Ø§Ù„Ø£Ø²Ø±Ø§Ø±
  const retryBtn = el.querySelector('.retry-btn');
  const tplBtn = el.querySelector('.select-tpl-btn');
  const closeBtn = el.querySelector('.close-btn');

  let dismissTimer = null;
  const startAutoDismiss = () => {
    if (!autoDismissMs) return;
    clearTimeout(dismissTimer);
    dismissTimer = setTimeout(() => fadeOutAndRemove(el), autoDismissMs);
  };
  const stopAutoDismiss = () => clearTimeout(dismissTimer);

//   el.addEventListener('mouseenter', stopAutoDismiss);
//   el.addEventListener('mouseleave', startAutoDismiss);

//   startAutoDismiss();

  // Retry callback (Ø§ØªØ±Ùƒ Ø§Ù„ÙØ¹Ù„ Ù„Ùƒ Ù„Ø±Ø¨Ø·Ù‡ Ø¨Ø¯Ø§Ù„ØªÙƒ)
  retryBtn.addEventListener('click', (ev) => {
    ev.preventDefault();
    fadeOutAndRemove(el);
    if (typeof onRetry === 'function') {
      try { onRetry(); } catch (e) { console.error('onRetry failed', e); }
    } else {
      // Ø¥Ø°Ø§ Ù„Ù… ØªÙˆÙÙ‘Ø± onRetryØŒ Ù†Ø·Ù„Ù‚ Ø­Ø¯Ø«Ù‹Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªÙ‚Ø§Ø·Ù‡ Ù…Ù† Ù‚ÙØ¨Ù„ ÙƒÙˆØ¯ Ø¢Ø®Ø±
      wrapper.dispatchEvent(new CustomEvent('chat9999:retry-send', { detail: { resData } }));
    }
  });

  // Select template callback
  tplBtn.addEventListener('click', (ev) => {
    ev.preventDefault();
    if (typeof onSelectTemplate === 'function') {
      try { onSelectTemplate(); } catch (e) { console.error('onSelectTemplate failed', e); }
    } else {
      wrapper.dispatchEvent(new CustomEvent('chat9999:open-template', { detail: { resData } }));
    }
  });

  // Close button
  closeBtn.addEventListener('click', () => fadeOutAndRemove(el));

  // helper functions
  function fadeOutAndRemove(node) {
    node.style.transition = 'opacity 220ms ease, transform 220ms ease';
    node.style.opacity = '0';
    node.style.transform = 'translateY(6px)';
    setTimeout(() => { if (node && node.parentNode) node.parentNode.removeChild(node); }, 240);
  }

  // escaping (safety)
  function escapeHtml(str) {
    return String(str || '').replace(/[&<>"'`=\/]/g, function(s){
      return ({
        '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;','/':'&#x2F;','`':'&#x60;','=':'&#x3D;'
      })[s];
    });
  }
}
</script> -->



<div id="cls3741_add_channel_modal" class="cls3741_modal_overlay" style="display: none;">
  <div class="cls3741_modal_content">
      <div class="cls3741_modal_header">
          <h3>Ø¥Ø¶Ø§ÙØ© Ù‚Ù†Ø§Ø© ÙˆØ§ØªØ³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯Ø©</h3>
          <button onclick="closeAddChannelModal()" class="cls3741_modal_close">&times;</button>
      </div>
      
      <div class="cls3741_modal_body">
        <div class="form-group">
            <label>Ø§Ø³Ù… Ø§Ù„Ù‚Ù†Ø§Ø© (Ù…Ø«Ù„Ø§Ù‹: ÙØ±Ø¹ Ø¯Ø¨ÙŠ)</label>
            <input type="text" id="new_ch_name" class="cls3741_input_field" placeholder="ØªØ³Ù…ÙŠØ© Ø¯Ø§Ø®Ù„ÙŠØ© Ù„Ù„Ù‚Ù†Ø§Ø©">
        </div>
    
        <div style="text-align: center; margin-top: 20px;">
            <div id="fb-root"></div>
            <button onclick="launchWhatsAppSignup()" class="cls3741_btn_facebook">
                <svg viewBox="0 0 24 24" width="20" height="20" fill="white" style="margin-right:8px; vertical-align:middle;">
                    <path d="M24 12.073c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.99 4.388 10.954 10.125 11.854v-8.385H7.078v-3.47h3.047V9.43c0-3.007 1.792-4.669 4.533-4.669 1.312 0 2.686.235 2.686.235v2.953H15.83c-1.491 0-1.956.925-1.956 1.874v2.25h3.328l-.532 3.47h-2.796v8.385C19.612 23.027 24 18.062 24 12.073z"/>
                </svg>
                Ø±Ø¨Ø· Ø­Ø³Ø§Ø¨ ÙˆØ§ØªØ³Ø§Ø¨ (Meta)
            </button>
            <p style="color:var(--text-secondary); font-size:12px; margin-top:10px;">
                Ø³ÙŠØªÙ… Ø¬Ù„Ø¨ Ø§Ù„Ø±Ù‚Ù… ÙˆØ§Ù„Ù…Ø¹Ø±ÙØ§Øª ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹.
            </p>
        </div>
    </div>
  </div>
</div>
 

<!-- audio player css  -->

<style>
  /* --- Green Audio Player Styling --- */
.audio.green-audio-player {
  width: 100%; /* Ø¬Ø¹Ù„ Ø§Ù„Ø¹Ø±Ø¶ Ù…Ø±Ù† */
  max-width: 350px; /* Ø£Ù‚ØµÙ‰ Ø¹Ø±Ø¶ */
  min-width: 250px;
  height: 56px;
  box-shadow: 0 4px 16px 0 rgba(0, 0, 0, 0.07);
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding-left: 16px;
  padding-right: 16px;
  border-radius: 40px;
  user-select: none;
  -webkit-user-select: none;
  background-color: #fff;
  direction: ltr; /* Ø§Ù„ØµÙˆØª Ø¯Ø§Ø¦Ù…Ø§Ù‹ Ù…Ù† Ø§Ù„ÙŠØ³Ø§Ø± Ù„Ù„ÙŠÙ…ÙŠÙ† */
  margin-bottom: 5px;
}

/* Ø²Ø± Ø§Ù„ØªØ´ØºÙŠÙ„ */
.audio.green-audio-player .play-pause-btn {
  display: flex;
  cursor: pointer;
  align-items: center;
  justify-content: center;
}
.audio.green-audio-player .play-pause-icon {
    fill: #566574;
    transition: fill 0.2s;
}
.audio.green-audio-player .play-pause-btn:hover .play-pause-icon {
    fill: #44bfa3;
}

/* Ù…Ù†Ø·Ù‚Ø© Ø§Ù„ØªØ­ÙƒÙ… (Ø§Ù„ÙˆÙ‚Øª ÙˆØ§Ù„Ø´Ø±ÙŠØ·) */
.audio.green-audio-player .controls {
  font-family: "Roboto", sans-serif;
  font-size: 12px; /* ØªØµØºÙŠØ± Ø§Ù„Ø®Ø· Ù‚Ù„ÙŠÙ„Ø§Ù‹ */
  line-height: 18px;
  color: #55606e;
  display: flex;
  flex-grow: 1;
  justify-content: space-between;
  align-items: center;
  margin-left: 12px;
  margin-right: 12px;
}

/* Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ‚Ø¯Ù… */
.audio.green-audio-player .slider {
  flex-grow: 1;
  background-color: #d8d8d8;
  cursor: pointer;
  position: relative;
  margin-left: 10px;
  margin-right: 10px;
  border-radius: 2px;
  height: 4px;
}

.audio.green-audio-player .slider .progress {
  background-color: #44bfa3;
  border-radius: inherit;
  position: absolute;
  top: 0;
  left: 0;
  bottom: 0;
  width: 0%; /* Ø³ÙŠØªØºÙŠØ± Ø¨Ø§Ù„Ø¬Ø§ÙØ§Ø³ÙƒØ±Ø¨Øª */
  pointer-events: none;
  height: 100% !important;
    overflow: visible !important;
}

.audio.green-audio-player .slider .progress .pin {
  height: 12px;
  width: 12px;
  border-radius: 50%;
  background-color: #44bfa3;
  position: absolute;
  right: -6px; /* Ù†ØµÙ Ø§Ù„Ø¹Ø±Ø¶ */
  top: -4px;
  box-shadow: 0px 1px 1px 0px rgba(0, 0, 0, 0.32);
  transition: transform 0.1s;
}

.audio.green-audio-player .controls span {
  cursor: default;
  min-width: 30px; /* Ù„Ø¶Ù…Ø§Ù† Ø¹Ø¯Ù… Ø§Ù‡ØªØ²Ø§Ø² Ø§Ù„ÙˆÙ‚Øª */
  text-align: center;
}

/* Ø§Ù„ØªØ­ÙƒÙ… Ø¨Ø§Ù„ØµÙˆØª (Volume) */
.audio.green-audio-player .volume {
  position: relative;
  display: flex;
  align-items: center;
}
.audio.green-audio-player .volume .volume-btn {
  cursor: pointer;
  display: flex;
}
/* Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø§Ù„ØµÙˆØª */
.audio.green-audio-player .volume svg path {
    fill: #566574;
}

/* Ø´Ø±ÙŠØ· Ø§Ù„ØµÙˆØª Ø§Ù„Ø¹Ù…ÙˆØ¯ÙŠ (Ù…Ø®ÙÙŠ Ø§ÙØªØ±Ø§Ø¶ÙŠØ§Ù‹) */
.audio.green-audio-player .volume .volume-controls {
  width: 30px;
  height: 100px;
  background-color: rgba(0, 0, 0, 0.8);
  border-radius: 7px;
  position: absolute;
  left: -5px;
  bottom: 35px;
  flex-direction: column;
  align-items: center;
  display: flex;
  z-index: 100;
  padding: 10px 0;
}
.audio.green-audio-player .volume .volume-controls.hidden {
  display: none;
}

.audio.green-audio-player .volume .volume-controls .slider {
  margin-top: 0;
  margin-bottom: 0;
  width: 4px;
  border-radius: 3px;
  height: 100%;
  position: relative;
}
.audio.green-audio-player .volume .volume-controls .slider .progress {
  bottom: 0;
  height: 80%; /* Ù…Ø³ØªÙˆÙ‰ Ø§Ù„ØµÙˆØª Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ */
  width: 100%;
  top: auto; /* Ù…Ù‡Ù… Ù„Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø¹Ù…ÙˆØ¯ÙŠ */
}
.audio.green-audio-player .volume .volume-controls .slider .progress .pin {
    top: -6px;
    right: -4px;
}






/* img video  sKetlen style  */


/* Ø­Ø§ÙˆÙŠØ© Ø§Ù„ÙˆØ³Ø§Ø¦Ø· (Ù„Ø¶Ø¨Ø· Ø§Ù„Ø­Ø¬Ù…) */
/* 1. Ø§Ù„Ø­Ø§ÙˆÙŠØ© (Wrapper) */
.media-loading-wrapper {
    position: relative;
    /* ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ Ù„Ù„Ø¹Ø±Ø¶ ÙˆØ§Ù„Ø§Ø±ØªÙØ§Ø¹ */
    max-width: 300px;  /* Ù„Ø§ ØªØªØ¬Ø§ÙˆØ² Ù‡Ø°Ø§ Ø§Ù„Ø¹Ø±Ø¶ */
    max-height: 300px; /* Ù„Ø§ ØªØªØ¬Ø§ÙˆØ² Ù‡Ø°Ø§ Ø§Ù„Ø§Ø±ØªÙØ§Ø¹ */
    min-width: 150px;
    min-height: 200px;
    border-radius: 12px; /* Ø­ÙˆØ§Ù Ø¯Ø§Ø¦Ø±ÙŠØ© Ù†Ø§Ø¹Ù…Ø© */
    overflow: hidden;    /* Ù‚Øµ Ø£ÙŠ Ø²ÙˆØ§Ø¦Ø¯ */
    margin-bottom: 5px;
    background-color: #f0f0f0;
    cursor: pointer;     /* Ø¥Ø´Ø§Ø±Ø© Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø£Ù†Ù‡Ø§ Ù‚Ø§Ø¨Ù„Ø© Ù„Ù„Ù†Ù‚Ø± */
    border: 1px solid rgba(0,0,0,0.05); /* Ø¥Ø·Ø§Ø± Ø®ÙÙŠÙ Ø¬Ø¯Ø§Ù‹ */
}

/* 2. Ø§Ù„ØµÙˆØ±Ø© Ù†ÙØ³Ù‡Ø§ */
.real-media-element {
    width: 100%;
    height: 100%;
    object-fit: cover; /* ğŸ”¥ Ø§Ù„Ø³Ø­Ø± Ù‡Ù†Ø§: ÙŠÙ…Ù„Ø£ Ø§Ù„Ø¥Ø·Ø§Ø± Ø¯ÙˆÙ† ØªØ´ÙˆÙŠÙ‡ Ø§Ù„ØµÙˆØ±Ø© */
    display: block;
}

/* ØªØ­Ø³ÙŠÙ† Ø®Ø§Øµ Ù„Ù„ÙÙŠØ¯ÙŠÙˆ Ù„ÙŠÙƒÙˆÙ† Ù…ØªÙ†Ø§Ø³Ù‚Ø§Ù‹ */
video.real-media-element {
    object-fit: contain; /* Ø§Ù„ÙÙŠØ¯ÙŠÙˆ ÙŠÙØ¶Ù„ contain Ù„ÙƒÙŠ Ù„Ø§ ÙŠØ®ØªÙÙŠ Ø¬Ø²Ø¡ Ù…Ù†Ù‡ */
    background: black;
}

/* Ø§Ù„Ù‡ÙŠÙƒÙ„ Ø§Ù„Ù…ØªØ­Ø±Ùƒ (ÙƒÙˆØ¯Ùƒ Ù…Ø¹ ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ø¨Ø³ÙŠØ·Ø©) */
.image_skeleton_loader {
    width: 100%;
    height: 100%;
    position: absolute;
    top: 0;
    left: 0;
    z-index: 10; /* ÙÙˆÙ‚ Ø§Ù„ØµÙˆØ±Ø© */
    background: linear-gradient(120deg, #e5e5e5 30%, #f0f0f0 38%, #f0f0f0 40%, #e5e5e5 48%);
    background-size: 200% 100%;
    background-position: 100% 0;
    animation: loadSkeleton 1.5s infinite linear;
}

/* Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠØ© (Ù…Ø®ÙÙŠØ© ÙÙŠ Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©) */
.real-media-element {
    display: none; /* Ù…Ø®ÙÙŠØ© Ø­ØªÙ‰ ÙŠØªÙ… ØªØ­Ù…ÙŠÙ„Ù‡Ø§ */
    width: 100%;
    height: auto;
    object-fit: cover;
    position: relative;
    z-index: 20;
    opacity: 0;
    transition: opacity 0.5s ease-in; /* Ø¸Ù‡ÙˆØ± Ù†Ø§Ø¹Ù… */
}

/* ÙƒÙ„Ø§Ø³ ÙŠØ¶Ø§Ù Ø¹Ù†Ø¯ Ø§ÙƒØªÙ…Ø§Ù„ Ø§Ù„ØªØ­Ù…ÙŠÙ„ */
.real-media-element.loaded {
    display: block;
    opacity: 1;
}

@keyframes loadSkeleton {
    100% {
        background-position: -100% 0;
    }
}


</style>

<div id="image_modal_overlay" class="cls3741_modal_overlay" style="display: none; background: rgba(0,0,0,0.9); z-index: 999999;" onclick="closeImageModal()">
  <span style="position: absolute; top: 20px; right: 30px; color: white; font-size: 40px; cursor: pointer;">&times;</span>
  <img id="modal_full_image" src="" style="max-width: 90%; max-height: 90%; border-radius: 5px; box-shadow: 0 0 20px rgba(0,0,0,0.5);">
</div>


<script>
  // 1. ÙØªØ­ Ø§Ù„Ù†Ø§ÙØ°Ø©
window.openAddChannelModal = function() {
    const modal = document.getElementById('cls3741_add_channel_modal');
    if(modal) modal.style.display = 'flex';
};

// 2. Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù†Ø§ÙØ°Ø©
window.closeAddChannelModal = function() {
    const modal = document.getElementById('cls3741_add_channel_modal');
    if(modal) modal.style.display = 'none';
};

// 3. Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ø³ÙŠØ±ÙØ±
window.submitNewChannel = async function() {
    const name = document.getElementById('new_ch_name').value;
    // const phone = document.getElementById('new_ch_phone').value;
    // const pid = document.getElementById('new_ch_pid').value;
    // const waba = document.getElementById('new_ch_waba').value;
    // const token = document.getElementById('new_ch_token').value;

    if (!name) {
        alert("ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©");
        return;
    }

    try {
        const response = await fetch('/discount/whatssapAPI/api/channels/create/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            body: JSON.stringify({
                name: name,
                phone_number: phone,
                phone_number_id: pid,
                business_account_id: waba,
                access_token: token
            })
        });

        const data = await response.json();

        if (response.ok && data.success) {
            alert("ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù‚Ù†Ø§Ø© Ø¨Ù†Ø¬Ø§Ø­! ğŸ‰");
            window.location.reload(); // Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø© Ù„ØªØ¸Ù‡Ø± Ø§Ù„Ù‚Ù†Ø§Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
        } else {
            alert("ÙØ´Ù„ Ø§Ù„Ø¥Ø¶Ø§ÙØ©: " + (data.error || "Ø®Ø·Ø£ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ"));
        }

    } catch (error) {
        console.error("Error creating channel:", error);
        alert("Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„");
    }
};





window.fbAsyncInit = function() {
    FB.init({
      appId      : '843023434947245', // âœ… ØªÙ… ÙˆØ¶Ø¹ Ø§Ù„Ù€ App ID Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ
      cookie     : true,
      xfbml      : true,
      version    : 'v24.0' // ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ù†Ø³Ø®Ø©ØŒ ÙŠÙØ¶Ù„ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø£Ø­Ø¯Ø«
    });
    
    console.log("âœ… Facebook SDK Initialized!");
};

// 2. ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù€ SDK (Ø¨Ø´ÙƒÙ„ ØºÙŠØ± Ù…ØªØ²Ø§Ù…Ù†)
(function(d, s, id){
     var js, fjs = d.getElementsByTagName(s)[0];
     if (d.getElementById(id)) {return;}
     js = d.createElement(s); js.id = id;
     js.src = "https://connect.facebook.net/en_US/sdk.js";
     fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));

// 3. Ø¯Ø§Ù„Ø© Ø§Ù„ØªØ´ØºÙŠÙ„ (Ù…Ø±Ø¨ÙˆØ·Ø© Ø¨Ø§Ù„Ø²Ø±)
window.launchWhatsAppSignup = function() {
    // ØªØ­Ù‚Ù‚ Ø£Ù…Ø§Ù† Ø¥Ø¶Ø§ÙÙŠ: Ù‡Ù„ FB Ù…Ø¹Ø±ÙØ©ØŸ
    if (typeof FB === 'undefined') {
        alert("Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Facebook SDK... ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± Ø«Ø§Ù†ÙŠØ© ÙˆØ§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø¬Ø¯Ø¯Ø§Ù‹.");
        return;
    }

    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ø³Ù… Ø§Ù„Ù‚Ù†Ø§Ø©
    const nameInput = document.getElementById('new_ch_name');
    const name = nameInput ? nameInput.value : '';
    
    if(!name) { 
        alert("Ø§Ù„Ù…Ø±Ø¬Ùˆ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ù„Ù„Ù‚Ù†Ø§Ø© Ø£ÙˆÙ„Ø§Ù‹"); 
        if(nameInput) nameInput.focus();
        return; 
    }

    // Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Login
    FB.login(function(response) {
        if (response.authResponse) {
            const accessToken = response.authResponse.accessToken;
            console.log('âœ… ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ØŒ Ø§Ù„ØªÙˆÙƒÙ†:', accessToken);
            
            // Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªÙˆÙƒÙ† Ù„Ù„Ø¨Ø§Ùƒ Ø¥Ù†Ø¯
            exchangeTokenForChannel(accessToken, name);
        } else {
            console.log('âŒ Ø£Ù„ØºÙ‰ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø¹Ù…Ù„ÙŠØ©.');
        }
    }, {
        // Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© (ØªØ£ÙƒØ¯ Ø£Ù†Ùƒ ØªØ·Ù„Ø¨Ù‡Ø§)
        scope: 'whatsapp_business_management, whatsapp_business_messaging',
        extras: {
            feature: 'whatsapp_embedded_signup',
            version: 2
        }
    });
};



// 3. Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªÙˆÙƒÙ† Ù„Ù„Ø¨Ø§Ùƒ Ø¥Ù†Ø¯
async function exchangeTokenForChannel(token, channelName) {
    try {
      const response = await fetch('/discount/whatssapAPI/api/channels/connect_meta/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCsrfToken() // ØªØ£ÙƒØ¯ Ø£Ù† Ø¯Ø§Ù„Ø© Ø§Ù„ØªÙˆÙƒÙ† Ù…ØªØ§Ø­Ø©
            },
            body: JSON.stringify({ 
                access_token: token,
                name: channelName
            })
        });

        const data = await response.json();
        
        if (data.success) {
            alert(`ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù‚Ù†Ø§Ø© "${data.phone_number}" Ø¨Ù†Ø¬Ø§Ø­! ğŸ‰`);
            window.location.reload();
        } else {
            alert('ÙØ´Ù„ Ø§Ù„Ø±Ø¨Ø·: ' + data.error);
        }
    } catch (e) {
        console.error(e);
        alert('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø³ÙŠØ±ÙØ±');
    }
}


</script>

<script> 
    
 

document.addEventListener("DOMContentLoaded", function() {
  window.API_URLS = {
    send: "{% url 'send_message' %}",
    upload: "{% url 'upload_media' %}",
    messages: "{% url 'get_messages' %}",
    contacts: "{% url 'api_contacts' %}",
    lastmsg:"{% url 'get_last_message' %}"
  };  

  (function(){
    // Ø§Ù„Ø¹Ù†Ø§ØµØ± - Ù…Ø­Ø¯Ø«Ø© Ù„Ù„Ø¹Ù†Ø§ØµØ± Ø§Ù„ÙØ¹Ù„ÙŠØ© ÙÙŠ Ø§Ù„Ù€DOM
    const contactsListEl = document.getElementById('cls3741_contacts_list');
    const messagesArea = document.getElementById('cls3741_messages_area');
    const messageInput = document.getElementById('cls3741_message_input'); // ØªÙ… Ø§Ù„ØªØµØ­ÙŠØ­
    const sendBtnmain = document.getElementById('cls3741_send_btn');
    
    // Ø¹Ù†Ø§ØµØ± Ø§Ù„ÙˆØ³Ø§Ø¦Ø· Ù…Ù† Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„ÙØ¹Ù„ÙŠØ©
    const imageInput = document.getElementById('cls3741_image_input');
    const videoInput = document.getElementById('cls3741_video_input');
    const imageBtn = document.getElementById('cls3741_image_btn');
    const videoBtn = document.getElementById('cls3741_video_btn');
    const audioBtn = document.getElementById('cls3741_audio_btn');
    const mediaPreview = document.getElementById('cls3741_media_preview');

    let currentPhone = null;
    let currentChannelId =  '{{ initial_channel_id }}' 
    let lastMessageId = 0;
    let contactsSnapshot = '';
    let pollInterval = 5000;
    let pollTimer = null;
    let contactPollCounter = 0;

    let queuedFile = null;
    let queuedFileType = null;

    // ğŸ”¥ Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø¨Ø­Ø« ÙˆØ§Ù„ÙÙ„ØªØ±Ø©
    let allContactsData = [];
    let currentFilter = 'all';
    let currentSearchQuery = '';

    // Ø­Ø§Ù„Ø© Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ØµÙˆØªÙŠ
    let mediaRecorder = null;
    let audioBlobs = [];
    let isRecording = false;

    // Ø¯Ø§Ù„Ø© Ù„Ø¥Ù†Ø´Ø§Ø¡ Ø£ÙŠÙ‚ÙˆÙ†Ø© ØªØ­Ù…ÙŠÙ„ Ø¬Ù…ÙŠÙ„Ø©
    function createLoadingSpinner() {
      const spinner = document.createElement('div');
      spinner.style.cssText = `
        width: 40px;
        height: 40px;
        border: 3px solid #f3f4f6;
        border-top: 3px solid #000000;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin: 20px auto;
      `;
      return spinner;
    }

    function createLoadingMessage() {
      const container = document.createElement('div');
      container.style.cssText = `
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 40px 20px;
        color: var(--text-secondary);
      `;
      
      container.innerHTML = `
        ${createLoadingSpinner().outerHTML}
        <div style="margin-top: 16px; font-size: 14px;">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©...</div>
      `;
      
      return container;
    }

    function getCsrfToken(){
      const tokenEl = document.querySelector('[name=csrfmiddlewaretoken]');
      return tokenEl ? tokenEl.value : '';
    }

    function escapeHtml(s){
      return (s||'').toString()
        .replace(/&/g,'&amp;')
        .replace(/</g,'&lt;')
        .replace(/>/g,'&gt;')
        .replace(/"/g,'&quot;')
        .replace(/'/g,'&#039;');
    }

    function scrollToBottom(force=false){
      if(!messagesArea) return;
      const nearBottom = messagesArea.scrollTop + messagesArea.clientHeight >= messagesArea.scrollHeight - 80;
      if(force || nearBottom) {
        messagesArea.scrollTop = messagesArea.scrollHeight;
      }
    }

  function existsMsgId(id){
  if(!id) return false;
  
  // ØªØ¬Ø§Ù‡Ù„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ù…Ø¤Ù‚ØªØ© Ø¹Ù†Ø¯ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØªÙƒØ±Ø§Ø±
  if (typeof id === 'string' && id.startsWith('temp_')) {
    return false;
  }
  
  return !!messagesArea.querySelector(`[data-msg-id="${id}"]`);
}
// ğŸ”¥ Ù…Ø´ØºÙ„ ØµÙˆØª Ù…Ø¨Ø³Ø· ÙˆØ£Ù†ÙŠÙ‚
// function initializeAdvancedAudioPlayer(messageWrapper) {
//   const audioElement = messageWrapper.querySelector('.audio-element');
//   const playBtn = messageWrapper.querySelector('.audio-play-btn');
//   const playIcon = messageWrapper.querySelector('.play-icon');
//   const pauseIcon = messageWrapper.querySelector('.pause-icon');
//   const progressBar = messageWrapper.querySelector('.audio-progress-fill');
//   const seekSlider = messageWrapper.querySelector('.audio-seek-slider');
//   const timeDisplay = messageWrapper.querySelector('.audio-time');
//   const durationDisplay = messageWrapper.querySelector('.audio-duration');

//   let isPlaying = false;
//   let animationFrame = null;

//   // 1. ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¹Ù†Ø¯ Ø§Ù„ØªØ­Ù…ÙŠÙ„ (Ù„Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ù…Ø¯Ø©)
//   audioElement.addEventListener('loadedmetadata', () => {
//     const duration = audioElement.duration;
//     if (!isNaN(duration) && duration !== Infinity) {
//       durationDisplay.textContent = formatTime(duration);
//       seekSlider.max = duration;
//     }
//   });

//   // 2. Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ø²Ø± Ø§Ù„ØªØ´ØºÙŠÙ„
//   playBtn.addEventListener('click', (e) => {
//     e.stopPropagation(); // Ù…Ù†Ø¹ Ø§Ù†ØªØ´Ø§Ø± Ø§Ù„Ø­Ø¯Ø«
//     console.log('Play/Pause Clicked. State:', isPlaying);
    
//     if (isPlaying) {
//       pauseAudio();
//     } else {
//       playAudio();
//     }
//   });

//   // 3. Ø¯Ø§Ù„Ø© Ø§Ù„ØªØ´ØºÙŠÙ„ (ØªÙ… Ø¥ØµÙ„Ø§Ø­Ù‡Ø§)
//   function playAudio() {
//     // ğŸ”¥ Ø§Ù„ØªØµØ­ÙŠØ­: Ø£Ø²Ù„Ù†Ø§ Ø´Ø±Ø· if (audioElement.readyState >= 2)
//     // Ù†Ø·Ù„Ø¨ Ø§Ù„ØªØ´ØºÙŠÙ„ Ù…Ø¨Ø§Ø´Ø±Ø©ØŒ ÙˆØ§Ù„Ù…ØªØµÙØ­ Ø³ÙŠØªÙƒÙÙ„ Ø¨Ø§Ù„ØªØ­Ù…ÙŠÙ„
    
//     const playPromise = audioElement.play();

//     if (playPromise !== undefined) {
//       playPromise.then(() => {
//         // Ù†Ø¬Ø­ Ø§Ù„ØªØ´ØºÙŠÙ„
//         isPlaying = true;
//         messageWrapper.classList.add('playing');
//         showPauseIcon();
//         updateProgress();
//       })
//       .catch(error => {
//         console.error('Audio play failed:', error);
//         // ÙÙŠ Ø­Ø§Ù„ ÙØ´Ù„ Ø§Ù„ØªØ´ØºÙŠÙ„ (Ù…Ø«Ù„Ø§Ù‹ Ø§Ù„Ø±Ø§Ø¨Ø· Ø®Ø·Ø£)
//         if(isPlaying) pauseAudio(); 
//       });
//     }
//   }

//   // 4. Ø¯Ø§Ù„Ø© Ø§Ù„Ø¥ÙŠÙ‚Ø§Ù
//   function pauseAudio() {
//     audioElement.pause();
//     isPlaying = false;
//     messageWrapper.classList.remove('playing');
//     showPlayIcon();
//     if (animationFrame) {
//       cancelAnimationFrame(animationFrame);
//     }
//   }

//   // 5. ØªØ­Ø¯ÙŠØ« Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ‚Ø¯Ù…
//   function updateProgress() {
//     if (!isNaN(audioElement.duration)) {
//       const currentTime = audioElement.currentTime;
//       const duration = audioElement.duration;
//       const progressPercent = (currentTime / duration) * 100;
      
//       progressBar.style.width = `${progressPercent}%`;
//       seekSlider.value = currentTime;
//       timeDisplay.textContent = formatTime(currentTime);
      
//       // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø¯Ø© Ø£ÙŠØ¶Ø§Ù‹ ÙÙŠ Ø­Ø§Ù„ Ù„Ù… ØªØ¸Ù‡Ø± ÙÙŠ Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©
//       if(durationDisplay.textContent === '--:--' || durationDisplay.textContent === '0:00') {
//           durationDisplay.textContent = formatTime(duration);
//           seekSlider.max = duration;
//       }
//     }

//     if (isPlaying) {
//       animationFrame = requestAnimationFrame(updateProgress);
//     }
//   }

//   // 6. Ø§Ù„ØªØ­ÙƒÙ… Ø¨Ø´Ø±ÙŠØ· Ø§Ù„Ø³Ø­Ø¨ (Seek)
//   seekSlider.addEventListener('input', (e) => {
//     const time = parseFloat(e.target.value);
//     audioElement.currentTime = time;
//     // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø±Ø¶ ÙŠØ¯ÙˆÙŠØ§Ù‹ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø³Ø­Ø¨
//     const progressPercent = (time / seekSlider.max) * 100;
//     progressBar.style.width = `${progressPercent}%`;
//     timeDisplay.textContent = formatTime(time);
//   });

//   // Ø¥ÙŠÙ‚Ø§Ù Ù…Ø¤Ù‚Øª Ø¹Ù†Ø¯ Ø§Ù„Ø³Ø­Ø¨
//   seekSlider.addEventListener('mousedown', () => {
//      audioElement.pause(); 
//   });
  
//   // Ø§Ø³ØªØ¦Ù†Ø§Ù Ø¹Ù†Ø¯ ØªØ±Ùƒ Ø§Ù„Ø³Ø­Ø¨ (Ø¥Ø°Ø§ ÙƒØ§Ù† ÙŠØ¹Ù…Ù„)
//   seekSlider.addEventListener('mouseup', () => {
//     if (isPlaying) audioElement.play();
//   });

//   // 7. Ø¹Ù†Ø¯ Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„Ù…Ù‚Ø·Ø¹
//   audioElement.addEventListener('ended', () => {
//     pauseAudio(); // ØªØ¹ÙŠØ¯ Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø© ÙˆØªÙˆÙ‚Ù Ø§Ù„Ø£Ù†ÙŠÙ…ÙŠØ´Ù†
//     audioElement.currentTime = 0;
//     progressBar.style.width = '0%';
//     seekSlider.value = 0;
//     timeDisplay.textContent = '0:00';
//   });

//   // Ø¯ÙˆØ§Ù„ Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø§Øª
//   function showPlayIcon() {
//     if(playIcon) playIcon.style.display = 'block';
//     if(pauseIcon) pauseIcon.style.display = 'none';
//   }

//   function showPauseIcon() {
//     if(playIcon) playIcon.style.display = 'none';
//     if(pauseIcon) pauseIcon.style.display = 'block';
//   }

//   function formatTime(seconds) {
//     if (isNaN(seconds) || !isFinite(seconds)) return '0:00';
//     const minutes = Math.floor(seconds / 60);
//     const remainingSeconds = Math.floor(seconds % 60);
//     return `${minutes}:${remainingSeconds.toString().padStart(2, '0')}`;
//   }
// }





function getStatusIconHTML(status) {
    // 1. Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± (Ø³Ø§Ø¹Ø©)
    const pendingIcon = `
        <svg viewBox="0 0 24 24" class="msg-status-icon pending" xmlns="http://www.w3.org/2000/svg">
            <path d="M11.99 2C6.47 2 2 6.48 2 12s4.47 10 9.99 10C17.52 22 22 17.52 22 12S17.52 2 11.99 2zM12 20c-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8-3.58 8-8 8zm.5-13H11v6l5.25 3.15.75-1.23-4.5-2.67z" fill="currentColor"></path>
        </svg>`;

    // 2. Ø£ÙŠÙ‚ÙˆÙ†Ø© Ù…Ø±Ø³Ù„Ø© (ØµØ­ ÙˆØ§Ø­Ø¯)
    const sentIcon = `
        <svg viewBox="0 0 24 24" class="msg-status-icon sent" xmlns="http://www.w3.org/2000/svg">
            <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z" fill="currentColor"></path>
        </svg>`;

    // 3. Ø£ÙŠÙ‚ÙˆÙ†Ø© ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ… Ø£Ùˆ Ø§Ù„Ù‚Ø±Ø§Ø¡Ø© (ØµØ­ÙŠÙ†) - Ù‡Ø°Ø§ Ø§Ù„ÙƒÙˆØ¯ ÙŠØ¶Ù…Ù† Ø¸Ù‡ÙˆØ± Ø§Ù„Ø§Ø«Ù†ÙŠÙ†
    // Ù†Ø³ØªØ®Ø¯Ù… Ù†ÙØ³ Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø© Ù„Ù„Ø­Ø§Ù„ØªÙŠÙ†ØŒ ÙˆØ§Ù„Ù„ÙˆÙ† ÙŠØªØºÙŠØ± Ø¹Ø¨Ø± CSS
    const doubleCheckIcon = `
        <svg viewBox="0 0 24 24" class="msg-status-icon ${status}" xmlns="http://www.w3.org/2000/svg">
            <path d="M18 7l-1.41-1.41-6.34 6.34 1.41 1.41L18 7zm4.24-1.41L11.66 16.17 7.48 12l-1.41 1.41L11.66 19l12-12-1.42-1.41zM.41 13.41L6 19l1.41-1.41L1.83 12 .41 13.41z" fill="currentColor"></path>
        </svg>`;

    // 4. Ø£ÙŠÙ‚ÙˆÙ†Ø© ÙØ´Ù„ (ØªØ¹Ø¬Ø¨)
    const failedIcon = `
        <svg viewBox="0 0 24 24" class="msg-status-icon failed" xmlns="http://www.w3.org/2000/svg">
             <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z" fill="currentColor"></path>
        </svg>`;

    switch (status) {
        case 'sent': return sentIcon;
        case 'delivered': return doubleCheckIcon; // ØµØ­ÙŠÙ† (Ø±Ù…Ø§Ø¯ÙŠ)
        case 'read': return doubleCheckIcon;      // ØµØ­ÙŠÙ† (Ø£Ø²Ø±Ù‚ - Ø³ÙŠØ£Ø®Ø° Ø§Ù„Ù„ÙˆÙ† Ù…Ù† CSS)
        case 'failed': return failedIcon;
        default: return pendingIcon;
    }
}

    function makeMessageNode(m) {
      const isMe = !!m.fromMe;
      const wrapper = document.createElement('div');
      wrapper.className = 'cls3741_msg_bubble' + (isMe ? ' me' : '');
      if (m.id) wrapper.dataset.msgId = m.id;
      const statusIconHTML = getStatusIconHTML(m.status);

      const timeHtml = `<span class="cls3741_msg_time">${escapeHtml(m.time)}</span>`;
      const msg_status = isMe ? `<span class="cls3741_msg_status" [data-msg-id="${m.id}"]  style="z-index:123; color:var(--wa-msg-muted); margin-top: 6px;">${statusIconHTML}</span>` : '';

      if (m.type === 'audio') {
        // ğŸ”¥ ØªØ­Ø³ÙŠÙ† Ø¹Ø±Ø¶ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø§Ù„ØµÙˆØªÙŠØ© Ù…Ø«Ù„ WhatsApp
        const audioUrl = escapeHtml(m.url || '');
        const isValidAudio = audioUrl && audioUrl.trim() !== '' && audioUrl !== 'None' && audioUrl !== 'null';

        // ØªØ³Ø¬ÙŠÙ„ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª debug
        console.log('m  ' , m)
        if (!isValidAudio) {
          console.warn('ğŸµ Invalid audio URL:', {
            url: m.url,
            escapedUrl: audioUrl,
            type: m.type
          });
        }

         // Ø¯Ø§Ø®Ù„ Ø¯Ø§Ù„Ø© makeMessageNodeØŒ Ø§Ø³ØªØ¨Ø¯Ù„ Ø¬Ø²Ø¡ Ø§Ù„ØµÙˆØª Ø¨Ù‡Ø°Ø§ Ø§Ù„ÙƒÙˆØ¯:

const uniqueId = `audio_${m.id || Date.now()}`; // Ù…Ø¹Ø±Ù ÙØ±ÙŠØ¯ Ù„Ø±Ø¨Ø· Ø§Ù„Ø¹Ù†Ø§ØµØ±
const audioSrc = isValidAudio ? audioUrl : '';
const uniqueMediaId = `media_${m.id || Date.now()}_${Math.random().toString(36).substr(2, 9)}`;

wrapper.innerHTML = `
    <div class="audio green-audio-player" id="player_${uniqueId}">
        
        <div class="play-pause-btn" onclick="togglePlayPause('${uniqueId}')">
            <svg viewBox="0 0 18 24" height="20" width="15" xmlns="http://www.w3.org/2000/svg">
                <path class="play-pause-icon" d="M18 12L0 24V0" fill-rule="evenodd"></path>
            </svg>
        </div>

        <div class="controls">
            <span class="current-time">0:00</span>
            
            <div class="slider" data-direction="horizontal" onclick="seekAudio(event, '${uniqueId}')">
                <div class="progress">
                    <div class="pin"></div>
                </div>
            </div>
            
            <span class="total-time">--:--</span>
        </div>

        <div class="volume">
            <div class="volume-btn" onclick="toggleVolumeSlider('${uniqueId}')">
                <svg viewBox="0 0 24 24" height="20" width="20" xmlns="http://www.w3.org/2000/svg">
                    <path d="M14.667 0v2.747c3.853 1.146 6.666 4.72 6.666 8.946 0 4.227-2.813 7.787-6.666 8.934v2.76C20 22.173 24 17.4 24 11.693 24 5.987 20 1.213 14.667 0zM18 11.693c0-2.36-1.333-4.386-3.333-5.373v10.707c2-.947 3.333-2.987 3.333-5.334zm-18-4v8h5.333L12 22.36V1.027L5.333 7.693H0z" fill-rule="evenodd"></path>
                </svg>
            </div>
            <div class="volume-controls hidden">
                <div class="slider" data-direction="vertical" onclick="setVolume(event, '${uniqueId}')">
                    <div class="progress" style="height: 80%;">
                        <div class="pin"></div>
                    </div>
                </div>
            </div>
        </div>

        <audio id="audio_el_${uniqueId}"  ontimeupdate="updateProgress('${uniqueId}')" onloadedmetadata="initAudioDuration('${uniqueId}')" onended="resetPlayer('${uniqueId}')">
            <source src="${audioSrc}" type="audio/ogg">
            <source src="${audioSrc}" type="audio/mpeg">
            <source src="${audioSrc}" type="audio/mp4">
        </audio>
    </div>

    <div class="cls3741_msg_footer" style="display:flex; justify-content:flex-end; gap: 5px; margin-top:5px;">
        ${timeHtml} ${msg_status}
    </div>
`;

        
        setTimeout(() => {
          const audioElement = wrapper.querySelector('.audio-element');
          if (audioElement && isValidAudio) {
            console.log('..')
            // initializeAdvancedAudioPlayer(wrapper);
          } else if (!isValidAudio) {
            // Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù‡Ù†Ø§Ùƒ Ø±Ø§Ø¨Ø· ØµÙˆØªÙŠ ØµØ­ÙŠØ­
            const container = wrapper.querySelector('.audio-container');
            if (container) {
              container.innerHTML = `
                <div class="audio-error">
                  <svg viewBox="0 0 24 24" width="20" height="20">
                    <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"/>
                  </svg>
                  <span>Ø§Ù„Ù…Ù‚Ø·Ø¹ Ø§Ù„ØµÙˆØªÙŠ ØºÙŠØ± Ù…ØªÙˆÙØ±</span>
                </div>
              `;
            }
          }
        }, 100);
      } else if (m.type === 'image') {
    wrapper.innerHTML = `
        <div class="media-loading-wrapper" id="wrapper_media_${m.id || Date.now()}_${Math.random().toString(36).substr(2, 9)}">
            <div class="image_skeleton_loader" id="skeleton_media_${m.id || Date.now()}_${Math.random().toString(36).substr(2, 9)}"></div>

            <img 
                src="${m.url}" 
                class="real-media-element" 
                alt="image"
                onload="onMediaLoaded(this)"
                onerror="onMediaError(this)"
                onclick="openImageModal('${m.url}')"
            >
        </div>
        
        <div class="cls3741_msg_footer">
            ${timeHtml} ${msg_status}
        </div>
    `;

} else if (m.type === 'video') {
    wrapper.innerHTML = `
        <div class="media-loading-wrapper" id="wrapper_media_${m.id || Date.now()}_${Math.random().toString(36).substr(2, 9)}">
            <div class="image_skeleton_loader" id="skeleton_media_${m.id || Date.now()}_${Math.random().toString(36).substr(2, 9)}"></div>

            <video 
                src="${m.url}" 
                class="real-media-element" 
                controls
                onloadeddata="onMediaLoaded(this)"
                onerror="onMediaError(this)"
            ></video>
        </div>
        
        <div class="cls3741_msg_footer">
            ${timeHtml} ${msg_status}
        </div>
    `;
}else {
        wrapper.innerHTML = `
          <div class="cls3741_text">${escapeHtml(m.body || '')}</div>
          <div class="cls3741_msg_footer" style="display:flex; justify-content: flex-end; 
    gap: 5px;">
            ${timeHtml}
            ${msg_status}
          </div>
        `;
      }

      wrapper.style.opacity = '0';
      wrapper.style.transform = 'translateY(10px)';
      wrapper.style.transition = 'all 0.3s ease';

      setTimeout(() => {
        wrapper.style.opacity = '1';
        wrapper.style.transform = 'translateY(0)';
      }, 50);

      return wrapper;
    }





/* --- Ø¯ÙˆØ§Ù„ ØªÙƒØ¨ÙŠØ± Ø§Ù„ØµÙˆØ±Ø© --- */

// Ø¯Ø§Ù„Ø© Ù„ÙØªØ­ Ø§Ù„Ù…ÙˆØ¯Ø§Ù„
window.openImageModal = function(src) {
    const modal = document.getElementById('image_modal_overlay');
    const img = document.getElementById('modal_full_image');
    if(modal && img) {
        img.src = src;
        modal.style.display = 'flex'; // ØªØ£ÙƒØ¯ Ø£Ù† Ø§Ù„Ù…ÙˆØ¯Ø§Ù„ ÙŠØ³ØªØ®Ø¯Ù… Flexbox Ù„Ù„ØªÙˆØ³Ø·
    }
};

// Ø¯Ø§Ù„Ø© Ù„Ù„Ø¥ØºÙ„Ø§Ù‚
window.closeImageModal = function() {
    document.getElementById('image_modal_overlay').style.display = 'none';
};


window.onMediaLoaded = function(element) {
    // Ù†Ø¨Ø­Ø« Ø¹Ù† Ø£Ù‚Ø±Ø¨ Ø£Ø¨ ÙŠØ­Ù…Ù„ ÙƒÙ„Ø§Ø³ Ø§Ù„Ù€ Wrapper
    const wrapper = element.closest('.media-loading-wrapper');
    
    if (!wrapper) {
        console.warn("Media wrapper not found for:", element);
        return;
    }

    // Ù†Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ù‡ÙŠÙƒÙ„ Ø§Ù„Ù…ØªØ­Ø±Ùƒ Ø¯Ø§Ø®Ù„ Ù‡Ø°Ø§ Ø§Ù„Ø£Ø¨
    const skeleton = wrapper.querySelector('.image_skeleton_loader');

    // Ø§Ù„ØªÙ†ÙÙŠØ°
    if (skeleton) {
        skeleton.style.display = 'none'; // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ù„ÙˆØ¯Ø±
    }
    
    element.classList.add('loaded'); // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„ØµÙˆØ±Ø©/Ø§Ù„ÙÙŠØ¯ÙŠÙˆ
    wrapper.style.minHeight = 'auto'; // ØªØ­Ø±ÙŠØ± Ø§Ù„Ø·ÙˆÙ„
};

// Ø¯Ø§Ù„Ø© Ø§Ù„ÙØ´Ù„
window.onMediaError = function(element) {
    const wrapper = element.closest('.media-loading-wrapper');
    if (!wrapper) return;

    const skeleton = wrapper.querySelector('.image_skeleton_loader');
    
    if (skeleton) {
        skeleton.style.animation = 'none';
        skeleton.style.background = '#ffecec'; // Ø®Ù„ÙÙŠØ© Ø­Ù…Ø±Ø§Ø¡ ÙØ§ØªØ­Ø©
        skeleton.innerHTML = `
            <div style="display:flex; flex-direction:column; align-items:center; justify-content:center; height:100%; color:#ef4444; font-size:12px; gap:4px;">
                <svg width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                <span>ÙØ´Ù„ Ø§Ù„ØªØ­Ù…ÙŠÙ„</span>
            </div>
        `;
    }
    
    // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ù…ÙƒØ³ÙˆØ±Ø©
    element.style.display = 'none';
}; 
window.togglePlayPause = async function(uid) {
    // uid Ù‡Ù†Ø§ Ù‡Ùˆ 'audio_47' Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ ÙƒÙˆØ¯Ùƒ
    const audioId = `audio_el_${uid}`;   // Ø³ÙŠØµØ¨Ø­ 'audio_el_audio_47'
    const playerId = `player_${uid}`;    // Ø³ÙŠØµØ¨Ø­ 'player_audio_47'

    const audio = document.getElementById(audioId);
    const player = document.getElementById(playerId);
    
    if (!audio || !player) {
        console.error("Audio element not found:", audioId);
        return;
    }

    const icon = player.querySelector('.play-pause-icon');
    
    // Ø¥ÙŠÙ‚Ø§Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ù‚Ø§Ø·Ø¹ Ø§Ù„Ø£Ø®Ø±Ù‰ ÙÙŠ Ø§Ù„ØµÙØ­Ø©
    document.querySelectorAll('audio').forEach(el => {
        if(el !== audio && !el.paused) { 
            el.pause();
            // Ø¥Ø¹Ø§Ø¯Ø© Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø§Ù„Ù…Ø´ØºÙ„Ø§Øª Ø§Ù„Ø£Ø®Ø±Ù‰ Ù„ÙˆØ¶Ø¹ Ø§Ù„Ø¥ÙŠÙ‚Ø§Ù
            const otherPlayer = el.closest('.green-audio-player');
            if(otherPlayer) {
               const otherIcon = otherPlayer.querySelector('.play-pause-icon');
               if(otherIcon) otherIcon.setAttribute('d', 'M18 12L0 24V0');
            }
        }
    })
    // Ù…Ù†Ø·Ù‚ Ø§Ù„ØªØ´ØºÙŠÙ„
    if (audio.paused) {
        // Ù†ØºÙŠØ± Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø© Ù„Ù€ Pause ÙÙˆØ±Ø§Ù‹ Ù„Ù„Ø§Ø³ØªØ¬Ø§Ø¨Ø© Ø§Ù„Ø¨ØµØ±ÙŠØ©
        icon.setAttribute('d', 'M0 0h6v24H0zM12 0h6v24h-6z'); 

        try {
            await audio.play();
        } catch (err) {
            console.warn("Playback interrupted:", err);
            // ÙÙŠ Ø­Ø§Ù„ Ø§Ù„Ø®Ø·Ø£ Ù†Ø¹ÙŠØ¯ Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø© Ù„Ù€ Play
            icon.setAttribute('d', 'M18 12L0 24V0');
        }
    } else {
        audio.pause();
        icon.setAttribute('d', 'M18 12L0 24V0');
    }
};


window.updateProgress = function(uid) {
    const audio = document.getElementById(`audio_el_${uid}`);
    const player = document.getElementById(`player_${uid}`);
    
    if (!audio || !player) return;

    const progress = player.querySelector('.controls .progress');
    const currentTimeEl = player.querySelector('.current-time');
    
    if (audio.duration && !isNaN(audio.duration)) {
        const percent = (audio.currentTime / audio.duration) * 100;
        progress.style.width = `${percent}%`;
        currentTimeEl.textContent = formatTime(audio.currentTime);
    }
};

// 3. Ø§Ù„ØªØ­ÙƒÙ… ÙÙŠ Ø§Ù„Ø´Ø±ÙŠØ· (ØªÙ‚Ø¯ÙŠÙ…/ØªØ£Ø®ÙŠØ±) Ø¹Ù†Ø¯ Ø§Ù„Ù†Ù‚Ø±
window.seekAudio = function(event, uid) {
    const audio = document.getElementById(`audio_el_${uid}`);
    if (!audio) return;

    const slider = event.currentTarget;
    const rect = slider.getBoundingClientRect();
    const clickX = event.clientX - rect.left; // Ù…ÙƒØ§Ù† Ø§Ù„Ù†Ù‚Ø±
    const width = rect.width; // Ø¹Ø±Ø¶ Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„ÙƒØ§Ù…Ù„
    
    // Ø­Ø³Ø§Ø¨ Ø§Ù„Ù†Ø³Ø¨Ø© Ø§Ù„Ù…Ø¦ÙˆÙŠØ©
    const percent = clickX / width;
    
    if (audio.duration) {
        audio.currentTime = percent * audio.duration;
    }
};

// 4. Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø¯Ø© Ø§Ù„Ø²Ù…Ù†ÙŠØ© Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù„Ù
window.initAudioDuration = function(uid) {
    const audio = document.getElementById(`audio_el_${uid}`);
    const player = document.getElementById(`player_${uid}`);
    if (!audio || !player) return;

    const totalTimeEl = player.querySelector('.total-time');
    // Ù†ØªØ£ÙƒØ¯ Ø£Ù† Ø§Ù„Ù…Ø¯Ø© Ø±Ù‚Ù… ØµØ­ÙŠØ­ ÙˆÙ„ÙŠØ³Øª Infinity
    if (audio.duration && isFinite(audio.duration)) {
        totalTimeEl.textContent = formatTime(audio.duration);
    }
};

// 5. Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø´ØºÙ„ Ø¹Ù†Ø¯ Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„Ù…Ù‚Ø·Ø¹
window.resetPlayer = function(uid) {
    const player = document.getElementById(`player_${uid}`);
    if (!player) return;

    const icon = player.querySelector('.play-pause-icon');
    const progress = player.querySelector('.controls .progress');
    
    icon.setAttribute('d', 'M18 12L0 24V0'); // Ø£ÙŠÙ‚ÙˆÙ†Ø© Play
    progress.style.width = '0%';
};

// 6. Ø§Ù„ØªØ­ÙƒÙ… ÙÙŠ Ø¸Ù‡ÙˆØ± Ø´Ø±ÙŠØ· Ø§Ù„ØµÙˆØª
window.toggleVolumeSlider = function(uid) {
    const player = document.getElementById(`player_${uid}`);
    if (player) {
        const volControls = player.querySelector('.volume-controls');
        volControls.classList.toggle('hidden');
    }
};

// 7. ØªØºÙŠÙŠØ± Ù…Ø³ØªÙˆÙ‰ Ø§Ù„ØµÙˆØª
window.setVolume = function(event, uid) {
    event.stopPropagation(); // Ù…Ù†Ø¹ Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù†Ø§ÙØ°Ø©
    const audio = document.getElementById(`audio_el_${uid}`);
    if (!audio) return;

    const slider = event.currentTarget;
    const rect = slider.getBoundingClientRect();
    const height = rect.height;
    const clickY = event.clientY - rect.top;
    
    // Ø§Ù„Ø­Ø³Ø§Ø¨ Ù…Ù† Ø§Ù„Ø£Ø³ÙÙ„ Ù„Ù„Ø£Ø¹Ù„Ù‰
    let percent = 1 - (clickY / height);
    
    if (percent > 1) percent = 1;
    if (percent < 0) percent = 0;
    
    audio.volume = percent;
    
    // ØªØ­Ø¯ÙŠØ« Ø§Ø±ØªÙØ§Ø¹ Ø´Ø±ÙŠØ· Ø§Ù„ØµÙˆØª
    const player = document.getElementById(`player_${uid}`);
    const progress = player.querySelector('.volume .progress');
    if (progress) progress.style.height = `${percent * 100}%`;
};

// Ø¯Ø§Ù„Ø© Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„ÙˆÙ‚Øª (0:00)
function formatTime(seconds) {
    if (!seconds || isNaN(seconds)) return "0:00";
    const min = Math.floor(seconds / 60);
    const sec = Math.floor(seconds % 60);
    return `${min}:${sec < 10 ? '0' + sec : sec}`;
}




    // Ø¯Ø§Ù„Ø© Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„ÙˆÙ‚Øª
     
    // Ø¯Ø§Ù„Ø© Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„ØªØ´ØºÙŠÙ„ Ø§Ù„ØµÙˆØª
    function initializeAudioPlayer(audio) {
      const playBtn = audio.closest('.audio-message').querySelector('.audio-play-btn');
      const progressBar = audio.closest('.audio-message').querySelector('.bar');
      const timeDisplay = audio.closest('.audio-message').querySelector('.audio-time');

      audio.addEventListener('timeupdate', () => {
        const current = formatTime(audio.currentTime);
        // const duration = formatTime(audio.duration);
        timeDisplay.textContent = `${current} / ${duration || '0:00'}`;
        // if (!isNaN(audio.duration)) {
        //   const percent = (audio.currentTime / audio.duration) * 100;
        //   progressBar.style.width = percent + '%';
        // }
      });

      audio.addEventListener('ended', () => {
        playBtn.textContent = 'â–¶';
        progressBar.style.width = '0%';
      });

      playBtn.addEventListener('click', () => {
        if (audio.paused) {
          audio.play();
          playBtn.textContent = 'â¸';
        } else {
          audio.pause();
          playBtn.textContent = 'â–¶';
        }
      });
    }

    // Ø¯Ø§Ù„Ø© Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„ØªØ£Ù…ÙŠÙ† Ø§Ù„Ù†ØµÙˆØµ
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }   // Ø¯Ø§Ù„Ø© Ù…Ø­Ø³Ù†Ø© Ù„Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø±Ø³Ø§Ø¦Ù„
    function appendMessagesws(msgArray){
      if (!msgArray || !Array.isArray(msgArray)) return;
      
      msgArray.sort((a,b)=> (a.id||0) - (b.id||0));
      let hasNewMessages = false;
      
      for(const m of msgArray){
        if(!m) continue;
        if(m.id && existsMsgId(m.id)) {
          if(m.id > (lastMessageId||0)) lastMessageId = m.id;
          continue;
        }
        
        const node = makeMessageNode(m);
        messagesArea.appendChild(node);
        if(m.id && m.id > (lastMessageId||0)) lastMessageId = m.id;
        hasNewMessages = true;
      }
      
      if (hasNewMessages) {
        scrollToBottom(true);
      }
    }

    // Ø¯Ø§Ù„Ø© Ù…Ø­Ø³Ù†Ø© Ù„Ø¬Ù„Ø¨ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„
    async function fetchMessagesForCurrentws(){
      if(!currentPhone) return;
      
      const url = `${window.API_URLS.messages}?phone=${encodeURIComponent(currentPhone)}&since_id=${encodeURIComponent(lastMessageId||0)}`;
      try{
        const res = await fetch(url, { 
          cache: 'no-store', 
          headers: { 'Accept': 'application/json' }
        });


          
        
        if(!res.ok) return;
        
        const data = await res.json();
        const msgs = data.messages || [];
        
        if(!Array.isArray(msgs) || msgs.length === 0) return;
        
        appendMessagesws(msgs);
        
      }catch(e){ 
        console.error('fetchMessagesForCurrentws', e); 
      }
    }


    async function lastmsg(){
      const url = `${window.API_URLS.lastmsg}?phone=${encodeURIComponent(currentPhone)}&since_id=${encodeURIComponent(lastMessageId||0)}`;
      try{
        const res = await fetch(url, { 
          cache: 'no-store', 
          headers: { 'Accept': 'application/json' }
        });
         if (res.status == 400) {
            console.log('Send error detected');
  const resData = await res.json();
  // Ø§Ø³ØªØ¯Ø¹Ù Ø§Ù„Ø¹Ø±Ø¶ Ù…Ø¹ Ø±Ø¨Ø· Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø¨Ø§Ø´Ø±Ø© Ø¥Ù„Ù‰ Ø¯Ø§Ù„ØªÙƒ
  showSendErrorchat(resData, {
    onRetry: () => {
      
      sendMessageLocal(); // Ø£Ùˆ: sendMessageLocal(queuedFile, queuedFileType)
    },
    onSelectTemplate: () => {
      window.openTemplatePanel();
      // document.dispatchEvent(new CustomEvent('openTemplatePanel'));
    },
    autoDismissMs: 9000
  });

 

  // Ù„Ø§ ØªØ±Ù…ÙŠ Ø§Ø³ØªØ«Ù†Ø§Ø¡ Ù‡Ù†Ø§ â€” ÙÙ‚Ø· Ø§Ø±Ø¬Ø¹ Ø¨Ø¹Ø¯ Ø¹Ø±Ø¶ Ø§Ù„Ø®Ø·Ø£ØŒ Ø£Ùˆ Ø§Ø³ØªØ®Ø¯Ù… return Ø¥Ø°Ø§ Ø£Ø±Ø¯Øª Ø¥ÙŠÙ‚Ø§Ù ØªÙ†ÙÙŠØ° Ø§Ù„Ø¨Ø§Ù‚ÙŠ
  return;
}
          if (res.status == 200) {
            const bannerer = document.querySelector('.error-banner');
            if (bannerer) {
              bannerer.remove();
            document.querySelector('.cls3741_chat_input_container').classList.remove('d-none')
            }
          }

}catch(e){console.error('fetchMessagesForCurrentws', e);} 

        // if(!res.ok) return;
      
    }



// let channelId = ''
    
//   // ------------------------- channel -------------------------- 
// function switchChannel(channelId) {
//   currentChannelId = document.querySelector('.workspace-item .active').getAttribute('currentChannelId')
    
//     if (currentChannelId === channelId) return;

//     // 1. ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø´ÙƒÙ„ Ø§Ù„Ø¨ØµØ±ÙŠ (Active Class)
//     document.querySelectorAll('.cls3741_channel_item').forEach(el => el.classList.remove('active'));
//     event.currentTarget.classList.add('active');

//     // 2. ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…ØªØºÙŠØ±
//     currentChannelId = channelId;
    
//     // 3. Ø¥Ø¸Ù‡Ø§Ø± Ù„ÙˆØ¯Ø± Ø§Ù„ØªØ­Ù…ÙŠÙ„ ÙÙŠ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
//     const contactsListEl = document.getElementById('cls3741_contacts_list');
//     contactsListEl.innerHTML = '<div class="cls3741_loader_new">...</div>';

//     // 4. Ø·Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ± Ù„Ù„Ù‚Ù†Ø§Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
//     // Ù„Ø§Ø­Ø¸: ÙŠØ¬Ø¨ ØªÙ…Ø±ÙŠØ± channel_id ÙÙŠ Ø§Ù„Ø·Ù„Ø¨
//     fetchInitialContacts(channelId); 
    
// }
 
async function fetchInitialContacts(channelId) {
    const url = `${window.API_URLS.contacts}?channel_id=${channelId}`;
    const res = await fetch(url, { 
        cache: 'no-store', 
        headers: { 'Accept': 'application/json' }
    });
    if (!res.ok) throw new Error("Failed to fetch contacts");
    const data = await res.json();
    renderContactsList(data.contacts);
    fetchContactsAndUpdateUIws(data.contacts, true);
}
 

 
fetchInitialContacts(currentChannelId);
window.loadTeamStats(currentChannelId);
// Ø¯Ø§Ù„Ø© ØªÙ‡ÙŠØ¦Ø© (ØªØ³ØªØ¯Ø¹Ù‰ Ø¹Ù†Ø¯ ÙØªØ­ Ø§Ù„ØµÙØ­Ø©)
// async function initApp() {
   
//     await fetchContacts();
// }

// Ø¯Ø§Ù„Ø© ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„Ù‚Ù†Ø§Ø© (Ø¹Ù†Ø¯ Ø§Ù„Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ø§Ù„Ø¯Ø§Ø¦Ø±Ø© Ø§Ù„ÙŠØ³Ø±Ù‰)
async function switchChannel(newChannelId) {
    if(currentChannelId === newChannelId) return;
    
    currentChannelId = newChannelId;
    
    // ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© (Active Class)

    document.querySelectorAll('.workspace-item').forEach(el => el.classList.remove('active'));
    const ci =  document.querySelector(`[data-channel-id="${newChannelId}"]`).classList.add('active');
    

    // ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø´Ø§Øª ÙˆØ§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©
    document.getElementById('cls3741_contacts_list').innerHTML = '<div class="loader">Loading...</div>';
    document.getElementById('cls3741_messages_area').innerHTML = '';
    
    // Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù‚Ù†Ø§Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
    await fetchContactsAndUpdateUIws( null , true);

    if (typeof window.loadContactsListForChannel === 'function') {
        window.loadContactsListForChannel(newChannelId);
    }

    // ğŸ”¥ ØªØ­Ø¯ÙŠØ« Ù‚Ø³Ù… Ø§Ù„Ù€ Automation ğŸ”¥
    if (window.automationsListInstance && typeof window.automationsListInstance.refreshForChannel === 'function') {
        window.automationsListInstance.refreshForChannel(newChannelId);
    }

    if (typeof window.loadTemplates === 'function') {
        // Ù†Ù…Ø±Ø± Ø§Ù„Ù€ ID Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ø£Ùˆ Ù†Ø¹ØªÙ…Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ù…ØªØºÙŠØ± Ø§Ù„Ø¹Ø§Ù… Ø§Ù„Ø°ÙŠ Ø­Ø¯Ø«Ù†Ø§Ù‡ ÙÙŠ Ø§Ù„Ø£Ø¹Ù„Ù‰
        window.loadTemplates(newChannelId); 
    }




    const selectedBtn = document.querySelector(`.workspace-item[data-channel-id="${newChannelId}"]`);
    
    if (selectedBtn) {
        // 2. Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø§Ù„Ù€ attributes
        const name = selectedBtn.getAttribute('data-name');
        const agentsCount = selectedBtn.getAttribute('data-agents');
        
        // 3. ØªØ­Ø¯ÙŠØ« Ø¹Ù†Ø§ØµØ± Ø§Ù„Ù‡ÙŠØ¯Ø± (DOM)
        const logoEl = document.getElementById('current_channel_logo');
        const nameEl = document.getElementById('current_channel_name');
        const subEl = document.getElementById('current_channel_agents_count');

        if (logoEl) logoEl.textContent = name.charAt(0).toUpperCase();
        if (nameEl) nameEl.textContent = name;
        if (subEl) subEl.textContent = `${agentsCount} Agents`;
    }
// ğŸ”¥ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ ğŸ”¥
if (typeof window.loadDashboardData === 'function') {
        window.loadDashboardData(newChannelId);
    }


    if (typeof window.loadTeamStats === 'function') {
        window.loadTeamStats(newChannelId);
    }

}
window.switchChannel = switchChannel;
window.openAddChannelModal = openAddChannelModal;



// Ø¯Ø§Ù„Ø© Ø¬Ù„Ø¨ Ø¬Ù‡Ø§Øª Ø§Ù„Ø§ØªØµØ§Ù„ (Ù…Ø¹Ø¯Ù„Ø©)
// async function fetchContacts() {
//     // Ù†Ù…Ø±Ø± channel_id ÙÙŠ Ø§Ù„Ø±Ø§Ø¨Ø·
//     const url = `${window.API_URLS.contacts}?channel_id=${currentChannelId}`;
//     const res = await fetch(url);
//     const data = await res.json();
    
//     // ØªØ­Ø¯ÙŠØ« currentChannelId Ø¥Ø°Ø§ Ø¹Ø§Ø¯ Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ± (Ù„Ø£ÙˆÙ„ Ù…Ø±Ø©)
//     if(data.current_channel) currentChannelId = data.current_channel;
    
//     renderContacts(data.contacts);
// }



// Ø¯Ø§Ù„Ø© Ø¬Ù„Ø¨ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ (Ù…Ø¹Ø¯Ù„Ø©)
// async function fetchMessagesForCurrent() {
//     if(!currentPhone || !currentChannelId) return;
    
//     const url = `${window.API_URLS.messages}?phone=${currentPhone}&channel_id=${currentChannelId}`;
//     // ... Ø¨Ø§Ù‚ÙŠ Ø§Ù„ÙƒÙˆØ¯ ...
// }




// ------------------------- contacts -------------------------- 
async function fetchContactsAndUpdateUIws(wsData = null, loadFromApi = false) {
    console.log('ğŸ”„ Update UI Triggered:', { wsData, loadFromApi });
    
    let contactsToProcess = [];

    try {
        // ==========================================
        // Ø§Ù„Ø­Ø§Ù„Ø© 1: ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø© (Ø¬Ù„Ø¨ Ø§Ù„ÙƒÙ„ Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ±)
        // ==========================================
        if (loadFromApi) {
            // const url = window.API_URLS.contacts;  
            const url = `${window.API_URLS.contacts}?channel_id=${currentChannelId}`;
            const res = await fetch(url, { 
                cache: 'no-store', 
                headers: { 'Accept': 'application/json' }
            });
            
            
            if (!res.ok) throw new Error("Failed to fetch contacts");
            
            const data = await res.json();
            contactsToProcess = Array.isArray(data) ? data : (data.contacts || []);
            console.log('loadFromApi' , data)
            // ğŸ”¥ Ø­ÙØ¸ Ø¬Ù…ÙŠØ¹ Ø¬Ù‡Ø§Øª Ø§Ù„Ø§ØªØµØ§Ù„ Ù„Ù„Ø¨Ø­Ø« ÙˆØ§Ù„ÙÙ„ØªØ±Ø©
            allContactsData = contactsToProcess;
            
            // ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© ÙÙ‚Ø· ÙÙŠ Ø­Ø§Ù„Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙƒØ§Ù…Ù„
            const listContainer = document.getElementById('contacts-list'); // Ø¶Ø¹ ID Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ù‡Ù†Ø§
            if (listContainer) listContainer.innerHTML = ''; 
        } 
        
        // ==========================================
        // Ø§Ù„Ø­Ø§Ù„Ø© 2: Ù…Ø³ØªØ®Ø¯Ù… Ø¬Ø¯ÙŠØ¯ Ù…Ù† Ø§Ù„Ø³ÙˆÙƒØª (Ø¨Ø¯ÙˆÙ† Fetch)
        // ==========================================
        else if (wsData) {
            contactsToProcess = [wsData];
            // ğŸ”¥ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ø¥Ù„Ù‰ allContactsData
            const existingIndex = allContactsData.findIndex(c => c.phone === wsData.phone);
            if (existingIndex >= 0) {
                allContactsData[existingIndex] = wsData;
            } else {
                allContactsData.unshift(wsData);
            }
        }

        const contacts = Array.isArray(contactsToProcess) ? contactsToProcess : (contactsToProcess.contacts || []);
        const snapshot = JSON.stringify(contacts.map(c => [c.phone, c.last_id, c.unread]));
        
        if(snapshot === contactsSnapshot && !loadFromApi) return;
        contactsSnapshot = snapshot;

        // ğŸ”¥ ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø¨Ø­Ø« ÙˆØ§Ù„ÙÙ„ØªØ±Ø©
        applySearchAndFilter();
        
      }catch(e){ 
        console.error('fetchContactsAndUpdateUIws', e); 
      }
    
    
    }


    // ğŸ”¥ Ø¯Ø§Ù„Ø© Ù„Ø¹Ø±Ø¶ Ø¬Ù‡Ø§Øª Ø§Ù„Ø§ØªØµØ§Ù„ Ù…Ø¹ Ø§Ù„Ø¨Ø­Ø« ÙˆØ§Ù„ÙÙ„ØªØ±Ø©
    function renderContactsList(contacts) {
        const contactsListEl = document.getElementById('cls3741_contacts_list');
        if (!contactsListEl) return;

        // ğŸ”¥ ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø¨Ø­Ø« ÙˆØ§Ù„ÙÙ„ØªØ±Ø©
        let filtered = contacts.filter(c => {
            // Ø§Ù„Ø¨Ø­Ø«
            if (currentSearchQuery) {
                const query = currentSearchQuery.toLowerCase();
                const name = (c.name || '').toLowerCase();
                const phone = (c.phone || '').toLowerCase();
                const snippet = (c.snippet || '').toLowerCase();
                if (!name.includes(query) && !phone.includes(query) && !snippet.includes(query)) {
                    return false;
                }
            }

            // Ø§Ù„ÙÙ„ØªØ±Ø©
            if (currentFilter === 'unread') {
                return c.unread && c.unread > 0;
            } else if (currentFilter === 'read') {
                return !c.unread || c.unread === 0;
            }
            return true; // 'all'
        });

        if (filtered.length === 0) {
            contactsListEl.innerHTML = `
                <div style="text-align:center;padding:60px 20px;color:var(--text-secondary)">
                    <div style="font-size:48px;margin-bottom:16px;opacity:0.3">ğŸ”</div>
                    <div style="font-size:15px;font-weight:500">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬</div>
                    <div style="font-size:13px;margin-top:8px;opacity:0.7">Ø¬Ø±Ø¨ ØªØºÙŠÙŠØ± Ø§Ù„Ø¨Ø­Ø« Ø£Ùˆ Ø§Ù„ÙÙ„ØªØ±</div>
                </div>
            `;
            return;
        }

    const frag = document.createDocumentFragment();
        filtered.forEach(c => {
          console.log('rendring contacts' , c)
    const item = document.createElement('div');
    item.className = 'cls3741_contact_item';
    item.setAttribute('data-phone', c.phone || '');
    item.setAttribute('data-name', c.name || '');
    item.setAttribute('timestamp_', c.timestamp || '');
    console.log('ğŸš€ ~ file: whatssap.html ~ line 255 ~ item.setAttribute ~ c.channel_id', c)
            item.setAttribute('data-channel-id', c.channel_id || '');
    const initial = (c.name || '').trim().charAt(0).toUpperCase() || '?';
    const isUnread = c.unread && c.unread > 0;
    const badge = isUnread ? `<div class="cls3741_contact_badge green">${c.unread}</div>` : '';
    const snippetClass = isUnread ? 'cls3741_contact_snippet green' : 'cls3741_contact_snippet';
    let statusIconHTML = '';
    const avatarSrc = c.profile_picture 
        ? c.profile_picture 
        : "https://cdn.pixabay.com/photo/2023/02/18/11/00/icon-7797704_640.png";


    if (c.fromMe) { 
        statusIconHTML = `<span class="sidebar-status-icon">${getStatusIconHTML(c.last_status || 'pending')}</span>`;
    }

    item.innerHTML = `
        <div class="cls3741_contact_avatar">
            <img src="${avatarSrc}" style="width:100%;height:100%;border-radius:50%;object-fit:cover;"> 
        </div>
        <div class="cls3741_contact_meta">
            <div class="cls3741_contact_name">${escapeHtml(c.name || c.phone)}</div>
            <div class="${snippetClass}" style="font-family:'tajawal', sans-serif;">
                ${statusIconHTML} ${escapeHtml(c.snippet || '')}
            </div>
        </div>
        <div style="display:flex; flex-direction:column; align-items:flex-end; gap:4px;">
             <span class="cls3741_msg_time" style="font-size:10px; color:var(--text-secondary);">${c.timestamp || 'Now'}</span>
             ${badge}
        </div>
    `;
    frag.appendChild(item);
});

        contactsListEl.innerHTML = '';
        contactsListEl.appendChild(frag);
        
        // ğŸ”¥ Ø±Ø¨Ø· Ø§Ù„Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ø§Ù„Ø¹Ù†Ø§ØµØ±
        contactsListEl.querySelectorAll('.cls3741_contact_item').forEach(item => {
            item.addEventListener('click', function() {
                onContactSelected(item);
            });
        });
    }

    // ğŸ”¥ Ø¯Ø§Ù„Ø© ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø¨Ø­Ø« ÙˆØ§Ù„ÙÙ„ØªØ±Ø©
    function applySearchAndFilter() {
        renderContactsList(allContactsData);
    }

// Ø¬Ø¹Ù„ Ø§Ù„Ø¯Ø§Ù„Ø© Ø¹Ø§Ù…Ø© Ù„ØªÙƒÙˆÙ† Ù…ØªØ§Ø­Ø© Ù„Ù„Ø³ÙˆÙƒÙŠØª
window.updateContactItemSingle = function(contactData) {
    console.log('âš¡ Updating Sidebar Item:', contactData);

    const contactsListEl = document.getElementById('cls3741_contacts_list');
    if (!contactsListEl) return;

    // 1. ØªÙ†Ø¸ÙŠÙ Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ù‡Ø§ØªÙ Ù„Ù„Ù…Ù‚Ø§Ø±Ù†Ø© Ø§Ù„Ø¯Ù‚ÙŠÙ‚Ø©
    const safePhone = (contactData.phone || '').replace(/^\+/, '').replace(/\s+/g, '');
    
    // ğŸ”¥ Ø§Ù„Ø®Ø·ÙˆØ© Ø§Ù„Ø­Ø§Ø³Ù…Ø©: Ø§Ù„ØªØ­Ù‚Ù‚ Ù‡Ù„ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© Ù…ÙØªÙˆØ­Ø© Ø§Ù„Ø¢Ù†ØŸ ğŸ”¥
    // Ù†Ø¬Ù„Ø¨ Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ù…ÙØªÙˆØ­ Ø­Ø§Ù„ÙŠØ§Ù‹ Ù…Ù† Ø§Ù„Ø¯Ø§Ù„Ø© Ø§Ù„Ø¹Ø§Ù…Ø©
    let activeChatPhone = null;
    if (window.getCurrentChatPhone) {
        activeChatPhone = window.getCurrentChatPhone();
        if (activeChatPhone) activeChatPhone = activeChatPhone.replace(/^\+/, '').replace(/\s+/g, '');
    }

    const isChatActive = activeChatPhone && (activeChatPhone === safePhone || activeChatPhone === contactData.phone);

    // ğŸ”¥ Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© Ù…ÙØªÙˆØ­Ø©ØŒ Ù†Ø¬Ø¨Ø± Ø§Ù„Ø¹Ø¯Ø§Ø¯ Ø£Ù† ÙŠÙƒÙˆÙ† 0 (Ø­ØªÙ‰ Ù„Ùˆ Ø§Ù„Ø³ÙŠØ±ÙØ± Ù‚Ø§Ù„ 1)
    if (isChatActive) {
        contactData.unread = 0;
    }

    // 2. Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ø¹Ù†ØµØ± Ø§Ù„Ù‚Ø¯ÙŠÙ…
    let existingItem = contactsListEl.querySelector(`.cls3741_contact_item[data-phone="${safePhone}"]`);
    if (!existingItem) {
        existingItem = contactsListEl.querySelector(`.cls3741_contact_item[data-phone="${contactData.phone}"]`);
    }

    // 3. ØªØ¬Ù‡ÙŠØ² Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø§Ù„Ø­Ø§Ù„Ø© (ØµØ­/Ø³Ø§Ø¹Ø©) Ù„Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„ØµØ§Ø¯Ø±Ø© Ù…Ù†ÙŠ
    let statusIconHTML = '';
    if (contactData.fromMe || contactData.is_from_me) { 
        const status = contactData.last_status || contactData.status || 'pending';
        // Ù†ØªØ£ÙƒØ¯ Ø£Ù† Ø¯Ø§Ù„Ø© Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø§Øª Ù…ÙˆØ¬ÙˆØ¯Ø©
        if (typeof getStatusIconHTML === 'function') {
            statusIconHTML = `<span class="sidebar-status-icon">${getStatusIconHTML(status)}</span>`;
        }
    }

    // 4. ØªØ¬Ù‡ÙŠØ² Ø´Ø§Ø±Ø© ØºÙŠØ± Ø§Ù„Ù…Ù‚Ø±ÙˆØ¡ (Badge)
    // Ø§Ù„Ø¢Ù† contactData.unread Ø£ØµØ¨Ø­ 0 Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø´Ø§Øª Ù…ÙØªÙˆØ­Ø§Ù‹ØŒ Ù„Ø°Ø§ Ù„Ù† ÙŠØ¸Ù‡Ø± Ø§Ù„Ø¨Ø§Ø¯Ø¬
    const isUnread = contactData.unread && contactData.unread > 0;
    const badgeHtml = isUnread ? `<div class="cls3741_contact_badge green">${contactData.unread}</div>` : '';
    
    // ØªÙ„ÙˆÙŠÙ† Ø§Ù„Ù†Øµ Ø¨Ø§Ù„Ø£Ø®Ø¶Ø± ÙÙ‚Ø· Ø¥Ø°Ø§ ÙƒØ§Ù†Øª ØºÙŠØ± Ù…Ù‚Ø±ÙˆØ¡Ø©
    const snippetClass = isUnread ? 'cls3741_contact_snippet green' : 'cls3741_contact_snippet';

    // 5. ØµÙˆØ±Ø© Ø§Ù„Ø¨Ø±ÙˆÙØ§ÙŠÙ„
    const avatarSrc = contactData.profile_picture 
        ? contactData.profile_picture 
        : "https://cdn.pixabay.com/photo/2023/02/18/11/00/icon-7797704_640.png";

    // 6. Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø¹Ù†ØµØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯
    const newItem = document.createElement('div');
    newItem.className = 'cls3741_contact_item';
    
    // Ø¥Ø¶Ø§ÙØ© ÙƒÙ„Ø§Ø³ Ø§Ù„ØªÙØ¹ÙŠÙ„ (Highlight) Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ùˆ Ø§Ù„Ù…ÙØªÙˆØ­
    if (isChatActive) {
        newItem.classList.add('cls3741_btn_active');
    }

    // ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    newItem.setAttribute('data-phone', contactData.phone);
    newItem.setAttribute('data-name', contactData.name);
    newItem.setAttribute('data-channel-id', contactData.channel_id || '');

    newItem.innerHTML = `
        <div class="cls3741_contact_avatar">
            <img src="${avatarSrc}" style="width:100%;height:100%;border-radius:50%;object-fit:cover;"> 
        </div>
        <div class="cls3741_contact_meta">
            <div class="cls3741_contact_name">${escapeHtml(contactData.name || contactData.phone)}</div>
            <div class="${snippetClass}" style="font-family:'tajawal', sans-serif;">
                ${statusIconHTML} ${escapeHtml(contactData.snippet || '')}
            </div>
        </div>
        <div style="display:flex; flex-direction:column; align-items:flex-end; gap:4px;">
             <span class="cls3741_msg_time" style="font-size:10px; color:var(--text-secondary);">${contactData.timestamp || 'Now'}</span>
             ${badgeHtml}
        </div>
    `;

    // Ø¥Ø¶Ø§ÙØ© Ø­Ø¯Ø« Ø§Ù„Ù†Ù‚Ø±
    newItem.addEventListener('click', function() {
        if (window.__chatSelectPhone) window.__chatSelectPhone(contactData.phone, contactData.name);
    });

    // 7. Ø§Ù„ØªØ­Ø¯ÙŠØ« ÙÙŠ Ø§Ù„Ù€ DOM
    if (existingItem) {
        existingItem.remove(); // Ø­Ø°Ù Ø§Ù„Ù‚Ø¯ÙŠÙ…
    }
    
    contactsListEl.prepend(newItem); // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¬Ø¯ÙŠØ¯ ÙÙŠ Ø§Ù„Ø£Ø¹Ù„Ù‰
};


// Ø¯Ø§Ù„Ø© Ù…Ø³Ø§Ø¹Ø¯Ø© ØµØºÙŠØ±Ø© Ø¥Ø°Ø§ Ù„Ù… ØªÙƒÙ† Ù…ÙˆØ¬ÙˆØ¯Ø©
function escapeHtml(s) {
    return (s||'').toString().replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
}




    // Ø¯Ø§Ù„Ø© Ù…Ø­Ø³Ù†Ø© Ù„Ø§Ø®ØªÙŠØ§Ø± Ø¬Ù‡Ø© Ø§ØªØµØ§Ù„
    function onContactSelected(el){
      const phone = el.getAttribute('data-phone');
      const name = el.getAttribute('data-name') || null;
      const las_seen__ = el.getAttribute('timestamp_' || null);
      const channelId = el.getAttribute('data-channel-id') || null; // ğŸ”¥ Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ channel_id
      if(!phone) return;
      
      currentPhone = phone.replace(/^\+/, '').replace(/\s+/g,'');
      currentChannelId = channelId; // ğŸ”¥ Ø­ÙØ¸ channel_id Ø§Ù„Ø­Ø§Ù„ÙŠ
      lastMessageId = 0;
      lastmsg();

      const avatarEl = document.getElementById('cls3741_active_avatar');
      if (avatarEl) {
        avatarEl.textContent = (name||phone).trim().charAt(0).toUpperCase();
        document.getElementById('crm-avatar_sidbar').textContent = (name||phone).trim().charAt(0).toUpperCase();
      }

      const nameEl = document.getElementById('cls3741_active_name');
      const last_seen_ = document.getElementById('last_seen_')
      console.log(el)
      if (last_seen_) last_seen_.textContent = 'last seen today at '+las_seen__
      if (nameEl){nameEl.textContent = name || phone;

        document.querySelector('.crm-name').textContent  = name || phone;
      }
      
      const userAvatarEl = document.getElementById('cls3741_user_avatar');
      if (userAvatarEl) userAvatarEl.textContent = (name||phone).trim().charAt(0).toUpperCase();
      
      const userNameEl = document.getElementById('cls3741_user_name');
      if (userNameEl) userNameEl.textContent = name || phone;
      
      const userPhoneEl = document.getElementById('cls3741_user_phone');
      if (userPhoneEl) {
        userPhoneEl.textContent = '+' + currentPhone;
       
      }
      document.querySelector('.crm-phone').textContent = '+' + currentPhone;
      messagesArea.innerHTML = '';
      messagesArea.appendChild(createLoadingMessage());
      
      fetchMessagesForCurrentws().then(()=>{

        const item = contactsListEl.querySelector(`.cls3741_contact_item[data-phone="${phone}"]`);
        if(item){
          const allItems = contactsListEl.querySelectorAll('.cls3741_contact_item');
          allItems.forEach(i => i.classList.remove('cls3741_btn_active'));
          item.classList.add('cls3741_btn_active')
          const badge = item.querySelector('.cls3741_contact_badge');
          if(badge) {
            badge.textContent = 'â€”';
            badge.style.opacity = '0';
          }
        }
      });


     
    }

 
function fileToBase64(file) {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.onload = () => {
      const result = reader.result.split(",")[1];
      resolve(result);
    };
    reader.onerror = reject;
    reader.readAsDataURL(file);
  });
}

async function sendMessageLocal_ws(fileObj = null, fileType = null) {
  // 1. Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù‡Ø§ØªÙ
  if (!currentPhone) { 
      alert('âš ï¸ ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ù…Ø­Ø§Ø¯Ø«Ø© Ø£ÙˆÙ„Ø§Ù‹'); 
      return; 
  }

  // 2. Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù‚Ù†Ø§Ø© (Ù…Ù† Ø§Ù„Ù…ØªØºÙŠØ± Ø§Ù„Ø¹Ø§Ù…)
  const activeChannelId = window.currentChannelId;
  console.log('ğŸ“¢ Sending on Channel:', activeChannelId); // Ù„Ù„ØªØ£ÙƒØ¯

  if (!activeChannelId || activeChannelId === 'null') {
      console.error('âŒ Missing Channel ID');
      alert('Ø®Ø·Ø£: Ø§Ù„Ù‚Ù†Ø§Ø© ØºÙŠØ± Ù…Ø­Ø¯Ø¯Ø©. ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙØ­Ø©.');
      return;
  }

  // Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ù…Ù„ÙØ§Øª
  if (fileObj instanceof Event) { fileObj = null; fileType = null; }
  const fileToSend = fileObj || queuedFile;
  const typeToSend = fileType || queuedFileType;

  // ØªØ¹Ø·ÙŠÙ„ Ø§Ù„Ø²Ø±
  if (sendBtnmain) sendBtnmain.disabled = true;

  try {
    // Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©
    const payload = {
      type: fileToSend ? 'media_upload' : 'text',
      to: currentPhone,
      body: '',
      channel_id: activeChannelId, // ğŸ”¥ ØªØµØ­ÙŠØ­ Ø§Ù„Ø§Ø³Ù… ÙˆØ§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù…ØªØºÙŠØ± Ø§Ù„Ø¹Ø§Ù…
      local_id: Date.now()
    };

    // ==========================================
    // Ø§Ù„Ø­Ø§Ù„Ø© 1: ÙˆØ³Ø§Ø¦Ø· (Ù…Ù„ÙØ§Øª)
    // ==========================================
    if (fileToSend && typeToSend) {
      const base64 = await fileToBase64(fileToSend);

      payload.type = typeToSend; 
      payload.file = base64;
      payload.mime = fileToSend.type || ( typeToSend === 'image' ? 'image/jpeg' :
        typeToSend === 'video' ? 'video/mp4' :
        typeToSend === 'audio' ? 'audio/ogg' : 'application/octet-stream' );
      payload.msg_type ='media_upload'; 
    }  
    // ==========================================
    // Ø§Ù„Ø­Ø§Ù„Ø© 2: Ù†Øµ Ø¹Ø§Ø¯ÙŠ
    // ==========================================
    else {
      const text = messageInput ? messageInput.value.trim() : '';
      
      if (!text) { 
          if (sendBtnmain) sendBtnmain.disabled = false; 
          // alert('Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„Ø©'); 
          return; 
      }
      
      // ØªÙ†Ø¸ÙŠÙ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© ÙÙˆØ±Ø§Ù‹
      if (messageInput) messageInput.value = '';
      
      payload.body = text;
      payload.type = 'text';
    }

    // ==========================================
    // Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ø¹Ø¨Ø± Ø§Ù„Ø³ÙˆÙƒÙŠØª
    // ==========================================
    
    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø£Ù† Ø§Ù„Ø³ÙˆÙƒÙŠØª Ù…ÙˆØ¬ÙˆØ¯ ÙˆÙ…ØªØµÙ„
    if (window.ChatSocket && window.ChatSocket.socket && window.ChatSocket.socket.readyState === WebSocket.OPEN) {
        
        await window.ChatSocket.send(
            'send_message', 
            payload
        );

        console.log("âœ… Message Sent via Socket:", payload);

        // ØªÙ†Ø¸ÙŠÙ Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ù…Ù„ÙØ§Øª Ø¨Ø¹Ø¯ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù†Ø§Ø¬Ø­
        if (fileToSend) {
            queuedFile = null;
            queuedFileType = null;
            if (mediaPreview) mediaPreview.innerHTML = '';
        }

    } else {
        throw new Error("Ø§ØªØµØ§Ù„ Ø§Ù„Ø³ÙˆÙƒÙŠØª ØºÙŠØ± Ù…ØªÙˆÙØ± (Disconnected)");
    }

  } catch (err) {
    console.error('âŒ sendMessageLocal error:', err);
    alert('ÙØ´Ù„ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„: ' + (err.message || "Ø®Ø·Ø£ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ"));
    
    // ÙÙŠ Ø­Ø§Ù„Ø© Ø§Ù„ÙØ´Ù„ØŒ Ù‚Ø¯ Ù†Ø­ØªØ§Ø¬ Ù„Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù†Øµ Ù„Ø­Ù‚Ù„ Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„
    // if (messageInput && payload.body) messageInput.value = payload.body;

  } finally {
    // Ø¥Ø¹Ø§Ø¯Ø© ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø²Ø± Ø¯Ø§Ø¦Ù…Ø§Ù‹
    if (sendBtnmain) sendBtnmain.disabled = false;
    // Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ±ÙƒÙŠØ²
    if (messageInput) messageInput.focus();
  }
}




// Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ÙˆØ³Ø§Ø¦Ø· ÙÙŠ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±
    function renderMediaPreview(file, type) {
      if (!mediaPreview) return;
      
      mediaPreview.innerHTML = '';
      
      const wrapper = document.createElement('div');
      wrapper.className = 'cls3741_preview_item';
      wrapper.style.cssText = `
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 12px;
        background: var(--bg-tertiary, #f1f3f4);
        border-radius: 12px;
        margin: 8px 0;
        border: 1px solid var(--border-color, #e5e7eb);
      `;

      let previewContent = '';
      
      if (type === 'image') {
        previewContent = `
          <img src="${URL.createObjectURL(file)}" style="width: 60px; height: 60px; border-radius: 8px; object-fit: cover;">
          <div style="flex: 1;">
            <div style="font-weight: 600; color: var(--text-primary);">ØµÙˆØ±Ø©</div>
            <div style="font-size: 12px; color: var(--text-secondary);">${file.name}</div>
          </div>
        `;
      } else if (type === 'video') {
        previewContent = `
          <div style="width: 60px; height: 60px; border-radius: 8px; background: var(--accent); display: flex; align-items: center; justify-content: center; color: white;">
            ğŸ¬
          </div>
          <div style="flex: 1;">
            <div style="font-weight: 600; color: var(--text-primary);">ÙÙŠØ¯ÙŠÙˆ</div>
            <div style="font-size: 12px; color: var(--text-secondary);">${file.name}</div>
          </div>
        `;
      } else if (type === 'audio') {
        previewContent = `
          <div style="width: 60px; height: 60px; border-radius: 8px; background: var(--accent); display: flex; align-items: center; justify-content: center; color: white;">
            ğŸµ
          </div>
          <div style="flex: 1;">
            <div style="font-weight: 600; color: var(--text-primary);">Ù…Ù‚Ø·Ø¹ ØµÙˆØªÙŠ</div>
            <div style="font-size: 12px; color: var(--text-secondary);">${Math.round(file.size/1024)} KB</div>
          </div>
        `;
      }

      wrapper.innerHTML = previewContent + `
        <button class="cls3741_preview_remove" style="background: none; border: none; color: var(--text-secondary); cursor: pointer; padding: 8px;" title="Ø¥Ø²Ø§Ù„Ø©">
          âœ•
        </button>
      `;

      wrapper.querySelector('.cls3741_preview_remove').addEventListener('click', () => {
        queuedFile = null;
        queuedFileType = null;
        mediaPreview.innerHTML = '';
      });

      mediaPreview.appendChild(wrapper);
    }

    // Ø±ÙØ¹ Ø§Ù„ØµÙˆØ± ÙˆØ§Ù„ÙÙŠØ¯ÙŠÙˆÙ‡Ø§Øª
    if(imageBtn && imageInput) {
      imageBtn.addEventListener('click', () => imageInput.click());
      imageInput.addEventListener('change', (e) => {
        const file = e.target.files[0];
        if(file) {
          queuedFile = file;
          queuedFileType = 'image';
          renderMediaPreview(file, 'image');
        }
        imageInput.value = '';
      });
    }

    if(videoBtn && videoInput) {
      videoBtn.addEventListener('click', () => videoInput.click());
      videoInput.addEventListener('change', (e) => {
        const file = e.target.files[0];
        if(file) {
          queuedFile = file;
          queuedFileType = 'video';
          renderMediaPreview(file, 'video');
        }
        videoInput.value = '';
      });
    }

    // Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ØµÙˆØªÙŠ
   // Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ØµÙˆØªÙŠ
    if(audioBtn) {
      audioBtn.addEventListener('click', async function(){
        try{
          if(!isRecording){
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            
            // --- [Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„ØªØ¹Ø¯ÙŠÙ„] ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ØµÙŠØºØ© Ø§Ù„Ù…Ù†Ø§Ø³Ø¨Ø© Ù„Ù„Ù…ØªØµÙØ­ ---
            let mimeType = 'audio/webm'; // Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ Ù„ÙƒØ±ÙˆÙ… ÙˆØ£Ù†Ø¯Ø±ÙˆÙŠØ¯
            let fileExtension = 'webm';

            // ÙØ­Øµ Ø¥Ø°Ø§ ÙƒØ§Ù† Ø³ÙØ§Ø±ÙŠ (ÙŠØ¯Ø¹Ù… mp4)
            if (MediaRecorder.isTypeSupported('audio/mp4')) {
                mimeType = 'audio/mp4';
                fileExtension = 'mp4'; // ØªØºÙŠÙŠØ± Ø§Ù„Ø§Ù…ØªØ¯Ø§Ø¯ Ù„Ù€ mp4
            } 
            // ÙØ­Øµ Ø§Ø­ØªÙŠØ§Ø·ÙŠ
            else if (MediaRecorder.isTypeSupported('audio/webm;codecs=opus')) {
                mimeType = 'audio/webm;codecs=opus';
            }
            // -----------------------------------------------------

            // ØªÙ…Ø±ÙŠØ± mimeType Ù„Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø¶Ø±ÙˆØ±ÙŠ Ø¬Ø¯Ø§Ù‹
            mediaRecorder = new MediaRecorder(stream, { mimeType: mimeType });
            audioBlobs = [];
            
            mediaRecorder.ondataavailable = e => {
                if (e.data.size > 0) audioBlobs.push(e.data);
            };

            mediaRecorder.onstop = () => {
              // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù†ÙØ³ Ø§Ù„Ù€ mimeType Ø§Ù„Ø°ÙŠ Ø­Ø¯Ø¯Ù†Ø§Ù‡ ÙÙŠ Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©
              const blob = new Blob(audioBlobs, { type: mimeType });
              
              // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø§Ù…ØªØ¯Ø§Ø¯ Ø§Ù„ØµØ­ÙŠØ­ (mp4 Ø£Ùˆ webm)
              queuedFile = new File([blob], `voice_${Date.now()}.${fileExtension}`, { type: mimeType });
              
              queuedFileType = 'audio';
              renderMediaPreview(queuedFile, 'audio');
              stream.getTracks().forEach(track => track.stop());
            };
            
            mediaRecorder.start();
            isRecording = true;
            audioBtn.classList.add('recording');
          } else {
            mediaRecorder.stop();
            isRecording = false;
            audioBtn.classList.remove('recording');
          }
        }catch(e){
          console.error('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ³Ø¬ÙŠÙ„:', e);
          alert('Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ÙˆØµÙˆÙ„ Ø¥Ù„Ù‰ Ø§Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ†. ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø£Ø°ÙˆÙ†Ø§Øª.');
        }
      });
    }
    // Ø±Ø¨Ø· Ø§Ù„Ø£Ø­Ø¯Ø§Ø« Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©
    contactsListEl?.addEventListener('click', function(e){
      let el = e.target;
      while(el && !el.classList.contains('cls3741_contact_item')) el = el.parentElement;
      if(el) onContactSelected(el);
    });

    // Ù…Ø¹Ø§Ù„Ø¬ Ø²Ø± Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ - Ù…Ø¨Ø³Ø·
    if(sendBtnmain) {
      console.log('Ø²Ø± Ø§Ù„Ø¥Ø±Ø³Ø§Ù„');
      sendBtnmain.addEventListener('click', function(e) {
        e.preventDefault();
        console.log('ğŸ”„ Ø²Ø± Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ ØªÙ… Ø§Ù„Ù†Ù‚Ø± Ø¹Ù„ÙŠÙ‡');
        
        if(queuedFile && queuedFileType) {
          sendMessageLocal_ws(queuedFile, queuedFileType);
        } else {
          sendMessageLocal_ws();
        }
      });
    }

    // Ø¥Ø±Ø³Ø§Ù„ Ø¨Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Enter
    if(messageInput) {
      messageInput.addEventListener('keydown', function(e) {
        if(e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();
          console.log('âŒ¨ï¸ Enter ØªÙ… Ø§Ù„Ø¶ØºØ· Ø¹Ù„ÙŠÙ‡');
          
          if(queuedFile && queuedFileType) {
            sendMessageLocal_ws(queuedFile, queuedFileType);
          } else {
            sendMessageLocal_ws();
          }
        }
      });
    }

    // async function pollLoop(){
    //   try{
    //     if(currentPhone) await fetchMessagesForCurrentws();
    //     contactPollCounter = (contactPollCounter + 1) % 3;
    //     // if(contactPollCounter === 0) await fetchContactsAndUpdateUI();
    //   }catch(e){
    //     console.error('pollLoop', e);
    //   } finally {
    //     pollTimer = setTimeout(pollLoop, pollInterval);
    //   }
    // }

    // ğŸ”¥ ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø¨Ø­Ø« ÙˆØ§Ù„ÙÙ„ØªØ±Ø©
 // ============================================================
//  ğŸ”¥ Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø­Ø§Ù„Ø© Ù„Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ© (Sidebar State)
// ============================================================
let sidebarState = {
    page: 1,
    isLoading: false,
    hasMore: true,
    query: '',
    filter: 'all', // all, unread, read
    contacts: [] // Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)
};

// Ø¹Ù†Ø§ØµØ± DOM Ø§Ù„Ø®Ø§ØµØ© Ø¨Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ©
const sidebarListEl = document.getElementById('cls3741_contacts_list');
const sidebarSearchInput = document.getElementById('cls3741_search');
const sidebarSearchClear = document.getElementById('cls3741_search_clear');
const sidebarFilterBtns = document.querySelectorAll('.cls3741_filter_btn');

// ============================================================
//  ğŸ”¥ Ø§Ù„Ø¯Ø§Ù„Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©: Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ± (Fetch)
// ============================================================
async function loadSidebarContacts(reset = false) {
    // 1. Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù‚Ù†Ø§Ø©
    const activeChannelId = window.currentChannelId;
    if (!activeChannelId || activeChannelId === 'null') return;

    // 2. Ø¥Ø°Ø§ ÙƒØ§Ù† Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† (Ø¨Ø­Ø« Ø¬Ø¯ÙŠØ¯ Ø£Ùˆ ÙÙ„ØªØ± Ø¬Ø¯ÙŠØ¯)ØŒ Ù†ØµÙØ± Ø§Ù„Ø¹Ø¯Ø§Ø¯Ø§Øª
    if (reset) {
        sidebarState.page = 1;
        sidebarState.hasMore = true;
        sidebarState.contacts = [];
        // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ†ØŒ Ù†Ø¸Ù Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© ÙˆØ§Ø¹Ø±Ø¶ Ø§Ù„Ù„ÙˆØ¯Ø±
        if(sidebarListEl) sidebarListEl.innerHTML = '<div class="cls3741_loader_new"><div class="cls3741_spinner"></div></div>';
    }

    // 3. Ø´Ø±ÙˆØ· Ø§Ù„ØªÙˆÙ‚Ù: Ø¥Ø°Ø§ ÙƒÙ†Ø§ Ù†Ø­Ù…Ù„ Ø­Ø§Ù„ÙŠØ§Ù‹ Ø£Ùˆ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø§Ù„Ù…Ø²ÙŠØ¯
    if (sidebarState.isLoading || !sidebarState.hasMore) return;

    sidebarState.isLoading = true;

    try {
        // 4. Ø¨Ù†Ø§Ø¡ Ø§Ù„Ø±Ø§Ø¨Ø·
        // Ù…Ù„Ø§Ø­Ø¸Ø©: Ù†Ø³ØªØ®Ø¯Ù… api_contacts2 Ø§Ù„ØªÙŠ Ø­Ø¯Ø«Ù†Ø§Ù‡Ø§ ÙÙŠ Ø§Ù„Ø¨Ø§Ùƒ Ø¥Ù†Ø¯
        let url = `${window.API_URLS.contacts}?channel_id=${activeChannelId}&page=${sidebarState.page}`;
        
        if (sidebarState.query) {
            url += `&q=${encodeURIComponent(sidebarState.query)}`;
        }
        if (sidebarState.filter !== 'all') {
            url += `&filter=${sidebarState.filter}`;
        }

        const res = await fetch(url, { headers: { 'Accept': 'application/json' } });
        if (!res.ok) throw new Error("Failed to load contacts");

        const data = await res.json();
        const newContacts = data.contacts || [];

        // 5. ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø©
        sidebarState.hasMore = data.has_next || false; // Ø§Ù„Ø³ÙŠØ±ÙØ± ÙŠØ®Ø¨Ø±Ù†Ø§ Ù‡Ù„ ÙŠÙˆØ¬Ø¯ Ø§Ù„Ù…Ø²ÙŠØ¯
        sidebarState.page++;

        // 6. Ø§Ù„Ø±Ø³Ù…
        renderSidebarItems(newContacts, reset);

    } catch (e) {
        console.error("Sidebar Load Error:", e);
        if (reset && sidebarListEl) {
            sidebarListEl.innerHTML = `<div style="text-align:center;padding:20px;color:var(--danger);">Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„</div>`;
        }
    } finally {
        sidebarState.isLoading = false;
    }
}

// ============================================================
//  ğŸ”¥ Ø¯Ø§Ù„Ø© Ø§Ù„Ø±Ø³Ù… (Render)
// ============================================================
function renderSidebarItems(contacts, isReset) {
    if (!sidebarListEl) return;

    // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ†ØŒ Ù†Ù…Ø³Ø­ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ù‚Ø¯ÙŠÙ… (Ø§Ù„Ù„ÙˆØ¯Ø±)
    if (isReset) {
        sidebarListEl.innerHTML = '';
        if (contacts.length === 0) {
            sidebarListEl.innerHTML = `
                <div style="text-align:center;padding:40px 20px;color:var(--text-secondary)">
                    <div style="font-size:24px;margin-bottom:8px;opacity:0.5">ğŸ”</div>
                    <div style="font-size:13px;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬</div>
                </div>`;
            return;
        }
    }

    const frag = document.createDocumentFragment();

    contacts.forEach(c => {
        const item = document.createElement('div');
        item.className = 'cls3741_contact_item';
        // Ø¥Ø¶Ø§ÙØ© Ø§Ù„ÙƒÙ„Ø§Ø³ Ø§Ù„Ù†Ø´Ø· Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ùˆ Ø§Ù„Ù…Ø®ØªØ§Ø± Ø­Ø§Ù„ÙŠØ§Ù‹
        if (window.getCurrentChatPhone && window.getCurrentChatPhone() === c.phone) {
            item.classList.add('cls3741_btn_active');
        }

        item.setAttribute('data-phone', c.phone || '');
        item.setAttribute('data-name', c.name || '');
        item.setAttribute('data-channel-id', c.channel_id || '');

        // Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø§Ù„Ø­Ø§Ù„Ø© (Ø¥Ø°Ø§ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ù…Ù†ÙŠ)
        let statusIcon = '';
        if (c.fromMe) {
            statusIcon = `<span class="sidebar-status-icon">${getStatusIconHTML(c.last_status || 'pending')}</span>`;
        }

        // Ø´Ø§Ø±Ø© ØºÙŠØ± Ø§Ù„Ù…Ù‚Ø±ÙˆØ¡
        const badgeHtml = (c.unread > 0) 
            ? `<div class="cls3741_contact_badge green">${c.unread}</div>` 
            : '';
        
        // ØªÙ„ÙˆÙŠÙ† Ø§Ù„Ù†Øµ Ø¥Ø°Ø§ ÙƒØ§Ù† ØºÙŠØ± Ù…Ù‚Ø±ÙˆØ¡
        const snippetClass = (c.unread > 0) ? 'cls3741_contact_snippet green' : 'cls3741_contact_snippet';

        item.innerHTML = `
            <div class="cls3741_contact_avatar">
                <img src="${c.profile_picture || 'https://cdn.pixabay.com/photo/2023/02/18/11/00/icon-7797704_640.png'}" 
                     style="width:100%; height:100%; border-radius:50%; object-fit:cover;">
            </div>
            <div class="cls3741_contact_meta">
                <div class="cls3741_contact_name">${escapeHtml(c.name || c.phone)}</div>
                <div class="${snippetClass}">
                    ${statusIcon} ${escapeHtml(c.snippet || '')}
                </div>
            </div>
            <div style="display:flex; flex-direction:column; align-items:flex-end; gap:4px;">
                <span class="cls3741_msg_time" style="font-size:10px; color:var(--text-secondary);">${c.timestamp || ''}</span>
                ${badgeHtml}
            </div>
        `;

        item.addEventListener('click', () => {
            if(window.__chatSelectPhone) window.__chatSelectPhone(c.phone, c.name);
        });

        frag.appendChild(item);
    });

    sidebarListEl.appendChild(frag);
}

// ============================================================
//  ğŸ”¥ Ù…Ø¹Ø§Ù„Ø¬Ø§Øª Ø§Ù„Ø£Ø­Ø¯Ø§Ø« (Event Listeners)
// ============================================================

// 1. Ø§Ù„Ø¨Ø­Ø« (Ù…Ø¹ Debounce Ù„ØªÙ‚Ù„ÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ù„Ù„Ø³ÙŠØ±ÙØ±)
let searchTimeout;
if (sidebarSearchInput) {
    sidebarSearchInput.addEventListener('input', (e) => {
        const val = e.target.value.trim();
        
        // Ø¥Ø¸Ù‡Ø§Ø±/Ø¥Ø®ÙØ§Ø¡ Ø²Ø± Ø§Ù„Ù…Ø³Ø­
        if (sidebarSearchClear) sidebarSearchClear.style.display = val ? 'flex' : 'none';

        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(() => {
            sidebarState.query = val;
            loadSidebarContacts(true); // Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ù…Ù† Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©
        }, 500); // Ø§Ù†ØªØ¸Ø± Ù†ØµÙ Ø«Ø§Ù†ÙŠØ© Ø¨Ø¹Ø¯ ØªÙˆÙ‚Ù Ø§Ù„ÙƒØªØ§Ø¨Ø©
    });
}

// Ø²Ø± Ù…Ø³Ø­ Ø§Ù„Ø¨Ø­Ø«
if (sidebarSearchClear) {
    sidebarSearchClear.addEventListener('click', () => {
        sidebarSearchInput.value = '';
        sidebarSearchInput.dispatchEvent(new Event('input')); // ØªÙØ¹ÙŠÙ„ Ø­Ø¯Ø« Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ Ø£Ø¹Ù„Ø§Ù‡
    });
}

// 2. Ø£Ø²Ø±Ø§Ø± Ø§Ù„ÙÙ„ØªØ±Ø© (Ø§Ù„ÙƒÙ„ØŒ ØºÙŠØ± Ù…Ù‚Ø±ÙˆØ¡ØŒ Ù…Ù‚Ø±ÙˆØ¡)
sidebarFilterBtns.forEach(btn => {
    btn.addEventListener('click', function() {
        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø´ÙƒÙ„
        sidebarFilterBtns.forEach(b => b.classList.remove('active'));
        this.classList.add('active');

        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø© ÙˆØ§Ù„ØªØ­Ù…ÙŠÙ„
        sidebarState.filter = this.getAttribute('data-filter');
        loadSidebarContacts(true); // Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ù…Ù† Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©
    });
});

// 3. Ø§Ù„ØªÙ…Ø±ÙŠØ± Ø§Ù„Ù„Ø§Ù†Ù‡Ø§Ø¦ÙŠ (Infinite Scroll) ğŸ”¥
if (sidebarListEl) {
    sidebarListEl.addEventListener('scroll', function() {
        // Ù…Ø¹Ø§Ø¯Ù„Ø©: Ù‡Ù„ ÙˆØµÙ„Ù†Ø§ Ù„Ø£Ø³ÙÙ„ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©ØŸ (Ù…Ø¹ Ù‡Ø§Ù…Ø´ 50 Ø¨ÙŠÙƒØ³Ù„)
        if (this.scrollTop + this.clientHeight >= this.scrollHeight - 50) {
            // ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø© Ø§Ù„ØªØ§Ù„ÙŠØ© (append = true Ø¶Ù…Ù†ÙŠØ§Ù‹ Ù„Ø£Ù†Ù†Ø§ Ù„Ù… Ù†Ù…Ø±Ø± reset=true)
            loadSidebarContacts(false); 
        }
    });
}

// ============================================================
//  ğŸ”¥ Ø±Ø¨Ø· Ù…Ø¹ Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ø¹Ø§Ù…
// ============================================================

// ØªØ¹Ø±ÙŠÙ Ø¯Ø§Ù„Ø© Ø§Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø§Ù…Ø© Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…Ù‡Ø§ Ø¹Ù†Ø¯ ØªØºÙŠÙŠØ± Ø§Ù„Ù‚Ù†Ø§Ø©
window.fetchContactsAndUpdateUIws = function(wsData, isFullReload) {
    if (isFullReload) {
        // Ø¹Ù†Ø¯ ØªØºÙŠÙŠØ± Ø§Ù„Ù‚Ù†Ø§Ø©ØŒ Ù†Ø¹ÙŠØ¯ Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ù…Ù† Ø§Ù„ØµÙØ±
        loadSidebarContacts(true);
    } else if (wsData) {
        // Ø¹Ù†Ø¯ ÙˆØµÙˆÙ„ Ø±Ø³Ø§Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø© Ø¹Ø¨Ø± Ø§Ù„Ø³ÙˆÙƒÙŠØª
        // Ù‡Ù†Ø§ Ù†Ø¶ÙŠÙ Ù…Ù†Ø·Ù‚ "Ù†Ù‚Ù„ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© Ù„Ù„Ø£Ø¹Ù„Ù‰" Ù…Ø­Ù„ÙŠØ§Ù‹ Ø¯ÙˆÙ† Ø·Ù„Ø¨ Ø§Ù„Ø³ÙŠØ±ÙØ±
        updateContactItemSingle(wsData); 
    }
};

// Ù…Ù„Ø§Ø­Ø¸Ø©: Ø¯Ø§Ù„Ø© updateContactItemSingle ÙŠØ¬Ø¨ Ø£Ù† ØªØ¨Ù‚Ù‰ Ù…ÙˆØ¬ÙˆØ¯Ø© ÙƒÙ…Ø§ ÙƒØªØ¨Ù†Ø§Ù‡Ø§ Ø³Ø§Ø¨Ù‚Ø§Ù‹
// Ù„ØªÙ‚ÙˆÙ… Ø¨ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø³Ø·Ø± Ø§Ù„ÙˆØ§Ø­Ø¯ Ø£Ùˆ Ø¥Ø¶Ø§ÙØªÙ‡ ÙÙŠ Ø§Ù„Ø£Ø¹Ù„Ù‰ Ø¹Ù†Ø¯ ÙˆØµÙˆÙ„ Socket EventØ°Ø°Ø°





    // Ø§Ù„ØªÙ‡ÙŠØ¦Ø©
    // fetchContactsAndUpdateUI(extract = true);
    fetchContactsAndUpdateUIws( null  ,  true);
    // pollLoop();
 
    window.fetchMessagesForCurrentws = fetchMessagesForCurrentws;
    window.sendMessageLocal_ws = sendMessageLocal_ws;

    window.__chatSelectPhone = function(phone, name){
      const normalized = (phone||'').replace(/^\+/, '').replace(/\s+/g,'');
      const item = contactsListEl.querySelector(`.cls3741_contact_item[data-phone="${normalized}"]`);
      if(item){ 
        
        item.click(); 
        return; 
      }
      
      currentPhone = normalized;
      // ğŸ”¥ Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ channel_id Ù…Ù† contact item Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…ÙˆØ¬ÙˆØ¯Ø§Ù‹
      const contactItem = contactsListEl?.querySelector(`.cls3741_contact_item[data-phone="${normalized}"]`);
      if (contactItem) {
        currentChannelId = contactItem.getAttribute('data-channel-id');
      }
      lastMessageId = 0;
      const userPhoneEl = document.getElementById('cls3741_user_phone');
      if (userPhoneEl) userPhoneEl.textContent = '+' + normalized;
      
      messagesArea.innerHTML = '';
      messagesArea.appendChild(createLoadingMessage());
      
      fetchMessagesForCurrentws();
       
      // fetchContactsAndUpdateUI();
       
    };

    // ØªØ¹Ø±ÙŠÙ Ø¯Ø§Ù„Ø© setCurrentPhone Ù„Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù…Ù† Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø§ØªØµØ§Ù„Ø§Øª
    window.__chatInput = window.__chatInput || {};
    window.__chatInput.setCurrentPhone = function(phone, channelId = null) {
      currentPhone = phone;
      currentChannelId = channelId; // ğŸ”¥ Ø­ÙØ¸ channel_id
      console.log('ğŸ“± ØªÙ… ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ù‡Ø§ØªÙ Ø§Ù„Ø­Ø§Ù„ÙŠ:', currentPhone, 'Channel ID:', currentChannelId);
    };

    console.log('âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø³ÙƒØ±ÙŠØ¨Øª Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© Ø¨Ù†Ø¬Ø§Ø­');

 


window.fetchMessagesForCurrentws = fetchMessagesForCurrentws;
window.sendMessage = sendMessageLocal_ws;
window.getStatusIconHTML =  getStatusIconHTML


window.appendMessagesws = appendMessagesws; 
window.updateContactItemSingle = updateContactItemSingle; 

console.log('âœ… Functions exposed to window successfully');


window.getCurrentChatPhone = function() {
    return currentPhone;
};

  })();  
});



</script> 
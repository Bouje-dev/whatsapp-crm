<div class="container-fluid p-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h4 class="fw-bold text-white"><i class="fas fa-bolt me-2 text-warning"></i> Quick Replies</h4>
        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addReplyModal">
            <i class="fas fa-plus"></i> New Reply
        </button>
    </div>

    <!-- <div id="quick_replies_section" style="display: none;"> <h5 class="text-white mb-3 border-bottom border-secondary pb-2">My Replies</h5>
        <div class="row g-3 mb-4" id="my_replies_grid">
            </div>
    
        <h5 class="text-white mb-3 border-bottom border-secondary pb-2">Team Replies</h5> -->
        <!-- <div class="row g-3" id="team_replies_grid">
            </div> -->

            <div class="mb-4">
                <h5 class="text-white mb-3 border-bottom pb-2 border-secondary"><i class="fas fa-user-edit me-2"></i> My Quick Replies</h5>
                <div class="table-responsive">
                    <table class="table table-hover align-middle reply-table">
                        <thead class="text-muted small text-uppercase">
                            <tr>
                                <th width="20%">Shortcut</th>
                                <th width="30%">Message Preview</th>
                                <th width="10%" class="text-center">Usage</th>
                                <th width="20%">Created By</th>
                                <th width="20%">Created At</th>
                                <th width="5%" class="text-end">Action</th>
                            </tr>
                        </thead>
                        <tbody id="my_replies_grid">
                            </tbody>
                    </table>
                </div>
            </div>
            
            <div class="mb-4">
                <h5 class="text-white mb-3 border-bottom pb-2 border-secondary"><i class="fas fa-users me-2"></i> Team Replies</h5>
                <div class="table-responsive">
                    <table class="table table-hover align-middle reply-table">
                        <thead class="text-muted small text-uppercase">
                            <tr>
                                <th width="20%">Shortcut</th>
                                <th width="30%">Message Preview</th>
                                <th width="10%" class="text-center">Usage</th>
                                <th width="20%">Created By</th>
                                <th width="20%">Created At</th>
                                <th width="5%" class="text-end">Action</th>
                            </tr>
                        </thead>
                        <tbody id="team_replies_grid">
                            </tbody>
                    </table>
                </div>
            </div>
            
            <div id="replies_loader" class="text-center py-5" style="display:none;">
                <div class="spinner-border text-primary" role="status"></div>
            </div>


    
        <div id="replies_loader" class="text-center py-5" style="display: none;">
            <div class="spinner-border text-primary" role="status"></div>
            <p class="text-muted mt-2">Loading templates...</p>
        </div>
    </div>


</div>

<div class="modal fade" id="addReplyModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content bg-dark text-white border-secondary">
            <div class="modal-header border-secondary">
                <h5 class="modal-title">Create Quick Reply</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="createReplyForm" enctype="multipart/form-data">
                    {% csrf_token %}
                    
                    <div class="mb-3">
                        <label class="form-label text-muted small">Shortcut (Trigger)</label>
                        <div class="input-group">
                            <span class="input-group-text bg-secondary border-secondary text-white">/</span>
                            <input type="text" name="shortcut" class="form-control bg-dark border-secondary text-white" placeholder="e.g. welcome" required>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label text-muted small">Message Text</label>
                        <textarea name="message" class="form-control bg-dark border-secondary text-white" rows="4" placeholder="Hello! Here is a video explaining..."></textarea>
                    </div>

                    <div class="mb-3">
                        <label class="form-label text-muted small">Attachment (Optional)</label>
                        <input type="file" name="attachment" class="form-control bg-dark border-secondary text-white">
                        <small class="text-muted">Supports: Video (mp4), Image (png, jpg), PDF</small>
                    </div>
                </form>
            </div>
            <div class="modal-footer border-secondary">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="submitReplyForm()">Save Reply</button>
            </div>
        </div>
    </div>
</div>
<div class="modal fade" id="mediaPreviewModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg"> <div class="modal-content bg-dark border-secondary text-white">
            <div class="modal-header border-0 pb-0">
                <h6 class="modal-title text-muted" id="previewTitle">Media Preview</h6>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center p-0 d-flex align-items-center justify-content-center" style="min-height: 300px; background: #000;">
                
                <div id="mediaPreviewContainer" class="w-100 h-100"></div>

            </div>
        </div>
    </div>
</div>

<script>
    function submitReplyForm() {
    // 1. Ø¬Ù…Ø¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (Ø¨Ù…Ø§ ÙÙŠ Ø°Ù„Ùƒ Ø§Ù„Ù…Ù„ÙØ§Øª)
    const form = document.getElementById('createReplyForm');
    const formData = new FormData(form);
    formData.append('channel' , currentChannelId)

    // 2. Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨
    $.ajax({
        url: "{% url 'api_create_canned_response' %}", // ØªØ£ÙƒØ¯ Ù…Ù† Ø¥Ù†Ø´Ø§Ø¡ Ù‡Ø°Ø§ Ø§Ù„Ù…Ø³Ø§Ø±
        type: "POST",
        data: formData,
        processData: false, // Ù…Ù‡Ù… Ø¬Ø¯Ø§Ù‹ Ù„Ù„Ù…Ù„ÙØ§Øª
        contentType: false, // Ù…Ù‡Ù… Ø¬Ø¯Ø§Ù‹ Ù„Ù„Ù…Ù„ÙØ§Øª
        headers: {
            "X-CSRFToken": document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        success: function(response) {
            // Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù…ÙˆØ¯Ø§Ù„ ÙˆØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙØ­Ø© (Ø£Ùˆ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© ÙŠØ¯ÙˆÙŠØ§Ù‹)
            $('#addReplyModal').modal('hide');
            location.reload(); // Ø£Ùˆ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ§Ù‹
        },
        error: function(xhr) {
            alert("Error saving reply: " + xhr.responseText);
        }
    });
}

function deleteReply(id) {
    if(confirm("Are you sure?")) {
        // ÙƒÙˆØ¯ Ø§Ù„Ø­Ø°Ù ...
    }
}



function openMediaPreview(type, url, title) {
    const container = $('#mediaPreviewContainer');
    const titleEl = $('#previewTitle');
    
    // ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø³Ø§Ø¨Ù‚
    container.empty();
    titleEl.text(`Preview: /${title}`);

    let htmlContent = '';

    if (type === 'video') {
        // ğŸ”¥ ÙÙŠØ¯ÙŠÙˆ: ØªØ´ØºÙŠÙ„ ØªÙ„Ù‚Ø§Ø¦ÙŠ Ù…Ø¹ Ø£Ø¯ÙˆØ§Øª Ø§Ù„ØªØ­ÙƒÙ…
        htmlContent = `
            <video controls autoplay style="max-width: 100%; max-height: 80vh; outline: none;">
                <source src="${url}" type="video/mp4">
                Your browser does not support the video tag.
            </video>
        `;
    } 
    else if (type === 'audio') {
        // ğŸ”¥ ØµÙˆØª: Ù…Ø´ØºÙ„ ØµÙˆØªÙŠ ÙƒØ¨ÙŠØ± ÙˆÙˆØ§Ø¶Ø­
        htmlContent = `
            <div class="p-5">
                <i class="fas fa-music fa-5x text-warning mb-4"></i>
                <br>
                <audio controls autoplay style="width: 300px;">
                    <source src="${url}" type="audio/mpeg">
                    Your browser does not support the audio element.
                </audio>
            </div>
        `;
    } 
    else if (type === 'image') {
        // ğŸ”¥ ØµÙˆØ±Ø©: Ø¹Ø±Ø¶ Ø§Ù„ØµÙˆØ±Ø© ÙƒØ§Ù…Ù„Ø©
        htmlContent = `
            <img src="${url}" class="img-fluid" style="max-height: 80vh;" alt="Full Preview">
        `;
    } 
    else if (type === 'document') {
        htmlContent = `
            <div class="p-5 text-center">
                <i class="fas fa-file-pdf fa-5x text-white mb-3"></i>
                <h5 class="text-white">Document Preview</h5>
                <a href="${url}" target="_blank" class="btn btn-primary mt-3">
                    <i class="fas fa-external-link-alt"></i> Open Document
                </a>
            </div>
        `;
    }

    container.html(htmlContent);
    $('#mediaPreviewModal').modal('show');
}

// ğŸ”¥ Ù†Ù‚Ø·Ø© Ù…Ù‡Ù…Ø© Ø¬Ø¯Ø§Ù‹: Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ØªØ´ØºÙŠÙ„ Ø¹Ù†Ø¯ Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù…ÙˆØ¯Ø§Ù„ ğŸ”¥
// ÙˆØ¥Ù„Ø§ Ø³ÙŠØ³ØªÙ…Ø± ØµÙˆØª Ø§Ù„ÙÙŠØ¯ÙŠÙˆ/Ø§Ù„Ø£ÙˆØ¯ÙŠÙˆ ÙŠØ¹Ù…Ù„ ÙÙŠ Ø§Ù„Ø®Ù„ÙÙŠØ©!
$('#mediaPreviewModal').on('hidden.bs.modal', function () {
    $('#mediaPreviewContainer').empty(); // Ø­Ø°Ù Ø§Ù„Ù…Ø­ØªÙˆÙ‰ ÙŠÙˆÙ‚Ù Ø§Ù„ØªØ´ØºÙŠÙ„ ÙÙˆØ±Ø§Ù‹
});






$(document).ready(function() {
    
    // Ø¹Ù†Ø¯ Ø§Ù„Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ø²Ø± ÙØªØ­ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø±Ø¯ÙˆØ¯
    $('#btn_open_quick_replies').click(function() {
        // 1. Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ù‚Ø³Ù… (Ù…ØªÙ„Ø§ ÙÙŠ Ù…ÙˆØ¯Ø§Ù„ Ø£Ùˆ ÙÙŠ ÙˆØ³Ø· Ø§Ù„ØµÙØ­Ø© Ø­Ø³Ø¨ ØªØµÙ…ÙŠÙ…Ùƒ)
        $('#quick_replies_section').show(); // Ø£Ùˆ $('#yourModal').modal('show');
        
        // 2. ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        window.loadQuickRepliesGrid(currentChannelId || 0);
    });

    window.loadQuickRepliesGrid = function(channel) { 
    const myGrid = $('#my_replies_grid');
    const teamGrid = $('#team_replies_grid');
    const loader = $('#replies_loader');

    myGrid.empty();
    teamGrid.empty();
    loader.show();

    const currentChan = channel || currentOpenChatId || 0;
    

    $.ajax({
        url: `/discount/whatssapAPI/api/get-canned-responses?channel_id=${currentChan}`,
        method: 'GET',
        success: function(response) {
            loader.hide();
            
            if (!response.data || response.data.length === 0) {
                myGrid.html('<tr><td colspan="5" class="text-center text-muted py-4">No replies found.</td></tr>');
                return;
            }

            response.data.forEach(reply => {
                // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø¯Ø§Ù„Ø© Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØµÙ Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
                const rowHTML = createReplyRowHTML(reply);

                if (reply.is_mine) {
                    myGrid.append(rowHTML);
                } else {
                    teamGrid.append(rowHTML);
                }
            });
        },
        error: function() {
            loader.hide();
            // toastr.error("Failed to load replies"); // ÙŠÙØ¶Ù„ Ø§Ø³ØªØ®Ø¯Ø§Ù… ØªÙ†Ø¨ÙŠÙ‡ Ù„Ø·ÙŠÙ
        }
    });
}



    // Ø¯Ø§Ù„Ø© Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„Ø±Ø³Ù… Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© (Ù†ÙØ³ ØªØµÙ…ÙŠÙ…Ùƒ Ø§Ù„Ø¬Ù…ÙŠÙ„)
   function createReplyRowHTML(reply) {
    console.log('respay' , reply);
    // 1. ØªØ­Ø¯ÙŠØ¯ Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø§Ù„Ù†ÙˆØ¹ (ØµÙˆØ±Ø©ØŒ Ù†ØµØŒ ÙÙŠØ¯ÙŠÙˆ)
    let typeIcon = '';
    let previewText = reply.message || 'No text provided';

    // ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø¨Ù†Ø§Ø¡ Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª
    if (reply.media_type === 'image' || reply.image) {
        typeIcon = `<div class="media-icon image"><i class="fas fa-image"></i></div>`;
        if(!reply.message) previewText = '<span class="fst-italic text-muted">Image Only</span>';
    } else if (reply.media_type === 'video') {
        typeIcon = `<div class="media-icon video"><i class="fas fa-video"></i></div>`;
        if(!reply.message) previewText = '<span class="fst-italic text-muted">Video Only</span>';
    } else if (reply.media_type === 'audio') {
        typeIcon = `<div class="media-icon audio"><i class="fas fa-microphone"></i></div>`;
        if(!reply.message) previewText = '<span class="fst-italic text-muted">Audio Clip</span>';
    } else {
        typeIcon = `<div class="media-icon text"><i class="fas fa-align-left"></i></div>`;
    }

    // Ù‚Øµ Ø§Ù„Ù†Øµ Ø§Ù„Ø·ÙˆÙŠÙ„
    const truncatedText = previewText.length > 50 ? previewText.substring(0, 50) + '...' : previewText;

    // 2. ØªØ­Ø¯ÙŠØ¯ ØµÙˆØ±Ø© Ø§Ù„Ù…Ù†Ø´Ø¦ (Avatar)
    // Ù†ÙØªØ±Ø¶ ÙˆØ¬ÙˆØ¯ Ø±Ø§Ø¨Ø· ØµÙˆØ±Ø©ØŒ ÙˆØ¥Ù„Ø§ Ù†Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø­Ø±Ù Ø§Ù„Ø£ÙˆÙ„
    const creatorAvatar = reply.author 
        ? `<img src="${reply.creator_avatar}" class="rounded-circle me-2" width="25" height="25">`
        : `<span class="badge bg-secondary rounded-circle me-2" style="width:25px;height:25px;display:inline-flex;align-items:center;justify-content:center;">${reply.creator_name ? reply.author.charAt(0).toUpperCase() : 'U'}</span>`;

    // 3. HTML Ø§Ù„ØµÙ
    return `
    <tr class="reply-item" onclick="openMediaPreview('${reply.media_type}', '${reply.file_url}', '${reply.shortcut}')">
        
        <td>
            <span class="shortcut-badge">/${reply.shortcut || 'no-code'}</span>
        </td>
        
        <td>
            <div class="d-flex align-items-center">
                ${typeIcon}
                <div class="text-white-50 small">${truncatedText}</div>
            </div>
        </td>

        <td class="text-center">
            <span class="usage-count">
                <i class="fas fa-history me-1"></i> ${reply.usage_count || 0}
            </span>
        </td>

        <td>
            <div class="d-flex align-items-center text-white-50 small">
                ${creatorAvatar}
                <span>${reply.author || 'Unknown'}</span>
            </div>
           
        </td>
        <td>
              <div class="d-flex align-items-center text-white-50 small">
                <i class="fas fa-calendar-alt me-1"></i>
                <span>${reply.created_at || 'Unknown'}</span>
            </div>
            </td>
        <td class="text-end">
            <button class="btn btn-icon btn-sm btn-active-light-primary w-30px h-30px" onclick="event.stopPropagation(); editReply(${reply.id})">
                <i class="fas fa-pencil-alt fs-5 text-muted"></i>
            </button>
            <button class="btn btn-icon btn-sm btn-active-light-danger w-30px h-30px ms-1" onclick="event.stopPropagation(); deleteReply(${reply.id})">
                <i class="fas fa-trash fs-5 text-muted"></i>
            </button>
        </td>
    </tr>
    `;
}
    
})
</script>


<style>
    /* ØªØµÙ…ÙŠÙ… Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ */
.reply-table {
    color: #e0e0e0; /* Ù„ÙˆÙ† Ù†Øµ ÙØ§ØªØ­ Ù„Ù„Ø®Ù„ÙÙŠØ© Ø§Ù„Ø¯Ø§ÙƒÙ†Ø© */
    border-collapse: separate;
    border-spacing: 0 8px; /* Ù…Ø³Ø§ÙØ© Ø¨ÙŠÙ† Ø§Ù„ØµÙÙˆÙ */
}

/* ØªØµÙ…ÙŠÙ… Ø§Ù„ØµÙÙˆÙ */
.reply-table tbody tr {
    background-color: #1e1e2d; /* Ù„ÙˆÙ† Ø®Ù„ÙÙŠØ© Ø§Ù„ØµÙ - Ø¹Ø¯Ù„Ù‡ Ø­Ø³Ø¨ Ø«ÙŠÙ… Ù…ÙˆÙ‚Ø¹Ùƒ */
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    transition: all 0.2s ease;
    border-radius: 8px;
}

.reply-table tbody tr td:first-child { border-top-left-radius: 8px; border-bottom-left-radius: 8px; }
.reply-table tbody tr td:last-child { border-top-right-radius: 8px; border-bottom-right-radius: 8px; }

.reply-table tbody tr:hover {
    transform: translateY(-2px);
    background-color: #2b2b40; /* Ù„ÙˆÙ† Ø¹Ù†Ø¯ Ø§Ù„ØªØ­ÙˆÙŠÙ… */
    box-shadow: 0 5px 15px rgba(0,0,0,0.3);
    cursor: pointer;
}

/* ØªØµÙ…ÙŠÙ… Ø§Ù„Ø§Ø®ØªØµØ§Ø± (Shortcut Badge) */
.shortcut-badge {
    background: rgba(54, 153, 255, 0.1);
    color: #3699ff;
    padding: 6px 12px;
    border-radius: 6px;
    font-family: 'Courier New', monospace;
    font-weight: bold;
    font-size: 0.9rem;
    border: 1px solid rgba(54, 153, 255, 0.2);
}

/* ØªØµÙ…ÙŠÙ… Ù†ÙˆØ¹ Ø§Ù„ÙˆØ³Ø§Ø¦Ø· (Media Icon) */
.media-icon {
    width: 32px;
    height: 32px;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
    margin-right: 10px;
    font-size: 12px;
}
.media-icon.image { background: rgba(255, 193, 7, 0.1); color: #ffc107; }
.media-icon.video { background: rgba(244, 67, 54, 0.1); color: #f44336; }
.media-icon.audio { background: rgba(0, 188, 212, 0.1); color: #00bcd4; }
.media-icon.text { background: rgba(158, 158, 158, 0.1); color: #9e9e9e; }

/* ØªØµÙ…ÙŠÙ… Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… */
.usage-count {
    font-weight: 600;
    color: #28a745;
    background: rgba(40, 167, 69, 0.1);
    padding: 2px 8px;
    border-radius: 4px;
    font-size: 0.8rem;
}
</style>